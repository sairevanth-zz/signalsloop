<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Duplicate Detection</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 30px; }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .mode-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn.active {
            border-color: #6366f1;
            background: #eef2ff;
        }
        .mode-btn:hover { background: #f8fafc; }

        .posts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .post-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .post-section h3 {
            margin: 0 0 15px 0;
            color: #334155;
            font-size: 16px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        input[type="number"] {
            width: 100px;
        }
        button {
            background: #6366f1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover { background: #4f46e5; }
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
        }
        .duplicate-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .duplicate-card.exact { border-color: #dc2626; background: #fef2f2; }
        .duplicate-card.semantic { border-color: #f59e0b; background: #fffbeb; }
        .duplicate-card.partial { border-color: #3b82f6; background: #eff6ff; }
        .duplicate-card.related { border-color: #8b5cf6; background: #f5f3ff; }

        .duplicate-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        .post-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }
        .similarity-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            margin-left: 10px;
        }
        .exact .similarity-badge { background: #dc2626; color: white; }
        .semantic .similarity-badge { background: #f59e0b; color: white; }
        .partial .similarity-badge { background: #3b82f6; color: white; }
        .related .similarity-badge { background: #8b5cf6; color: white; }

        .merge-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }
        .merge-badge.merge { background: #dcfce7; color: #166534; }
        .merge-badge.link { background: #dbeafe; color: #1e40af; }
        .merge-badge.keep { background: #f3f4f6; color: #374151; }

        .explanation {
            color: #475569;
            font-size: 14px;
            margin: 15px 0;
            line-height: 1.6;
        }
        .themes-diff {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .theme-box {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .theme-title {
            font-weight: 600;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .theme-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .theme-list li {
            padding: 4px 0;
            font-size: 13px;
            color: #1e293b;
        }
        .theme-list li:before {
            content: "‚Ä¢";
            margin-right: 8px;
            color: #6366f1;
        }
        .cluster-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .cluster-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .cluster-stats {
            display: flex;
            gap: 30px;
            font-size: 14px;
            opacity: 0.95;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 6px;
        }
        .examples {
            margin-bottom: 20px;
            padding: 15px;
            background: #eff6ff;
            border-radius: 6px;
        }
        .example-btn {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
        }
        .example-btn:hover {
            background: #f1f5f9;
        }
        .post-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
        }
        .post-item {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }
        .post-item:last-child { border-bottom: none; }
        .merged-content {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        .merged-label {
            font-weight: 600;
            color: #166534;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .merged-text {
            color: #15803d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Duplicate Detection</h1>
        <p class="subtitle">Advanced semantic analysis for identifying duplicate feedback</p>

        <div class="mode-selector">
            <div class="mode-btn active" onclick="switchMode('single')" id="mode-single">
                <strong>Single Post Detection</strong>
                <p style="margin:5px 0 0 0; font-size:13px; color:#64748b;">Find duplicates of one post</p>
            </div>
            <div class="mode-btn" onclick="switchMode('cluster')" id="mode-cluster">
                <strong>Cluster Analysis</strong>
                <p style="margin:5px 0 0 0; font-size:13px; color:#64748b;">Find groups of related posts</p>
            </div>
        </div>

        <div id="single-mode">
            <div class="examples">
                <strong>Quick Test Examples:</strong><br>
                <button class="example-btn" onclick="loadExample('exact')">üéØ Exact Duplicate</button>
                <button class="example-btn" onclick="loadExample('semantic')">üîÑ Semantic Duplicate</button>
                <button class="example-btn" onclick="loadExample('partial')">üìä Partial Overlap</button>
                <button class="example-btn" onclick="loadExample('unrelated')">‚ùå Different Posts</button>
            </div>

            <div class="posts-grid">
                <div class="post-section">
                    <h3>üìù New Post</h3>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="newTitle" placeholder="e.g., Add dark mode">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="newDescription" placeholder="Detailed description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="newCategory">
                            <option value="">None</option>
                            <option value="feature">Feature Request</option>
                            <option value="bug">Bug</option>
                            <option value="improvement">Improvement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vote Count</label>
                        <input type="number" id="newVotes" value="10">
                    </div>
                </div>

                <div class="post-section">
                    <h3>üìö Existing Post</h3>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="existingTitle" placeholder="e.g., Dark theme support">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="existingDescription" placeholder="Detailed description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="existingCategory">
                            <option value="">None</option>
                            <option value="feature">Feature Request</option>
                            <option value="bug">Bug</option>
                            <option value="improvement">Improvement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vote Count</label>
                        <input type="number" id="existingVotes" value="25">
                    </div>
                </div>
            </div>

            <button onclick="detectSingle()">Detect Duplicates</button>
        </div>

        <div id="cluster-mode" style="display:none;">
            <p style="color:#64748b; margin-bottom:20px;">Cluster mode analyzes multiple posts to find groups of related feedback. This is useful for consolidation and roadmap planning.</p>
            <button class="example-btn" onclick="loadClusterExample()">Load Sample Posts for Clustering</button>
            <div id="cluster-posts" class="post-list" style="margin-top:15px; min-height:200px;">
                <p style="color:#94a3b8; text-align:center; padding:40px;">Click "Load Sample Posts" to see cluster analysis in action</p>
            </div>
            <button onclick="detectClusters()">Analyze Clusters</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let currentMode = 'single';
        let clusterPosts = [];

        const examples = {
            exact: {
                new: {
                    title: 'Add dark mode support',
                    description: 'I would really love to have a dark mode option for the dashboard. My eyes hurt from the bright white background when working at night.',
                    category: 'feature',
                    votes: 10
                },
                existing: {
                    title: 'Dark mode support needed',
                    description: 'Please add dark mode! The white background is too bright when I work late at night and causes eye strain.',
                    category: 'feature',
                    votes: 25
                }
            },
            semantic: {
                new: {
                    title: 'Export to CSV feature',
                    description: 'Need the ability to download all my data in CSV format for analysis in Excel.',
                    category: 'feature',
                    votes: 15
                },
                existing: {
                    title: 'Data export functionality',
                    description: 'Would be great to have a way to export reports to spreadsheet format so I can analyze the data offline.',
                    category: 'feature',
                    votes: 30
                }
            },
            partial: {
                new: {
                    title: 'Slack integration',
                    description: 'Connect with Slack to get notifications about new feedback',
                    category: 'integration',
                    votes: 20
                },
                existing: {
                    title: 'Team notifications',
                    description: 'Send email notifications to our team when new feedback arrives',
                    category: 'feature',
                    votes: 18
                }
            },
            unrelated: {
                new: {
                    title: 'Two-factor authentication',
                    description: 'Add 2FA security for better account protection',
                    category: 'security',
                    votes: 45
                },
                existing: {
                    title: 'Dashboard loading slowly',
                    description: 'The main dashboard takes 30+ seconds to load all widgets',
                    category: 'performance',
                    votes: 12
                }
            }
        };

        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('mode-single').classList.toggle('active', mode === 'single');
            document.getElementById('mode-cluster').classList.toggle('active', mode === 'cluster');
            document.getElementById('single-mode').style.display = mode === 'single' ? 'block' : 'none';
            document.getElementById('cluster-mode').style.display = mode === 'cluster' ? 'block' : 'none';
            document.getElementById('results').innerHTML = '';
        }

        function loadExample(type) {
            const ex = examples[type];
            document.getElementById('newTitle').value = ex.new.title;
            document.getElementById('newDescription').value = ex.new.description;
            document.getElementById('newCategory').value = ex.new.category;
            document.getElementById('newVotes').value = ex.new.votes;

            document.getElementById('existingTitle').value = ex.existing.title;
            document.getElementById('existingDescription').value = ex.existing.description;
            document.getElementById('existingCategory').value = ex.existing.category;
            document.getElementById('existingVotes').value = ex.existing.votes;
        }

        function loadClusterExample() {
            clusterPosts = [
                { id: '1', title: 'Add dark mode', description: 'Dark theme for night work', category: 'feature', voteCount: 45, createdAt: new Date('2024-01-01') },
                { id: '2', title: 'Dark theme support', description: 'Support dark/light mode toggle', category: 'feature', voteCount: 30, createdAt: new Date('2024-01-05') },
                { id: '3', title: 'Night mode needed', description: 'Please add night mode', category: 'feature', voteCount: 20, createdAt: new Date('2024-01-10') },
                { id: '4', title: 'CSV export feature', description: 'Export data to CSV', category: 'feature', voteCount: 25, createdAt: new Date('2024-01-03') },
                { id: '5', title: 'Download reports', description: 'Download reports as spreadsheets', category: 'feature', voteCount: 18, createdAt: new Date('2024-01-07') },
                { id: '6', title: 'Mobile app support', description: 'Need a mobile application', category: 'feature', voteCount: 60, createdAt: new Date('2024-01-02') },
            ];

            let html = '<p style="color:#334155; font-weight:600; margin-bottom:10px;">Sample Posts Loaded:</p>';
            clusterPosts.forEach(post => {
                html += `<div class="post-item"><strong>${post.title}</strong> (${post.voteCount} votes) - ${post.description}</div>`;
            });
            document.getElementById('cluster-posts').innerHTML = html;
        }

        async function detectSingle() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">ü§ñ Analyzing for duplicates...</div>';

            const data = {
                mode: 'single',
                newPost: {
                    id: 'new-' + Date.now(),
                    title: document.getElementById('newTitle').value,
                    description: document.getElementById('newDescription').value,
                    category: document.getElementById('newCategory').value || undefined,
                    voteCount: parseInt(document.getElementById('newVotes').value) || 0,
                    createdAt: new Date()
                },
                existingPosts: [{
                    id: 'existing-1',
                    title: document.getElementById('existingTitle').value,
                    description: document.getElementById('existingDescription').value,
                    category: document.getElementById('existingCategory').value || undefined,
                    voteCount: parseInt(document.getElementById('existingVotes').value) || 0,
                    createdAt: new Date()
                }],
                options: {
                    threshold: 0.65,
                    maxResults: 5,
                    includeRelated: true
                }
            };

            try {
                const response = await fetch('/api/ai/duplicate-detect-v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                displaySingleResults(result);
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function detectClusters() {
            if (clusterPosts.length === 0) {
                alert('Please load sample posts first!');
                return;
            }

            const results = document.getElementById('results');
            results.innerHTML = '<div class="loading">ü§ñ Analyzing clusters... This may take a moment...</div>';

            try {
                const response = await fetch('/api/ai/duplicate-detect-v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'cluster',
                        posts: clusterPosts,
                        options: {
                            minClusterSize: 2,
                            clusterThreshold: 0.60
                        }
                    })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                displayClusterResults(result);
            } catch (error) {
                results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function displaySingleResults(result) {
            const { duplicates, metadata } = result;

            let html = '<div class="results"><h2>Duplicate Analysis Results</h2>';

            if (duplicates.length === 0) {
                html += '<p style="color:#64748b;">No duplicates found. These posts appear to be unique.</p>';
            } else {
                duplicates.forEach(dup => {
                    const analysis = dup.analysis;
                    html += `
                        <div class="duplicate-card ${analysis.duplicateType}">
                            <div class="duplicate-header">
                                <div class="post-title">${dup.post.title}</div>
                                <div>
                                    <span class="similarity-badge">${(analysis.similarityScore * 100).toFixed(1)}% Match</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <span class="merge-badge ${analysis.mergeRecommendation}">${analysis.mergeRecommendation.replace('_', ' ').toUpperCase()}</span>
                                <span style="background:#f3f4f6; padding:4px 10px; border-radius:4px; font-size:12px; color:#374151;">
                                    ${analysis.duplicateType.toUpperCase()} ‚Ä¢ ${(analysis.confidence * 100).toFixed(0)}% confidence
                                </span>
                            </div>
                            <div class="explanation">${analysis.explanation}</div>
                            ${analysis.commonThemes && analysis.commonThemes.length > 0 ? `
                                <div class="themes-diff">
                                    <div class="theme-box">
                                        <div class="theme-title">Common Themes</div>
                                        <ul class="theme-list">
                                            ${analysis.commonThemes.map(t => `<li>${t}</li>`).join('')}
                                        </ul>
                                    </div>
                                    ${analysis.differences && analysis.differences.length > 0 ? `
                                        <div class="theme-box">
                                            <div class="theme-title">Key Differences</div>
                                            <ul class="theme-list">
                                                ${analysis.differences.map(d => `<li>${d}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            ${analysis.mergedTitle ? `
                                <div class="merged-content">
                                    <div class="merged-label">SUGGESTED MERGED TITLE</div>
                                    <div class="merged-text"><strong>${analysis.mergedTitle}</strong></div>
                                    ${analysis.mergedDescription ? `
                                        <div class="merged-label" style="margin-top:10px;">SUGGESTED MERGED DESCRIPTION</div>
                                        <div class="merged-text">${analysis.mergedDescription}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            html += `<p style="color:#94a3b8; font-size:12px; margin-top:20px;">
                Analyzed ${metadata.candidatesAnalyzed} posts ‚Ä¢ Found ${metadata.duplicatesFound} potential duplicates ‚Ä¢ ${new Date(metadata.timestamp).toLocaleString()}
            </p></div>`;

            document.getElementById('results').innerHTML = html;
        }

        function displayClusterResults(result) {
            const { clusters, metadata } = result;

            let html = '<div class="results"><h2>Cluster Analysis Results</h2>';

            if (clusters.length === 0) {
                html += '<p style="color:#64748b;">No clusters found. Posts appear to be unique.</p>';
            } else {
                clusters.forEach((cluster, idx) => {
                    html += `
                        <div class="cluster-card">
                            <div class="cluster-title">Cluster ${idx + 1}: ${cluster.clusterTheme}</div>
                            <div class="cluster-stats">
                                <div>üìä ${cluster.duplicates.length + 1} related posts</div>
                                <div>‚¨ÜÔ∏è ${cluster.totalVotes} total votes</div>
                            </div>
                            <div style="margin-top:15px; padding:15px; background:rgba(255,255,255,0.2); border-radius:6px;">
                                <strong>Recommended Action:</strong> ${cluster.recommendedAction}
                            </div>
                        </div>
                        <div style="margin-bottom:30px;">
                            <div style="background:white; padding:15px; border-radius:6px; margin-bottom:10px; border-left:4px solid #667eea;">
                                <strong>Primary:</strong> ${cluster.primaryPost.title} (${cluster.primaryPost.voteCount} votes)
                            </div>
                            ${cluster.duplicates.map(dup => `
                                <div style="background:#f8fafc; padding:12px; border-radius:6px; margin-bottom:8px; border-left:3px solid #cbd5e1;">
                                    <strong>${dup.post.title}</strong> (${dup.post.voteCount} votes) -
                                    ${(dup.analysis.similarityScore * 100).toFixed(0)}% similar -
                                    <span style="color:#6366f1; font-weight:600;">${dup.analysis.mergeRecommendation}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
            }

            html += `<p style="color:#94a3b8; font-size:12px; margin-top:20px;">
                Analyzed ${metadata.totalPosts} posts ‚Ä¢ Found ${metadata.clustersFound} clusters ‚Ä¢ ${new Date(metadata.timestamp).toLocaleString()}
            </p></div>`;

            document.getElementById('results').innerHTML = html;
        }

        // Load default example
        loadExample('exact');
    </script>
</body>
</html>
