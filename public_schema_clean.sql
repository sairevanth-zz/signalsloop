--
-- PostgreSQL database dump
--


-- Dumped from database version 17.6
-- Dumped by pg_dump version 18.1

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: public; Type: SCHEMA; Schema: -; Owner: -
--



--
-- Name: SCHEMA public; Type: COMMENT; Schema: -; Owner: -
--



--
-- Name: action_priority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.action_priority AS ENUM (
    'urgent',
    'high',
    'medium',
    'low'
);


--
-- Name: action_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.action_status AS ENUM (
    'pending',
    'in_progress',
    'completed',
    'dismissed'
);


--
-- Name: competitive_event_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.competitive_event_type AS ENUM (
    'feature_launch',
    'pricing_change',
    'funding',
    'negative_press',
    'acquisition',
    'layoffs',
    'executive_change',
    'other'
);


--
-- Name: competitor_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.competitor_status AS ENUM (
    'active',
    'monitoring',
    'dismissed'
);


--
-- Name: deal_stage; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.deal_stage AS ENUM (
    'prospecting',
    'qualification',
    'proposal',
    'negotiation',
    'closed'
);


--
-- Name: deal_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.deal_status AS ENUM (
    'won',
    'lost',
    'open'
);


--
-- Name: feature_gap_priority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.feature_gap_priority AS ENUM (
    'critical',
    'high',
    'medium',
    'low'
);


--
-- Name: feature_gap_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.feature_gap_status AS ENUM (
    'identified',
    'planned',
    'building',
    'shipped',
    'dismissed'
);


--
-- Name: feedback_classification; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.feedback_classification AS ENUM (
    'bug',
    'feature_request',
    'praise',
    'complaint',
    'churn_risk',
    'question',
    'other',
    'usability_issue',
    'comparison'
);


--
-- Name: impact_level; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.impact_level AS ENUM (
    'high',
    'medium',
    'low'
);


--
-- Name: integration_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.integration_status AS ENUM (
    'active',
    'paused',
    'error',
    'setup'
);


--
-- Name: jira_connection_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.jira_connection_status AS ENUM (
    'active',
    'expired',
    'disconnected',
    'error'
);


--
-- Name: jira_sync_action; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.jira_sync_action AS ENUM (
    'issue_created',
    'issue_updated',
    'status_synced',
    'webhook_received',
    'token_refreshed',
    'connection_created',
    'connection_disconnected'
);


--
-- Name: jira_webhook_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.jira_webhook_status AS ENUM (
    'active',
    'failed',
    'disabled'
);


--
-- Name: loss_reason_category; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.loss_reason_category AS ENUM (
    'pricing',
    'features',
    'competitor',
    'timing',
    'budget',
    'fit',
    'process',
    'other'
);


--
-- Name: mention_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.mention_type AS ENUM (
    'comparison',
    'switch_to',
    'switch_from',
    'feature_comparison',
    'general'
);


--
-- Name: platform_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.platform_type AS ENUM (
    'reddit',
    'twitter',
    'hackernews',
    'g2',
    'producthunt',
    'appstore',
    'playstore',
    'capterra',
    'trustpilot'
);


--
-- Name: recommendation_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.recommendation_status AS ENUM (
    'pending',
    'accepted',
    'in_progress',
    'completed',
    'dismissed'
);


--
-- Name: recommendation_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.recommendation_type AS ENUM (
    'attack',
    'defend',
    'react',
    'ignore'
);


--
-- Name: slack_alert_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.slack_alert_type AS ENUM (
    'critical_feedback',
    'sentiment_drop',
    'new_theme',
    'competitive_threat',
    'weekly_digest',
    'resolution_update',
    'jira_created',
    'theme_trending'
);


--
-- Name: slack_connection_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.slack_connection_status AS ENUM (
    'active',
    'expired',
    'disconnected'
);


--
-- Name: slack_rule_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.slack_rule_type AS ENUM (
    'critical_feedback',
    'sentiment_drop',
    'new_theme',
    'competitive_threat'
);


--
-- Name: sprint_phase; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.sprint_phase AS ENUM (
    'planning',
    'active',
    'completed',
    'cancelled'
);


--
-- Name: sprint_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.sprint_status AS ENUM (
    'backlog',
    'to_do',
    'in_progress',
    'done'
);


--
-- Name: story_priority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.story_priority AS ENUM (
    'critical',
    'high',
    'medium',
    'low'
);


--
-- Name: account_billing_profiles_set_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.account_billing_profiles_set_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = timezone('utc', now());
  IF TG_OP = 'INSERT' AND NEW.created_at IS NULL THEN
    NEW.created_at = NEW.updated_at;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: analyze_stakeholder_query_performance(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.analyze_stakeholder_query_performance() RETURNS TABLE(table_name text, index_name text, index_size text, table_size text, index_scans bigint)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    schemaname || '.' || tablename AS table_name,
    indexname AS index_name,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,
    pg_size_pretty(pg_relation_size(tablename::regclass)) AS table_size,
    idx_scan AS index_scans
  FROM pg_stat_user_indexes
  WHERE schemaname = 'public'
    AND tablename IN ('posts', 'sentiment_analysis', 'themes', 'stakeholder_queries', 'timeline_events')
  ORDER BY pg_relation_size(indexrelid) DESC;
END;
$$;


--
-- Name: FUNCTION analyze_stakeholder_query_performance(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.analyze_stakeholder_query_performance() IS 'Analyzes index usage and table sizes for stakeholder tables';


--
-- Name: apply_discount_code(character varying, uuid, uuid, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.apply_discount_code(p_code character varying, p_user_id uuid, p_project_id uuid, p_amount numeric) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  validation_result JSON;
  discount_amount DECIMAL(10,2);
  discount_code_id UUID;
BEGIN
  -- Validate the discount code
  SELECT public.validate_discount_code(p_code, p_user_id, p_amount) INTO validation_result;
  
  IF (validation_result->>'valid')::boolean = false THEN
    RETURN validation_result;
  END IF;
  
  -- Extract discount details
  discount_amount := (validation_result->>'discount_amount')::DECIMAL(10,2);
  discount_code_id := (validation_result->>'discount_code_id')::UUID;
  
  -- Record the usage
  INSERT INTO discount_code_usage (
    discount_code_id,
    user_id,
    project_id,
    amount_discounted
  ) VALUES (
    discount_code_id,
    p_user_id,
    p_project_id,
    discount_amount
  );
  
  -- Update usage count
  UPDATE discount_codes 
  SET usage_count = usage_count + 1
  WHERE id = discount_code_id;
  
  RETURN json_build_object(
    'success', true,
    'discount_amount', discount_amount,
    'final_amount', p_amount - discount_amount
  );
END;
$$;


--
-- Name: auto_enqueue_for_triage(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_enqueue_for_triage() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Only enqueue if not already triaged
  IF NEW.category IS NULL OR NEW.priority IS NULL OR NEW.assigned_pm_id IS NULL THEN
    INSERT INTO triage_queue (project_id, post_id, status)
    VALUES (NEW.project_id, NEW.id, 'pending')
    ON CONFLICT (post_id) DO NOTHING;
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: backfill_sentiment_history(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.backfill_sentiment_history(p_project_id uuid, p_days_back integer DEFAULT 90) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_date DATE;
  v_days_processed INTEGER := 0;
BEGIN
  -- Calculate sentiment for each day in the past N days
  FOR v_date IN
    SELECT generate_series(
      CURRENT_DATE - p_days_back,
      CURRENT_DATE,
      '1 day'::interval
    )::DATE
  LOOP
    PERFORM calculate_daily_sentiment(p_project_id, v_date);
    v_days_processed := v_days_processed + 1;
  END LOOP;

  RETURN v_days_processed;
END;
$$;


--
-- Name: FUNCTION backfill_sentiment_history(p_project_id uuid, p_days_back integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.backfill_sentiment_history(p_project_id uuid, p_days_back integer) IS 'Backfills historical sentiment data for past N days';


--
-- Name: calculate_daily_sentiment(uuid, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_daily_sentiment(p_project_id uuid, p_date date DEFAULT CURRENT_DATE) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_avg_sentiment NUMERIC;
  v_total_posts INTEGER;
  v_positive_count INTEGER;
  v_neutral_count INTEGER;
  v_negative_count INTEGER;
BEGIN
  -- Calculate sentiment for the specified date
  SELECT
    AVG(sa.sentiment_score),
    COUNT(*),
    COUNT(*) FILTER (WHERE sa.sentiment_score > 0.3),
    COUNT(*) FILTER (WHERE sa.sentiment_score BETWEEN -0.3 AND 0.3),
    COUNT(*) FILTER (WHERE sa.sentiment_score < -0.3)
  INTO
    v_avg_sentiment,
    v_total_posts,
    v_positive_count,
    v_neutral_count,
    v_negative_count
  FROM posts p
  LEFT JOIN sentiment_analysis sa ON sa.post_id = p.id
  WHERE p.project_id = p_project_id
    AND DATE(p.created_at) = p_date;

  -- Insert or update sentiment history
  INSERT INTO sentiment_history (
    project_id,
    date,
    avg_sentiment,
    total_posts,
    positive_count,
    neutral_count,
    negative_count
  ) VALUES (
    p_project_id,
    p_date,
    v_avg_sentiment,
    v_total_posts,
    v_positive_count,
    v_neutral_count,
    v_negative_count
  )
  ON CONFLICT (project_id, date)
  DO UPDATE SET
    avg_sentiment = EXCLUDED.avg_sentiment,
    total_posts = EXCLUDED.total_posts,
    positive_count = EXCLUDED.positive_count,
    neutral_count = EXCLUDED.neutral_count,
    negative_count = EXCLUDED.negative_count;
END;
$$;


--
-- Name: FUNCTION calculate_daily_sentiment(p_project_id uuid, p_date date); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_daily_sentiment(p_project_id uuid, p_date date) IS 'Calculates and stores daily sentiment snapshot for a project';


--
-- Name: calculate_experiment_significance(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_experiment_significance(p_experiment_id uuid, p_metric_name text) RETURNS TABLE(metric_name text, control_mean numeric, treatment_mean numeric, p_value numeric, is_significant boolean, improvement_percent numeric)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  v_control_mean decimal;
  v_control_std decimal;
  v_control_n integer;
  v_treatment_mean decimal;
  v_treatment_std decimal;
  v_treatment_n integer;
  v_pooled_std_err decimal;
  v_t_statistic decimal;
  v_p_value decimal;
  v_is_significant boolean;
  v_improvement decimal;
BEGIN
  -- Get control stats
  SELECT mean_value, std_dev, sample_size
  INTO v_control_mean, v_control_std, v_control_n
  FROM experiment_results
  WHERE experiment_id = p_experiment_id
    AND metric_name = p_metric_name
    AND variant = 'control'
  LIMIT 1;

  -- Get treatment stats
  SELECT mean_value, std_dev, sample_size
  INTO v_treatment_mean, v_treatment_std, v_treatment_n
  FROM experiment_results
  WHERE experiment_id = p_experiment_id
    AND metric_name = p_metric_name
    AND variant = 'treatment'
  LIMIT 1;

  -- Check if we have data
  IF v_control_mean IS NULL OR v_treatment_mean IS NULL THEN
    RETURN;
  END IF;

  -- Calculate pooled standard error (Welch's t-test)
  v_pooled_std_err := sqrt(
    (power(v_control_std, 2) / v_control_n) +
    (power(v_treatment_std, 2) / v_treatment_n)
  );

  -- Calculate t-statistic
  v_t_statistic := (v_treatment_mean - v_control_mean) / v_pooled_std_err;

  -- Simplified p-value calculation (approximate)
  -- For production, use proper statistical library
  v_p_value := CASE
    WHEN abs(v_t_statistic) > 2.576 THEN 0.01  -- 99% confidence
    WHEN abs(v_t_statistic) > 1.96 THEN 0.05   -- 95% confidence
    WHEN abs(v_t_statistic) > 1.645 THEN 0.10  -- 90% confidence
    ELSE 0.20
  END;

  v_is_significant := v_p_value < 0.05;

  -- Calculate improvement percentage
  v_improvement := CASE
    WHEN v_control_mean = 0 THEN NULL
    ELSE ((v_treatment_mean - v_control_mean) / v_control_mean * 100)
  END;

  -- Return results
  metric_name := p_metric_name;
  control_mean := v_control_mean;
  treatment_mean := v_treatment_mean;
  p_value := v_p_value;
  is_significant := v_is_significant;
  improvement_percent := v_improvement;

  RETURN NEXT;
END;
$$;


--
-- Name: calculate_next_brief_run(character varying, integer, integer, time without time zone, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_next_brief_run(p_frequency character varying, p_day_of_week integer, p_day_of_month integer, p_time_of_day time without time zone, p_timezone character varying) RETURNS timestamp with time zone
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_now TIMESTAMP WITH TIME ZONE;
  v_next TIMESTAMP WITH TIME ZONE;
BEGIN
  v_now := NOW() AT TIME ZONE p_timezone;
  
  CASE p_frequency
    WHEN 'daily' THEN
      -- Next occurrence is today at specified time, or tomorrow if past
      v_next := DATE_TRUNC('day', v_now) + p_time_of_day;
      IF v_next <= v_now THEN
        v_next := v_next + INTERVAL '1 day';
      END IF;
      
    WHEN 'weekly' THEN
      -- Next occurrence is this week's day_of_week, or next week if past
      v_next := DATE_TRUNC('week', v_now) + (p_day_of_week || ' days')::INTERVAL + p_time_of_day;
      IF v_next <= v_now THEN
        v_next := v_next + INTERVAL '1 week';
      END IF;
      
    WHEN 'monthly' THEN
      -- Next occurrence is this month's day, or next month if past
      v_next := DATE_TRUNC('month', v_now) + ((p_day_of_month - 1) || ' days')::INTERVAL + p_time_of_day;
      IF v_next <= v_now THEN
        v_next := v_next + INTERVAL '1 month';
      END IF;
  END CASE;
  
  RETURN v_next AT TIME ZONE p_timezone;
END;
$$;


--
-- Name: calculate_next_run_time(text, time without time zone, integer, integer, text, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_next_run_time(p_frequency text, p_time_of_day time without time zone, p_day_of_week integer, p_day_of_month integer, p_timezone text, p_from_time timestamp with time zone DEFAULT now()) RETURNS timestamp with time zone
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_next_run TIMESTAMPTZ;
  v_current_time TIMESTAMPTZ;
BEGIN
  v_current_time := p_from_time AT TIME ZONE p_timezone;

  CASE p_frequency
    WHEN 'daily' THEN
      -- Next occurrence of time_of_day
      v_next_run := (DATE(v_current_time) + p_time_of_day)::TIMESTAMPTZ AT TIME ZONE p_timezone;
      IF v_next_run <= v_current_time THEN
        v_next_run := v_next_run + INTERVAL '1 day';
      END IF;

    WHEN 'weekly' THEN
      -- Next occurrence of day_of_week at time_of_day
      v_next_run := (DATE(v_current_time) + ((p_day_of_week - EXTRACT(DOW FROM v_current_time)::INTEGER + 7) % 7) * INTERVAL '1 day' + p_time_of_day)::TIMESTAMPTZ AT TIME ZONE p_timezone;
      IF v_next_run <= v_current_time THEN
        v_next_run := v_next_run + INTERVAL '7 days';
      END IF;

    WHEN 'monthly' THEN
      -- Next occurrence of day_of_month at time_of_day
      v_next_run := (DATE_TRUNC('month', v_current_time) + (p_day_of_month - 1) * INTERVAL '1 day' + p_time_of_day)::TIMESTAMPTZ AT TIME ZONE p_timezone;
      IF v_next_run <= v_current_time THEN
        v_next_run := (DATE_TRUNC('month', v_current_time) + INTERVAL '1 month' + (p_day_of_month - 1) * INTERVAL '1 day' + p_time_of_day)::TIMESTAMPTZ AT TIME ZONE p_timezone;
      END IF;

    ELSE
      RAISE EXCEPTION 'Invalid frequency: %', p_frequency;
  END CASE;

  RETURN v_next_run;
END;
$$;


--
-- Name: FUNCTION calculate_next_run_time(p_frequency text, p_time_of_day time without time zone, p_day_of_week integer, p_day_of_month integer, p_timezone text, p_from_time timestamp with time zone); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_next_run_time(p_frequency text, p_time_of_day time without time zone, p_day_of_week integer, p_day_of_month integer, p_timezone text, p_from_time timestamp with time zone) IS 'Calculates the next run time for a scheduled report';


--
-- Name: calculate_pre_ship_metrics(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_pre_ship_metrics(p_project_id uuid, p_theme_name text) RETURNS TABLE(avg_sentiment numeric, theme_volume integer, churn_risk numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    RETURN QUERY
    SELECT
        COALESCE(AVG(sa.sentiment_score), 0)::DECIMAL as avg_sentiment,
        COUNT(*)::INTEGER as theme_volume,
        0.0::DECIMAL as churn_risk -- Placeholder, can be enhanced with actual churn data
    FROM posts p
    LEFT JOIN sentiment_analysis sa ON p.id = sa.post_id
    WHERE p.project_id = p_project_id
      AND p.category ILIKE '%' || p_theme_name || '%'
      AND p.created_at >= NOW() - INTERVAL '30 days';
END;
$$;


--
-- Name: calculate_priority_score(integer, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_priority_score(p_must_have integer, p_important integer, p_nice_to_have integer) RETURNS integer
    LANGUAGE plpgsql IMMUTABLE
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN (p_must_have * 10) + (p_important * 5) + (p_nice_to_have * 2);
END;
$$;


--
-- Name: calculate_team_velocity(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_team_velocity(p_project_id uuid, p_weeks_lookback integer DEFAULT 4) RETURNS TABLE(avg_velocity_points numeric, avg_velocity_features numeric, trend text)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
DECLARE
    v_avg_points DECIMAL;
    v_avg_features DECIMAL;
    v_recent_avg DECIMAL;
    v_older_avg DECIMAL;
    v_trend TEXT;
BEGIN
    -- Calculate average velocity over lookback period
    SELECT
        AVG(completed_story_points),
        AVG(completed_features)
    INTO v_avg_points, v_avg_features
    FROM team_capacity
    WHERE project_id = p_project_id
      AND week_start_date >= CURRENT_DATE - (p_weeks_lookback * 7)
      AND completed_story_points IS NOT NULL;

    -- Calculate trend (compare recent half vs older half)
    SELECT AVG(completed_story_points)
    INTO v_recent_avg
    FROM team_capacity
    WHERE project_id = p_project_id
      AND week_start_date >= CURRENT_DATE - ((p_weeks_lookback / 2) * 7)
      AND completed_story_points IS NOT NULL;

    SELECT AVG(completed_story_points)
    INTO v_older_avg
    FROM team_capacity
    WHERE project_id = p_project_id
      AND week_start_date >= CURRENT_DATE - (p_weeks_lookback * 7)
      AND week_start_date < CURRENT_DATE - ((p_weeks_lookback / 2) * 7)
      AND completed_story_points IS NOT NULL;

    -- Determine trend
    IF v_recent_avg IS NULL OR v_older_avg IS NULL THEN
        v_trend := 'unknown';
    ELSIF v_recent_avg > v_older_avg * 1.1 THEN
        v_trend := 'increasing';
    ELSIF v_recent_avg < v_older_avg * 0.9 THEN
        v_trend := 'decreasing';
    ELSE
        v_trend := 'stable';
    END IF;

    RETURN QUERY
    SELECT v_avg_points, v_avg_features, v_trend;
END;
$$;


--
-- Name: FUNCTION calculate_team_velocity(p_project_id uuid, p_weeks_lookback integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_team_velocity(p_project_id uuid, p_weeks_lookback integer) IS 'Calculate average team velocity and trend over lookback period';


--
-- Name: check_ai_usage_limit(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_ai_usage_limit(p_project_id uuid, p_feature_type text, p_limit integer) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
  current_count INTEGER;
  last_reset TIMESTAMP WITH TIME ZONE;
  should_reset BOOLEAN;
BEGIN
  -- Get current usage
  SELECT 
    usage_count,
    last_reset_at,
    (EXTRACT(EPOCH FROM (NOW() - last_reset_at)) > 2592000) -- 30 days
  INTO current_count, last_reset, should_reset
  FROM ai_usage_tracking
  WHERE project_id = p_project_id AND feature_type = p_feature_type;

  -- If no record or should reset, allow usage
  IF current_count IS NULL OR should_reset THEN
    RETURN jsonb_build_object(
      'allowed', true, 
      'current', COALESCE(current_count, 0),
      'limit', p_limit,
      'remaining', p_limit
    );
  END IF;

  -- Check if under limit
  IF current_count < p_limit THEN
    RETURN jsonb_build_object(
      'allowed', true,
      'current', current_count,
      'limit', p_limit,
      'remaining', p_limit - current_count
    );
  END IF;

  -- Over limit
  RETURN jsonb_build_object(
    'allowed', false,
    'current', current_count,
    'limit', p_limit,
    'remaining', 0
  );
END;
$$;


--
-- Name: check_email_rate_limit(character varying, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_email_rate_limit(p_email character varying, p_max_per_day integer DEFAULT 5) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  current_count INTEGER;
BEGIN
  -- Get today's email count
  SELECT COALESCE(email_count, 0) INTO current_count
  FROM email_batches
  WHERE to_email = p_email
  AND batch_date = CURRENT_DATE;
  
  -- Return true if under limit
  RETURN (current_count < p_max_per_day);
END;
$$;


--
-- Name: check_hunter_scan_complete(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_hunter_scan_complete(p_scan_id uuid) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_pending INT;
  v_failed INT;
  v_total INT;
BEGIN
  SELECT 
    count(*) FILTER (WHERE status IN ('pending', 'processing')),
    count(*) FILTER (WHERE status = 'failed'),
    count(*)
  INTO v_pending, v_failed, v_total
  FROM hunter_jobs
  WHERE scan_id = p_scan_id;
  
  IF v_pending = 0 THEN
    -- All jobs done
    IF v_failed > 0 AND v_failed < v_total THEN
      -- Some failed, some succeeded
      UPDATE hunter_scans SET status = 'partial', completed_at = now() WHERE id = p_scan_id;
    ELSIF v_failed = v_total THEN
      -- All failed
      UPDATE hunter_scans SET status = 'failed', completed_at = now() WHERE id = p_scan_id;
    ELSE
      -- All succeeded
      UPDATE hunter_scans SET status = 'complete', completed_at = now() WHERE id = p_scan_id;
    END IF;
    RETURN true;
  END IF;
  
  RETURN false;
END;
$$;


--
-- Name: check_theme_detection_trigger(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_theme_detection_trigger() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_threshold INTEGER;
  v_pending_count INTEGER;
BEGIN
  -- Get theme detection threshold
  SELECT theme_detection_threshold INTO v_threshold
  FROM hunter_configs
  WHERE project_id = NEW.project_id AND is_active = true;

  IF v_threshold IS NULL THEN
    RETURN NEW;
  END IF;

  -- Count pending items
  v_pending_count := get_pending_theme_detection_count(NEW.project_id);

  -- If threshold met, you would trigger theme detection here
  -- This is a placeholder - actual trigger would call your theme detection API
  IF v_pending_count >= v_threshold THEN
    -- Log that threshold was met
    RAISE NOTICE 'Theme detection threshold met for project %: % items pending', NEW.project_id, v_pending_count;
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: claim_gift_subscription(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.claim_gift_subscription(gift_id uuid) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  gift_record gift_subscriptions%ROWTYPE;
  project_record projects%ROWTYPE;
  new_expiry_date TIMESTAMP WITH TIME ZONE;
BEGIN
  -- Get the gift record
  SELECT * INTO gift_record FROM gift_subscriptions WHERE id = gift_id;
  
  IF NOT FOUND THEN
    RETURN json_build_object('success', false, 'error', 'Gift not found');
  END IF;
  
  -- Check if gift is still valid
  IF gift_record.status != 'pending' THEN
    RETURN json_build_object('success', false, 'error', 'Gift already claimed or expired');
  END IF;
  
  IF gift_record.expires_at < NOW() THEN
    UPDATE gift_subscriptions SET status = 'expired' WHERE id = gift_id;
    RETURN json_build_object('success', false, 'error', 'Gift has expired');
  END IF;
  
  -- Get the project
  SELECT * INTO project_record FROM projects WHERE id = gift_record.project_id;
  
  IF NOT FOUND THEN
    RETURN json_build_object('success', false, 'error', 'Project not found');
  END IF;
  
  -- Calculate new expiry date
  new_expiry_date := COALESCE(project_record.current_period_end, NOW()) + (gift_record.duration_months || ' months')::INTERVAL;
  
  -- Update the project to Pro plan
  UPDATE projects 
  SET 
    plan = 'pro',
    current_period_end = new_expiry_date,
    subscription_status = 'active',
    updated_at = NOW()
  WHERE id = gift_record.project_id;
  
  -- Update the gift status
  UPDATE gift_subscriptions 
  SET 
    status = 'claimed',
    claimed_at = NOW(),
    recipient_id = auth.uid(),
    updated_at = NOW()
  WHERE id = gift_id;
  
  RETURN json_build_object(
    'success', true, 
    'message', 'Gift claimed successfully',
    'expires_at', new_expiry_date
  );
END;
$$;


SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: hunter_jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.hunter_jobs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    scan_id uuid NOT NULL,
    project_id uuid NOT NULL,
    job_type text NOT NULL,
    platform text NOT NULL,
    status text DEFAULT 'pending'::text,
    locked_by text,
    locked_at timestamp with time zone,
    attempts integer DEFAULT 0,
    max_attempts integer DEFAULT 3,
    error text,
    next_retry_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    priority integer DEFAULT 0,
    CONSTRAINT hunter_jobs_job_type_check CHECK ((job_type = ANY (ARRAY['discovery'::text, 'relevance'::text, 'classify'::text]))),
    CONSTRAINT hunter_jobs_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'processing'::text, 'complete'::text, 'failed'::text])))
);


--
-- Name: COLUMN hunter_jobs.priority; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.hunter_jobs.priority IS 'Job priority: 0=free, 10=pro, 20=premium, 30=enterprise. Higher values processed first.';


--
-- Name: claim_hunter_job(text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.claim_hunter_job(p_job_type text, p_worker_id text) RETURNS SETOF public.hunter_jobs
    LANGUAGE plpgsql
    AS $$
DECLARE
    claimed_job hunter_jobs;
BEGIN
    -- Atomically claim the highest priority pending job
    -- Order by: priority DESC (high priority first), created_at ASC (oldest first within same priority)
    UPDATE hunter_jobs
    SET 
        status = 'processing',
        locked_by = p_worker_id,
        locked_at = NOW(),
        started_at = COALESCE(started_at, NOW())
    WHERE id = (
        SELECT id 
        FROM hunter_jobs 
        WHERE job_type = p_job_type 
          AND status = 'pending'
          AND (next_retry_at IS NULL OR next_retry_at <= NOW())
        ORDER BY priority DESC, created_at ASC
        LIMIT 1
        FOR UPDATE SKIP LOCKED
    )
    RETURNING * INTO claimed_job;
    
    IF claimed_job.id IS NOT NULL THEN
        RETURN NEXT claimed_job;
    END IF;
    
    RETURN;
END;
$$;


--
-- Name: cleanup_expired_audio_briefings(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_expired_audio_briefings() RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM audio_briefings WHERE expires_at < NOW();
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$;


--
-- Name: cleanup_expired_oauth_states(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_expired_oauth_states() RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  DELETE FROM jira_oauth_states
  WHERE expires_at < NOW();
END;
$$;


--
-- Name: cleanup_old_audit_logs(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_audit_logs(p_retention_days integer DEFAULT 730) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_deleted INT;
BEGIN
  WITH deleted AS (
    DELETE FROM audit_logs
    WHERE created_at < NOW() - (p_retention_days || ' days')::INTERVAL
    RETURNING id
  )
  SELECT COUNT(*) INTO v_deleted FROM deleted;
  
  RETURN v_deleted;
END;
$$;


--
-- Name: cleanup_old_notification_logs(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_notification_logs() RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM notification_logs WHERE created_at < NOW() - INTERVAL '30 days';
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$;


--
-- Name: cleanup_old_reasoning_traces(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_reasoning_traces() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM reasoning_traces
  WHERE created_at < NOW() - INTERVAL '90 days';
  
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$;


--
-- Name: complete_hunter_job(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.complete_hunter_job(p_job_id uuid) RETURNS void
    LANGUAGE sql
    AS $$
  UPDATE hunter_jobs 
  SET status = 'complete',
      completed_at = now(),
      locked_by = NULL,
      locked_at = NULL
  WHERE id = p_job_id
$$;


--
-- Name: create_default_slack_alert_rules(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_default_slack_alert_rules() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- Critical feedback rule
  INSERT INTO slack_alert_rules (project_id, rule_type, enabled, config)
  VALUES (
    NEW.id,
    'critical_feedback',
    true,
    '{
      "sentiment_threshold": -0.7,
      "keywords": ["churn", "cancel", "refund", "frustrated", "switching"],
      "urgency_min": 4,
      "revenue_risk_min": 1000
    }'::jsonb
  );

  -- Sentiment drop rule
  INSERT INTO slack_alert_rules (project_id, rule_type, enabled, config)
  VALUES (
    NEW.id,
    'sentiment_drop',
    true,
    '{
      "drop_percentage": 20,
      "time_period_days": 7,
      "min_sample_size": 50
    }'::jsonb
  );

  -- New theme rule
  INSERT INTO slack_alert_rules (project_id, rule_type, enabled, config)
  VALUES (
    NEW.id,
    'new_theme',
    true,
    '{
      "min_mentions": 10,
      "time_window_hours": 24,
      "sentiment_filter": "negative",
      "min_urgency": 3
    }'::jsonb
  );

  -- Competitive threat rule
  INSERT INTO slack_alert_rules (project_id, rule_type, enabled, config)
  VALUES (
    NEW.id,
    'competitive_threat',
    true,
    '{
      "min_mentions": 20,
      "time_window_hours": 48,
      "sentiment_spike": 0.3,
      "competitor_comparison": true
    }'::jsonb
  );

  RETURN NEW;
END;
$$;


--
-- Name: create_gift_subscription(uuid, character varying, integer, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_gift_subscription(p_project_id uuid, p_recipient_email character varying, p_duration_months integer DEFAULT 1, p_gift_message text DEFAULT NULL::text) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  gift_id UUID;
  expires_at TIMESTAMP WITH TIME ZONE;
BEGIN
  -- Check if user has permission to gift for this project
  IF NOT EXISTS (
    SELECT 1 FROM projects 
    WHERE id = p_project_id 
    AND owner_id = auth.uid()
  ) THEN
    RETURN json_build_object('success', false, 'error', 'Unauthorized to gift for this project');
  END IF;
  
  -- Set expiry date (gifts expire after 30 days if not claimed)
  expires_at := NOW() + INTERVAL '30 days';
  
  -- Create the gift
  INSERT INTO gift_subscriptions (
    project_id,
    gifter_id,
    gifter_email,
    recipient_email,
    gift_type,
    duration_months,
    expires_at,
    gift_message
  ) VALUES (
    p_project_id,
    auth.uid(),
    auth.email(),
    p_recipient_email,
    'pro',
    p_duration_months,
    expires_at,
    p_gift_message
  ) RETURNING id INTO gift_id;
  
  RETURN json_build_object(
    'success', true, 
    'gift_id', gift_id,
    'expires_at', expires_at
  );
END;
$$;


--
-- Name: create_user_story_from_theme(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_user_story_from_theme(p_theme_id uuid, p_project_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_story_id UUID;
BEGIN
  -- This is a placeholder - actual AI generation happens via API
  -- This function just creates a basic story structure
  INSERT INTO user_stories (
    project_id,
    theme_id,
    title,
    user_type,
    user_goal,
    user_benefit,
    full_story,
    generated_by_ai,
    generation_timestamp
  )
  SELECT
    p_project_id,
    p_theme_id,
    'User Story: ' || t.theme_name,
    'user',
    'implement ' || t.theme_name,
    'improve the product',
    'As a user, I want to implement ' || t.theme_name || ' so that I can improve the product.',
    true,
    NOW()
  FROM themes t
  WHERE t.id = p_theme_id
  RETURNING id INTO v_story_id;

  RETURN v_story_id;
END;
$$;


--
-- Name: decrement_vote_count(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.decrement_vote_count(post_id_param uuid) RETURNS integer
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  new_count INTEGER;
BEGIN
  UPDATE posts 
  SET vote_count = GREATEST(vote_count - 1, 0) 
  WHERE id = post_id_param
  RETURNING vote_count INTO new_count;
  
  RETURN COALESCE(new_count, 0);
END;
$$;


--
-- Name: detect_competitive_event_spike(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.detect_competitive_event_spike(p_competitor_id uuid, p_days_back integer DEFAULT 1) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

DECLARE

  v_recent_count INTEGER;

  v_avg_daily_count DECIMAL;

  v_threshold DECIMAL;

BEGIN

  -- Count mentions in last N days

  SELECT COUNT(*) INTO v_recent_count

  FROM competitive_mentions

  WHERE competitor_id = p_competitor_id

    AND created_at >= NOW() - (p_days_back || ' days')::INTERVAL;

 

  -- Get average daily count over previous 30 days

  SELECT COALESCE(AVG(daily_count), 0) INTO v_avg_daily_count

  FROM (

    SELECT DATE(created_at), COUNT(*) as daily_count

    FROM competitive_mentions

    WHERE competitor_id = p_competitor_id

      AND created_at >= NOW() - INTERVAL '30 days'

      AND created_at < NOW() - (p_days_back || ' days')::INTERVAL

    GROUP BY DATE(created_at)

  ) daily_counts;

 

  -- Spike if recent count is 3x average

  v_threshold := v_avg_daily_count * 3 * p_days_back;

 

  RETURN v_recent_count > v_threshold AND v_recent_count > 5;

END;

$$;


--
-- Name: detect_feedback_spike(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.detect_feedback_spike(p_project_id uuid, p_theme text DEFAULT NULL::text, p_hours integer DEFAULT 24) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  current_count INTEGER;
  baseline_count NUMERIC;
  spike_detected BOOLEAN;
  result JSON;
BEGIN
  -- Count feedback in last p_hours
  IF p_theme IS NOT NULL THEN
    SELECT COUNT(*) INTO current_count
    FROM posts
    WHERE project_id = p_project_id
      AND created_at > NOW() - (p_hours || ' hours')::INTERVAL
      AND category = p_theme;

    -- Baseline: average per day over last 30 days
    SELECT COUNT(*)::NUMERIC / 30 INTO baseline_count
    FROM posts
    WHERE project_id = p_project_id
      AND created_at > NOW() - INTERVAL '30 days'
      AND created_at < NOW() - (p_hours || ' hours')::INTERVAL
      AND category = p_theme;
  ELSE
    SELECT COUNT(*) INTO current_count
    FROM posts
    WHERE project_id = p_project_id
      AND created_at > NOW() - (p_hours || ' hours')::INTERVAL;

    SELECT COUNT(*)::NUMERIC / 30 INTO baseline_count
    FROM posts
    WHERE project_id = p_project_id
      AND created_at > NOW() - INTERVAL '30 days'
      AND created_at < NOW() - (p_hours || ' hours')::INTERVAL;
  END IF;

  -- Detect spike if current > 2x baseline
  spike_detected := current_count > (baseline_count * 2);

  SELECT json_build_object(
    'spike_detected', spike_detected,
    'current_count', current_count,
    'baseline_count', COALESCE(baseline_count, 0),
    'deviation_percentage',
      CASE
        WHEN baseline_count > 0 THEN ((current_count - baseline_count) / baseline_count * 100)::INTEGER
        ELSE 0
      END,
    'theme', p_theme,
    'period_hours', p_hours
  ) INTO result;

  RETURN result;
END;
$$;


--
-- Name: detect_feedback_spikes(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.detect_feedback_spikes(p_project_id uuid, lookback_days integer DEFAULT 7) RETURNS TABLE(event_type text, title text, description text, event_date timestamp with time zone, severity text, metadata jsonb)
    LANGUAGE plpgsql
    AS $$
DECLARE
  baseline_count INTEGER;
  recent_count INTEGER;
  spike_threshold NUMERIC := 2.0; -- 2x baseline
BEGIN
  -- Calculate baseline (average daily feedback over lookback period)
  SELECT COUNT(*) / lookback_days INTO baseline_count
  FROM posts
  WHERE project_id = p_project_id
    AND created_at >= NOW() - (lookback_days || ' days')::INTERVAL
    AND created_at < NOW() - INTERVAL '1 day';

  -- Calculate recent count (last 24 hours)
  SELECT COUNT(*) INTO recent_count
  FROM posts
  WHERE project_id = p_project_id
    AND created_at >= NOW() - INTERVAL '1 day';

  -- Check for spike
  IF recent_count > baseline_count * spike_threshold AND baseline_count > 0 THEN
    RETURN QUERY
    SELECT
      'feedback_spike'::TEXT,
      'Feedback Volume Spike Detected'::TEXT,
      format('Received %s feedback items in the last 24 hours (%.1fx normal volume)',
        recent_count,
        recent_count::NUMERIC / NULLIF(baseline_count, 0)
      )::TEXT,
      NOW(),
      CASE
        WHEN recent_count > baseline_count * 3 THEN 'critical'
        WHEN recent_count > baseline_count * 2 THEN 'high'
        ELSE 'medium'
      END::TEXT,
      jsonb_build_object(
        'recent_count', recent_count,
        'baseline_count', baseline_count,
        'spike_ratio', recent_count::NUMERIC / NULLIF(baseline_count, 0)
      );
  END IF;
END;
$$;


--
-- Name: FUNCTION detect_feedback_spikes(p_project_id uuid, lookback_days integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.detect_feedback_spikes(p_project_id uuid, lookback_days integer) IS 'Detects unusual spikes in feedback volume';


--
-- Name: enrich_feedback_with_customer_data(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.enrich_feedback_with_customer_data(p_project_id uuid, p_email text) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_updated_count INTEGER;
BEGIN
  -- Update discovered_feedback with customer data
  UPDATE discovered_feedback df
  SET
    customer_profile_id = cp.id,
    customer_email = cp.email,
    customer_company = cp.company_name,
    customer_segment = cp.segment,
    customer_mrr = cp.mrr,
    customer_plan_tier = cp.plan_tier
  FROM customer_profiles cp
  WHERE df.project_id = p_project_id
    AND cp.project_id = p_project_id
    AND cp.email = p_email
    AND (
      -- Match by email in author_username or author_metadata
      LOWER(df.author_username) = LOWER(p_email)
      OR LOWER(df.author_metadata->>'email') = LOWER(p_email)
    );

  GET DIAGNOSTICS v_updated_count = ROW_COUNT;
  RETURN v_updated_count;
END;
$$;


--
-- Name: expire_old_invitations(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.expire_old_invitations() RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  UPDATE team_invitations
  SET status = 'expired', updated_at = NOW()
  WHERE status = 'pending'
  AND expires_at < NOW();
END;
$$;


--
-- Name: expire_old_proposals(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.expire_old_proposals() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
DECLARE
  expired_count INTEGER;
BEGIN
  UPDATE roadmap_adjustment_proposals
  SET 
    status = 'expired',
    updated_at = NOW()
  WHERE status = 'pending'
    AND expires_at < NOW();
    
  GET DIAGNOSTICS expired_count = ROW_COUNT;
  RETURN expired_count;
END;
$$;


--
-- Name: extract_mentions_from_text(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.extract_mentions_from_text(comment_text text) RETURNS text[]
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
  DECLARE
    mentions TEXT[];
  BEGIN
    -- Extract all @mentions using regex
    -- Matches @name (letters, numbers, dots, hyphens but NO SPACES) or @email @domain 
    SELECT ARRAY_AGG(DISTINCT TRIM(mention))
    INTO mentions
    FROM (
      SELECT regexp_matches(comment_text,
  '@([a-zA-Z0-9._+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}|[a-zA-Z0-9._\-]+)', 'g') as
  m
    ) matches
    CROSS JOIN LATERAL (SELECT m[1] as mention) extracted;

    RETURN COALESCE(mentions, ARRAY[]::TEXT[]);
  END;
  $$;


--
-- Name: fail_hunter_job(uuid, text, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.fail_hunter_job(p_job_id uuid, p_error text, p_should_retry boolean DEFAULT true) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_attempts INT;
  v_max_attempts INT;
  v_backoff_ms INT[];
BEGIN
  -- Get current attempt count
  SELECT attempts, max_attempts INTO v_attempts, v_max_attempts
  FROM hunter_jobs WHERE id = p_job_id;
  
  v_backoff_ms := ARRAY[0, 30000, 60000]; -- 0s, 30s, 60s
  
  IF p_should_retry AND v_attempts < v_max_attempts THEN
    -- Schedule retry with backoff
    UPDATE hunter_jobs 
    SET status = 'pending',
        error = p_error,
        locked_by = NULL,
        locked_at = NULL,
        next_retry_at = now() + (v_backoff_ms[LEAST(v_attempts, 3)] || ' milliseconds')::interval
    WHERE id = p_job_id;
  ELSE
    -- Mark as permanently failed
    UPDATE hunter_jobs 
    SET status = 'failed',
        error = p_error,
        completed_at = now(),
        locked_by = NULL,
        locked_at = NULL
    WHERE id = p_job_id;
  END IF;
END;
$$;


--
-- Name: find_similar_deals(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.find_similar_deals(p_deal_id uuid, p_limit integer DEFAULT 5) RETURNS TABLE(similar_deal_id uuid, similarity_score numeric, deal_name text, deal_amount numeric, deal_status public.deal_status, competitor text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_deal RECORD;
BEGIN
  -- Get the reference deal
  SELECT * INTO v_deal
  FROM deals
  WHERE id = p_deal_id;

  -- Find similar deals based on:
  -- 1. Same competitor
  -- 2. Similar amount (+/- 50%)
  -- 3. Similar stage
  RETURN QUERY
  SELECT
    d.id as similar_deal_id,
    (
      -- Competitor match: 40 points
      CASE WHEN d.competitor = v_deal.competitor THEN 40 ELSE 0 END +
      -- Amount similarity: 30 points max
      CASE
        WHEN d.amount BETWEEN v_deal.amount * 0.5 AND v_deal.amount * 1.5
        THEN 30 - (ABS(d.amount - v_deal.amount) / v_deal.amount * 10)
        ELSE 0
      END +
      -- Stage similarity: 20 points
      CASE WHEN d.stage = v_deal.stage THEN 20 ELSE 0 END +
      -- Notes similarity (basic text matching): 10 points
      CASE
        WHEN v_deal.notes IS NOT NULL AND d.notes IS NOT NULL
        THEN 10 * (
          SELECT COUNT(*)::NUMERIC / GREATEST(
            array_length(string_to_array(lower(v_deal.notes), ' '), 1),
            array_length(string_to_array(lower(d.notes), ' '), 1)
          )
          FROM unnest(string_to_array(lower(v_deal.notes), ' ')) AS word
          WHERE word = ANY(string_to_array(lower(d.notes), ' '))
        )
        ELSE 0
      END
    )::NUMERIC as similarity_score,
    d.name as deal_name,
    d.amount as deal_amount,
    d.status as deal_status,
    d.competitor
  FROM deals d
  WHERE d.id != p_deal_id
    AND d.project_id = v_deal.project_id
  ORDER BY similarity_score DESC
  LIMIT p_limit;
END;
$$;


--
-- Name: find_temporal_correlations(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.find_temporal_correlations(p_project_id uuid, p_time_window_hours integer DEFAULT 48) RETURNS TABLE(event1_type text, event1_id uuid, event1_time timestamp with time zone, event2_type text, event2_id uuid, event2_time timestamp with time zone, time_diff_hours integer, correlation_score numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- Find pairs of events that occurred within time window
  RETURN QUERY
  SELECT
    e1.event_type as event1_type,
    e1.entity_id as event1_id,
    e1.detected_at as event1_time,
    e2.event_type as event2_type,
    e2.entity_id as event2_id,
    e2.detected_at as event2_time,
    EXTRACT(EPOCH FROM (e2.detected_at - e1.detected_at))::INTEGER / 3600 as time_diff_hours,
    -- Simple correlation score based on temporal proximity
    1.0 - (EXTRACT(EPOCH FROM (e2.detected_at - e1.detected_at)) / (p_time_window_hours * 3600)) as correlation_score
  FROM signal_events e1
  JOIN signal_events e2 ON e1.project_id = e2.project_id
  WHERE e1.project_id = p_project_id
    AND e1.id != e2.id
    AND e2.detected_at > e1.detected_at
    AND e2.detected_at <= e1.detected_at + (p_time_window_hours || ' hours')::INTERVAL
    AND e1.detected_at > NOW() - INTERVAL '30 days'
  ORDER BY correlation_score DESC, e1.detected_at DESC
  LIMIT 50;
END;
$$;


--
-- Name: generate_smart_replies(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_smart_replies(post_id uuid) RETURNS TABLE(reply_text text, reply_type character varying)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  post_data RECORD;
BEGIN
  -- Get post details
  SELECT title, description, category, author_name, author_email
  INTO post_data
  FROM posts
  WHERE id = post_id;
  
  -- This function will be called by the API to generate replies
  -- The actual AI logic will be in the API endpoint
  RETURN;
END;
$$;


--
-- Name: generate_stakeholder_access_token(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_stakeholder_access_token() RETURNS text
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN encode(gen_random_bytes(32), 'base64');
END;
$$;


--
-- Name: generate_timeline_events(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_timeline_events(p_project_id uuid) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  events_created INTEGER := 0;
  event_record RECORD;
BEGIN
  -- Detect feedback spikes
  FOR event_record IN
    SELECT * FROM detect_feedback_spikes(p_project_id, 7)
  LOOP
    -- Only create if doesn't exist in last 24 hours
    IF NOT EXISTS (
      SELECT 1 FROM timeline_events
      WHERE project_id = p_project_id
        AND event_type = 'feedback_spike'
        AND event_date >= NOW() - INTERVAL '24 hours'
    ) THEN
      INSERT INTO timeline_events (
        project_id, event_type, title, description, event_date, severity, metadata
      ) VALUES (
        p_project_id,
        event_record.event_type,
        event_record.title,
        event_record.description,
        event_record.event_date,
        event_record.severity,
        event_record.metadata
      );
      events_created := events_created + 1;
    END IF;
  END LOOP;

  -- Detect critical issues (high volume of negative feedback)
  FOR event_record IN
    SELECT
      'issue'::TEXT as event_type,
      format('Critical Issue: %s', category) as title,
      format('%s negative feedback items about %s', COUNT(*), category) as description,
      MAX(created_at) as event_date,
      'high'::TEXT as severity,
      jsonb_build_object('category', category, 'count', COUNT(*)) as metadata
    FROM posts p
    LEFT JOIN sentiment_analysis sa ON sa.post_id = p.id
    WHERE p.project_id = p_project_id
      AND p.created_at >= NOW() - INTERVAL '7 days'
      AND sa.sentiment_score < -0.5
      AND p.category IS NOT NULL
    GROUP BY category
    HAVING COUNT(*) >= 5
  LOOP
    -- Only create if doesn't exist for this category in last 7 days
    IF NOT EXISTS (
      SELECT 1 FROM timeline_events
      WHERE project_id = p_project_id
        AND event_type = 'issue'
        AND metadata->>'category' = event_record.metadata->>'category'
        AND event_date >= NOW() - INTERVAL '7 days'
    ) THEN
      INSERT INTO timeline_events (
        project_id, event_type, title, description, event_date, severity, metadata
      ) VALUES (
        p_project_id,
        event_record.event_type,
        event_record.title,
        event_record.description,
        event_record.event_date,
        event_record.severity,
        event_record.metadata
      );
      events_created := events_created + 1;
    END IF;
  END LOOP;

  RETURN events_created;
END;
$$;


--
-- Name: FUNCTION generate_timeline_events(p_project_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.generate_timeline_events(p_project_id uuid) IS 'Auto-generates timeline events from project activity (feedback spikes, critical issues, etc.)';


--
-- Name: generate_unsubscribe_token(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_unsubscribe_token() RETURNS character varying
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN encode(gen_random_bytes(32), 'hex');
END;
$$;


--
-- Name: generate_verification_token(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_verification_token() RETURNS character varying
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN encode(gen_random_bytes(32), 'hex');
END;
$$;


--
-- Name: get_action_queue_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_action_queue_stats(p_project_id uuid) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'pending', COUNT(*) FILTER (WHERE executed = false AND dismissed = false),
    'executed', COUNT(*) FILTER (WHERE executed = true),
    'dismissed', COUNT(*) FILTER (WHERE dismissed = true),
    'critical', COUNT(*) FILTER (WHERE severity = 'critical' AND executed = false AND dismissed = false),
    'high_priority', COUNT(*) FILTER (WHERE priority = 1 AND executed = false AND dismissed = false),
    'by_type', json_object_agg(
      action_type,
      type_count
    )
  ) INTO result
  FROM (
    SELECT
      action_type,
      COUNT(*) as type_count
    FROM unified_action_queue
    WHERE project_id = p_project_id
      AND created_at > NOW() - INTERVAL '30 days'
    GROUP BY action_type
  ) type_stats;

  RETURN result;
END;
$$;


--
-- Name: get_active_anomalies(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_active_anomalies(p_project_id uuid) RETURNS TABLE(id uuid, anomaly_type character varying, severity character varying, detected_at timestamp with time zone, ai_summary text, recommended_actions jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    ad.id,
    ad.anomaly_type,
    ad.severity,
    ad.detected_at,
    ad.ai_summary,
    ad.recommended_actions
  FROM anomaly_detections ad
  WHERE ad.project_id = p_project_id
    AND ad.status = 'active'
  ORDER BY ad.severity DESC, ad.detected_at DESC;
END;
$$;


--
-- Name: get_active_jira_connection(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_active_jira_connection(p_project_id uuid) RETURNS TABLE(id uuid, cloud_id text, site_url text, default_project_key text, default_issue_type text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    jc.id,
    jc.cloud_id,
    jc.site_url,
    jc.default_project_key,
    jc.default_issue_type
  FROM jira_connections jc
  WHERE jc.project_id = p_project_id
    AND jc.user_id = auth.uid()
    AND jc.status = 'active'
  LIMIT 1;
END;
$$;


--
-- Name: get_active_slack_connection(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_active_slack_connection(p_project_id uuid) RETURNS TABLE(id uuid, team_id text, team_name text, bot_token_encrypted text, bot_user_id text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    sc.id,
    sc.team_id,
    sc.team_name,
    sc.bot_token_encrypted,
    sc.bot_user_id
  FROM slack_connections sc
  WHERE sc.project_id = p_project_id
    AND sc.status = 'active'
  LIMIT 1;
END;
$$;


--
-- Name: get_adjustment_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_adjustment_stats(p_project_id uuid) RETURNS TABLE(total_proposals bigint, pending_proposals bigint, approved_proposals bigint, rejected_proposals bigint, approval_rate numeric, avg_confidence numeric, last_proposal_at timestamp with time zone)
    LANGUAGE sql STABLE SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
  SELECT 
    COUNT(*) as total_proposals,
    COUNT(*) FILTER (WHERE status = 'pending') as pending_proposals,
    COUNT(*) FILTER (WHERE status = 'approved') as approved_proposals,
    COUNT(*) FILTER (WHERE status = 'rejected') as rejected_proposals,
    CASE 
      WHEN COUNT(*) FILTER (WHERE status IN ('approved', 'rejected')) > 0 
      THEN ROUND(
        COUNT(*) FILTER (WHERE status = 'approved')::DECIMAL / 
        COUNT(*) FILTER (WHERE status IN ('approved', 'rejected')) * 100, 
        1
      )
      ELSE 0 
    END as approval_rate,
    ROUND(AVG(confidence_score), 2) as avg_confidence,
    MAX(created_at) as last_proposal_at
  FROM roadmap_adjustment_proposals
  WHERE project_id = p_project_id;
$$;


--
-- Name: get_audit_summary(timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_audit_summary(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) RETURNS TABLE(event_category character varying, event_type character varying, total_count bigint, success_count bigint, failure_count bigint, unique_actors bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    al.event_category,
    al.event_type,
    COUNT(*) as total_count,
    COUNT(*) FILTER (WHERE al.action_status = 'success') as success_count,
    COUNT(*) FILTER (WHERE al.action_status = 'failure') as failure_count,
    COUNT(DISTINCT al.actor_id) as unique_actors
  FROM audit_logs al
  WHERE al.created_at BETWEEN p_start_date AND p_end_date
  GROUP BY al.event_category, al.event_type
  ORDER BY al.event_category, total_count DESC;
END;
$$;


--
-- Name: get_churn_radar_summary(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_churn_radar_summary(p_project_id uuid) RETURNS TABLE(total_customers bigint, healthy_customers bigint, at_risk_customers bigint, critical_customers bigint, avg_health_score integer, total_revenue_at_risk numeric, open_alerts bigint, critical_alerts bigint)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::BIGINT as total_customers,
    COUNT(*) FILTER (WHERE churn_risk = 'low')::BIGINT as healthy_customers,
    COUNT(*) FILTER (WHERE churn_risk IN ('medium', 'high'))::BIGINT as at_risk_customers,
    COUNT(*) FILTER (WHERE churn_risk = 'critical')::BIGINT as critical_customers,
    AVG(health_score)::INTEGER as avg_health_score,
    SUM(CASE WHEN churn_risk IN ('high', 'critical') THEN mrr ELSE 0 END)::DECIMAL(12,2) as total_revenue_at_risk,
    (SELECT COUNT(*) FROM churn_alerts WHERE project_id = p_project_id AND status NOT IN ('resolved', 'dismissed'))::BIGINT as open_alerts,
    (SELECT COUNT(*) FROM churn_alerts WHERE project_id = p_project_id AND severity = 'critical' AND status NOT IN ('resolved', 'dismissed'))::BIGINT as critical_alerts
  FROM customer_health
  WHERE project_id = p_project_id;
END;
$$;


--
-- Name: get_company_feedback_insights(character varying, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_company_feedback_insights(p_customer_company character varying, p_project_id uuid) RETURNS TABLE(total_feedback integer, must_have_count integer, important_count integer, nice_to_have_count integer, unique_features integer, top_priority_feature character varying)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER AS total_feedback,
    COUNT(*) FILTER (WHERE fm.priority = 'must_have')::INTEGER AS must_have_count,
    COUNT(*) FILTER (WHERE fm.priority = 'important')::INTEGER AS important_count,
    COUNT(*) FILTER (WHERE fm.priority = 'nice_to_have')::INTEGER AS nice_to_have_count,
    COUNT(DISTINCT fm.post_id)::INTEGER AS unique_features,
    (
      SELECT p.title
      FROM feedback_metadata fm2
      JOIN posts p ON fm2.post_id = p.id
      WHERE fm2.customer_company = p_customer_company
      AND p.project_id = p_project_id
      AND fm2.priority = 'must_have'
      ORDER BY fm2.created_at DESC
      LIMIT 1
    ) AS top_priority_feature
  FROM feedback_metadata fm
  JOIN posts p ON fm.post_id = p.id
  WHERE fm.customer_company = p_customer_company
  AND p.project_id = p_project_id;
END;
$$;


--
-- Name: get_company_vote_insights(character varying, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_company_vote_insights(p_customer_company character varying, p_project_id uuid) RETURNS TABLE(total_votes integer, must_have_count integer, important_count integer, nice_to_have_count integer, unique_features integer, top_priority_feature character varying)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*)::INTEGER AS total_votes,
    COUNT(*) FILTER (WHERE vm.priority = 'must_have')::INTEGER AS must_have_count,
    COUNT(*) FILTER (WHERE vm.priority = 'important')::INTEGER AS important_count,
    COUNT(*) FILTER (WHERE vm.priority = 'nice_to_have')::INTEGER AS nice_to_have_count,
    COUNT(DISTINCT v.post_id)::INTEGER AS unique_features,
    (
      SELECT p.title 
      FROM vote_metadata vm2
      JOIN votes v2 ON vm2.vote_id = v2.id
      JOIN posts p ON v2.post_id = p.id
      WHERE vm2.customer_company = p_customer_company
      AND p.project_id = p_project_id
      AND vm2.priority = 'must_have'
      ORDER BY vm2.created_at DESC
      LIMIT 1
    ) AS top_priority_feature
  FROM vote_metadata vm
  JOIN votes v ON vm.vote_id = v.id
  JOIN posts p ON v.post_id = p.id
  WHERE vm.customer_company = p_customer_company
  AND p.project_id = p_project_id;
END;
$$;


--
-- Name: get_competitive_overview(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_competitive_overview(p_project_id uuid) RETURNS TABLE(total_competitors bigint, active_competitors bigint, total_mentions bigint, mentions_last_7d bigint, mentions_last_30d bigint, avg_sentiment_vs_competitors numeric, total_switches_to_you integer, total_switches_from_you integer, net_switches integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

BEGIN

  RETURN QUERY

  SELECT

    COUNT(DISTINCT c.id) as total_competitors,

    COUNT(DISTINCT c.id) FILTER (WHERE c.status = 'active') as active_competitors,

    SUM(c.total_mentions)::BIGINT as total_mentions,

    COUNT(DISTINCT cm.id) FILTER (WHERE cm.created_at >= NOW() - INTERVAL '7 days')::BIGINT as mentions_last_7d,

    COUNT(DISTINCT cm.id) FILTER (WHERE cm.created_at >= NOW() - INTERVAL '30 days')::BIGINT as mentions_last_30d,

    ROUND(AVG(cm.sentiment_vs_you)::NUMERIC, 2) as avg_sentiment_vs_competitors,

    SUM(c.switches_to_you)::INTEGER as total_switches_to_you,

    SUM(c.switches_from_you)::INTEGER as total_switches_from_you,

    (SUM(c.switches_to_you) - SUM(c.switches_from_you))::INTEGER as net_switches

  FROM competitors c

  LEFT JOIN competitive_mentions cm ON c.id = cm.competitor_id

  WHERE c.project_id = p_project_id;

END;

$$;


--
-- Name: get_competitor_hiring_trends(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_competitor_hiring_trends(p_project_id uuid, p_days integer DEFAULT 30) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  result JSONB;
BEGIN
  WITH department_counts AS (
    SELECT 
      competitor_name,
      department,
      COUNT(*) as count
    FROM competitor_job_postings
    WHERE project_id = p_project_id 
      AND is_active = true
      AND first_seen_at > NOW() - (p_days || ' days')::INTERVAL
    GROUP BY competitor_name, department
  ),
  competitor_totals AS (
    SELECT 
      competitor_name,
      COUNT(*) as total_jobs,
      jsonb_object_agg(COALESCE(department, 'other'), count) as by_department
    FROM department_counts
    GROUP BY competitor_name
  )
  SELECT jsonb_agg(
    jsonb_build_object(
      'competitor', competitor_name,
      'total_jobs', total_jobs,
      'departments', by_department
    )
  ) INTO result
  FROM competitor_totals
  ORDER BY total_jobs DESC;
  
  RETURN COALESCE(result, '[]'::jsonb);
END;
$$;


--
-- Name: get_competitor_product_analytics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_competitor_product_analytics(p_product_id uuid) RETURNS json
    LANGUAGE plpgsql
    AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'product_info', (
      SELECT row_to_json(cp) FROM competitor_products cp WHERE cp.id = p_product_id
    ),
    'review_stats', (
      SELECT json_build_object(
        'total_reviews', COUNT(*),
        'avg_rating', AVG(rating),
        'sentiment_breakdown', json_build_object(
          'positive', COUNT(*) FILTER (WHERE sentiment_category = 'positive'),
          'negative', COUNT(*) FILTER (WHERE sentiment_category = 'negative'),
          'neutral', COUNT(*) FILTER (WHERE sentiment_category = 'neutral'),
          'mixed', COUNT(*) FILTER (WHERE sentiment_category = 'mixed')
        ),
        'platform_breakdown', json_build_object(
          'g2', COUNT(*) FILTER (WHERE platform = 'g2'),
          'capterra', COUNT(*) FILTER (WHERE platform = 'capterra'),
          'trustradius', COUNT(*) FILTER (WHERE platform = 'trustradius')
        )
      )
      FROM competitor_reviews WHERE competitor_product_id = p_product_id
    ),
    'top_features', (
      SELECT json_agg(row_to_json(cf))
      FROM (
        SELECT * FROM competitor_features
        WHERE competitor_product_id = p_product_id
        ORDER BY mention_count DESC
        LIMIT 10
      ) cf
    ),
    'strengths', (
      SELECT json_agg(row_to_json(cs))
      FROM (
        SELECT * FROM competitor_strengths
        WHERE competitor_product_id = p_product_id
        ORDER BY praise_count DESC
        LIMIT 10
      ) cs
    ),
    'weaknesses', (
      SELECT json_agg(row_to_json(cw))
      FROM (
        SELECT * FROM competitor_weaknesses
        WHERE competitor_product_id = p_product_id
        ORDER BY complaint_count DESC
        LIMIT 10
      ) cw
    )
  ) INTO result;

  RETURN result;
END;
$$;


--
-- Name: get_competitor_profile(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_competitor_profile(p_competitor_id uuid) RETURNS TABLE(competitor_data jsonb, mention_breakdown jsonb, sentiment_trend jsonb, top_mentions jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

DECLARE

  v_competitor JSONB;

  v_mention_breakdown JSONB;

  v_sentiment_trend JSONB;

  v_top_mentions JSONB;

BEGIN

  -- Get competitor data

  SELECT row_to_json(c)::JSONB INTO v_competitor

  FROM competitors c

  WHERE c.id = p_competitor_id;

 

  -- Get mention type breakdown

  SELECT jsonb_agg(jsonb_build_object(

    'mention_type', mention_type,

    'count', count

  )) INTO v_mention_breakdown

  FROM (

    SELECT mention_type, COUNT(*) as count

    FROM competitive_mentions

    WHERE competitor_id = p_competitor_id

    GROUP BY mention_type

    ORDER BY count DESC

  ) breakdown;

 

  -- Get sentiment trend (last 30 days)

  SELECT jsonb_agg(jsonb_build_object(

    'date', date,

    'avg_sentiment_vs_you', avg_sentiment,

    'mention_count', mention_count

  ) ORDER BY date) INTO v_sentiment_trend

  FROM (

    SELECT

      DATE(cm.created_at) as date,

      ROUND(AVG(cm.sentiment_vs_you)::NUMERIC, 2) as avg_sentiment,

      COUNT(*) as mention_count

    FROM competitive_mentions cm

    WHERE cm.competitor_id = p_competitor_id

      AND cm.created_at >= NOW() - INTERVAL '30 days'

    GROUP BY DATE(cm.created_at)

    ORDER BY date DESC

  ) trend;

 

  -- Get top mentions with context

  SELECT jsonb_agg(jsonb_build_object(

    'id', cm.id,

    'feedback_id', cm.feedback_id,

    'mention_type', cm.mention_type,

    'context_snippet', cm.context_snippet,

    'sentiment_vs_you', cm.sentiment_vs_you,

    'key_points', cm.key_points,

    'created_at', cm.created_at

  ) ORDER BY cm.created_at DESC) INTO v_top_mentions

  FROM competitive_mentions cm

  WHERE cm.competitor_id = p_competitor_id

  ORDER BY cm.created_at DESC

  LIMIT 20;

 

  RETURN QUERY SELECT v_competitor, v_mention_breakdown, v_sentiment_trend, v_top_mentions;

END;

$$;


--
-- Name: get_correlation_network(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_correlation_network(p_project_id uuid) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'nodes', (
      SELECT json_agg(DISTINCT jsonb_build_object(
        'id', source_id,
        'type', source_type,
        'description', source_description
      ))
      FROM signal_correlations
      WHERE project_id = p_project_id
        AND status = 'active'
        AND correlation_score >= 0.5
    ),
    'edges', (
      SELECT json_agg(jsonb_build_object(
        'id', id,
        'source', source_id,
        'target', target_id,
        'correlation_type', correlation_type,
        'score', correlation_score,
        'confidence', confidence_level
      ))
      FROM signal_correlations
      WHERE project_id = p_project_id
        AND status = 'active'
        AND correlation_score >= 0.5
      ORDER BY correlation_score DESC
      LIMIT 100
    )
  ) INTO result;

  RETURN result;
END;
$$;


--
-- Name: get_customer_feedback_history(character varying, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_customer_feedback_history(p_customer_email character varying, p_project_id uuid) RETURNS TABLE(post_id uuid, post_title character varying, post_description text, priority character varying, feedback_source character varying, submitted_at timestamp with time zone, submitted_by_admin_name character varying, status character varying)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    p.id AS post_id,
    p.title AS post_title,
    p.description AS post_description,
    fm.priority,
    fm.feedback_source,
    fm.created_at AS submitted_at,
    fm.submitted_by_admin_name,
    p.status
  FROM feedback_metadata fm
  JOIN posts p ON fm.post_id = p.id
  WHERE fm.customer_email = p_customer_email
  AND p.project_id = p_project_id
  ORDER BY fm.created_at DESC;
END;
$$;


--
-- Name: get_customer_vote_history(character varying, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_customer_vote_history(p_customer_email character varying, p_project_id uuid) RETURNS TABLE(post_id uuid, post_title character varying, priority character varying, vote_source character varying, voted_at timestamp with time zone, voted_by_admin_name character varying)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    p.id AS post_id,
    p.title AS post_title,
    vm.priority,
    vm.vote_source,
    vm.created_at AS voted_at,
    vm.voted_by_admin_name
  FROM vote_metadata vm
  JOIN votes v ON vm.vote_id = v.id
  JOIN posts p ON v.post_id = p.id
  WHERE vm.customer_email = p_customer_email
  AND p.project_id = p_project_id
  ORDER BY vm.created_at DESC;
END;
$$;


--
-- Name: get_daily_sentiment_aggregates(uuid, timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_daily_sentiment_aggregates(p_project_id uuid, p_start_date timestamp with time zone, p_end_date timestamp with time zone) RETURNS TABLE(date text, avg_sentiment numeric, feedback_count integer, positive_count integer, negative_count integer, neutral_count integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    DATE(p.created_at)::TEXT as date,
    COALESCE(AVG(sa.sentiment_score), 0)::DECIMAL as avg_sentiment,
    COUNT(p.id)::INTEGER as feedback_count,
    SUM(CASE WHEN sa.sentiment_category = 'positive' THEN 1 ELSE 0 END)::INTEGER as positive_count,
    SUM(CASE WHEN sa.sentiment_category = 'negative' THEN 1 ELSE 0 END)::INTEGER as negative_count,
    SUM(CASE WHEN sa.sentiment_category IN ('neutral', 'mixed') THEN 1 ELSE 0 END)::INTEGER as neutral_count
  FROM posts p
  LEFT JOIN sentiment_analysis sa ON sa.post_id = p.id
  WHERE p.project_id = p_project_id
    AND p.created_at >= p_start_date
    AND p.created_at <= p_end_date
  GROUP BY DATE(p.created_at)
  ORDER BY DATE(p.created_at) ASC;
END;
$$;


--
-- Name: get_dashboard_metrics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_dashboard_metrics(p_project_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_result JSONB;
  v_sentiment_data JSONB;
  v_feedback_data JSONB;
  v_roadmap_data JSONB;
  v_competitor_data JSONB;
BEGIN
  -- Sentiment metrics (last 7 days)
  -- JOIN with sentiment_analysis table to get sentiment scores
  SELECT jsonb_build_object(
    'current_nps', COALESCE(ROUND(AVG(sa.sentiment_score) * 100), 0),
    'total_feedback', COUNT(DISTINCT p.id),
    'trend', CASE
      WHEN COUNT(DISTINCT p.id) FILTER (WHERE p.created_at >= NOW() - INTERVAL '7 days') >
           COUNT(DISTINCT p.id) FILTER (WHERE p.created_at >= NOW() - INTERVAL '14 days' AND p.created_at < NOW() - INTERVAL '7 days')
      THEN 'up'
      ELSE 'down'
    END,
    'change_percent', COALESCE(
      ROUND(
        ((AVG(sa.sentiment_score) FILTER (WHERE p.created_at >= NOW() - INTERVAL '7 days')) -
         (AVG(sa.sentiment_score) FILTER (WHERE p.created_at >= NOW() - INTERVAL '14 days' AND p.created_at < NOW() - INTERVAL '7 days'))) * 100
      , 2), 0
    )
  ) INTO v_sentiment_data
  FROM posts p
  LEFT JOIN sentiment_analysis sa ON sa.post_id = p.id
  WHERE p.project_id = p_project_id
    AND p.created_at >= NOW() - INTERVAL '14 days';

  -- Feedback velocity (issues per week)
  SELECT jsonb_build_object(
    'issues_per_week', COALESCE(COUNT(*) / 1.0, 0),
    'total_this_week', COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days'),
    'trend', CASE
      WHEN COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days') >
           COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '14 days' AND created_at < NOW() - INTERVAL '7 days')
      THEN 'up'
      ELSE 'down'
    END
  ) INTO v_feedback_data
  FROM posts
  WHERE project_id = p_project_id
    AND created_at >= NOW() - INTERVAL '7 days';

  -- Roadmap status (check if roadmap_items table exists)
  BEGIN
    SELECT jsonb_build_object(
      'in_progress', COUNT(*) FILTER (WHERE status = 'in-progress'),
      'planned', COUNT(*) FILTER (WHERE status = 'planned'),
      'completed_this_week', COUNT(*) FILTER (WHERE status = 'completed' AND updated_at >= NOW() - INTERVAL '7 days')
    ) INTO v_roadmap_data
    FROM roadmap_items
    WHERE project_id = p_project_id;
  EXCEPTION
    WHEN undefined_table THEN
      v_roadmap_data := jsonb_build_object('in_progress', 0, 'planned', 0, 'completed_this_week', 0);
  END;

  -- Competitor insights (if table exists)
  BEGIN
    SELECT jsonb_build_object(
      'new_insights_count', COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days'),
      'high_priority_count', COUNT(*) FILTER (WHERE priority = 'high' AND created_at >= NOW() - INTERVAL '7 days')
    ) INTO v_competitor_data
    FROM competitive_insights
    WHERE project_id = p_project_id
      AND created_at >= NOW() - INTERVAL '7 days';
  EXCEPTION
    WHEN undefined_table THEN
      v_competitor_data := jsonb_build_object('new_insights_count', 0, 'high_priority_count', 0);
  END;

  -- Combine all metrics
  v_result := jsonb_build_object(
    'sentiment', COALESCE(v_sentiment_data, jsonb_build_object('current_nps', 0, 'total_feedback', 0, 'trend', 'stable', 'change_percent', 0)),
    'feedback', COALESCE(v_feedback_data, jsonb_build_object('issues_per_week', 0, 'total_this_week', 0, 'trend', 'stable')),
    'roadmap', COALESCE(v_roadmap_data, jsonb_build_object('in_progress', 0, 'planned', 0, 'completed_this_week', 0)),
    'competitors', COALESCE(v_competitor_data, jsonb_build_object('new_insights_count', 0, 'high_priority_count', 0))
  );

  RETURN v_result;
END;
$$;


--
-- Name: FUNCTION get_dashboard_metrics(p_project_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_dashboard_metrics(p_project_id uuid) IS 'Aggregates dashboard metrics for sentiment, feedback velocity, roadmap, and competitors. Fixed to use sentiment_analysis table instead of non-existent posts.sentiment_score column.';


--
-- Name: get_deals_overview(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_deals_overview(p_project_id uuid, p_days_back integer DEFAULT 30) RETURNS TABLE(total_deals bigint, open_deals bigint, won_deals bigint, lost_deals bigint, win_rate numeric, total_revenue numeric, revenue_won numeric, revenue_lost numeric, revenue_in_pipeline numeric, top_loss_reasons jsonb, top_competitors jsonb, recent_losses bigint, avg_deal_size numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_total_deals BIGINT;
  v_open_deals BIGINT;
  v_won_deals BIGINT;
  v_lost_deals BIGINT;
  v_win_rate NUMERIC;
  v_total_revenue NUMERIC;
  v_revenue_won NUMERIC;
  v_revenue_lost NUMERIC;
  v_revenue_in_pipeline NUMERIC;
  v_top_loss_reasons JSONB;
  v_top_competitors JSONB;
  v_recent_losses BIGINT;
  v_avg_deal_size NUMERIC;
BEGIN
  -- Count deals by status
  SELECT
    COUNT(*),
    COUNT(*) FILTER (WHERE status = 'open'),
    COUNT(*) FILTER (WHERE status = 'won'),
    COUNT(*) FILTER (WHERE status = 'lost')
  INTO v_total_deals, v_open_deals, v_won_deals, v_lost_deals
  FROM deals
  WHERE project_id = p_project_id;

  -- Calculate win rate
  IF (v_won_deals + v_lost_deals) > 0 THEN
    v_win_rate := ROUND((v_won_deals::NUMERIC / (v_won_deals + v_lost_deals)::NUMERIC * 100), 2);
  ELSE
    v_win_rate := 0;
  END IF;

  -- Calculate revenue metrics
  SELECT
    COALESCE(SUM(amount), 0),
    COALESCE(SUM(amount) FILTER (WHERE status = 'won'), 0),
    COALESCE(SUM(amount) FILTER (WHERE status = 'lost'), 0),
    COALESCE(SUM(amount) FILTER (WHERE status = 'open'), 0),
    COALESCE(AVG(amount), 0)
  INTO v_total_revenue, v_revenue_won, v_revenue_lost, v_revenue_in_pipeline, v_avg_deal_size
  FROM deals
  WHERE project_id = p_project_id;

  -- Get top loss reasons
  SELECT COALESCE(jsonb_agg(reason_data ORDER BY count DESC), '[]'::jsonb)
  INTO v_top_loss_reasons
  FROM (
    SELECT
      jsonb_build_object(
        'reason', COALESCE(da.primary_reason::TEXT, 'unknown'),
        'count', COUNT(*),
        'revenue_lost', COALESCE(SUM(d.amount), 0)
      ) as reason_data,
      COUNT(*) as count
    FROM deals d
    LEFT JOIN deal_autopsies da ON da.deal_id = d.id
    WHERE d.project_id = p_project_id
      AND d.status = 'lost'
      AND d.closed_at >= NOW() - (p_days_back || ' days')::INTERVAL
    GROUP BY da.primary_reason
    LIMIT 5
  ) reasons;

  -- Get top competitors
  SELECT COALESCE(jsonb_agg(comp_data ORDER BY count DESC), '[]'::jsonb)
  INTO v_top_competitors
  FROM (
    SELECT
      jsonb_build_object(
        'competitor', competitor,
        'count', COUNT(*),
        'lost_count', COUNT(*) FILTER (WHERE status = 'lost'),
        'won_count', COUNT(*) FILTER (WHERE status = 'won'),
        'revenue_lost', COALESCE(SUM(amount) FILTER (WHERE status = 'lost'), 0)
      ) as comp_data,
      COUNT(*) as count
    FROM deals
    WHERE project_id = p_project_id
      AND competitor IS NOT NULL
      AND closed_at >= NOW() - (p_days_back || ' days')::INTERVAL
    GROUP BY competitor
    LIMIT 5
  ) competitors;

  -- Count recent losses
  SELECT COUNT(*)
  INTO v_recent_losses
  FROM deals
  WHERE project_id = p_project_id
    AND status = 'lost'
    AND closed_at >= NOW() - (p_days_back || ' days')::INTERVAL;

  RETURN QUERY SELECT
    v_total_deals,
    v_open_deals,
    v_won_deals,
    v_lost_deals,
    v_win_rate,
    v_total_revenue,
    v_revenue_won,
    v_revenue_lost,
    v_revenue_in_pipeline,
    v_top_loss_reasons,
    v_top_competitors,
    v_recent_losses,
    v_avg_deal_size;
END;
$$;


--
-- Name: get_experiment_full(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_experiment_full(p_experiment_id uuid) RETURNS json
    LANGUAGE sql STABLE
    AS $$
  SELECT json_build_object(
    'experiment', row_to_json(e.*),
    'results', (
      SELECT COALESCE(json_agg(row_to_json(r.*) ORDER BY r.measured_at DESC), '[]'::json)
      FROM experiment_results r
      WHERE r.experiment_id = p_experiment_id
    ),
    'learnings', (
      SELECT COALESCE(json_agg(row_to_json(l.*) ORDER BY l.impact_score DESC NULLS LAST, l.created_at DESC), '[]'::json)
      FROM experiment_learnings l
      WHERE l.experiment_id = p_experiment_id
    ),
    'snapshots', (
      SELECT COALESCE(json_agg(row_to_json(s.*)), '[]'::json)
      FROM (
        SELECT *
        FROM experiment_snapshots s
        WHERE s.experiment_id = p_experiment_id
        ORDER BY s.created_at DESC
        LIMIT 10
      ) s
    )
  )
  FROM experiments e
  WHERE e.id = p_experiment_id;
$$;


--
-- Name: get_experiments_needing_sync(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_experiments_needing_sync() RETURNS TABLE(id uuid, project_id uuid, name text, feature_flag_key text, feature_flag_provider text, last_synced_at timestamp with time zone, sync_frequency_minutes integer)
    LANGUAGE sql STABLE
    AS $$
  SELECT
    e.id,
    e.project_id,
    e.name,
    e.feature_flag_key,
    e.feature_flag_provider,
    e.last_synced_at,
    e.sync_frequency_minutes
  FROM experiments e
  WHERE e.sync_enabled = true
    AND e.status = 'running'
    AND e.feature_flag_key IS NOT NULL
    AND e.feature_flag_provider IS NOT NULL
    AND (
      e.last_synced_at IS NULL
      OR e.last_synced_at < NOW() - (e.sync_frequency_minutes || ' minutes')::INTERVAL
    )
  ORDER BY e.last_synced_at ASC NULLS FIRST;
$$;


--
-- Name: get_feature_impact_stats(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_feature_impact_stats(p_project_id uuid, p_category text DEFAULT NULL::text) RETURNS TABLE(total_features integer, avg_sentiment_impact numeric, avg_churn_impact numeric, avg_adoption_rate numeric, success_rate numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    RETURN QUERY
    SELECT
        COUNT(*)::INT as total_features,
        AVG(sentiment_impact) as avg_sentiment_impact,
        AVG(churn_impact) as avg_churn_impact,
        AVG(post_adoption_rate) as avg_adoption_rate,
        (COUNT(*) FILTER (WHERE success_rating >= 4)::DECIMAL / NULLIF(COUNT(*), 0)) as success_rate
    FROM feature_impact_history
    WHERE project_id = p_project_id
      AND (p_category IS NULL OR feature_category = p_category)
      AND launched_at IS NOT NULL;
END;
$$;


--
-- Name: FUNCTION get_feature_impact_stats(p_project_id uuid, p_category text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_feature_impact_stats(p_project_id uuid, p_category text) IS 'Get aggregate statistics on feature impact for a project';


--
-- Name: get_gift_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_gift_stats(p_project_id uuid) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  total_gifts INTEGER;
  pending_gifts INTEGER;
  claimed_gifts INTEGER;
  expired_gifts INTEGER;
BEGIN
  SELECT 
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE status = 'pending') as pending,
    COUNT(*) FILTER (WHERE status = 'claimed') as claimed,
    COUNT(*) FILTER (WHERE status = 'expired') as expired
  INTO total_gifts, pending_gifts, claimed_gifts, expired_gifts
  FROM gift_subscriptions 
  WHERE project_id = p_project_id;
  
  RETURN json_build_object(
    'total_gifts', total_gifts,
    'pending_gifts', pending_gifts,
    'claimed_gifts', claimed_gifts,
    'expired_gifts', expired_gifts
  );
END;
$$;


--
-- Name: get_inbox_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_inbox_stats(p_project_id uuid) RETURNS TABLE(total_items bigint, new_items bigint, unread_items bigint, starred_items bigint, items_today bigint, items_this_week bigint, avg_sentiment numeric, by_category jsonb, by_source jsonb)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::BIGINT as total_items,
    COUNT(*) FILTER (WHERE status = 'new')::BIGINT as new_items,
    COUNT(*) FILTER (WHERE read_at IS NULL)::BIGINT as unread_items,
    COUNT(*) FILTER (WHERE starred = true)::BIGINT as starred_items,
    COUNT(*) FILTER (WHERE imported_at >= CURRENT_DATE)::BIGINT as items_today,
    COUNT(*) FILTER (WHERE imported_at >= CURRENT_DATE - INTERVAL '7 days')::BIGINT as items_this_week,
    AVG(sentiment_score)::DECIMAL(3,2) as avg_sentiment,
    (
      SELECT jsonb_object_agg(category, cnt)
      FROM (
        SELECT category, COUNT(*)::INTEGER as cnt
        FROM unified_feedback_items
        WHERE project_id = p_project_id AND is_duplicate = false AND category IS NOT NULL
        GROUP BY category
      ) cat_counts
    ) as by_category,
    (
      SELECT jsonb_object_agg(source_type, cnt)
      FROM (
        SELECT source_type, COUNT(*)::INTEGER as cnt
        FROM unified_feedback_items
        WHERE project_id = p_project_id AND is_duplicate = false
        GROUP BY source_type
      ) source_counts
    ) as by_source
  FROM unified_feedback_items
  WHERE project_id = p_project_id AND is_duplicate = false;
END;
$$;


--
-- Name: get_integration_credential(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_integration_credential(p_project_id uuid, p_provider text) RETURNS json
    LANGUAGE sql STABLE SECURITY DEFINER
    AS $$
  SELECT row_to_json(ic.*)
  FROM integration_credentials ic
  WHERE ic.project_id = p_project_id
    AND ic.provider = p_provider
    AND ic.is_active = true
  LIMIT 1;
$$;


--
-- Name: get_jira_sync_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_jira_sync_stats(p_project_id uuid) RETURNS TABLE(total_issues_created bigint, issues_created_today bigint, issues_created_this_week bigint, total_sync_events bigint, successful_syncs bigint, failed_syncs bigint, last_sync_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(DISTINCT jil.id) as total_issues_created,
    COUNT(DISTINCT jil.id) FILTER (WHERE jil.created_at >= CURRENT_DATE) as issues_created_today,
    COUNT(DISTINCT jil.id) FILTER (WHERE jil.created_at >= CURRENT_DATE - INTERVAL '7 days') as issues_created_this_week,
    COUNT(jsl.id) as total_sync_events,
    COUNT(jsl.id) FILTER (WHERE jsl.success = true) as successful_syncs,
    COUNT(jsl.id) FILTER (WHERE jsl.success = false) as failed_syncs,
    MAX(jc.last_sync_at) as last_sync_at
  FROM jira_connections jc
  LEFT JOIN jira_issue_links jil ON jc.id = jil.jira_connection_id
  LEFT JOIN jira_sync_logs jsl ON jc.id = jsl.jira_connection_id
  WHERE jc.project_id = p_project_id
    AND jc.user_id = auth.uid();
END;
$$;


--
-- Name: get_latest_insight_report(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_latest_insight_report(p_project_id uuid) RETURNS TABLE(id uuid, report_period_start timestamp with time zone, report_period_end timestamp with time zone, executive_summary text, key_insights jsonb, recommended_actions jsonb, sentiment_trend character varying, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    ir.id,
    ir.report_period_start,
    ir.report_period_end,
    ir.executive_summary,
    ir.key_insights,
    ir.recommended_actions,
    ir.sentiment_trend,
    ir.created_at
  FROM insight_reports ir
  WHERE ir.project_id = p_project_id
    AND ir.report_type = 'weekly'
  ORDER BY ir.report_period_end DESC
  LIMIT 1;
END;
$$;


--
-- Name: get_latest_sentiment_forecast(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_latest_sentiment_forecast(p_project_id uuid, p_horizon integer DEFAULT 7) RETURNS TABLE(forecast_date timestamp with time zone, target_date timestamp with time zone, predicted_sentiment numeric, confidence_lower numeric, confidence_upper numeric, trend_direction character varying)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    sf.forecast_date,
    sf.target_date,
    sf.predicted_sentiment_score,
    sf.confidence_lower,
    sf.confidence_upper,
    sf.feature_trend_direction
  FROM sentiment_forecasts sf
  WHERE sf.project_id = p_project_id
    AND sf.forecast_horizon = p_horizon
  ORDER BY sf.forecast_date DESC
  LIMIT 1;
END;
$$;


--
-- Name: get_pending_actions(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_pending_actions(p_project_id uuid) RETURNS TABLE(action json, age_minutes integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    row_to_json(uaq.*) as action,
    EXTRACT(EPOCH FROM (NOW() - uaq.created_at))::INTEGER / 60 as age_minutes
  FROM unified_action_queue uaq
  WHERE uaq.project_id = p_project_id
    AND uaq.executed = false
    AND uaq.dismissed = false
    AND (uaq.expires_at IS NULL OR uaq.expires_at > NOW())
  ORDER BY
    -- Critical items first
    CASE WHEN uaq.severity = 'critical' THEN 1 ELSE 2 END,
    uaq.priority ASC,
    uaq.created_at DESC
  LIMIT 50;
END;
$$;


--
-- Name: get_pending_proposals(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_pending_proposals(p_project_id uuid) RETURNS TABLE(id uuid, trigger_type text, trigger_severity text, trigger_description text, proposed_changes jsonb, confidence_score numeric, created_at timestamp with time zone, expires_at timestamp with time zone)
    LANGUAGE sql STABLE SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
  SELECT 
    id,
    trigger_type,
    trigger_severity,
    trigger_description,
    proposed_changes,
    confidence_score,
    created_at,
    expires_at
  FROM roadmap_adjustment_proposals
  WHERE project_id = p_project_id
    AND status = 'pending'
    AND expires_at > NOW()
  ORDER BY 
    CASE trigger_severity 
      WHEN 'critical' THEN 1 
      WHEN 'high' THEN 2 
      WHEN 'medium' THEN 3 
      ELSE 4 
    END,
    created_at DESC;
$$;


--
-- Name: get_pending_theme_detection_count(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_pending_theme_detection_count(p_project_id uuid) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN (
    SELECT COUNT(*)
    FROM discovered_feedback
    WHERE project_id = p_project_id
      AND theme_analyzed_at IS NULL
      AND is_duplicate = false
      AND is_archived = false
  );
END;
$$;


--
-- Name: get_poll_results(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_poll_results(p_poll_id uuid) RETURNS TABLE(option_id uuid, option_text text, vote_count bigint, weighted_vote_count numeric, percentage numeric, weighted_percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  total_votes BIGINT;
  total_weighted NUMERIC;
BEGIN
  -- Get totals
  SELECT COUNT(*), COALESCE(SUM(COALESCE(customer_mrr, 1)), 0)
  INTO total_votes, total_weighted
  FROM poll_votes
  WHERE poll_id = p_poll_id;
  
  RETURN QUERY
  SELECT
    po.id as option_id,
    po.option_text,
    COUNT(pv.id) as vote_count,
    COALESCE(SUM(COALESCE(pv.customer_mrr, 1)), 0) as weighted_vote_count,
    CASE WHEN total_votes > 0 
      THEN ROUND((COUNT(pv.id)::NUMERIC / total_votes) * 100, 1)
      ELSE 0 
    END as percentage,
    CASE WHEN total_weighted > 0 
      THEN ROUND((COALESCE(SUM(COALESCE(pv.customer_mrr, 1)), 0) / total_weighted) * 100, 1)
      ELSE 0 
    END as weighted_percentage
  FROM poll_options po
  LEFT JOIN poll_votes pv ON po.id = pv.option_id
  WHERE po.poll_id = p_poll_id
  GROUP BY po.id, po.option_text, po.display_order
  ORDER BY po.display_order;
END;
$$;


--
-- Name: get_poll_results_by_segment(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_poll_results_by_segment(p_poll_id uuid) RETURNS TABLE(option_id uuid, option_text text, segment text, vote_count bigint, percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  WITH segment_totals AS (
    SELECT 
      COALESCE(pv.customer_segment, 'Unknown') as seg,
      COUNT(*) as total
    FROM poll_votes pv
    WHERE pv.poll_id = p_poll_id
    GROUP BY COALESCE(pv.customer_segment, 'Unknown')
  )
  SELECT
    po.id as option_id,
    po.option_text,
    COALESCE(pv.customer_segment, 'Unknown') as segment,
    COUNT(pv.id) as vote_count,
    CASE WHEN st.total > 0 
      THEN ROUND((COUNT(pv.id)::NUMERIC / st.total) * 100, 1)
      ELSE 0 
    END as percentage
  FROM poll_options po
  CROSS JOIN (SELECT DISTINCT COALESCE(customer_segment, 'Unknown') as seg FROM poll_votes WHERE poll_id = p_poll_id) segments
  LEFT JOIN poll_votes pv ON po.id = pv.option_id AND COALESCE(pv.customer_segment, 'Unknown') = segments.seg
  LEFT JOIN segment_totals st ON st.seg = segments.seg
  WHERE po.poll_id = p_poll_id
  GROUP BY po.id, po.option_text, po.display_order, segments.seg, st.total, pv.customer_segment
  ORDER BY po.display_order, segments.seg;
END;
$$;


--
-- Name: get_popular_queries(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_popular_queries(p_project_id uuid, p_role text DEFAULT NULL::text, p_limit integer DEFAULT 10) RETURNS TABLE(query_text text, query_count bigint, avg_rating numeric, avg_generation_time numeric)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    sq.query_text,
    COUNT(*)::BIGINT as query_count,
    AVG(sq.rating)::NUMERIC as avg_rating,
    AVG(sq.generation_time_ms)::NUMERIC as avg_generation_time
  FROM stakeholder_queries sq
  WHERE sq.project_id = p_project_id
    AND (p_role IS NULL OR sq.user_role = p_role)
  GROUP BY sq.query_text
  ORDER BY query_count DESC, avg_rating DESC NULLS LAST
  LIMIT p_limit;
END;
$$;


--
-- Name: FUNCTION get_popular_queries(p_project_id uuid, p_role text, p_limit integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_popular_queries(p_project_id uuid, p_role text, p_limit integer) IS 'Returns most frequently asked queries with analytics';


--
-- Name: get_post_participants(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_post_participants(p_post_id uuid, p_search_term text DEFAULT NULL::text) RETURNS TABLE(email text, name text, participation_count bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  WITH all_participants AS (
    SELECT
      p.author_email::TEXT AS email,
      p.author_name::TEXT AS name,
      1::BIGINT AS count
    FROM public.posts p
    WHERE p.id = p_post_id
      AND p.author_email IS NOT NULL

    UNION ALL

    SELECT
      c.author_email::TEXT AS email,
      c.author_name::TEXT AS name,
      COUNT(*)::BIGINT AS count
    FROM public.comments c
    WHERE c.post_id = p_post_id
      AND c.author_email IS NOT NULL
    GROUP BY c.author_email, c.author_name
  )
  SELECT
    ap.email,
    MAX(ap.name) AS name,
    SUM(ap.count)::BIGINT AS participation_count
  FROM all_participants ap
  WHERE ap.email IS NOT NULL
    AND (
      p_search_term IS NULL
      OR ap.email ILIKE '%' || p_search_term || '%'
      OR ap.name ILIKE '%' || p_search_term || '%'
    )
  GROUP BY ap.email
  ORDER BY participation_count DESC, name ASC
  LIMIT 20;
END;
$$;


--
-- Name: get_prediction_accuracy_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_prediction_accuracy_stats(p_project_id uuid) RETURNS TABLE(total_predictions integer, predictions_with_outcomes integer, avg_accuracy numeric, strategy_performance jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER as total_predictions,
    COUNT(CASE WHEN actual_adoption_rate IS NOT NULL THEN 1 END)::INTEGER as predictions_with_outcomes,
    AVG(prediction_accuracy)::DECIMAL as avg_accuracy,
    jsonb_object_agg(
      prediction_strategy,
      jsonb_build_object(
        'count', COUNT(*),
        'avg_accuracy', AVG(prediction_accuracy)
      )
    ) as strategy_performance
  FROM feature_predictions
  WHERE project_id = p_project_id
  GROUP BY project_id;
END;
$$;


--
-- Name: get_prediction_for_spec(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_prediction_for_spec(p_spec_id uuid) RETURNS TABLE(id uuid, predicted_adoption_rate numeric, predicted_sentiment_impact numeric, confidence_score numeric, explanation_text text, explanation_factors jsonb, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    fp.id,
    fp.predicted_adoption_rate,
    fp.predicted_sentiment_impact,
    fp.confidence_score,
    fp.explanation_text,
    fp.explanation_factors,
    fp.created_at
  FROM feature_predictions fp
  WHERE fp.spec_id = p_spec_id
  ORDER BY fp.created_at DESC
  LIMIT 1;
END;
$$;


--
-- Name: get_project_experiments_by_status(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_project_experiments_by_status(p_project_id uuid, p_status text DEFAULT NULL::text) RETURNS json
    LANGUAGE sql STABLE
    AS $$
  SELECT COALESCE(json_agg(
    json_build_object(
      'experiment', row_to_json(e.*),
      'result_count', (
        SELECT COUNT(*)
        FROM experiment_results r
        WHERE r.experiment_id = e.id
      ),
      'significant_results', (
        SELECT COUNT(*)
        FROM experiment_results r
        WHERE r.experiment_id = e.id
        AND r.statistical_significance = true
      ),
      'learning_count', (
        SELECT COUNT(*)
        FROM experiment_learnings l
        WHERE l.experiment_id = e.id
      )
    ) ORDER BY e.created_at DESC
  ), '[]'::json)
  FROM experiments e
  WHERE e.project_id = p_project_id
    AND (p_status IS NULL OR e.status = p_status);
$$;


--
-- Name: get_project_reasoning_traces(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_project_reasoning_traces(p_project_id uuid, p_feature text DEFAULT NULL::text, p_limit integer DEFAULT 50) RETURNS TABLE(id uuid, feature text, decision_type text, decision_summary text, reasoning_steps jsonb, outputs jsonb, metadata jsonb, entity_type text, entity_id uuid, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    rt.id,
    rt.feature,
    rt.decision_type,
    rt.decision_summary,
    rt.reasoning_steps,
    rt.outputs,
    rt.metadata,
    rt.entity_type,
    rt.entity_id,
    rt.created_at
  FROM reasoning_traces rt
  WHERE rt.project_id = p_project_id
    AND (p_feature IS NULL OR rt.feature = p_feature)
  ORDER BY rt.created_at DESC
  LIMIT p_limit;
END;
$$;


--
-- Name: get_project_stakeholders(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_project_stakeholders(p_project_id uuid) RETURNS json
    LANGUAGE sql STABLE
    AS $$
  SELECT COALESCE(json_agg(
    json_build_object(
      'stakeholder', row_to_json(s.*),
      'report_count', (
        SELECT COUNT(*)
        FROM stakeholder_reports r
        WHERE r.stakeholder_id = s.id
      ),
      'last_report_sent', (
        SELECT MAX(sent_at)
        FROM stakeholder_reports r
        WHERE r.stakeholder_id = s.id
      ),
      'total_opens', (
        SELECT COUNT(*)
        FROM stakeholder_reports r
        WHERE r.stakeholder_id = s.id AND r.opened_at IS NOT NULL
      ),
      'total_clicks', (
        SELECT COALESCE(SUM(click_count), 0)
        FROM stakeholder_reports r
        WHERE r.stakeholder_id = s.id
      )
    ) ORDER BY s.created_at DESC
  ), '[]'::json)
  FROM stakeholders s
  WHERE s.project_id = p_project_id;
$$;


--
-- Name: get_reasoning_for_entity(text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_reasoning_for_entity(p_entity_type text, p_entity_id uuid) RETURNS TABLE(id uuid, feature text, decision_type text, decision_summary text, reasoning_steps jsonb, outputs jsonb, metadata jsonb, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    rt.id,
    rt.feature,
    rt.decision_type,
    rt.decision_summary,
    rt.reasoning_steps,
    rt.outputs,
    rt.metadata,
    rt.created_at
  FROM reasoning_traces rt
  WHERE rt.entity_type = p_entity_type
    AND rt.entity_id = p_entity_id
  ORDER BY rt.created_at DESC
  LIMIT 10;
END;
$$;


--
-- Name: get_reasoning_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_reasoning_stats(p_project_id uuid) RETURNS TABLE(total_traces integer, traces_by_feature jsonb, avg_confidence numeric, avg_latency_ms numeric, most_common_decision_types jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER as total_traces,
    jsonb_object_agg(
      rt.feature,
      feature_count
    ) as traces_by_feature,
    AVG((rt.outputs->>'confidence')::DECIMAL)::DECIMAL as avg_confidence,
    AVG((rt.metadata->>'latency_ms')::DECIMAL)::DECIMAL as avg_latency_ms,
    (
      SELECT jsonb_agg(jsonb_build_object('decision_type', dt, 'count', dt_count))
      FROM (
        SELECT decision_type as dt, COUNT(*) as dt_count
        FROM reasoning_traces
        WHERE project_id = p_project_id
        GROUP BY decision_type
        ORDER BY dt_count DESC
        LIMIT 10
      ) top_types
    ) as most_common_decision_types
  FROM reasoning_traces rt
  LEFT JOIN LATERAL (
    SELECT COUNT(*) as feature_count
    FROM reasoning_traces rt2
    WHERE rt2.project_id = p_project_id AND rt2.feature = rt.feature
  ) fc ON true
  WHERE rt.project_id = p_project_id
  GROUP BY rt.project_id;
END;
$$;


--
-- Name: get_recent_priority_changes(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_recent_priority_changes(p_project_id uuid, p_days integer DEFAULT 7) RETURNS TABLE(theme_name text, old_priority text, new_priority text, score_change numeric, adjustment_reason text, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    RETURN QUERY
    SELECT
        rph.theme_name,
        rph.old_priority,
        rph.new_priority,
        rph.score_change,
        rph.adjustment_reason,
        rph.created_at
    FROM roadmap_priority_history rph
    WHERE rph.project_id = p_project_id
      AND rph.created_at >= NOW() - (p_days || ' days')::INTERVAL
    ORDER BY rph.created_at DESC;
END;
$$;


--
-- Name: FUNCTION get_recent_priority_changes(p_project_id uuid, p_days integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_recent_priority_changes(p_project_id uuid, p_days integer) IS 'Get priority changes for a project in the last N days';


--
-- Name: get_resource_audit_logs(character varying, uuid, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_resource_audit_logs(p_resource_type character varying, p_resource_id uuid, p_limit integer DEFAULT 100, p_offset integer DEFAULT 0) RETURNS TABLE(id uuid, event_type character varying, actor_email character varying, action character varying, action_status character varying, changes jsonb, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    al.id,
    al.event_type,
    al.actor_email,
    al.action,
    al.action_status,
    al.changes,
    al.created_at
  FROM audit_logs al
  WHERE al.resource_type = p_resource_type
    AND al.resource_id = p_resource_id
  ORDER BY al.created_at DESC
  LIMIT p_limit
  OFFSET p_offset;
END;
$$;


--
-- Name: get_revenue_prioritized_feedback(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_revenue_prioritized_feedback(p_project_id uuid, p_limit integer DEFAULT 20) RETURNS TABLE(feedback_id uuid, content text, customer_email text, customer_company text, customer_mrr numeric, customer_segment text, customer_plan_tier text, created_at timestamp with time zone)
    LANGUAGE sql STABLE
    AS $$
  SELECT
    df.id as feedback_id,
    df.content,
    df.customer_email,
    df.customer_company,
    df.customer_mrr,
    df.customer_segment,
    df.customer_plan_tier,
    df.created_at
  FROM discovered_feedback df
  WHERE df.project_id = p_project_id
    AND df.classification = 'feature_request'
    AND df.customer_profile_id IS NOT NULL
  ORDER BY
    -- Priority: enterprise > mid-market > smb
    CASE df.customer_segment
      WHEN 'enterprise' THEN 3
      WHEN 'mid-market' THEN 2
      WHEN 'smb' THEN 1
      ELSE 0
    END DESC,
    -- Then by MRR (highest first)
    df.customer_mrr DESC NULLS LAST,
    -- Then by recency
    df.created_at DESC
  LIMIT p_limit;
$$;


--
-- Name: FUNCTION get_revenue_prioritized_feedback(p_project_id uuid, p_limit integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_revenue_prioritized_feedback(p_project_id uuid, p_limit integer) IS 'Returns feedback sorted by customer revenue (enterprise > MRR > recency)';


--
-- Name: get_risk_alerts_summary(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_risk_alerts_summary(p_project_id uuid) RETURNS TABLE(total_alerts bigint, critical_alerts bigint, high_alerts bigint, open_alerts bigint, alerts_last_7d bigint, top_risk_types jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) as total_alerts,
    COUNT(*) FILTER (WHERE severity = 'critical') as critical_alerts,
    COUNT(*) FILTER (WHERE severity = 'high') as high_alerts,
    COUNT(*) FILTER (WHERE status = 'open') as open_alerts,
    COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days') as alerts_last_7d,
    jsonb_agg(DISTINCT jsonb_build_object(
      'risk_type', risk_type,
      'count', (SELECT COUNT(*) FROM prd_risk_alerts WHERE project_id = p_project_id AND risk_type = prd_risk_alerts.risk_type)
    )) as top_risk_types
  FROM prd_risk_alerts
  WHERE project_id = p_project_id;
END;
$$;


--
-- Name: get_security_event_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_security_event_stats() RETURNS TABLE(total_events bigint, critical_events bigint, high_events bigint, medium_events bigint, low_events bigint, events_last_24h bigint, events_last_7d bigint, top_event_types jsonb, events_by_day jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  RETURN QUERY
  WITH event_counts AS (
    SELECT
      COUNT(*) as total,
      COUNT(*) FILTER (WHERE severity = 'critical') as critical,
      COUNT(*) FILTER (WHERE severity = 'high') as high,
      COUNT(*) FILTER (WHERE severity = 'medium') as medium,
      COUNT(*) FILTER (WHERE severity = 'low') as low,
      COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '24 hours') as last_24h,
      COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days') as last_7d
    FROM security_events
  ),
  top_types AS (
    SELECT jsonb_agg(
      jsonb_build_object(
        'type', type,
        'count', count
      ) ORDER BY count DESC
    ) as types
    FROM (
      SELECT type, COUNT(*) as count
      FROM security_events
      WHERE created_at >= NOW() - INTERVAL '30 days'
      GROUP BY type
      ORDER BY count DESC
      LIMIT 10
    ) t
  ),
  daily_counts AS (
    SELECT jsonb_agg(
      jsonb_build_object(
        'date', day,
        'count', count
      ) ORDER BY day DESC
    ) as days
    FROM (
      SELECT
        DATE(created_at) as day,
        COUNT(*) as count
      FROM security_events
      WHERE created_at >= NOW() - INTERVAL '30 days'
      GROUP BY DATE(created_at)
      ORDER BY day DESC
    ) d
  )
  SELECT
    ec.total,
    ec.critical,
    ec.high,
    ec.medium,
    ec.low,
    ec.last_24h,
    ec.last_7d,
    COALESCE(tt.types, '[]'::jsonb),
    COALESCE(dc.days, '[]'::jsonb)
  FROM event_counts ec
  CROSS JOIN top_types tt
  CROSS JOIN daily_counts dc;
END;
$$;


--
-- Name: FUNCTION get_security_event_stats(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_security_event_stats() IS 'Returns statistics about security events for admin dashboard';


--
-- Name: get_sentiment_distribution(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_sentiment_distribution(p_project_id uuid, p_days_ago integer DEFAULT 30) RETURNS TABLE(sentiment_category text, count bigint, percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    sa.sentiment_category,
    COUNT(*) as count,
    ROUND((COUNT(*) * 100.0 / NULLIF(SUM(COUNT(*)) OVER (), 0)), 2) as percentage
  FROM posts p
  INNER JOIN sentiment_analysis sa ON p.id = sa.post_id
  WHERE p.project_id = p_project_id
    AND sa.analyzed_at >= NOW() - (p_days_ago || ' days')::INTERVAL
  GROUP BY sa.sentiment_category
  ORDER BY count DESC;
END;
$$;


--
-- Name: get_sentiment_trend(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_sentiment_trend(p_project_id uuid, p_days integer DEFAULT 30) RETURNS TABLE(date date, avg_sentiment numeric, total_posts integer)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    sh.date,
    sh.avg_sentiment,
    sh.total_posts
  FROM sentiment_history sh
  WHERE sh.project_id = p_project_id
    AND sh.date >= CURRENT_DATE - p_days
  ORDER BY sh.date ASC;
END;
$$;


--
-- Name: FUNCTION get_sentiment_trend(p_project_id uuid, p_days integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_sentiment_trend(p_project_id uuid, p_days integer) IS 'Returns sentiment trend data for charts';


--
-- Name: get_slack_channel_for_alert(uuid, public.slack_alert_type); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_slack_channel_for_alert(p_connection_id uuid, p_alert_type public.slack_alert_type) RETURNS TABLE(channel_id text, channel_name text, mention_users text[], use_threads boolean)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    scm.channel_id,
    scm.channel_name,
    scm.mention_users,
    scm.use_threads
  FROM slack_channel_mappings scm
  WHERE scm.slack_connection_id = p_connection_id
    AND scm.alert_type = p_alert_type
  LIMIT 1;
END;
$$;


--
-- Name: get_slow_stakeholder_queries(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_slow_stakeholder_queries() RETURNS TABLE(query_text text, avg_generation_time_ms numeric, total_executions bigint, user_role text)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    sq.query_text,
    AVG(sq.generation_time_ms)::NUMERIC AS avg_generation_time_ms,
    COUNT(*)::BIGINT AS total_executions,
    sq.user_role
  FROM stakeholder_queries sq
  WHERE sq.generation_time_ms > 5000 -- Slower than 5 seconds
  GROUP BY sq.query_text, sq.user_role
  ORDER BY AVG(sq.generation_time_ms) DESC
  LIMIT 20;
END;
$$;


--
-- Name: FUNCTION get_slow_stakeholder_queries(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_slow_stakeholder_queries() IS 'Identifies slow stakeholder queries for optimization';


--
-- Name: get_sprint_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_sprint_stats(p_sprint_id uuid) RETURNS TABLE(total_stories bigint, total_points integer, completed_stories bigint, completed_points integer, in_progress_stories bigint, todo_stories bigint, capacity integer, capacity_used_percent numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) as total_stories,
    COALESCE(SUM(us.story_points), 0)::INTEGER as total_points,
    COUNT(*) FILTER (WHERE us.sprint_status = 'done') as completed_stories,
    COALESCE(SUM(us.story_points) FILTER (WHERE us.sprint_status = 'done'), 0)::INTEGER as completed_points,
    COUNT(*) FILTER (WHERE us.sprint_status = 'in_progress') as in_progress_stories,
    COUNT(*) FILTER (WHERE us.sprint_status = 'to_do') as todo_stories,
    s.capacity_points as capacity,
    CASE
      WHEN s.capacity_points > 0 THEN ROUND((COALESCE(SUM(us.story_points), 0) / s.capacity_points) * 100, 2)
      ELSE 0
    END as capacity_used_percent
  FROM sprints s
  LEFT JOIN user_stories us ON us.sprint_id = s.id
  WHERE s.id = p_sprint_id
  GROUP BY s.id, s.capacity_points;
END;
$$;


--
-- Name: get_stakeholder_with_reports(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_stakeholder_with_reports(p_stakeholder_id uuid) RETURNS json
    LANGUAGE sql
    AS $$
  SELECT json_build_object(
    'stakeholder', row_to_json(s.*),
    'recent_reports', (
      SELECT COALESCE(json_agg(row_to_json(r.*)), '[]'::json)
      FROM (
        SELECT *
        FROM stakeholder_reports r
        WHERE r.stakeholder_id = p_stakeholder_id
        ORDER BY r.generated_at DESC
        LIMIT 10
      ) r
    ),
    'interests', (
      SELECT COALESCE(json_agg(row_to_json(i.*)), '[]'::json)
      FROM stakeholder_interests i
      WHERE i.stakeholder_id = p_stakeholder_id
    )
  )
  FROM stakeholders s
  WHERE s.id = p_stakeholder_id;
$$;


--
-- Name: get_theme_statistics(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_theme_statistics(p_project_id uuid, p_days_ago integer DEFAULT 30) RETURNS TABLE(total_themes bigint, emerging_themes bigint, total_feedback_items bigint, avg_theme_frequency numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

BEGIN

  RETURN QUERY

  SELECT

    COUNT(DISTINCT t.id) as total_themes,

    COUNT(DISTINCT t.id) FILTER (WHERE t.is_emerging = true) as emerging_themes,

    COUNT(DISTINCT ft.feedback_id) as total_feedback_items,

    ROUND(AVG(t.frequency)::NUMERIC, 2) as avg_theme_frequency

  FROM themes t

  LEFT JOIN feedback_themes ft ON t.id = ft.theme_id

  WHERE t.project_id = p_project_id

    AND t.created_at >= NOW() - (p_days_ago || ' days')::INTERVAL;

END;

$$;


--
-- Name: get_theme_trend(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_theme_trend(p_theme_id uuid, p_days_ago integer DEFAULT 30) RETURNS TABLE(date date, feedback_count bigint, avg_sentiment numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

BEGIN

  RETURN QUERY

  SELECT

    DATE(p.created_at) as date,

    COUNT(*) as feedback_count,

    ROUND(AVG(sa.sentiment_score)::NUMERIC, 2) as avg_sentiment

  FROM feedback_themes ft

  INNER JOIN posts p ON ft.feedback_id = p.id

  LEFT JOIN sentiment_analysis sa ON p.id = sa.post_id

  WHERE ft.theme_id = p_theme_id

    AND p.created_at >= NOW() - (p_days_ago || ' days')::INTERVAL

  GROUP BY DATE(p.created_at)

  ORDER BY date DESC;

END;

$$;


--
-- Name: get_today_briefing(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_today_briefing(p_project_id uuid) RETURNS TABLE(id uuid, project_id uuid, content jsonb, created_at timestamp with time zone, updated_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    db.id,
    db.project_id,
    db.content,
    db.created_at,
    db.updated_at
  FROM daily_briefings db
  WHERE db.project_id = p_project_id
    AND db.briefing_date = CURRENT_DATE
  ORDER BY db.created_at DESC
  LIMIT 1;
END;
$$;


--
-- Name: FUNCTION get_today_briefing(p_project_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_today_briefing(p_project_id uuid) IS 'Retrieves today''s briefing for a project (if it exists)';


--
-- Name: get_triage_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_triage_stats(p_project_id uuid) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    'pending', COUNT(*) FILTER (WHERE status = 'pending'),
    'processing', COUNT(*) FILTER (WHERE status = 'processing'),
    'completed', COUNT(*) FILTER (WHERE status = 'completed'),
    'failed', COUNT(*) FILTER (WHERE status = 'failed'),
    'total', COUNT(*),
    'avg_processing_time_minutes',
      COALESCE(AVG(EXTRACT(EPOCH FROM (processed_at - created_at)) / 60) FILTER (WHERE status = 'completed'), 0)::INTEGER,
    'auto_categorized_count', COUNT(*) FILTER (WHERE auto_categorized = true),
    'auto_assigned_count', COUNT(*) FILTER (WHERE auto_assigned = true),
    'auto_merged_count', COUNT(*) FILTER (WHERE auto_merged = true)
  ) INTO result
  FROM triage_queue
  WHERE project_id = p_project_id
    AND created_at > NOW() - INTERVAL '30 days';

  RETURN result;
END;
$$;


--
-- Name: get_user_story_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_story_stats(p_project_id uuid) RETURNS TABLE(total_stories bigint, stories_in_backlog bigint, stories_in_sprint bigint, total_story_points bigint, exported_to_jira bigint, ai_generated bigint, manually_edited bigint, avg_story_points numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) as total_stories,
    COUNT(*) FILTER (WHERE sprint_status = 'backlog') as stories_in_backlog,
    COUNT(*) FILTER (WHERE sprint_id IS NOT NULL) as stories_in_sprint,
    COALESCE(SUM(story_points), 0) as total_story_points,
    COUNT(*) FILTER (WHERE exported_to_jira = true) as exported_to_jira,
    COUNT(*) FILTER (WHERE generated_by_ai = true) as ai_generated,
    COUNT(*) FILTER (WHERE manually_edited = true) as manually_edited,
    ROUND(AVG(story_points)::NUMERIC, 2) as avg_story_points
  FROM user_stories
  WHERE project_id = p_project_id;
END;
$$;


--
-- Name: get_war_room_summary(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_war_room_summary(p_project_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  result JSONB;
BEGIN
  SELECT jsonb_build_object(
    'total_alerts', (SELECT COUNT(*) FROM competitor_alerts WHERE project_id = p_project_id),
    'new_alerts', (SELECT COUNT(*) FROM competitor_alerts WHERE project_id = p_project_id AND status = 'new'),
    'critical_alerts', (SELECT COUNT(*) FROM competitor_alerts WHERE project_id = p_project_id AND severity = 'critical' AND status NOT IN ('addressed', 'dismissed')),
    'high_alerts', (SELECT COUNT(*) FROM competitor_alerts WHERE project_id = p_project_id AND severity = 'high' AND status NOT IN ('addressed', 'dismissed')),
    'total_job_postings', (SELECT COUNT(*) FROM competitor_job_postings WHERE project_id = p_project_id AND is_active = true),
    'ai_ml_postings', (SELECT COUNT(*) FROM competitor_job_postings WHERE project_id = p_project_id AND is_active = true AND department = 'ai_ml'),
    'engineering_postings', (SELECT COUNT(*) FROM competitor_job_postings WHERE project_id = p_project_id AND is_active = true AND department = 'engineering'),
    'monitored_competitors', (SELECT COUNT(*) FROM competitor_monitoring_config WHERE project_id = p_project_id AND is_active = true),
    'revenue_at_risk', (SELECT COALESCE(SUM(revenue_at_risk), 0) FROM competitor_alerts WHERE project_id = p_project_id AND status NOT IN ('addressed', 'dismissed')),
    'last_alert_at', (SELECT MAX(detected_at) FROM competitor_alerts WHERE project_id = p_project_id)
  ) INTO result;
  
  RETURN result;
END;
$$;


--
-- Name: handle_new_user(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_new_user() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  user_name TEXT;
BEGIN
  -- Try to extract name from user metadata
  user_name := COALESCE(
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'name',
    NEW.raw_user_meta_data->>'first_name',
    NULL
  );

  INSERT INTO public.users (id, email, name, plan)
  VALUES (NEW.id, NEW.email, user_name, 'free')
  ON CONFLICT (id) DO NOTHING;

  RETURN NEW;
END;
$$;


--
-- Name: health_score_to_grade(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.health_score_to_grade(score integer) RETURNS character varying
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF score >= 80 THEN RETURN 'A';
  ELSIF score >= 60 THEN RETURN 'B';
  ELSIF score >= 40 THEN RETURN 'C';
  ELSIF score >= 20 THEN RETURN 'D';
  ELSE RETURN 'F';
  END IF;
END;
$$;


--
-- Name: health_score_to_risk(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.health_score_to_risk(score integer) RETURNS character varying
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF score >= 70 THEN RETURN 'low';
  ELSIF score >= 50 THEN RETURN 'medium';
  ELSIF score >= 30 THEN RETURN 'high';
  ELSE RETURN 'critical';
  END IF;
END;
$$;


--
-- Name: increment_ai_usage(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_ai_usage(p_project_id uuid, p_feature_type text) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
  current_count INTEGER;
  last_reset TIMESTAMP WITH TIME ZONE;
  should_reset BOOLEAN;
BEGIN
  -- Check if we need to reset (monthly)
  SELECT 
    usage_count,
    last_reset_at,
    (EXTRACT(EPOCH FROM (NOW() - last_reset_at)) > 2592000) -- 30 days in seconds
  INTO current_count, last_reset, should_reset
  FROM ai_usage_tracking
  WHERE project_id = p_project_id AND feature_type = p_feature_type;

  -- If record doesn't exist, create it
  IF current_count IS NULL THEN
    INSERT INTO ai_usage_tracking (project_id, feature_type, usage_count)
    VALUES (p_project_id, p_feature_type, 1)
    RETURNING usage_count INTO current_count;
    
    RETURN jsonb_build_object('usage_count', current_count, 'reset', false);
  END IF;

  -- If should reset, reset the counter
  IF should_reset THEN
    UPDATE ai_usage_tracking
    SET usage_count = 1, last_reset_at = NOW(), updated_at = NOW()
    WHERE project_id = p_project_id AND feature_type = p_feature_type
    RETURNING usage_count INTO current_count;
    
    RETURN jsonb_build_object('usage_count', current_count, 'reset', true);
  END IF;

  -- Otherwise, increment
  UPDATE ai_usage_tracking
  SET usage_count = usage_count + 1, updated_at = NOW()
  WHERE project_id = p_project_id AND feature_type = p_feature_type
  RETURNING usage_count INTO current_count;

  RETURN jsonb_build_object('usage_count', current_count, 'reset', false);
END;
$$;


--
-- Name: increment_competitor_mentions(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_competitor_mentions(p_competitor_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

BEGIN

  UPDATE competitors

  SET

    total_mentions = total_mentions + 1,

    last_mentioned_at = NOW(),

    first_mentioned_at = COALESCE(first_mentioned_at, NOW()),

    updated_at = NOW()

  WHERE id = p_competitor_id;

END;

$$;


--
-- Name: increment_email_count(character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_email_count(p_email character varying) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  INSERT INTO email_batches (to_email, batch_date, email_count)
  VALUES (p_email, CURRENT_DATE, 1)
  ON CONFLICT (to_email, batch_date) DO UPDATE SET
    email_count = email_batches.email_count + 1,
    updated_at = NOW();
END;
$$;


--
-- Name: increment_event_retry_count(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_event_retry_count(event_id uuid) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE events
  SET retry_count = COALESCE(retry_count, 0) + 1
  WHERE id = event_id;
END;
$$;


--
-- Name: FUNCTION increment_event_retry_count(event_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.increment_event_retry_count(event_id uuid) IS 'Increments the retry count for a failed event';


--
-- Name: increment_post_stats(uuid, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_post_stats(p_post_id uuid, p_votes integer DEFAULT 0, p_comments integer DEFAULT 0) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE posts
  SET
    vote_count = vote_count + p_votes,
    comment_count = comment_count + p_comments,
    updated_at = NOW()
  WHERE id = p_post_id;
END;
$$;


--
-- Name: increment_vote_count(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_vote_count(post_id_param uuid) RETURNS integer
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  new_count INTEGER;
BEGIN
  UPDATE posts 
  SET vote_count = vote_count + 1 
  WHERE id = post_id_param
  RETURNING vote_count INTO new_count;
  
  RETURN COALESCE(new_count, 0);
END;
$$;


--
-- Name: insert_audit_log(character varying, character varying, uuid, character varying, character varying, uuid, character varying, character varying, jsonb, inet, text, uuid, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.insert_audit_log(p_event_type character varying, p_event_category character varying, p_actor_id uuid, p_actor_email character varying, p_resource_type character varying, p_resource_id uuid, p_action character varying, p_action_status character varying, p_changes jsonb DEFAULT NULL::jsonb, p_ip_address inet DEFAULT NULL::inet, p_user_agent text DEFAULT NULL::text, p_project_id uuid DEFAULT NULL::uuid, p_metadata jsonb DEFAULT '{}'::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_log_id UUID;
BEGIN
  INSERT INTO audit_logs (
    event_type,
    event_category,
    actor_id,
    actor_email,
    resource_type,
    resource_id,
    action,
    action_status,
    changes,
    ip_address,
    user_agent,
    project_id,
    metadata
  ) VALUES (
    p_event_type,
    p_event_category,
    p_actor_id,
    p_actor_email,
    p_resource_type,
    p_resource_id,
    p_action,
    p_action_status,
    p_changes,
    p_ip_address,
    p_user_agent,
    p_project_id,
    p_metadata
  )
  RETURNING id INTO v_log_id;
  
  RETURN v_log_id;
END;
$$;


--
-- Name: log_strategy_shift_event(uuid, uuid, text, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_strategy_shift_event(p_shift_id uuid, p_project_id uuid, p_event_type text, p_payload jsonb DEFAULT '{}'::jsonb) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  INSERT INTO strategy_shift_events(shift_id, project_id, event_type, payload)
  VALUES (p_shift_id, p_project_id, p_event_type, p_payload);
END;
$$;


--
-- Name: process_comment_mentions(uuid, text, uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.process_comment_mentions(p_comment_id uuid, p_comment_text text, p_post_id uuid, p_project_id uuid) RETURNS integer
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  mention_count INTEGER := 0;
  mentioned_text TEXT;
  participant_record RECORD;
BEGIN
  -- Extract all @mentions from text
  FOR mentioned_text IN
    SELECT UNNEST(extract_mentions_from_text(p_comment_text))
  LOOP
    -- Try to find this mention in post participants
    -- Match by exact name first, then by email, then by partial match
    FOR participant_record IN
      SELECT * FROM get_post_participants(p_post_id, mentioned_text)
      WHERE LOWER(TRIM(name)) = LOWER(TRIM(mentioned_text))
         OR LOWER(email) = LOWER(mentioned_text)
         OR name ILIKE '%' || mentioned_text || '%'
         OR email ILIKE '%' || mentioned_text || '%'
      ORDER BY
        CASE
          WHEN LOWER(TRIM(name)) = LOWER(TRIM(mentioned_text)) THEN 1
          WHEN LOWER(email) = LOWER(mentioned_text) THEN 2
          ELSE 3
        END
      LIMIT 1
    LOOP
      -- Insert mention (will be ignored if duplicate due to UNIQUE constraint)
      INSERT INTO comment_mentions (
        comment_id,
        mentioned_user_email,
        mentioned_user_name,
        project_id,
        post_id
      ) VALUES (
        p_comment_id,
        participant_record.email,
        participant_record.name,
        p_project_id,
        p_post_id
      )
      ON CONFLICT (comment_id, mentioned_user_email) DO NOTHING;

      mention_count := mention_count + 1;
    END LOOP;
  END LOOP;

  RETURN mention_count;
END;
$$;


--
-- Name: publish_feedback_created_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_feedback_created_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  INSERT INTO events (
    type,
    aggregate_type,
    aggregate_id,
    payload,
    metadata,
    version
  ) VALUES (
    'feedback.created',
    'post',
    NEW.id,
    jsonb_build_object(
      'title', NEW.title,
      'content', NEW.content,
      'category', NEW.category,
      'vote_count', NEW.vote_count,
      'status', NEW.status
    ),
    jsonb_build_object(
      'project_id', NEW.project_id::text,
      'user_id', NEW.user_id::text,
      'timestamp', NOW()::text,
      'source', 'database_trigger'
    ),
    1
  );
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_feedback_created_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_feedback_created_event() IS 'Publishes feedback.created event when new feedback is submitted';


--
-- Name: publish_feedback_updated_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_feedback_updated_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF OLD.title != NEW.title OR
     OLD.content != NEW.content OR
     OLD.category != NEW.category OR
     OLD.status != NEW.status THEN

    INSERT INTO events (
      type,
      aggregate_type,
      aggregate_id,
      payload,
      metadata,
      version
    ) VALUES (
      'feedback.updated',
      'post',
      NEW.id,
      jsonb_build_object(
        'title', NEW.title,
        'content', NEW.content,
        'category', NEW.category,
        'status', NEW.status,
        'changes', jsonb_build_object(
          'title_changed', OLD.title != NEW.title,
          'content_changed', OLD.content != NEW.content,
          'category_changed', OLD.category != NEW.category,
          'status_changed', OLD.status != NEW.status
        )
      ),
      jsonb_build_object(
        'project_id', NEW.project_id::text,
        'user_id', NEW.user_id::text,
        'timestamp', NOW()::text,
        'source', 'database_trigger'
      ),
      1
    );
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_feedback_updated_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_feedback_updated_event() IS 'Publishes feedback.updated event when feedback content is modified';


--
-- Name: publish_feedback_voted_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_feedback_voted_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF OLD.vote_count != NEW.vote_count THEN
    INSERT INTO events (
      type,
      aggregate_type,
      aggregate_id,
      payload,
      metadata,
      version
    ) VALUES (
      'feedback.voted',
      'post',
      NEW.id,
      jsonb_build_object(
        'vote_count', NEW.vote_count,
        'previous_vote_count', OLD.vote_count,
        'vote_delta', NEW.vote_count - OLD.vote_count
      ),
      jsonb_build_object(
        'project_id', NEW.project_id::text,
        'timestamp', NOW()::text,
        'source', 'database_trigger'
      ),
      1
    );
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_feedback_voted_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_feedback_voted_event() IS 'Publishes feedback.voted event when vote count changes';


--
-- Name: publish_sentiment_analyzed_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_sentiment_analyzed_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_post posts%ROWTYPE;
BEGIN
  SELECT * INTO v_post FROM posts WHERE id = NEW.post_id;

  INSERT INTO events (
    type,
    aggregate_type,
    aggregate_id,
    payload,
    metadata,
    version
  ) VALUES (
    'sentiment.analyzed',
    'sentiment_analysis',
    NEW.id,
    jsonb_build_object(
      'post_id', NEW.post_id::text,
      'sentiment_score', NEW.sentiment_score,
      'sentiment_category', NEW.sentiment_category,
      'key_themes', NEW.key_themes,
      'emotional_intensity', NEW.emotional_intensity,
      'post_title', v_post.title
    ),
    jsonb_build_object(
      'project_id', v_post.project_id::text,
      'user_id', v_post.user_id::text,
      'timestamp', NOW()::text,
      'source', 'database_trigger',
      'correlation_id', NEW.post_id::text
    ),
    1
  );
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_sentiment_analyzed_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_sentiment_analyzed_event() IS 'Publishes sentiment.analyzed event when AI analyzes feedback sentiment';


--
-- Name: publish_spec_approved_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_spec_approved_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF OLD.status != 'approved' AND NEW.status = 'approved' THEN
    INSERT INTO events (
      type,
      aggregate_type,
      aggregate_id,
      payload,
      metadata,
      version
    ) VALUES (
      'spec.approved',
      'spec',
      NEW.id,
      jsonb_build_object(
        'title', NEW.title,
        'auto_generated', NEW.auto_generated,
        'linked_feedback_count', array_length(NEW.linked_feedback_ids, 1),
        'linked_feedback_ids', NEW.linked_feedback_ids
      ),
      jsonb_build_object(
        'project_id', NEW.project_id::text,
        'user_id', NEW.created_by::text,
        'timestamp', NOW()::text,
        'source', 'database_trigger',
        'priority', 'high'
      ),
      1
    );
    RAISE NOTICE 'Spec approved: %', NEW.title;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_spec_approved_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_spec_approved_event() IS 'Publishes spec.approved event when PM approves a spec';


--
-- Name: publish_spec_auto_drafted_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_spec_auto_drafted_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.auto_generated = TRUE THEN
    INSERT INTO events (
      type,
      aggregate_type,
      aggregate_id,
      payload,
      metadata,
      version
    ) VALUES (
      'spec.auto_drafted',
      'spec',
      NEW.id,
      jsonb_build_object(
        'title', NEW.title,
        'input_idea', NEW.input_idea,
        'status', NEW.status,
        'linked_feedback_count', array_length(NEW.linked_feedback_ids, 1),
        'linked_feedback_ids', NEW.linked_feedback_ids,
        'generation_model', NEW.generation_model,
        'generation_tokens', NEW.generation_tokens
      ),
      jsonb_build_object(
        'project_id', NEW.project_id::text,
        'user_id', NEW.created_by::text,
        'timestamp', NOW()::text,
        'source', 'database_trigger',
        'priority', 'high'
      ),
      1
    );
    RAISE NOTICE 'Spec auto-drafted: % (% linked feedback items)', NEW.title, array_length(NEW.linked_feedback_ids, 1);
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_spec_auto_drafted_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_spec_auto_drafted_event() IS 'Publishes spec.auto_drafted event when Proactive Spec Writer generates a new spec';


--
-- Name: publish_theme_detected_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_theme_detected_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  INSERT INTO events (
    type,
    aggregate_type,
    aggregate_id,
    payload,
    metadata,
    version
  ) VALUES (
    'theme.detected',
    'theme',
    NEW.id,
    jsonb_build_object(
      'theme_name', NEW.theme_name,
      'description', NEW.description,
      'frequency', NEW.frequency,
      'avg_sentiment', NEW.avg_sentiment,
      'is_emerging', NEW.is_emerging
    ),
    jsonb_build_object(
      'project_id', NEW.project_id::text,
      'timestamp', NOW()::text,
      'source', 'database_trigger'
    ),
    1
  );
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_theme_detected_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_theme_detected_event() IS 'Publishes theme.detected event when AI identifies a new theme';


--
-- Name: publish_theme_threshold_reached_event(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_theme_threshold_reached_event() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_threshold INTEGER := 20;
BEGIN
  IF OLD.frequency < v_threshold AND NEW.frequency >= v_threshold THEN
    INSERT INTO events (
      type,
      aggregate_type,
      aggregate_id,
      payload,
      metadata,
      version
    ) VALUES (
      'theme.threshold_reached',
      'theme',
      NEW.id,
      jsonb_build_object(
        'theme_name', NEW.theme_name,
        'description', NEW.description,
        'frequency', NEW.frequency,
        'threshold', v_threshold,
        'avg_sentiment', NEW.avg_sentiment,
        'is_emerging', NEW.is_emerging
      ),
      jsonb_build_object(
        'project_id', NEW.project_id::text,
        'timestamp', NOW()::text,
        'source', 'database_trigger',
        'priority', 'high'
      ),
      1
    );
    RAISE NOTICE 'Theme threshold reached: % (% feedback items)', NEW.theme_name, NEW.frequency;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION publish_theme_threshold_reached_event(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_theme_threshold_reached_event() IS 'Publishes theme.threshold_reached event when theme hits 20+ feedback items (triggers spec generation)';


--
-- Name: record_customer_sync(uuid, text, text, text, integer, integer, integer, text, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_customer_sync(p_project_id uuid, p_sync_type text, p_provider text, p_status text, p_customers_synced integer DEFAULT 0, p_customers_created integer DEFAULT 0, p_customers_updated integer DEFAULT 0, p_error_message text DEFAULT NULL::text, p_raw_response jsonb DEFAULT NULL::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_log_id UUID;
BEGIN
  INSERT INTO customer_sync_log (
    project_id,
    sync_type,
    provider,
    status,
    customers_synced,
    customers_created,
    customers_updated,
    error_message,
    raw_response
  ) VALUES (
    p_project_id,
    p_sync_type,
    p_provider,
    p_status,
    p_customers_synced,
    p_customers_created,
    p_customers_updated,
    p_error_message,
    p_raw_response
  )
  RETURNING id INTO v_log_id;

  RETURN v_log_id;
END;
$$;


--
-- Name: record_experiment_sync(uuid, text, text, text, integer, text, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_experiment_sync(p_experiment_id uuid, p_sync_type text, p_provider text, p_status text, p_results_synced integer DEFAULT 0, p_error_message text DEFAULT NULL::text, p_raw_response jsonb DEFAULT NULL::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_log_id UUID;
BEGIN
  -- Insert sync log
  INSERT INTO experiment_sync_log (
    experiment_id,
    sync_type,
    provider,
    status,
    results_synced,
    error_message,
    raw_response
  ) VALUES (
    p_experiment_id,
    p_sync_type,
    p_provider,
    p_status,
    p_results_synced,
    p_error_message,
    p_raw_response
  )
  RETURNING id INTO v_log_id;

  -- Update experiment's last_synced_at if successful
  IF p_status = 'success' OR p_status = 'partial' THEN
    UPDATE experiments
    SET last_synced_at = NOW()
    WHERE id = p_experiment_id;
  END IF;

  RETURN v_log_id;
END;
$$;


--
-- Name: record_signal_event(uuid, text, text, uuid, text, numeric, numeric, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_signal_event(p_project_id uuid, p_event_type text, p_entity_type text, p_entity_id uuid, p_entity_name text, p_metric_value numeric, p_baseline_value numeric DEFAULT NULL::numeric, p_metadata jsonb DEFAULT '{}'::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  event_id UUID;
  deviation_val NUMERIC;
BEGIN
  -- Calculate deviation
  IF p_baseline_value IS NOT NULL AND p_baseline_value > 0 THEN
    deviation_val := (p_metric_value - p_baseline_value) / p_baseline_value;
  ELSE
    deviation_val := NULL;
  END IF;

  -- Insert event
  INSERT INTO signal_events (
    project_id,
    event_type,
    entity_type,
    entity_id,
    entity_name,
    metric_value,
    baseline_value,
    deviation,
    metadata
  ) VALUES (
    p_project_id,
    p_event_type,
    p_entity_type,
    p_entity_id,
    p_entity_name,
    p_metric_value,
    p_baseline_value,
    deviation_val,
    p_metadata
  ) RETURNING id INTO event_id;

  RETURN event_id;
END;
$$;


--
-- Name: recover_stale_hunter_jobs(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.recover_stale_hunter_jobs() RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_count INT;
BEGIN
  WITH recovered AS (
    UPDATE hunter_jobs 
    SET status = 'pending', 
        locked_by = NULL, 
        locked_at = NULL,
        next_retry_at = now() -- Retry immediately
    WHERE status = 'processing' 
      AND locked_at < now() - interval '5 minutes'
    RETURNING id
  )
  SELECT count(*)::int INTO v_count FROM recovered;
  
  RETURN v_count;
END;
$$;


--
-- Name: refresh_theme_sentiment_cache(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.refresh_theme_sentiment_cache(p_project_id uuid DEFAULT NULL::uuid) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF p_project_id IS NULL THEN
    -- Refresh entire cache
    REFRESH MATERIALIZED VIEW CONCURRENTLY theme_sentiment_cache;
  ELSE
    -- For project-specific refresh, use regular view query
    -- (Postgres doesn't support partial materialized view refresh)
    -- Application should use cache with TTL for project-specific data
    NULL;
  END IF;
END;
$$;


--
-- Name: FUNCTION refresh_theme_sentiment_cache(p_project_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.refresh_theme_sentiment_cache(p_project_id uuid) IS 'Refreshes the theme sentiment materialized view';


--
-- Name: resolve_or_create_customer(uuid, character varying, character varying, character varying, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.resolve_or_create_customer(p_project_id uuid, p_email character varying, p_name character varying DEFAULT NULL::character varying, p_source_type character varying DEFAULT NULL::character varying, p_source_id character varying DEFAULT NULL::character varying) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_customer_id UUID;
  v_identities JSONB;
BEGIN
  -- Try to find existing customer by email
  SELECT id, identities INTO v_customer_id, v_identities
  FROM customers
  WHERE project_id = p_project_id AND email = p_email
  LIMIT 1;
  
  IF v_customer_id IS NOT NULL THEN
    -- Update identities if new source provided
    IF p_source_type IS NOT NULL AND p_source_id IS NOT NULL THEN
      v_identities := COALESCE(v_identities, '{}'::JSONB) || jsonb_build_object(p_source_type, p_source_id);
      UPDATE customers SET identities = v_identities, updated_at = NOW()
      WHERE id = v_customer_id;
    END IF;
    RETURN v_customer_id;
  END IF;
  
  -- Create new customer
  v_identities := CASE 
    WHEN p_source_type IS NOT NULL AND p_source_id IS NOT NULL 
    THEN jsonb_build_object(p_source_type, p_source_id)
    ELSE '{}'::JSONB
  END;
  
  INSERT INTO customers (project_id, email, name, identities)
  VALUES (p_project_id, p_email, p_name, v_identities)
  RETURNING id INTO v_customer_id;
  
  RETURN v_customer_id;
END;
$$;


--
-- Name: search_agent_memory(uuid, public.vector, text[], integer, smallint, double precision); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_agent_memory(p_project_id uuid, p_query_embedding public.vector, p_agent_names text[] DEFAULT NULL::text[], p_limit integer DEFAULT 8, p_min_importance smallint DEFAULT 1, p_similarity_threshold double precision DEFAULT 0.60) RETURNS TABLE(id uuid, agent_name text, memory_type text, content text, metadata jsonb, similarity double precision, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    am.id,
    am.agent_name,
    am.memory_type,
    am.content,
    am.metadata,
    1 - (am.embedding <=> p_query_embedding) AS similarity,
    am.created_at
  FROM agent_memory am
  WHERE am.project_id = p_project_id
    AND am.embedding IS NOT NULL
    AND (p_agent_names IS NULL OR am.agent_name = ANY(p_agent_names))
    AND am.importance >= p_min_importance
    AND 1 - (am.embedding <=> p_query_embedding) >= p_similarity_threshold
  ORDER BY am.embedding <=> p_query_embedding
  LIMIT p_limit;
END;
$$;


--
-- Name: FUNCTION search_agent_memory(p_project_id uuid, p_query_embedding public.vector, p_agent_names text[], p_limit integer, p_min_importance smallint, p_similarity_threshold double precision); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_agent_memory(p_project_id uuid, p_query_embedding public.vector, p_agent_names text[], p_limit integer, p_min_importance smallint, p_similarity_threshold double precision) IS 'Find relevant agent memory entries using vector similarity';


--
-- Name: search_competitor_events_by_similarity(public.vector, uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_competitor_events_by_similarity(p_embedding public.vector, p_project_id uuid, p_limit integer DEFAULT 10) RETURNS TABLE(id uuid, competitor_id uuid, event_type text, event_title text, event_summary text, event_date date, impact_assessment text, strategic_implications jsonb, similarity double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    ce.id,
    ce.competitor_id,
    ce.event_type,
    ce.event_title,
    ce.event_summary,
    ce.event_date,
    ce.impact_assessment,
    ce.strategic_implications,
    1 - (ce.embedding <=> p_embedding) as similarity
  FROM competitor_events ce
  WHERE ce.project_id = p_project_id
  ORDER BY ce.embedding <=> p_embedding
  LIMIT p_limit;
END;
$$;


--
-- Name: search_context_semantic(public.vector, uuid, double precision, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_context_semantic(query_embedding public.vector, p_project_id uuid, match_threshold double precision DEFAULT 0.6, match_count integer DEFAULT 15) RETURNS TABLE(context_type text, context_id uuid, title text, content text, metadata jsonb, similarity double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    'feedback'::TEXT AS context_type,
    p.id AS context_id,
    COALESCE(p.title, 'Feedback') AS title,
    COALESCE(p.description, p.content, '') AS content,
    jsonb_build_object(
      'status', p.status,
      'category', p.category,
      'upvotes', COALESCE(p.upvotes, p.vote_count, 0)
    ) AS metadata,
    1 - (fe.embedding <=> query_embedding) AS similarity
  FROM feedback_embeddings fe
  JOIN posts p ON p.id = fe.feedback_id
  WHERE fe.project_id = p_project_id
    AND 1 - (fe.embedding <=> query_embedding) >= match_threshold

  UNION ALL

  SELECT
    'roadmap'::TEXT AS context_type,
    rs.id AS context_id,
    COALESCE(rs.recommendation_text, 'Roadmap suggestion') AS title,
    LEFT(
      COALESCE(rs.why_matters, '') || '\n' ||
      COALESCE(rs.recommendation_text, '') || '\n' ||
      COALESCE(rs.implementation_strategy, '') || '\n' ||
      COALESCE(rs.user_segments_affected, ''),
      2000
    ) AS content,
    jsonb_build_object(
      'priority', rs.priority_level,
      'status', rs.status,
      'theme_id', rs.theme_id,
      'score', rs.priority_score
    ) AS metadata,
    1 - (re.embedding <=> query_embedding) AS similarity
  FROM roadmap_item_embeddings re
  JOIN roadmap_suggestions rs ON rs.id = re.roadmap_item_id
  WHERE re.project_id = p_project_id
    AND 1 - (re.embedding <=> query_embedding) >= match_threshold

  UNION ALL

  SELECT
    'competitor'::TEXT AS context_type,
    c.id AS context_id,
    c.name AS title,
    LEFT(COALESCE(c.description, ''), 2000) AS content,
    jsonb_build_object(
      'category', c.category,
      'status', c.status,
      'total_mentions', c.total_mentions
    ) AS metadata,
    1 - (ce.embedding <=> query_embedding) AS similarity
  FROM competitor_embeddings ce
  JOIN competitors c ON c.id = ce.competitor_id
  WHERE ce.project_id = p_project_id
    AND 1 - (ce.embedding <=> query_embedding) >= match_threshold

  UNION ALL

  SELECT
    'persona'::TEXT AS context_type,
    p2.id AS context_id,
    p2.name AS title,
    LEFT(
      COALESCE(p2.description, '') || '\nGoals: ' || COALESCE(p2.goals, '') || '\nPain Points: ' || COALESCE(p2.pain_points, ''),
      2000
    ) AS content,
    jsonb_build_object(
      'role', p2.role
    ) AS metadata,
    1 - (pe.embedding <=> query_embedding) AS similarity
  FROM persona_embeddings pe
  JOIN personas p2 ON p2.id = pe.persona_id
  WHERE pe.project_id = p_project_id
    AND 1 - (pe.embedding <=> query_embedding) >= match_threshold

  UNION ALL

  SELECT
    'product_doc'::TEXT AS context_type,
    d.id AS context_id,
    d.title AS title,
    LEFT(d.content, 2000) AS content,
    jsonb_build_object(
      'doc_type', d.doc_type,
      'source_url', d.source_url
    ) AS metadata,
    1 - (de.embedding <=> query_embedding) AS similarity
  FROM product_doc_embeddings de
  JOIN product_documents d ON d.id = de.product_doc_id
  WHERE de.project_id = p_project_id
    AND 1 - (de.embedding <=> query_embedding) >= match_threshold

  ORDER BY similarity DESC
  LIMIT match_count;
END;
$$;


--
-- Name: FUNCTION search_context_semantic(query_embedding public.vector, p_project_id uuid, match_threshold double precision, match_count integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_context_semantic(query_embedding public.vector, p_project_id uuid, match_threshold double precision, match_count integer) IS 'Semantic search across feedback, roadmap items, competitors, personas, and product documents';


--
-- Name: search_experiments_semantic(public.vector, double precision, integer, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_experiments_semantic(query_embedding public.vector, match_threshold double precision DEFAULT 0.7, match_count integer DEFAULT 5, p_project_id uuid DEFAULT NULL::uuid) RETURNS TABLE(experiment_id uuid, experiment_name text, hypothesis text, description text, status text, similarity double precision)
    LANGUAGE sql STABLE
    AS $$
  SELECT
    e.id,
    e.name,
    e.hypothesis,
    e.description,
    e.status,
    1 - (ee.embedding <=> query_embedding) as similarity
  FROM experiment_embeddings ee
  JOIN experiments e ON e.id = ee.experiment_id
  WHERE 1 - (ee.embedding <=> query_embedding) > match_threshold
    AND (p_project_id IS NULL OR e.project_id = p_project_id)
    AND ee.content_type = 'full_experiment'
  ORDER BY similarity DESC
  LIMIT match_count;
$$;


--
-- Name: search_feedback_semantic(public.vector, uuid, double precision, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_feedback_semantic(query_embedding public.vector, p_project_id uuid, match_threshold double precision DEFAULT 0.7, match_count integer DEFAULT 10) RETURNS TABLE(feedback_id uuid, content text, title text, status text, category text, upvotes integer, created_at timestamp with time zone, similarity double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    p.id AS feedback_id,
    p.description AS content,
    p.title,
    p.status,
    p.category,
    COALESCE(p.upvotes, 0) AS upvotes,
    p.created_at,
    1 - (fe.embedding <=> query_embedding) AS similarity
  FROM feedback_embeddings fe
  JOIN posts p ON p.id = fe.feedback_id
  WHERE fe.project_id = p_project_id
    AND 1 - (fe.embedding <=> query_embedding) >= match_threshold
  ORDER BY fe.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;


--
-- Name: FUNCTION search_feedback_semantic(query_embedding public.vector, p_project_id uuid, match_threshold double precision, match_count integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_feedback_semantic(query_embedding public.vector, p_project_id uuid, match_threshold double precision, match_count integer) IS 'Semantic search for feedback using vector similarity (cosine distance)';


--
-- Name: search_similar_feedback(uuid, public.vector, integer, double precision); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_similar_feedback(p_project_id uuid, p_query_embedding public.vector, p_limit integer DEFAULT 10, p_similarity_threshold double precision DEFAULT 0.65) RETURNS TABLE(post_id uuid, content text, votes integer, segment character varying, similarity double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    p.id AS post_id,
    p.content,
    COALESCE(p.upvotes, 0) AS votes,
    p.classification AS segment,
    1 - (pe.embedding <=> p_query_embedding) AS similarity
  FROM posts_embeddings pe
  JOIN posts p ON p.id = pe.post_id
  WHERE p.project_id = p_project_id
    AND 1 - (pe.embedding <=> p_query_embedding) >= p_similarity_threshold
  ORDER BY pe.embedding <=> p_query_embedding
  LIMIT p_limit;
END;
$$;


--
-- Name: FUNCTION search_similar_feedback(p_project_id uuid, p_query_embedding public.vector, p_limit integer, p_similarity_threshold double precision); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_similar_feedback(p_project_id uuid, p_query_embedding public.vector, p_limit integer, p_similarity_threshold double precision) IS 'Search for similar feedback using vector similarity (for RAG context retrieval)';


--
-- Name: search_similar_specs(uuid, public.vector, integer, double precision); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_similar_specs(p_project_id uuid, p_query_embedding public.vector, p_limit integer DEFAULT 10, p_similarity_threshold double precision DEFAULT 0.7) RETURNS TABLE(spec_id uuid, title character varying, preview text, similarity double precision, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    s.id AS spec_id,
    s.title,
    LEFT(s.content, 500) AS preview,
    1 - (se.embedding <=> p_query_embedding) AS similarity,
    s.created_at
  FROM spec_embeddings se
  JOIN specs s ON s.id = se.spec_id
  WHERE s.project_id = p_project_id
    AND 1 - (se.embedding <=> p_query_embedding) >= p_similarity_threshold
    AND s.status != 'archived' -- Exclude archived specs
  ORDER BY se.embedding <=> p_query_embedding
  LIMIT p_limit;
END;
$$;


--
-- Name: FUNCTION search_similar_specs(p_project_id uuid, p_query_embedding public.vector, p_limit integer, p_similarity_threshold double precision); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_similar_specs(p_project_id uuid, p_query_embedding public.vector, p_limit integer, p_similarity_threshold double precision) IS 'Search for similar specs using vector similarity (for RAG context retrieval)';


--
-- Name: send_gift_notification(uuid, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.send_gift_notification(p_gift_id uuid, p_notification_type character varying) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  -- This is a placeholder function
  -- In a real implementation, you would integrate with your email service
  -- (Resend, SendGrid, etc.) to send actual email notifications
  
  RETURN json_build_object(
    'success', true,
    'message', 'Notification queued',
    'notification_type', p_notification_type
  );
END;
$$;


--
-- Name: should_send_email(character varying, uuid, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.should_send_email(p_email character varying, p_user_id uuid, p_email_type character varying) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
declare
  prefs record;
  can_send boolean := false;
begin
  select * into prefs
  from email_preferences
  where (user_id = p_user_id or email = p_email)
  and unsubscribed_at is null;

  if not found then
    return true;
  end if;

  case p_email_type
    when 'status_change' then can_send := prefs.status_change_emails;
    when 'comment' then can_send := prefs.comment_reply_emails;
    when 'vote_milestone' then can_send := prefs.vote_milestone_emails;
    when 'team_feedback_alert' then can_send := prefs.team_feedback_alert_emails;
    when 'mention' then can_send := prefs.mention_emails;
    when 'weekly_digest' then can_send := prefs.weekly_digest;
    else can_send := true;
  end case;

  return coalesce(can_send, true);
end;
$$;


--
-- Name: sync_account_billing_from_project(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.sync_account_billing_from_project() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
DECLARE
  existing_plan TEXT;
BEGIN
  IF NEW.owner_id IS NULL THEN
    RETURN NEW;
  END IF;

  -- Get the existing plan if it exists
  SELECT plan INTO existing_plan
  FROM account_billing_profiles
  WHERE user_id = NEW.owner_id;

  -- Insert or update the billing profile
  INSERT INTO account_billing_profiles AS abp (
    user_id,
    plan,
    stripe_customer_id,
    subscription_id,
    subscription_status,
    current_period_end,
    cancel_at_period_end,
    trial_start_date,
    trial_end_date,
    trial_status,
    is_trial,
    trial_cancelled_at
  ) VALUES (
    NEW.owner_id,
    COALESCE(NEW.plan, 'free'),
    NEW.stripe_customer_id,
    NEW.subscription_id,
    NEW.subscription_status,
    NEW.current_period_end,
    COALESCE(NEW.cancel_at_period_end, false),
    NEW.trial_start_date,
    NEW.trial_end_date,
    NEW.trial_status,
    COALESCE(NEW.is_trial, false),
    NEW.trial_cancelled_at
  )
  ON CONFLICT (user_id) DO UPDATE SET
    -- Preserve pro plan if existing profile is pro and new project is not
    plan = CASE
      WHEN existing_plan = 'pro' AND EXCLUDED.plan <> 'pro' THEN existing_plan
      ELSE EXCLUDED.plan
    END,
    stripe_customer_id = EXCLUDED.stripe_customer_id,
    subscription_id = EXCLUDED.subscription_id,
    subscription_status = EXCLUDED.subscription_status,
    current_period_end = COALESCE(EXCLUDED.current_period_end, abp.current_period_end),
    cancel_at_period_end = EXCLUDED.cancel_at_period_end,
    trial_start_date = EXCLUDED.trial_start_date,
    trial_end_date = EXCLUDED.trial_end_date,
    trial_status = EXCLUDED.trial_status,
    is_trial = EXCLUDED.is_trial,
    trial_cancelled_at = EXCLUDED.trial_cancelled_at;

  RETURN NEW;
END;
$$;


--
-- Name: sync_jira_issue_status(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.sync_jira_issue_status() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- If issue status changed to Done, mark feedback as resolved
  IF NEW.status IN ('Done', 'Closed', 'Resolved') AND
     (OLD.status IS NULL OR OLD.status NOT IN ('Done', 'Closed', 'Resolved')) THEN

    UPDATE discovered_feedback
    SET
      responded_at = NOW(),
      response_content = 'Resolved via Jira issue ' || NEW.issue_key,
      response_url = NEW.issue_url
    WHERE id = NEW.feedback_id;

  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: track_manual_edits(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.track_manual_edits() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- If certain fields are updated and story was AI-generated, mark as manually edited
  IF OLD.generated_by_ai = true AND (
    OLD.title != NEW.title OR
    OLD.user_type != NEW.user_type OR
    OLD.user_goal != NEW.user_goal OR
    OLD.user_benefit != NEW.user_benefit OR
    OLD.acceptance_criteria::text != NEW.acceptance_criteria::text OR
    OLD.story_points IS DISTINCT FROM NEW.story_points OR
    OLD.technical_notes IS DISTINCT FROM NEW.technical_notes
  ) THEN
    NEW.manually_edited = true;
    NEW.manually_edited_at = NOW();
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: track_report_click(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.track_report_click(p_report_id uuid) RETURNS void
    LANGUAGE sql
    AS $$
  UPDATE stakeholder_reports
  SET click_count = click_count + 1
  WHERE id = p_report_id;
$$;


--
-- Name: track_report_open(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.track_report_open(p_report_id uuid) RETURNS void
    LANGUAGE sql
    AS $$
  UPDATE stakeholder_reports
  SET opened_at = COALESCE(opened_at, NOW())
  WHERE id = p_report_id AND opened_at IS NULL;
$$;


--
-- Name: trigger_enrich_feedback_on_customer_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_enrich_feedback_on_customer_change() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  PERFORM enrich_feedback_with_customer_data(NEW.project_id, NEW.email);
  RETURN NEW;
END;
$$;


--
-- Name: trigger_update_battlecard(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_battlecard() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Only update when deal status changes to won/lost
  IF (TG_OP = 'UPDATE' AND OLD.status = 'open' AND NEW.status IN ('won', 'lost')) OR
     (TG_OP = 'INSERT' AND NEW.status IN ('won', 'lost')) THEN
    PERFORM update_battlecard_stats(NEW.id);
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: trigger_update_cluster_theme_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_cluster_theme_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$

BEGIN

  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN

    IF NEW.cluster_id IS NOT NULL THEN

      PERFORM update_cluster_theme_count(NEW.cluster_id);

    END IF;

  END IF;

 

  IF TG_OP = 'DELETE' THEN

    IF OLD.cluster_id IS NOT NULL THEN

      PERFORM update_cluster_theme_count(OLD.cluster_id);

    END IF;

  END IF;

 

  IF TG_OP = 'UPDATE' AND OLD.cluster_id IS DISTINCT FROM NEW.cluster_id THEN

    IF OLD.cluster_id IS NOT NULL THEN

      PERFORM update_cluster_theme_count(OLD.cluster_id);

    END IF;

  END IF;

 

  RETURN NULL;

END;

$$;


--
-- Name: trigger_update_competitor_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_competitor_stats() RETURNS trigger
    LANGUAGE plpgsql
    AS $$

BEGIN

  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN

    PERFORM update_competitor_sentiment(NEW.competitor_id);

    PERFORM update_competitor_switches(NEW.competitor_id);

  END IF;

 

  IF TG_OP = 'DELETE' THEN

    PERFORM update_competitor_sentiment(OLD.competitor_id);

    PERFORM update_competitor_switches(OLD.competitor_id);

  END IF;

 

  RETURN NULL;

END;

$$;


--
-- Name: trigger_update_theme_metrics(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_theme_metrics() RETURNS trigger
    LANGUAGE plpgsql
    AS $$

BEGIN

  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN

    PERFORM update_theme_metrics(NEW.theme_id);

  END IF;

 

  IF TG_OP = 'DELETE' THEN

    PERFORM update_theme_metrics(OLD.theme_id);

  END IF;

 

  RETURN NULL;

END;

$$;


--
-- Name: update_action_queue_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_action_queue_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_adj_proposals_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_adj_proposals_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_ask_conversations_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_ask_conversations_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_battlecard_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_battlecard_stats(p_deal_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_deal RECORD;
  v_battlecard_id UUID;
BEGIN
  -- Get deal details
  SELECT * INTO v_deal
  FROM deals
  WHERE id = p_deal_id;

  -- Skip if no competitor or still open
  IF v_deal.competitor IS NULL OR v_deal.status = 'open' THEN
    RETURN;
  END IF;

  -- Get or create battlecard
  INSERT INTO deal_battlecards (project_id, competitor_name, competitor_product)
  VALUES (v_deal.project_id, v_deal.competitor, v_deal.competitor_product)
  ON CONFLICT (project_id, competitor_name)
  DO UPDATE SET updated_at = NOW()
  RETURNING id INTO v_battlecard_id;

  -- Update stats
  UPDATE deal_battlecards bc
  SET
    total_deals_competing = (
      SELECT COUNT(*)::INTEGER
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status IN ('won', 'lost')
    ),
    deals_won = (
      SELECT COUNT(*)::INTEGER
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status = 'won'
    ),
    deals_lost = (
      SELECT COUNT(*)::INTEGER
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status = 'lost'
    ),
    total_revenue_at_stake = (
      SELECT COALESCE(SUM(amount), 0)
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status IN ('won', 'lost')
    ),
    revenue_won = (
      SELECT COALESCE(SUM(amount), 0)
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status = 'won'
    ),
    revenue_lost = (
      SELECT COALESCE(SUM(amount), 0)
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status = 'lost'
    ),
    deal_ids = (
      SELECT ARRAY_AGG(id)
      FROM deals
      WHERE project_id = bc.project_id
        AND competitor = bc.competitor_name
        AND status IN ('won', 'lost')
    ),
    last_analyzed_at = NOW(),
    updated_at = NOW()
  WHERE id = v_battlecard_id;

  -- Update win rate
  UPDATE deal_battlecards
  SET win_rate = CASE
    WHEN (deals_won + deals_lost) > 0
    THEN ROUND((deals_won::NUMERIC / (deals_won + deals_lost)::NUMERIC * 100), 2)
    ELSE 0
  END
  WHERE id = v_battlecard_id;
END;
$$;


--
-- Name: update_call_ingests_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_call_ingests_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_call_records_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_call_records_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_cluster_theme_count(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_cluster_theme_count(p_cluster_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

BEGIN

  UPDATE theme_clusters

  SET

    theme_count = (

      SELECT COUNT(*)::INTEGER

      FROM themes

      WHERE cluster_id = p_cluster_id

    ),

    updated_at = NOW()

  WHERE id = p_cluster_id;

END;

$$;


--
-- Name: update_competitor_feature_metrics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_competitor_feature_metrics(p_product_id uuid) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Update mention counts and sentiment
  UPDATE competitor_features cf
  SET
    mention_count = (
      SELECT COUNT(*)
      FROM competitor_reviews cr
      WHERE cr.competitor_product_id = p_product_id
        AND cf.feature_name = ANY(cr.mentioned_features)
    ),
    positive_mentions = (
      SELECT COUNT(*)
      FROM competitor_reviews cr
      WHERE cr.competitor_product_id = p_product_id
        AND cf.feature_name = ANY(cr.mentioned_features)
        AND cr.sentiment_category IN ('positive', 'mixed')
    ),
    negative_mentions = (
      SELECT COUNT(*)
      FROM competitor_reviews cr
      WHERE cr.competitor_product_id = p_product_id
        AND cf.feature_name = ANY(cr.mentioned_features)
        AND cr.sentiment_category IN ('negative', 'mixed')
    ),
    last_mentioned_at = (
      SELECT MAX(cr.published_at)
      FROM competitor_reviews cr
      WHERE cr.competitor_product_id = p_product_id
        AND cf.feature_name = ANY(cr.mentioned_features)
    ),
    updated_at = NOW()
  WHERE cf.competitor_product_id = p_product_id;
END;
$$;


--
-- Name: update_competitor_sentiment(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_competitor_sentiment(p_competitor_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

DECLARE

  v_avg_vs_you DECIMAL(3,2);

  v_avg_about_them DECIMAL(3,2);

BEGIN

  SELECT

    COALESCE(ROUND(AVG(sentiment_vs_you)::NUMERIC, 2), 0),

    COALESCE(ROUND(AVG(sentiment_about_competitor)::NUMERIC, 2), 0)

  INTO v_avg_vs_you, v_avg_about_them

  FROM competitive_mentions

  WHERE competitor_id = p_competitor_id;

 

  UPDATE competitors

  SET

    avg_sentiment_vs_you = v_avg_vs_you,

    avg_sentiment_about_them = v_avg_about_them,

    updated_at = NOW()

  WHERE id = p_competitor_id;

END;

$$;


--
-- Name: update_competitor_switches(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_competitor_switches(p_competitor_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

BEGIN

  UPDATE competitors

  SET

    switches_to_you = (

      SELECT COUNT(*)::INTEGER

      FROM competitive_mentions

      WHERE competitor_id = p_competitor_id AND mention_type = 'switch_from'

    ),

    switches_from_you = (

      SELECT COUNT(*)::INTEGER

      FROM competitive_mentions

      WHERE competitor_id = p_competitor_id AND mention_type = 'switch_to'

    ),

    updated_at = NOW()

  WHERE id = p_competitor_id;

END;

$$;


--
-- Name: update_correlation_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_correlation_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_customer_feedback_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_customer_feedback_stats() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.customer_id IS NOT NULL THEN
    UPDATE customers SET
      total_feedback_count = (
        SELECT COUNT(*) FROM unified_feedback_items 
        WHERE customer_id = NEW.customer_id AND is_duplicate = false
      ),
      average_sentiment = (
        SELECT AVG(sentiment_score) FROM unified_feedback_items 
        WHERE customer_id = NEW.customer_id AND sentiment_score IS NOT NULL AND is_duplicate = false
      ),
      last_feedback_at = NEW.original_created_at,
      updated_at = NOW()
    WHERE id = NEW.customer_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_customer_profiles_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_customer_profiles_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_daily_briefings_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_daily_briefings_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_experiments_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_experiments_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_feature_impact_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_feature_impact_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- Name: update_feature_outcomes_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_feature_outcomes_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- Name: update_feedback_metadata_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_feedback_metadata_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_health_derived_fields(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_health_derived_fields() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.health_grade := health_score_to_grade(NEW.health_score);
  NEW.churn_risk := health_score_to_risk(NEW.health_score);
  NEW.updated_at := NOW();
  
  -- Record history if score changed significantly (>= 5 points)
  IF TG_OP = 'UPDATE' AND ABS(NEW.health_score - OLD.health_score) >= 5 THEN
    INSERT INTO customer_health_history (
      customer_health_id,
      project_id,
      health_score,
      churn_risk,
      engagement_score,
      sentiment_score,
      support_score,
      product_usage_score,
      payment_score,
      change_reason
    ) VALUES (
      NEW.id,
      NEW.project_id,
      NEW.health_score,
      NEW.churn_risk,
      NEW.engagement_score,
      NEW.sentiment_score,
      NEW.support_score,
      NEW.product_usage_score,
      NEW.payment_score,
      CASE 
        WHEN NEW.health_score > OLD.health_score THEN 'Health improved'
        ELSE 'Health declined'
      END
    );
    
    -- Store previous score
    NEW.previous_health_score := OLD.health_score;
  END IF;
  
  RETURN NEW;
END;
$$;


--
-- Name: update_health_scores_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_health_scores_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_hunter_scan_stats(uuid, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_hunter_scan_stats(p_scan_id uuid, p_discovered integer DEFAULT 0, p_relevant integer DEFAULT 0, p_classified integer DEFAULT 0) RETURNS void
    LANGUAGE sql
    AS $$
  UPDATE hunter_scans 
  SET total_discovered = total_discovered + p_discovered,
      total_relevant = total_relevant + p_relevant,
      total_classified = total_classified + p_classified
  WHERE id = p_scan_id
$$;


--
-- Name: update_hunter_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_hunter_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_integration_credentials_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_integration_credentials_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_jira_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_jira_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_next_run_time(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_next_run_time() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Only update next_run_at if active and schedule fields changed (or INSERT)
  IF NEW.is_active = true AND (
    TG_OP = 'INSERT' OR
    OLD.frequency IS DISTINCT FROM NEW.frequency OR
    OLD.time_of_day IS DISTINCT FROM NEW.time_of_day OR
    OLD.day_of_week IS DISTINCT FROM NEW.day_of_week OR
    OLD.day_of_month IS DISTINCT FROM NEW.day_of_month OR
    OLD.timezone IS DISTINCT FROM NEW.timezone
  ) THEN
    NEW.next_run_at := calculate_next_run_time(
      NEW.frequency,
      NEW.time_of_day,
      NEW.day_of_week,
      NEW.day_of_month,
      NEW.timezone,
      COALESCE(NEW.last_run_at, NOW())
    );
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: update_personas_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_personas_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_platform_stats(uuid, boolean, integer, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_platform_stats(p_integration_id uuid, p_success boolean, p_items_found integer, p_error_message text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE platform_integrations
  SET
    -- INCREMENT total_scans (was possibly decrementing before)
    total_scans = COALESCE(total_scans, 0) + 1,
    successful_scans = CASE 
      WHEN p_success THEN COALESCE(successful_scans, 0) + 1 
      ELSE successful_scans 
    END,
    failed_scans = CASE 
      WHEN NOT p_success THEN COALESCE(failed_scans, 0) + 1 
      ELSE failed_scans 
    END,
    total_items_found = COALESCE(total_items_found, 0) + p_items_found,
    last_scan_at = NOW(),
    last_error = CASE WHEN p_success THEN NULL ELSE p_error_message END,
    health_status = CASE 
      WHEN p_success THEN 'healthy'
      ELSE 'error'
    END,
    last_scan_status = CASE 
      WHEN p_success THEN 'success'
      ELSE 'failed'
    END,
    updated_at = NOW()
  WHERE id = p_integration_id;
END;
$$;


--
-- Name: update_pm_assignment_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_pm_assignment_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_poll_vote_counts(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_poll_vote_counts() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    -- Update poll total
    UPDATE polls 
    SET vote_count = vote_count + 1,
        unique_voter_count = (
          SELECT COUNT(DISTINCT voter_hash) FROM poll_votes WHERE poll_id = NEW.poll_id
        ),
        updated_at = NOW()
    WHERE id = NEW.poll_id;
    
    -- Update option count
    UPDATE poll_options
    SET vote_count = vote_count + 1,
        weighted_vote_count = weighted_vote_count + COALESCE(NEW.customer_mrr, 1)
    WHERE id = NEW.option_id;
    
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    -- Update poll total
    UPDATE polls 
    SET vote_count = GREATEST(0, vote_count - 1),
        unique_voter_count = (
          SELECT COUNT(DISTINCT voter_hash) FROM poll_votes WHERE poll_id = OLD.poll_id
        ),
        updated_at = NOW()
    WHERE id = OLD.poll_id;
    
    -- Update option count
    UPDATE poll_options
    SET vote_count = GREATEST(0, vote_count - 1),
        weighted_vote_count = GREATEST(0, weighted_vote_count - COALESCE(OLD.customer_mrr, 1))
    WHERE id = OLD.option_id;
    
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_polls_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_polls_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_post_comment_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_post_comment_count() RETURNS trigger
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE posts SET comment_count = comment_count + 1 WHERE id = NEW.post_id;
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE posts SET comment_count = comment_count - 1 WHERE id = OLD.post_id;
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_post_priority_counts(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_post_priority_counts(p_post_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
declare
  v_must_have integer := 0;
  v_important integer := 0;
  v_nice_to_have integer := 0;
  v_total_score integer := 0;
begin
  select
    coalesce(sum(case when coalesce(v.priority, vm.priority) = 'must_have' then 1 else 0 end), 0),
    coalesce(sum(case when coalesce(v.priority, vm.priority) = 'important' then 1 else 0 end), 0),
    coalesce(sum(case when coalesce(v.priority, vm.priority) = 'nice_to_have' then 1 else 0 end), 0)
  into v_must_have, v_important, v_nice_to_have
  from votes v
  left join vote_metadata vm on vm.vote_id = v.id
  where v.post_id = p_post_id;

  v_total_score := calculate_priority_score(
    coalesce(v_must_have, 0),
    coalesce(v_important, 0),
    coalesce(v_nice_to_have, 0)
  );

  update posts set
    must_have_votes = coalesce(v_must_have, 0),
    important_votes = coalesce(v_important, 0),
    nice_to_have_votes = coalesce(v_nice_to_have, 0),
    total_priority_score = coalesce(v_total_score, 0),
    updated_at = now()
  where id = p_post_id;
end;
$$;


--
-- Name: update_post_vote_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_post_vote_count() RETURNS trigger
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE posts SET vote_count = vote_count + 1 WHERE id = NEW.post_id;
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE posts SET vote_count = vote_count - 1 WHERE id = OLD.post_id;
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_prd_risk_alerts_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_prd_risk_alerts_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_product_documents_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_product_documents_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_project_notification_recipients_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_project_notification_recipients_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
begin
  new.updated_at = now();
  return new;
end;
$$;


--
-- Name: update_retro_card_vote_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_retro_card_vote_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE retro_cards SET vote_count = vote_count + 1 WHERE id = NEW.card_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE retro_cards SET vote_count = vote_count - 1 WHERE id = OLD.card_id;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_roadmap_suggestions_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_roadmap_suggestions_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- Name: update_scheduled_query_next_run(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_scheduled_query_next_run() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.next_run_at := calculate_next_run_time(
    NEW.frequency,
    NEW.day_of_week,
    NEW.day_of_month,
    NEW.time_utc,
    COALESCE(NEW.last_run_at, NOW())
  );
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_similarity_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_similarity_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_slack_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_slack_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_specs_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_specs_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_sprint_points(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_sprint_points() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_sprint_id UUID;
BEGIN
  -- Determine which sprint(s) to update
  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
    v_sprint_id := NEW.sprint_id;
  END IF;

  IF TG_OP = 'DELETE' OR (TG_OP = 'UPDATE' AND OLD.sprint_id IS DISTINCT FROM NEW.sprint_id) THEN
    -- Update old sprint if story was removed or moved
    IF OLD.sprint_id IS NOT NULL THEN
      UPDATE sprints
      SET current_points = (
        SELECT COALESCE(SUM(story_points), 0)
        FROM user_stories
        WHERE sprint_id = OLD.sprint_id
      )
      WHERE id = OLD.sprint_id;
    END IF;
  END IF;

  -- Update new sprint
  IF v_sprint_id IS NOT NULL THEN
    UPDATE sprints
    SET current_points = (
      SELECT COALESCE(SUM(story_points), 0)
      FROM user_stories
      WHERE sprint_id = v_sprint_id
    )
    WHERE id = v_sprint_id;
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: update_stakeholder_queries_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_stakeholder_queries_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_stakeholder_table_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_stakeholder_table_stats() RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  ANALYZE posts;
  ANALYZE sentiment_analysis;
  ANALYZE themes;
  ANALYZE stakeholder_queries;
  ANALYZE timeline_events;

  -- Log completion
  RAISE NOTICE 'Table statistics updated for stakeholder intelligence tables';
END;
$$;


--
-- Name: update_stakeholders_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_stakeholders_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_strategy_shifts_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_strategy_shifts_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_survey_response_counts(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_survey_response_counts() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
    UPDATE surveys 
    SET response_count = (
          SELECT COUNT(*) FROM survey_responses WHERE survey_id = NEW.survey_id AND is_complete = true
        ),
        completion_rate = (
          SELECT ROUND(
            (COUNT(*) FILTER (WHERE is_complete = true)::NUMERIC / NULLIF(COUNT(*), 0)) * 100, 1
          ) FROM survey_responses WHERE survey_id = NEW.survey_id
        ),
        avg_sentiment = (
          SELECT AVG(sentiment_score) FROM survey_responses 
          WHERE survey_id = NEW.survey_id AND sentiment_score IS NOT NULL
        ),
        updated_at = NOW()
    WHERE id = NEW.survey_id;
    
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE surveys 
    SET response_count = GREATEST(0, response_count - 1),
        updated_at = NOW()
    WHERE id = OLD.survey_id;
    
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_team_capacity_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_team_capacity_updated_at() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public'
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- Name: update_theme_metrics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_theme_metrics(p_theme_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$

DECLARE

  v_frequency INTEGER;

  v_avg_sentiment DECIMAL(3, 2);

  v_first_seen TIMESTAMPTZ;

  v_last_seen TIMESTAMPTZ;

BEGIN

  -- Calculate metrics from associated feedback

  SELECT

    COUNT(*)::INTEGER,

    COALESCE(ROUND(AVG(sa.sentiment_score)::NUMERIC, 2), 0),

    MIN(p.created_at),

    MAX(p.created_at)

  INTO v_frequency, v_avg_sentiment, v_first_seen, v_last_seen

  FROM feedback_themes ft

  INNER JOIN posts p ON ft.feedback_id = p.id

  LEFT JOIN sentiment_analysis sa ON p.id = sa.post_id

  WHERE ft.theme_id = p_theme_id;

 

  -- Update theme metrics

  UPDATE themes

  SET

    frequency = v_frequency,

    avg_sentiment = v_avg_sentiment,

    first_seen = COALESCE(v_first_seen, first_seen),

    last_seen = COALESCE(v_last_seen, last_seen),

    updated_at = NOW()

  WHERE id = p_theme_id;

END;

$$;


--
-- Name: update_timeline_events_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_timeline_events_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_ufi_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_ufi_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector := 
    setweight(to_tsvector('english', COALESCE(NEW.title, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.content_plain, NEW.content, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.author_name, '')), 'C') ||
    setweight(to_tsvector('english', COALESCE(array_to_string(NEW.tags, ' '), '')), 'C');
  RETURN NEW;
END;
$$;


--
-- Name: update_updated_at_column(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_user_intelligence_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_user_intelligence_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_user_stories_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_user_stories_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_vote_metadata_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_vote_metadata_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    SET search_path TO 'public', 'pg_temp'
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_war_room_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_war_room_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: upsert_customer_profile(uuid, text, text, text, text, numeric, numeric, text, text, text, text, text, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.upsert_customer_profile(p_project_id uuid, p_email text, p_external_id text DEFAULT NULL::text, p_name text DEFAULT NULL::text, p_company_name text DEFAULT NULL::text, p_mrr numeric DEFAULT NULL::numeric, p_arr numeric DEFAULT NULL::numeric, p_plan_tier text DEFAULT NULL::text, p_segment text DEFAULT NULL::text, p_status text DEFAULT 'active'::text, p_crm_provider text DEFAULT NULL::text, p_crm_url text DEFAULT NULL::text, p_crm_data jsonb DEFAULT NULL::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_profile_id UUID;
BEGIN
  -- Upsert customer profile
  INSERT INTO customer_profiles (
    project_id,
    email,
    external_customer_id,
    name,
    company_name,
    mrr,
    arr,
    plan_tier,
    segment,
    status,
    crm_provider,
    crm_url,
    crm_data,
    last_synced_at
  ) VALUES (
    p_project_id,
    LOWER(p_email),
    p_external_id,
    p_name,
    p_company_name,
    p_mrr,
    p_arr,
    p_plan_tier,
    p_segment,
    p_status,
    p_crm_provider,
    p_crm_url,
    p_crm_data,
    NOW()
  )
  ON CONFLICT (project_id, email)
  DO UPDATE SET
    external_customer_id = COALESCE(EXCLUDED.external_customer_id, customer_profiles.external_customer_id),
    name = COALESCE(EXCLUDED.name, customer_profiles.name),
    company_name = COALESCE(EXCLUDED.company_name, customer_profiles.company_name),
    mrr = COALESCE(EXCLUDED.mrr, customer_profiles.mrr),
    arr = COALESCE(EXCLUDED.arr, customer_profiles.arr),
    plan_tier = COALESCE(EXCLUDED.plan_tier, customer_profiles.plan_tier),
    segment = COALESCE(EXCLUDED.segment, customer_profiles.segment),
    status = EXCLUDED.status,
    crm_provider = COALESCE(EXCLUDED.crm_provider, customer_profiles.crm_provider),
    crm_url = COALESCE(EXCLUDED.crm_url, customer_profiles.crm_url),
    crm_data = COALESCE(EXCLUDED.crm_data, customer_profiles.crm_data),
    last_synced_at = NOW(),
    updated_at = NOW()
  RETURNING id INTO v_profile_id;

  -- Enrich related feedback
  PERFORM enrich_feedback_with_customer_data(p_project_id, LOWER(p_email));

  RETURN v_profile_id;
END;
$$;


--
-- Name: validate_discount_code(character varying, uuid, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_discount_code(p_code character varying, p_user_id uuid, p_amount numeric) RETURNS json
    LANGUAGE plpgsql SECURITY DEFINER
    SET search_path TO 'public', 'pg_temp'
    AS $$
DECLARE
  discount_record discount_codes%ROWTYPE;
  usage_count INTEGER;
  discount_amount DECIMAL(10,2);
  final_discount DECIMAL(10,2);
  user_email VARCHAR(255);
BEGIN
  -- Get the discount code
  SELECT * INTO discount_record FROM discount_codes 
  WHERE code = p_code 
  AND is_active = true 
  AND NOW() BETWEEN valid_from AND COALESCE(valid_until, NOW() + INTERVAL '1 year');
  
  IF NOT FOUND THEN
    RETURN json_build_object('valid', false, 'error', 'Invalid or expired discount code');
  END IF;
  
  -- Get user email for email-specific code validation
  SELECT email INTO user_email FROM users WHERE id = p_user_id;
  
  -- Check if code is email-specific and if user email matches
  IF discount_record.target_email IS NOT NULL AND discount_record.target_email != user_email THEN
    RETURN json_build_object('valid', false, 'error', 'This discount code is not valid for your account');
  END IF;
  
  -- Check usage limit
  IF discount_record.usage_limit IS NOT NULL THEN
    SELECT COUNT(*) INTO usage_count FROM discount_code_usage 
    WHERE discount_code_id = discount_record.id;
    
    IF usage_count >= discount_record.usage_limit THEN
      RETURN json_build_object('valid', false, 'error', 'Discount code usage limit exceeded');
    END IF;
  END IF;
  
  -- Check if user already used this code
  SELECT COUNT(*) INTO usage_count FROM discount_code_usage 
  WHERE discount_code_id = discount_record.id AND user_id = p_user_id;
  
  IF usage_count > 0 THEN
    RETURN json_build_object('valid', false, 'error', 'You have already used this discount code');
  END IF;
  
  -- Check minimum amount
  IF p_amount < discount_record.min_amount THEN
    RETURN json_build_object('valid', false, 'error', 'Minimum amount not met');
  END IF;
  
  -- Calculate discount amount
  IF discount_record.discount_type = 'percentage' THEN
    discount_amount := p_amount * (discount_record.discount_value / 100);
  ELSE
    discount_amount := discount_record.discount_value;
  END IF;
  
  -- Apply maximum discount limit
  IF discount_record.max_discount IS NOT NULL THEN
    final_discount := LEAST(discount_amount, discount_record.max_discount);
  ELSE
    final_discount := discount_amount;
  END IF;
  
  RETURN json_build_object(
    'valid', true,
    'discount_amount', final_discount,
    'discount_code_id', discount_record.id,
    'description', discount_record.description
  );
END;
$$;


--
-- Name: account_billing_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_billing_profiles (
    user_id uuid NOT NULL,
    plan text DEFAULT 'free'::text NOT NULL,
    stripe_customer_id text,
    subscription_id text,
    subscription_status text,
    current_period_end timestamp with time zone,
    cancel_at_period_end boolean DEFAULT false NOT NULL,
    billing_cycle text,
    trial_start_date timestamp with time zone,
    trial_end_date timestamp with time zone,
    trial_status text,
    is_trial boolean DEFAULT false NOT NULL,
    trial_cancelled_at timestamp with time zone,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
    CONSTRAINT account_billing_profiles_plan_check CHECK ((plan = ANY (ARRAY['free'::text, 'pro'::text, 'premium'::text])))
);


--
-- Name: action_recommendations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.action_recommendations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    feedback_ids uuid[] NOT NULL,
    issue_summary text NOT NULL,
    issue_category text,
    mention_count integer DEFAULT 0,
    avg_sentiment numeric(3,2),
    sentiment_trend text,
    revenue_at_risk_estimate numeric(12,2),
    affected_users_estimate integer,
    business_impact text,
    priority public.action_priority DEFAULT 'medium'::public.action_priority,
    priority_score numeric(5,2),
    priority_reason text,
    suggested_actions jsonb DEFAULT '[]'::jsonb,
    draft_response text,
    draft_response_tone text DEFAULT 'professional'::text,
    status public.action_status DEFAULT 'pending'::public.action_status,
    assigned_to uuid,
    viewed_at timestamp with time zone,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    dismissed_at timestamp with time zone,
    dismissal_reason text,
    actual_actions_taken jsonb DEFAULT '[]'::jsonb,
    outcome_notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE action_recommendations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.action_recommendations IS 'AI-generated action items based on feedback patterns';


--
-- Name: COLUMN action_recommendations.revenue_at_risk_estimate; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.action_recommendations.revenue_at_risk_estimate IS 'Estimated revenue at risk in USD if issue not addressed';


--
-- Name: admin_email_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.admin_email_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    admin_email character varying(255) NOT NULL,
    project_id uuid,
    high_priority_posts boolean DEFAULT true,
    suspicious_activity boolean DEFAULT true,
    weekly_analytics boolean DEFAULT true,
    billing_reminders boolean DEFAULT true,
    analytics_frequency character varying(20) DEFAULT 'weekly'::character varying,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT admin_email_preferences_analytics_frequency_check CHECK (((analytics_frequency)::text = ANY ((ARRAY['daily'::character varying, 'weekly'::character varying, 'monthly'::character varying, 'never'::character varying])::text[])))
);


--
-- Name: feedback_metadata; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feedback_metadata (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid NOT NULL,
    submitted_by_admin_id uuid NOT NULL,
    submitted_by_admin_email character varying(255),
    submitted_by_admin_name character varying(255),
    customer_email character varying(255) NOT NULL,
    customer_name character varying(255) NOT NULL,
    customer_company character varying(255),
    priority character varying(50) NOT NULL,
    feedback_source character varying(100),
    internal_note text,
    customer_notified boolean DEFAULT false,
    customer_notified_at timestamp with time zone,
    verified_by_customer boolean DEFAULT false,
    verified_at timestamp with time zone,
    verification_token character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: posts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.posts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    board_id uuid,
    title character varying(500) NOT NULL,
    description text NOT NULL,
    status character varying(20) DEFAULT 'open'::character varying,
    author_email character varying(255),
    author_name character varying(255),
    author_id uuid,
    vote_count integer DEFAULT 0,
    comment_count integer DEFAULT 0,
    duplicate_of uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    ai_category character varying(50),
    ai_confidence numeric(3,2),
    ai_reasoning text,
    category text,
    ai_categorized boolean DEFAULT false,
    estimated_completion timestamp with time zone,
    completion_date timestamp with time zone,
    priority_score numeric(3,1) DEFAULT 0.0,
    priority_reason text,
    ai_analyzed_at timestamp with time zone,
    priority character varying(10) DEFAULT 'medium'::character varying,
    effort_estimate character varying(5) DEFAULT 'M'::character varying,
    progress_percentage integer DEFAULT 0,
    estimated_timeline character varying(100),
    tags text[],
    last_updated timestamp with time zone DEFAULT now(),
    must_have_votes integer DEFAULT 0,
    important_votes integer DEFAULT 0,
    nice_to_have_votes integer DEFAULT 0,
    total_priority_score integer DEFAULT 0,
    ai_duplicate_checked_at timestamp with time zone,
    call_record_id uuid,
    call_metadata jsonb DEFAULT '{}'::jsonb,
    arr_hint numeric(12,2),
    competitor_mentioned text,
    objection_type text,
    timestamp_text text,
    assigned_pm_id uuid,
    assigned_at timestamp with time zone,
    auto_assigned boolean DEFAULT false,
    merged_into uuid,
    content text,
    user_id uuid,
    CONSTRAINT posts_ai_confidence_check CHECK (((ai_confidence >= (0)::numeric) AND (ai_confidence <= (1)::numeric))),
    CONSTRAINT posts_status_check CHECK (((status)::text = ANY ((ARRAY['open'::character varying, 'planned'::character varying, 'in_progress'::character varying, 'done'::character varying, 'declined'::character varying])::text[])))
);


--
-- Name: COLUMN posts.ai_category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.ai_category IS 'AI-generated category for the post (Bug, Feature Request, Improvement, etc.)';


--
-- Name: COLUMN posts.ai_confidence; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.ai_confidence IS 'AI confidence score for the categorization (0.0 to 1.0)';


--
-- Name: COLUMN posts.ai_reasoning; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.ai_reasoning IS 'AI explanation for why this category was chosen';


--
-- Name: COLUMN posts.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.category IS 'AI-generated category for the post (Bug, Feature Request, Improvement, etc.)';


--
-- Name: COLUMN posts.ai_categorized; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.ai_categorized IS 'Boolean flag indicating if this post has been processed by AI';


--
-- Name: COLUMN posts.completion_date; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.completion_date IS 'Actual or estimated completion date';


--
-- Name: COLUMN posts.priority; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.priority IS 'Priority level: low, medium, high, critical';


--
-- Name: COLUMN posts.effort_estimate; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.effort_estimate IS 'Effort estimate using T-shirt sizing: XS, S, M, L, XL';


--
-- Name: COLUMN posts.progress_percentage; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.progress_percentage IS 'Completion percentage (0-100) for in-progress items';


--
-- Name: COLUMN posts.estimated_timeline; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.estimated_timeline IS 'Human-readable timeline estimate (e.g., "Q2 2024", "Next month")';


--
-- Name: COLUMN posts.tags; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.tags IS 'Array of tags for categorization and filtering';


--
-- Name: COLUMN posts.last_updated; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.last_updated IS 'Last time this post was updated';


--
-- Name: COLUMN posts.call_record_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.call_record_id IS 'Link to originating call record if post was generated from a call';


--
-- Name: COLUMN posts.call_metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.call_metadata IS 'Additional metadata from call analysis (timestamps, context, etc.)';


--
-- Name: COLUMN posts.arr_hint; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.posts.arr_hint IS 'Annual Recurring Revenue hint from call context';


--
-- Name: projects; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.projects (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name character varying(255) NOT NULL,
    slug character varying(255) NOT NULL,
    owner_id uuid,
    plan character varying(20) DEFAULT 'free'::character varying,
    stripe_customer_id character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    subscription_status character varying(50),
    subscription_id character varying(255),
    current_period_end timestamp with time zone,
    cancel_at_period_end boolean DEFAULT false,
    downgraded_at timestamp with time zone,
    custom_domain character varying(255),
    domain_verified boolean DEFAULT false,
    domain_verification_token character varying(255),
    domain_verification_method character varying(50) DEFAULT 'dns_txt'::character varying,
    domain_verified_at timestamp with time zone,
    domain_status character varying(50) DEFAULT 'pending'::character varying,
    trial_start_date timestamp with time zone,
    trial_end_date timestamp with time zone,
    trial_cancelled_at timestamp with time zone,
    trial_status character varying(50) DEFAULT 'none'::character varying,
    is_trial boolean DEFAULT false,
    roadmap_title character varying(200),
    roadmap_description text,
    roadmap_logo_url text,
    roadmap_brand_color character varying(7) DEFAULT '#3B82F6'::character varying,
    roadmap_custom_css text,
    roadmap_show_progress boolean DEFAULT true,
    roadmap_show_effort boolean DEFAULT true,
    roadmap_show_timeline boolean DEFAULT true,
    roadmap_allow_anonymous_votes boolean DEFAULT true,
    roadmap_subscribe_emails boolean DEFAULT false,
    smart_replies_enabled boolean DEFAULT true,
    smart_replies_config jsonb DEFAULT '{"max_replies": 3, "reply_types": ["follow_up", "clarification", "details"]}'::jsonb,
    pro_welcome_email_sent_at timestamp with time zone,
    cancellation_email_sent_at timestamp with time zone,
    CONSTRAINT check_subscription_status CHECK (((subscription_status)::text = ANY ((ARRAY['active'::character varying, 'canceled'::character varying, 'past_due'::character varying, 'incomplete'::character varying, 'incomplete_expired'::character varying, 'trialing'::character varying, 'unpaid'::character varying])::text[]))),
    CONSTRAINT projects_plan_check CHECK (((plan)::text = ANY ((ARRAY['free'::character varying, 'pro'::character varying, 'premium'::character varying])::text[])))
);


--
-- Name: COLUMN projects.subscription_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.subscription_status IS 'Current subscription status from Stripe';


--
-- Name: COLUMN projects.subscription_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.subscription_id IS 'Stripe subscription ID';


--
-- Name: COLUMN projects.current_period_end; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.current_period_end IS 'End of current billing period';


--
-- Name: COLUMN projects.cancel_at_period_end; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.cancel_at_period_end IS 'Whether subscription will cancel at period end';


--
-- Name: COLUMN projects.downgraded_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.downgraded_at IS 'When the subscription was downgraded to free';


--
-- Name: COLUMN projects.custom_domain; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.custom_domain IS 'Custom domain for the project (e.g., feedback.company.com)';


--
-- Name: COLUMN projects.domain_verified; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.domain_verified IS 'Whether the custom domain has been verified';


--
-- Name: COLUMN projects.domain_verification_token; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.domain_verification_token IS 'Token for domain verification';


--
-- Name: COLUMN projects.domain_verification_method; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.domain_verification_method IS 'Method used for domain verification (dns_txt, dns_cname, file)';


--
-- Name: COLUMN projects.domain_verified_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.domain_verified_at IS 'When the domain was verified';


--
-- Name: COLUMN projects.domain_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.domain_status IS 'Domain verification status (pending, verified, failed, expired)';


--
-- Name: COLUMN projects.trial_start_date; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.trial_start_date IS 'When the trial period started';


--
-- Name: COLUMN projects.trial_end_date; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.trial_end_date IS 'When the trial period ends';


--
-- Name: COLUMN projects.trial_cancelled_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.trial_cancelled_at IS 'When the trial was cancelled by user';


--
-- Name: COLUMN projects.trial_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.trial_status IS 'Trial status: none, active, cancelled, expired, converted';


--
-- Name: COLUMN projects.is_trial; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.is_trial IS 'Whether the current subscription is in trial period';


--
-- Name: COLUMN projects.roadmap_title; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_title IS 'Custom title for the roadmap page';


--
-- Name: COLUMN projects.roadmap_description; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_description IS 'Mission statement or description for the roadmap';


--
-- Name: COLUMN projects.roadmap_logo_url; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_logo_url IS 'URL to company logo for roadmap branding';


--
-- Name: COLUMN projects.roadmap_brand_color; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_brand_color IS 'Brand color for roadmap theming (hex code)';


--
-- Name: COLUMN projects.roadmap_custom_css; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_custom_css IS 'Custom CSS for advanced theming';


--
-- Name: COLUMN projects.roadmap_show_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_show_progress IS 'Whether to show progress bars on roadmap items';


--
-- Name: COLUMN projects.roadmap_show_effort; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_show_effort IS 'Whether to show effort estimates';


--
-- Name: COLUMN projects.roadmap_show_timeline; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_show_timeline IS 'Whether to show timeline estimates';


--
-- Name: COLUMN projects.roadmap_allow_anonymous_votes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_allow_anonymous_votes IS 'Whether anonymous users can vote';


--
-- Name: COLUMN projects.roadmap_subscribe_emails; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.projects.roadmap_subscribe_emails IS 'Whether to allow email subscriptions for updates';


--
-- Name: admin_feedback_on_behalf; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.admin_feedback_on_behalf WITH (security_barrier='true', security_invoker='true') AS
 SELECT p.id AS post_id,
    p.title AS post_title,
    p.description AS post_description,
    p.status,
    p.project_id,
    pr.name AS project_name,
    pr.slug AS project_slug,
    count(fm.id) AS total_feedback_count,
    count(*) FILTER (WHERE ((fm.priority)::text = 'must_have'::text)) AS must_have_count,
    count(*) FILTER (WHERE ((fm.priority)::text = 'important'::text)) AS important_count,
    count(*) FILTER (WHERE ((fm.priority)::text = 'nice_to_have'::text)) AS nice_to_have_count,
    count(DISTINCT fm.customer_company) FILTER (WHERE (fm.customer_company IS NOT NULL)) AS unique_companies,
    count(DISTINCT fm.customer_email) AS unique_customers,
    p.created_at,
    p.updated_at
   FROM ((public.posts p
     JOIN public.projects pr ON ((p.project_id = pr.id)))
     LEFT JOIN public.feedback_metadata fm ON ((p.id = fm.post_id)))
  GROUP BY p.id, p.title, p.description, p.status, p.project_id, pr.name, pr.slug, p.created_at, p.updated_at;


--
-- Name: VIEW admin_feedback_on_behalf; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.admin_feedback_on_behalf IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: vote_metadata; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vote_metadata (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    vote_id uuid NOT NULL,
    voted_by_admin_id uuid NOT NULL,
    voted_by_admin_email character varying(255),
    voted_by_admin_name character varying(255),
    customer_email character varying(255) NOT NULL,
    customer_name character varying(255) NOT NULL,
    customer_company character varying(255),
    priority character varying(50) NOT NULL,
    vote_source character varying(100),
    internal_note text,
    customer_notified boolean DEFAULT false,
    customer_notified_at timestamp with time zone,
    verified_by_customer boolean DEFAULT false,
    verified_at timestamp with time zone,
    verification_token character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: votes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.votes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid,
    user_id uuid,
    ip_address text,
    user_agent text,
    created_at timestamp with time zone DEFAULT now(),
    anonymous_id character varying(255),
    voter_hash character varying(255),
    priority text DEFAULT 'important'::text,
    voter_email text,
    CONSTRAINT votes_priority_check CHECK ((priority = ANY (ARRAY['must_have'::text, 'important'::text, 'nice_to_have'::text])))
);


--
-- Name: admin_priority_votes; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.admin_priority_votes WITH (security_barrier='true', security_invoker='true') AS
 SELECT p.id AS post_id,
    p.title AS post_title,
    p.status,
    p.project_id,
    count(v.id) AS total_votes,
    p.must_have_votes,
    p.important_votes,
    p.nice_to_have_votes,
    p.total_priority_score,
    count(DISTINCT vm.customer_company) FILTER (WHERE (vm.customer_company IS NOT NULL)) AS unique_companies,
    count(DISTINCT vm.customer_email) AS unique_customers,
    p.created_at,
    p.updated_at
   FROM ((public.posts p
     LEFT JOIN public.votes v ON ((p.id = v.post_id)))
     LEFT JOIN public.vote_metadata vm ON ((v.id = vm.vote_id)))
  GROUP BY p.id, p.title, p.status, p.project_id, p.must_have_votes, p.important_votes, p.nice_to_have_votes, p.total_priority_score, p.created_at, p.updated_at;


--
-- Name: VIEW admin_priority_votes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.admin_priority_votes IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: agent_memory; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.agent_memory (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    agent_name text NOT NULL,
    memory_type text DEFAULT 'observation'::text NOT NULL,
    content text NOT NULL,
    embedding public.vector(1536),
    importance smallint DEFAULT 1 NOT NULL,
    source_id uuid,
    source_type text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT agent_memory_importance_check CHECK (((importance >= 1) AND (importance <= 5))),
    CONSTRAINT agent_memory_memory_type_check CHECK ((memory_type = ANY (ARRAY['observation'::text, 'decision'::text, 'spec_context'::text, 'alert'::text])))
);


--
-- Name: TABLE agent_memory; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.agent_memory IS 'Shared vectorized memory for autonomous agents (context, decisions, summaries)';


--
-- Name: COLUMN agent_memory.agent_name; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.agent_memory.agent_name IS 'Name of the agent that created the memory entry';


--
-- Name: COLUMN agent_memory.memory_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.agent_memory.memory_type IS 'Memory category: observation, decision, spec_context, alert';


--
-- Name: COLUMN agent_memory.embedding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.agent_memory.embedding IS 'Vector embedding of the memory content for similarity search';


--
-- Name: ai_usage_tracking; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_usage_tracking (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    feature_type text NOT NULL,
    usage_count integer DEFAULT 0,
    last_reset_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: ai_weight_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_weight_preferences (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid,
    feature_type character varying(50) NOT NULL,
    preset_name character varying(100),
    weights jsonb DEFAULT '{"revenue_impact": 25, "technical_effort": 10, "customer_requests": 30, "strategic_alignment": 20, "competitive_pressure": 15}'::jsonb NOT NULL,
    is_default boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: analytics_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.analytics_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    event_name character varying(100) NOT NULL,
    api_key character varying(255) NOT NULL,
    project_id uuid,
    url text,
    user_agent text,
    ip_address character varying(45),
    referer text,
    properties jsonb DEFAULT '{}'::jsonb,
    "timestamp" timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: anomaly_detections; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.anomaly_detections (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    detected_at timestamp with time zone DEFAULT now() NOT NULL,
    anomaly_type character varying(50) NOT NULL,
    severity character varying(20) NOT NULL,
    metric_name character varying(100) NOT NULL,
    expected_value numeric(10,4),
    actual_value numeric(10,4),
    deviation_score numeric(10,4),
    statistical_significance numeric(5,4),
    window_start timestamp with time zone NOT NULL,
    window_end timestamp with time zone NOT NULL,
    comparison_period_days integer DEFAULT 30,
    affected_posts_count integer DEFAULT 0,
    related_post_ids uuid[],
    related_topics text[],
    ai_summary text,
    potential_causes jsonb DEFAULT '[]'::jsonb,
    recommended_actions jsonb DEFAULT '[]'::jsonb,
    detection_method character varying(100) NOT NULL,
    model_name character varying(100),
    is_acknowledged boolean DEFAULT false,
    acknowledged_by uuid,
    acknowledged_at timestamp with time zone,
    user_notes text,
    status character varying(20) DEFAULT 'active'::character varying,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: api_keys; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.api_keys (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    name character varying(255) NOT NULL,
    key_hash character varying(255) NOT NULL,
    last_used_at timestamp with time zone,
    usage_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    is_active boolean DEFAULT true
);


--
-- Name: ask_action_executions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ask_action_executions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    message_id uuid NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid NOT NULL,
    action_type text NOT NULL,
    action_parameters jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    result_data jsonb,
    error_message text,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    duration_ms integer,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT ask_action_executions_action_type_check CHECK ((action_type = ANY (ARRAY['create_prd'::text, 'create_spec'::text, 'escalate_issue'::text, 'generate_report'::text, 'create_roadmap_item'::text, 'send_notification'::text, 'schedule_query'::text]))),
    CONSTRAINT ask_action_executions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'executing'::text, 'completed'::text, 'failed'::text, 'cancelled'::text])))
);


--
-- Name: TABLE ask_action_executions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ask_action_executions IS 'Log of all action executions triggered by Ask SignalsLoop';


--
-- Name: ask_analytics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ask_analytics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    message_id uuid NOT NULL,
    project_id uuid NOT NULL,
    query_text text NOT NULL,
    query_type text,
    response_rating integer,
    feedback_text text,
    tokens_used integer,
    latency_ms integer,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT ask_analytics_response_rating_check CHECK (((response_rating >= 1) AND (response_rating <= 5)))
);


--
-- Name: TABLE ask_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ask_analytics IS 'Analytics and performance metrics for AI chat queries';


--
-- Name: COLUMN ask_analytics.response_rating; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_analytics.response_rating IS 'User rating of response quality (1-5)';


--
-- Name: COLUMN ask_analytics.tokens_used; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_analytics.tokens_used IS 'Number of tokens consumed by query';


--
-- Name: COLUMN ask_analytics.latency_ms; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_analytics.latency_ms IS 'Response latency in milliseconds';


--
-- Name: ask_conversations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ask_conversations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    title text,
    is_pinned boolean DEFAULT false,
    last_message_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE ask_conversations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ask_conversations IS 'Chat conversations for Ask SignalsLoop Anything feature';


--
-- Name: COLUMN ask_conversations.title; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_conversations.title IS 'Conversation title (auto-generated or user-defined)';


--
-- Name: COLUMN ask_conversations.is_pinned; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_conversations.is_pinned IS 'Whether conversation is pinned for quick access';


--
-- Name: COLUMN ask_conversations.last_message_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_conversations.last_message_at IS 'Timestamp of last message for sorting';


--
-- Name: ask_messages; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ask_messages (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    conversation_id uuid NOT NULL,
    role text NOT NULL,
    content text NOT NULL,
    query_type text,
    sources jsonb DEFAULT '[]'::jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    is_voice_input boolean DEFAULT false,
    voice_transcript text,
    voice_duration_seconds integer,
    action_executed text,
    action_result jsonb,
    action_status text,
    CONSTRAINT ask_messages_action_status_check CHECK ((action_status = ANY (ARRAY['pending'::text, 'executing'::text, 'completed'::text, 'failed'::text]))),
    CONSTRAINT ask_messages_query_type_check CHECK ((query_type = ANY (ARRAY['feedback'::text, 'sentiment'::text, 'competitive'::text, 'themes'::text, 'metrics'::text, 'actions'::text, 'general'::text]))),
    CONSTRAINT ask_messages_role_check CHECK ((role = ANY (ARRAY['user'::text, 'assistant'::text, 'system'::text])))
);


--
-- Name: TABLE ask_messages; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ask_messages IS 'Individual messages within chat conversations';


--
-- Name: COLUMN ask_messages.role; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.role IS 'Message sender role: user, assistant, or system';


--
-- Name: COLUMN ask_messages.content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.content IS 'Message content text';


--
-- Name: COLUMN ask_messages.query_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.query_type IS 'Classification of query type for analytics';


--
-- Name: COLUMN ask_messages.sources; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.sources IS 'JSONB array of source references used in response';


--
-- Name: COLUMN ask_messages.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.metadata IS 'Additional metadata (tokens, model, etc.)';


--
-- Name: COLUMN ask_messages.is_voice_input; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.is_voice_input IS 'Whether this message was created from voice input';


--
-- Name: COLUMN ask_messages.voice_transcript; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.voice_transcript IS 'The transcribed text from voice input';


--
-- Name: COLUMN ask_messages.voice_duration_seconds; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.voice_duration_seconds IS 'Duration of the voice recording in seconds';


--
-- Name: COLUMN ask_messages.action_executed; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.action_executed IS 'The action type that was executed (if any)';


--
-- Name: COLUMN ask_messages.action_result; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.action_result IS 'Result data from the executed action';


--
-- Name: COLUMN ask_messages.action_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ask_messages.action_status IS 'Status of the action execution';


--
-- Name: ask_proactive_suggestions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ask_proactive_suggestions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    suggestion_type text NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    query_suggestion text NOT NULL,
    priority text NOT NULL,
    status text DEFAULT 'active'::text,
    context_data jsonb,
    viewed_by_users uuid[] DEFAULT '{}'::uuid[],
    dismissed_by uuid,
    dismissed_at timestamp with time zone,
    acted_upon_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone,
    CONSTRAINT ask_proactive_suggestions_priority_check CHECK ((priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text]))),
    CONSTRAINT ask_proactive_suggestions_status_check CHECK ((status = ANY (ARRAY['active'::text, 'dismissed'::text, 'acted_upon'::text]))),
    CONSTRAINT ask_proactive_suggestions_suggestion_type_check CHECK ((suggestion_type = ANY (ARRAY['sentiment_drop'::text, 'theme_spike'::text, 'churn_risk'::text, 'opportunity'::text, 'competitor_move'::text])))
);


--
-- Name: TABLE ask_proactive_suggestions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ask_proactive_suggestions IS 'AI-generated proactive suggestions based on detected patterns';


--
-- Name: ask_scheduled_queries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ask_scheduled_queries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid NOT NULL,
    query_text text NOT NULL,
    frequency text NOT NULL,
    day_of_week integer,
    day_of_month integer,
    time_utc time without time zone DEFAULT '09:00:00'::time without time zone NOT NULL,
    delivery_method text NOT NULL,
    slack_channel_id text,
    is_active boolean DEFAULT true,
    last_run_at timestamp with time zone,
    next_run_at timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT ask_scheduled_queries_day_of_month_check CHECK (((day_of_month >= 1) AND (day_of_month <= 31))),
    CONSTRAINT ask_scheduled_queries_day_of_week_check CHECK (((day_of_week >= 0) AND (day_of_week <= 6))),
    CONSTRAINT ask_scheduled_queries_delivery_method_check CHECK ((delivery_method = ANY (ARRAY['email'::text, 'slack'::text, 'both'::text]))),
    CONSTRAINT ask_scheduled_queries_frequency_check CHECK ((frequency = ANY (ARRAY['daily'::text, 'weekly'::text, 'monthly'::text])))
);


--
-- Name: TABLE ask_scheduled_queries; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ask_scheduled_queries IS 'Recurring queries that run automatically and deliver results via email/Slack';


--
-- Name: audio_briefings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audio_briefings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    briefing_id uuid NOT NULL,
    audio_url text NOT NULL,
    voice text DEFAULT 'nova'::text NOT NULL,
    duration_seconds integer DEFAULT 0,
    file_size_bytes integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone NOT NULL
);


--
-- Name: audit_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_logs (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    event_type character varying(100) NOT NULL,
    event_category character varying(50) DEFAULT 'general'::character varying NOT NULL,
    actor_id uuid,
    actor_email character varying(255),
    actor_type character varying(50) DEFAULT 'user'::character varying,
    resource_type character varying(100),
    resource_id uuid,
    resource_name character varying(255),
    action character varying(100) NOT NULL,
    action_status character varying(50) DEFAULT 'success'::character varying,
    previous_value jsonb,
    new_value jsonb,
    changes jsonb,
    ip_address inet,
    user_agent text,
    request_path character varying(500),
    request_method character varying(10),
    project_id uuid,
    session_id character varying(255),
    correlation_id character varying(255),
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT audit_logs_event_type_check CHECK (((event_type IS NOT NULL) AND ((event_type)::text <> ''::text)))
);


--
-- Name: TABLE audit_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.audit_logs IS 'Comprehensive audit trail for SOC 2 compliance.

Event Categories:
- auth: Authentication events (login, logout, password_change, mfa_enabled)
- data: Data operations (create, update, delete, export, import)
- admin: Administrative actions (user_create, role_change, settings_update)
- security: Security events (api_key_create, permission_change, access_denied)
- api: API access (api_call, rate_limited, invalid_key)
- integration: Integration events (connected, disconnected, sync)

Common Event Types:
- user.login, user.logout, user.password_change
- user.mfa_enabled, user.mfa_disabled
- data.create, data.update, data.delete, data.export
- project.create, project.update, project.delete
- project.member_added, project.member_removed
- api_key.create, api_key.revoke, api_key.used
- webhook.create, webhook.update, webhook.delete
- settings.update, settings.reset
- integration.connect, integration.disconnect, integration.sync
- security.access_denied, security.rate_limited
- admin.user_create, admin.user_delete, admin.role_change
';


--
-- Name: themes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.themes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    cluster_id uuid,
    theme_name text NOT NULL,
    description text NOT NULL,
    frequency integer DEFAULT 0 NOT NULL,
    avg_sentiment numeric(3,2) DEFAULT 0,
    first_seen timestamp with time zone DEFAULT now() NOT NULL,
    last_seen timestamp with time zone DEFAULT now() NOT NULL,
    is_emerging boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE themes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.themes IS 'Stores individual themes detected from feedback using AI analysis';


--
-- Name: COLUMN themes.theme_name; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.themes.theme_name IS 'Concise label for the theme';


--
-- Name: COLUMN themes.description; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.themes.description IS 'One-sentence description of what the theme represents';


--
-- Name: COLUMN themes.frequency; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.themes.frequency IS 'Number of feedback items associated with this theme';


--
-- Name: COLUMN themes.avg_sentiment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.themes.avg_sentiment IS 'Average sentiment score of feedback items in this theme';


--
-- Name: COLUMN themes.is_emerging; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.themes.is_emerging IS 'Flag indicating if this is a new or rapidly growing theme';


--
-- Name: user_stories; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_stories (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    theme_id uuid,
    title text NOT NULL,
    user_type text NOT NULL,
    user_goal text NOT NULL,
    user_benefit text NOT NULL,
    full_story text NOT NULL,
    acceptance_criteria jsonb DEFAULT '[]'::jsonb NOT NULL,
    story_points integer,
    complexity_score numeric(3,2),
    uncertainty_score numeric(3,2),
    effort_score numeric(3,2),
    estimation_reasoning text,
    labels text[] DEFAULT ARRAY[]::text[],
    technical_notes text,
    definition_of_done jsonb DEFAULT '[]'::jsonb,
    priority_level public.story_priority DEFAULT 'medium'::public.story_priority,
    jira_issue_key text,
    jira_issue_id text,
    exported_to_jira boolean DEFAULT false,
    export_timestamp timestamp with time zone,
    jira_export_error text,
    sprint_id uuid,
    sprint_status public.sprint_status DEFAULT 'backlog'::public.sprint_status,
    assigned_to text,
    generated_by_ai boolean DEFAULT true,
    generation_model text DEFAULT 'gpt-4'::text,
    generation_timestamp timestamp with time zone DEFAULT now(),
    generation_tokens_used integer,
    manually_edited boolean DEFAULT false,
    manually_edited_at timestamp with time zone,
    supporting_feedback_ids uuid[] DEFAULT ARRAY[]::uuid[],
    feedback_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT user_stories_complexity_score_check CHECK (((complexity_score >= (0)::numeric) AND (complexity_score <= (1)::numeric))),
    CONSTRAINT user_stories_effort_score_check CHECK (((effort_score >= (0)::numeric) AND (effort_score <= (1)::numeric))),
    CONSTRAINT user_stories_story_points_check CHECK ((story_points = ANY (ARRAY[1, 2, 3, 5, 8, 13, 21]))),
    CONSTRAINT user_stories_uncertainty_score_check CHECK (((uncertainty_score >= (0)::numeric) AND (uncertainty_score <= (1)::numeric)))
);


--
-- Name: TABLE user_stories; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_stories IS 'AI-generated user stories from themes, sprint-ready with acceptance criteria';


--
-- Name: COLUMN user_stories.full_story; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_stories.full_story IS 'Complete formatted user story: As a [user_type], I want [user_goal] so that [user_benefit]';


--
-- Name: COLUMN user_stories.acceptance_criteria; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_stories.acceptance_criteria IS 'Array of criterion objects with id, text, and details';


--
-- Name: COLUMN user_stories.story_points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_stories.story_points IS 'Fibonacci scale estimation: 1, 2, 3, 5, 8, 13, 21';


--
-- Name: COLUMN user_stories.complexity_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_stories.complexity_score IS 'AI-calculated technical complexity (0-1)';


--
-- Name: COLUMN user_stories.uncertainty_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_stories.uncertainty_score IS 'AI-calculated requirements uncertainty (0-1)';


--
-- Name: COLUMN user_stories.effort_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_stories.effort_score IS 'AI-calculated development effort (0-1)';


--
-- Name: backlog_stories; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.backlog_stories WITH (security_barrier='true', security_invoker='true') AS
 SELECT us.id,
    us.project_id,
    us.theme_id,
    us.title,
    us.user_type,
    us.user_goal,
    us.user_benefit,
    us.full_story,
    us.acceptance_criteria,
    us.story_points,
    us.complexity_score,
    us.uncertainty_score,
    us.effort_score,
    us.estimation_reasoning,
    us.labels,
    us.technical_notes,
    us.definition_of_done,
    us.priority_level,
    us.jira_issue_key,
    us.jira_issue_id,
    us.exported_to_jira,
    us.export_timestamp,
    us.jira_export_error,
    us.sprint_id,
    us.sprint_status,
    us.assigned_to,
    us.generated_by_ai,
    us.generation_model,
    us.generation_timestamp,
    us.generation_tokens_used,
    us.manually_edited,
    us.manually_edited_at,
    us.supporting_feedback_ids,
    us.feedback_count,
    us.created_at,
    us.updated_at,
    t.theme_name,
    t.frequency AS theme_frequency,
    t.avg_sentiment AS theme_sentiment
   FROM (public.user_stories us
     LEFT JOIN public.themes t ON ((us.theme_id = t.id)))
  WHERE (us.sprint_status = 'backlog'::public.sprint_status)
  ORDER BY us.priority_level, us.story_points DESC, us.created_at DESC;


--
-- Name: VIEW backlog_stories; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.backlog_stories IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: billing_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.billing_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    event_type character varying(100) NOT NULL,
    stripe_customer_id character varying(255),
    stripe_subscription_id character varying(255),
    amount integer,
    currency character varying(3) DEFAULT 'usd'::character varying,
    metadata jsonb,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE billing_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.billing_events IS 'Log of all Stripe billing events for audit trail';


--
-- Name: COLUMN billing_events.event_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.billing_events.event_type IS 'Type of Stripe event (payment_succeeded, subscription_canceled, etc.)';


--
-- Name: COLUMN billing_events.amount; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.billing_events.amount IS 'Amount in cents';


--
-- Name: COLUMN billing_events.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.billing_events.metadata IS 'Additional event metadata from Stripe';


--
-- Name: boards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.boards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    name character varying(255) NOT NULL,
    description text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    is_private boolean DEFAULT false,
    allow_anonymous_posts boolean DEFAULT true,
    require_approval boolean DEFAULT false,
    auto_close_days integer,
    custom_css text,
    welcome_message text,
    sort_default character varying(20) DEFAULT 'votes'::character varying,
    posts_per_page integer DEFAULT 20,
    show_author_emails boolean DEFAULT true,
    enable_comments boolean DEFAULT true,
    enable_voting boolean DEFAULT true,
    custom_statuses jsonb DEFAULT '[]'::jsonb,
    CONSTRAINT boards_sort_default_check CHECK (((sort_default)::text = ANY ((ARRAY['votes'::character varying, 'newest'::character varying, 'oldest'::character varying])::text[])))
);


--
-- Name: COLUMN boards.is_private; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.is_private IS 'Whether the board is private (requires authentication)';


--
-- Name: COLUMN boards.allow_anonymous_posts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.allow_anonymous_posts IS 'Whether anonymous users can submit posts';


--
-- Name: COLUMN boards.require_approval; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.require_approval IS 'Whether posts require approval before being visible';


--
-- Name: COLUMN boards.auto_close_days; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.auto_close_days IS 'Number of days after which posts are automatically closed (null = never)';


--
-- Name: COLUMN boards.custom_css; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.custom_css IS 'Custom CSS styles for the board';


--
-- Name: COLUMN boards.welcome_message; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.welcome_message IS 'Welcome message shown to users';


--
-- Name: COLUMN boards.sort_default; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.sort_default IS 'Default sort order for posts';


--
-- Name: COLUMN boards.posts_per_page; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.posts_per_page IS 'Number of posts to show per page';


--
-- Name: COLUMN boards.show_author_emails; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.show_author_emails IS 'Whether to show author email addresses';


--
-- Name: COLUMN boards.enable_comments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.enable_comments IS 'Whether comments are enabled on posts';


--
-- Name: COLUMN boards.enable_voting; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.enable_voting IS 'Whether voting is enabled on posts';


--
-- Name: COLUMN boards.custom_statuses; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.boards.custom_statuses IS 'Custom status options for posts (JSON array)';


--
-- Name: brief_schedules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.brief_schedules (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    template_id uuid,
    name character varying(255) NOT NULL,
    frequency character varying(20) NOT NULL,
    day_of_week integer,
    day_of_month integer,
    time_of_day time without time zone DEFAULT '09:00:00'::time without time zone,
    timezone character varying(50) DEFAULT 'UTC'::character varying,
    recipients jsonb DEFAULT '[]'::jsonb NOT NULL,
    delivery_method character varying(50) DEFAULT 'email'::character varying,
    slack_channel character varying(255),
    is_active boolean DEFAULT true,
    last_run_at timestamp with time zone,
    last_brief_id uuid,
    next_run_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid
);


--
-- Name: brief_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.brief_templates (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    description text,
    include_sections jsonb DEFAULT '{}'::jsonb,
    format character varying(20) DEFAULT 'markdown'::character varying,
    tone character varying(20) DEFAULT 'executive'::character varying,
    default_recipients jsonb DEFAULT '[]'::jsonb,
    is_default boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid
);


--
-- Name: call_ingests; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.call_ingests (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    source text NOT NULL,
    file_url text,
    total_calls integer DEFAULT 0 NOT NULL,
    processed_calls integer DEFAULT 0 NOT NULL,
    errors jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    completed_at timestamp with time zone,
    CONSTRAINT call_ingests_source_check CHECK ((source = ANY (ARRAY['csv'::text, 'zip'::text, 'api'::text, 'manual'::text]))),
    CONSTRAINT call_ingests_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text])))
);


--
-- Name: TABLE call_ingests; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.call_ingests IS 'Tracks batch uploads of customer call transcripts';


--
-- Name: call_records; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.call_records (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    ingest_id uuid NOT NULL,
    project_id uuid NOT NULL,
    customer text,
    deal_id text,
    amount numeric(12,2),
    stage text,
    transcript text NOT NULL,
    transcript_url text,
    duration integer,
    analyzed_at timestamp with time zone,
    highlight_summary text,
    sentiment numeric(3,2),
    priority_score integer,
    feature_requests jsonb DEFAULT '[]'::jsonb,
    objections jsonb DEFAULT '[]'::jsonb,
    competitors jsonb DEFAULT '[]'::jsonb,
    expansion_signals jsonb DEFAULT '[]'::jsonb,
    churn_signals jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE call_records; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.call_records IS 'Individual call records with transcripts and AI analysis results';


--
-- Name: COLUMN call_records.sentiment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.call_records.sentiment IS 'Sentiment score from -1 (very negative) to 1 (very positive)';


--
-- Name: COLUMN call_records.priority_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.call_records.priority_score IS 'AI-generated priority score from 1-100';


--
-- Name: COLUMN call_records.feature_requests; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.call_records.feature_requests IS 'Extracted feature requests as JSON array';


--
-- Name: COLUMN call_records.objections; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.call_records.objections IS 'Customer objections detected in the call';


--
-- Name: COLUMN call_records.competitors; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.call_records.competitors IS 'Competitor mentions and context';


--
-- Name: call_analytics_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.call_analytics_summary WITH (security_barrier='true', security_invoker='true') AS
 SELECT ci.project_id,
    ci.id AS ingest_id,
    ci.status,
    ci.source,
    ci.total_calls,
    ci.processed_calls,
    count(cr.id) AS total_records,
    count(cr.analyzed_at) AS analyzed_records,
    sum(
        CASE
            WHEN ((cr.amount IS NOT NULL) AND (COALESCE(((cr.expansion_signals ->> 'score'::text))::numeric, (0)::numeric) > (50)::numeric)) THEN cr.amount
            ELSE (0)::numeric
        END) AS expansion_revenue,
    sum(
        CASE
            WHEN ((cr.amount IS NOT NULL) AND (COALESCE(((cr.churn_signals ->> 'score'::text))::numeric, (0)::numeric) > (50)::numeric)) THEN cr.amount
            ELSE (0)::numeric
        END) AS churn_risk_revenue,
    avg(cr.sentiment) AS avg_sentiment,
    avg(cr.priority_score) AS avg_priority,
    ci.created_at,
    ci.completed_at
   FROM (public.call_ingests ci
     LEFT JOIN public.call_records cr ON ((cr.ingest_id = ci.id)))
  GROUP BY ci.id, ci.project_id, ci.status, ci.source, ci.total_calls, ci.processed_calls, ci.created_at, ci.completed_at;


--
-- Name: VIEW call_analytics_summary; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.call_analytics_summary IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: changelog_entries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.changelog_entries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    release_id uuid,
    title character varying(255) NOT NULL,
    description text,
    entry_type character varying(20) DEFAULT 'feature'::character varying,
    priority character varying(10) DEFAULT 'medium'::character varying,
    icon character varying(50),
    color character varying(7) DEFAULT '#3B82F6'::character varying,
    order_index integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT changelog_entries_entry_type_check CHECK (((entry_type)::text = ANY ((ARRAY['feature'::character varying, 'improvement'::character varying, 'fix'::character varying, 'security'::character varying, 'breaking'::character varying])::text[]))),
    CONSTRAINT changelog_entries_priority_check CHECK (((priority)::text = ANY ((ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying, 'critical'::character varying])::text[])))
);


--
-- Name: changelog_feedback_links; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.changelog_feedback_links (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    release_id uuid,
    post_id uuid,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: changelog_media; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.changelog_media (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    release_id uuid,
    file_url text NOT NULL,
    file_type character varying(50) NOT NULL,
    file_size integer,
    alt_text character varying(255),
    caption text,
    display_order integer DEFAULT 0,
    is_video boolean DEFAULT false,
    video_thumbnail_url text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: changelog_releases; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.changelog_releases (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    title character varying(255) NOT NULL,
    slug character varying(255) NOT NULL,
    content text NOT NULL,
    excerpt text,
    release_type character varying(20) DEFAULT 'minor'::character varying,
    release_date timestamp with time zone DEFAULT now(),
    published_at timestamp with time zone,
    is_published boolean DEFAULT false,
    is_featured boolean DEFAULT false,
    version character varying(50),
    tags text[],
    metadata jsonb DEFAULT '{}'::jsonb,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT changelog_releases_release_type_check CHECK (((release_type)::text = ANY ((ARRAY['major'::character varying, 'minor'::character varying, 'patch'::character varying, 'hotfix'::character varying])::text[])))
);


--
-- Name: changelog_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.changelog_subscriptions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    email character varying(255) NOT NULL,
    subscription_token character varying(255) NOT NULL,
    is_active boolean DEFAULT true,
    subscribed_at timestamp with time zone DEFAULT now(),
    last_notified_at timestamp with time zone,
    notification_preferences jsonb DEFAULT '{"email": true, "major": true, "minor": true, "patch": false}'::jsonb
);


--
-- Name: changelog_webhooks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.changelog_webhooks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    webhook_url text NOT NULL,
    webhook_secret character varying(255),
    events text[] DEFAULT ARRAY['release.published'::text],
    is_active boolean DEFAULT true,
    last_triggered_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: churn_alert_rules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.churn_alert_rules (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    description text,
    rule_type character varying(50) NOT NULL,
    conditions jsonb NOT NULL,
    severity character varying(20) DEFAULT 'medium'::character varying NOT NULL,
    alert_title_template character varying(500),
    alert_description_template text,
    recommended_action_template text,
    notify_slack boolean DEFAULT false,
    notify_email boolean DEFAULT false,
    notification_recipients jsonb DEFAULT '[]'::jsonb,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid
);


--
-- Name: churn_alerts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.churn_alerts (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    customer_health_id uuid NOT NULL,
    alert_type character varying(50) NOT NULL,
    severity character varying(20) NOT NULL,
    title character varying(500) NOT NULL,
    description text,
    trigger_data jsonb DEFAULT '{}'::jsonb,
    recommended_action text,
    action_template_id character varying(50),
    status character varying(20) DEFAULT 'new'::character varying,
    acknowledged_at timestamp with time zone,
    acknowledged_by uuid,
    resolved_at timestamp with time zone,
    resolved_by uuid,
    resolution_notes text,
    revenue_at_risk numeric(12,2),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: churn_risk_predictions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.churn_risk_predictions (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    user_identifier character varying(255),
    user_segment character varying(100),
    prediction_date timestamp with time zone NOT NULL,
    churn_probability numeric(5,4) NOT NULL,
    risk_level character varying(20) NOT NULL,
    confidence_score numeric(3,2) NOT NULL,
    risk_factors jsonb DEFAULT '[]'::jsonb NOT NULL,
    recent_sentiment_avg numeric(3,2),
    sentiment_trend character varying(20),
    feedback_frequency_change numeric(5,2),
    critical_issues_count integer DEFAULT 0,
    days_since_last_positive integer,
    days_since_last_negative integer,
    model_name character varying(100) NOT NULL,
    model_version character varying(50),
    actual_churned boolean,
    churn_date timestamp with time zone,
    prediction_accuracy_score numeric(3,2),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT churn_risk_confidence_range CHECK (((confidence_score >= (0)::numeric) AND (confidence_score <= (1)::numeric))),
    CONSTRAINT churn_risk_probability_range CHECK (((churn_probability >= (0)::numeric) AND (churn_probability <= (1)::numeric)))
);


--
-- Name: collected_reviews; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.collected_reviews (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_id uuid,
    product_name text NOT NULL,
    product_name_normalized text NOT NULL,
    review_text text NOT NULL,
    rating numeric(2,1),
    review_date date,
    author text,
    source text NOT NULL,
    source_url text,
    sentiment numeric(3,2),
    themes text[],
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT collected_reviews_source_check CHECK ((source = ANY (ARRAY['reddit'::text, 'app_store'::text, 'play_store'::text, 'hacker_news'::text, 'pasted'::text, 'csv_upload'::text])))
);


--
-- Name: comment_mentions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.comment_mentions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    comment_id uuid NOT NULL,
    mentioned_user_email text NOT NULL,
    mentioned_user_name text,
    project_id uuid NOT NULL,
    post_id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    notified_at timestamp with time zone
);


--
-- Name: comments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.comments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid,
    author_email character varying(255),
    author_name character varying(255),
    author_id uuid,
    content text NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    parent_id uuid
);


--
-- Name: competitive_dashboard_overview; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.competitive_dashboard_overview AS
SELECT
    NULL::uuid AS project_id,
    NULL::uuid AS competitor_id,
    NULL::text AS competitor_name,
    NULL::text AS category,
    NULL::public.competitor_status AS status,
    NULL::integer AS total_mentions,
    NULL::numeric(3,2) AS avg_sentiment_vs_you,
    NULL::numeric(3,2) AS avg_sentiment_about_them,
    NULL::integer AS switches_to_you,
    NULL::integer AS switches_from_you,
    NULL::integer AS net_switches,
    NULL::timestamp with time zone AS last_mentioned_at,
    NULL::bigint AS mentions_last_7d,
    NULL::bigint AS mentions_last_30d,
    NULL::bigint AS comparison_count,
    NULL::bigint AS feature_comparison_count;


--
-- Name: VIEW competitive_dashboard_overview; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.competitive_dashboard_overview IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: competitive_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitive_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    competitor_id uuid NOT NULL,
    event_type public.competitive_event_type NOT NULL,
    title text NOT NULL,
    description text,
    event_date date NOT NULL,
    mention_count integer DEFAULT 0,
    avg_sentiment numeric(3,2),
    impact_level public.impact_level DEFAULT 'medium'::public.impact_level,
    feedback_ids uuid[] DEFAULT ARRAY[]::uuid[],
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE competitive_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitive_events IS 'Significant competitive events detected from feedback patterns';


--
-- Name: competitive_intel_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitive_intel_sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_token text NOT NULL,
    user_product_name text,
    competitor_names text[],
    status text DEFAULT 'pending'::text,
    results jsonb,
    email text,
    converted_to_signup boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    CONSTRAINT competitive_intel_sessions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'collecting'::text, 'analyzing'::text, 'completed'::text, 'failed'::text])))
);


--
-- Name: competitive_mentions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitive_mentions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    feedback_id uuid NOT NULL,
    competitor_id uuid NOT NULL,
    mention_type public.mention_type NOT NULL,
    context_snippet text,
    sentiment_vs_you numeric(3,2),
    sentiment_about_competitor numeric(3,2),
    key_points text[] DEFAULT ARRAY[]::text[],
    extracted_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT competitive_mentions_sentiment_about_competitor_check CHECK (((sentiment_about_competitor >= ('-1'::integer)::numeric) AND (sentiment_about_competitor <= (1)::numeric))),
    CONSTRAINT competitive_mentions_sentiment_vs_you_check CHECK (((sentiment_vs_you >= ('-1'::integer)::numeric) AND (sentiment_vs_you <= (1)::numeric)))
);


--
-- Name: TABLE competitive_mentions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitive_mentions IS 'Individual competitor mentions extracted from feedback with sentiment';


--
-- Name: COLUMN competitive_mentions.mention_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitive_mentions.mention_type IS 'Type of competitive mention: comparison, switch_to, switch_from, feature_comparison, general';


--
-- Name: COLUMN competitive_mentions.sentiment_vs_you; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitive_mentions.sentiment_vs_you IS 'How user compares you to competitor (-1 favors them, +1 favors you)';


--
-- Name: COLUMN competitive_mentions.sentiment_about_competitor; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitive_mentions.sentiment_about_competitor IS 'Users general sentiment about the competitor';


--
-- Name: competitor_alerts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_alerts (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    competitor_name character varying(255) NOT NULL,
    competitor_id uuid,
    alert_type character varying(50) NOT NULL,
    severity character varying(20) DEFAULT 'medium'::character varying,
    title character varying(500) NOT NULL,
    description text,
    source_url text,
    source_type character varying(50),
    customer_impact_count integer DEFAULT 0,
    revenue_at_risk numeric(12,2) DEFAULT 0,
    urgency_score integer DEFAULT 50,
    ai_summary text,
    ai_recommended_action text,
    feature_comparison jsonb DEFAULT '{}'::jsonb,
    status character varying(20) DEFAULT 'new'::character varying,
    acknowledged_by uuid,
    acknowledged_at timestamp with time zone,
    addressed_by uuid,
    addressed_at timestamp with time zone,
    resolution_notes text,
    raw_data jsonb DEFAULT '{}'::jsonb,
    detected_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT competitor_alerts_urgency_score_check CHECK (((urgency_score >= 0) AND (urgency_score <= 100)))
);


--
-- Name: competitor_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    competitor_id uuid NOT NULL,
    project_id uuid NOT NULL,
    embedding public.vector(1536),
    content_hash text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE competitor_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_embeddings IS 'Vector embeddings for competitor intelligence records';


--
-- Name: competitor_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    competitor_id uuid NOT NULL,
    event_type text NOT NULL,
    event_title text NOT NULL,
    event_summary text NOT NULL,
    event_date date NOT NULL,
    source_url text,
    source_type text,
    impact_assessment text,
    strategic_implications jsonb,
    embedding public.vector(1536),
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT competitor_events_event_type_check CHECK ((event_type = ANY (ARRAY['feature_launch'::text, 'pricing_change'::text, 'funding'::text, 'acquisition'::text, 'partnership'::text, 'executive_change'::text, 'product_sunset'::text, 'expansion'::text]))),
    CONSTRAINT competitor_events_impact_assessment_check CHECK ((impact_assessment = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text, 'informational'::text]))),
    CONSTRAINT competitor_events_source_type_check CHECK ((source_type = ANY (ARRAY['changelog'::text, 'press_release'::text, 'news'::text, 'social'::text, 'sec_filing'::text, 'job_posting'::text])))
);


--
-- Name: TABLE competitor_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_events IS 'Competitor intelligence events scraped from external sources with vector embeddings for semantic search';


--
-- Name: COLUMN competitor_events.embedding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitor_events.embedding IS 'OpenAI text-embedding-3-small (1536 dimensions) for semantic similarity search';


--
-- Name: competitor_features; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_features (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    competitor_product_id uuid NOT NULL,
    project_id uuid NOT NULL,
    feature_name text NOT NULL,
    feature_category text,
    description text,
    mention_count integer DEFAULT 0,
    positive_mentions integer DEFAULT 0,
    negative_mentions integer DEFAULT 0,
    avg_sentiment numeric(3,2),
    review_ids uuid[],
    first_detected_at timestamp with time zone DEFAULT now(),
    last_mentioned_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE competitor_features; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_features IS 'Features extracted from competitor reviews';


--
-- Name: competitor_job_postings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_job_postings (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    competitor_name character varying(255) NOT NULL,
    competitor_id uuid,
    job_title character varying(500) NOT NULL,
    department character varying(100),
    location character varying(255),
    job_type character varying(50),
    seniority_level character varying(50),
    source_url text,
    source_platform character varying(50),
    strategic_signals text[],
    skills_mentioned text[],
    tech_stack_hints text[],
    ai_interpretation text,
    is_active boolean DEFAULT true,
    first_seen_at timestamp with time zone DEFAULT now(),
    last_seen_at timestamp with time zone DEFAULT now(),
    raw_data jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: competitor_monitoring_config; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_monitoring_config (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    competitor_name character varying(255) NOT NULL,
    competitor_id uuid,
    is_active boolean DEFAULT true,
    website_url text,
    linkedin_url text,
    twitter_handle character varying(100),
    careers_page_url text,
    changelog_url text,
    alert_on_feature_launch boolean DEFAULT true,
    alert_on_pricing_change boolean DEFAULT true,
    alert_on_job_postings boolean DEFAULT true,
    alert_on_social_mentions boolean DEFAULT false,
    alert_on_review_trends boolean DEFAULT true,
    slack_channel_id character varying(50),
    email_recipients text[],
    last_checked_at timestamp with time zone,
    next_check_at timestamp with time zone,
    check_frequency_hours integer DEFAULT 24,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: competitor_products; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_products (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    product_name text NOT NULL,
    company_name text NOT NULL,
    g2_product_id text,
    g2_url text,
    capterra_product_id text,
    capterra_url text,
    trustradius_product_id text,
    trustradius_url text,
    is_active boolean DEFAULT true,
    monitoring_enabled boolean DEFAULT true,
    platforms text[] DEFAULT ARRAY['g2'::text, 'capterra'::text, 'trustradius'::text],
    category text,
    description text,
    logo_url text,
    last_synced_at timestamp with time zone,
    last_sync_error text,
    total_reviews_synced integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE competitor_products; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_products IS 'Competitor products to monitor on external review platforms';


--
-- Name: competitor_products_overview; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.competitor_products_overview AS
SELECT
    NULL::uuid AS id,
    NULL::uuid AS project_id,
    NULL::text AS product_name,
    NULL::text AS company_name,
    NULL::boolean AS is_active,
    NULL::boolean AS monitoring_enabled,
    NULL::text[] AS platforms,
    NULL::timestamp with time zone AS last_synced_at,
    NULL::bigint AS total_reviews,
    NULL::bigint AS g2_reviews,
    NULL::bigint AS capterra_reviews,
    NULL::bigint AS trustradius_reviews,
    NULL::numeric AS avg_rating,
    NULL::numeric AS avg_g2_rating,
    NULL::numeric AS avg_capterra_rating,
    NULL::numeric AS avg_trustradius_rating,
    NULL::bigint AS features_identified,
    NULL::bigint AS strengths_identified,
    NULL::bigint AS weaknesses_identified,
    NULL::timestamp with time zone AS latest_review_date,
    NULL::bigint AS reviews_last_30_days;


--
-- Name: VIEW competitor_products_overview; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.competitor_products_overview IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: competitor_reviews; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_reviews (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    competitor_product_id uuid NOT NULL,
    project_id uuid NOT NULL,
    platform text NOT NULL,
    external_review_id text NOT NULL,
    title text,
    content text NOT NULL,
    rating numeric(3,2),
    reviewer_name text,
    reviewer_role text,
    reviewer_company_size text,
    published_at timestamp with time zone,
    verified_reviewer boolean DEFAULT false,
    incentivized_review boolean DEFAULT false,
    sentiment_score numeric(3,2),
    sentiment_category text,
    mentioned_features text[],
    pros text[],
    cons text[],
    use_cases text[],
    processed boolean DEFAULT false,
    processed_at timestamp with time zone,
    ai_extracted_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT competitor_reviews_platform_check CHECK ((platform = ANY (ARRAY['g2'::text, 'capterra'::text, 'trustradius'::text]))),
    CONSTRAINT competitor_reviews_sentiment_category_check CHECK ((sentiment_category = ANY (ARRAY['positive'::text, 'negative'::text, 'neutral'::text, 'mixed'::text])))
);


--
-- Name: TABLE competitor_reviews; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_reviews IS 'Scraped reviews from G2, Capterra, TrustRadius';


--
-- Name: competitor_strengths; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_strengths (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    competitor_product_id uuid NOT NULL,
    project_id uuid NOT NULL,
    feature_name text NOT NULL,
    strength_category text,
    description text,
    praise_count integer DEFAULT 0,
    avg_rating numeric(3,2),
    confidence_score numeric(3,2),
    sample_quotes text[],
    review_ids uuid[],
    first_identified_at timestamp with time zone DEFAULT now(),
    last_updated_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE competitor_strengths; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_strengths IS 'Highly praised features (competitive strengths)';


--
-- Name: competitor_weaknesses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitor_weaknesses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    competitor_product_id uuid NOT NULL,
    project_id uuid NOT NULL,
    feature_name text NOT NULL,
    weakness_category text,
    description text,
    complaint_count integer DEFAULT 0,
    avg_rating numeric(3,2),
    severity_score numeric(3,2),
    confidence_score numeric(3,2),
    sample_quotes text[],
    review_ids uuid[],
    opportunity_score numeric(3,2),
    strategic_importance text,
    first_identified_at timestamp with time zone DEFAULT now(),
    last_updated_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT competitor_weaknesses_strategic_importance_check CHECK ((strategic_importance = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text])))
);


--
-- Name: TABLE competitor_weaknesses; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitor_weaknesses IS 'Commonly criticized features (competitive weaknesses)';


--
-- Name: competitors; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.competitors (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name text NOT NULL,
    category text,
    website text,
    description text,
    auto_detected boolean DEFAULT false,
    status public.competitor_status DEFAULT 'monitoring'::public.competitor_status,
    total_mentions integer DEFAULT 0,
    first_mentioned_at timestamp with time zone,
    last_mentioned_at timestamp with time zone,
    avg_sentiment_vs_you numeric(3,2) DEFAULT 0,
    avg_sentiment_about_them numeric(3,2) DEFAULT 0,
    switches_to_you integer DEFAULT 0,
    switches_from_you integer DEFAULT 0,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT competitors_avg_sentiment_about_them_check CHECK (((avg_sentiment_about_them >= ('-1'::integer)::numeric) AND (avg_sentiment_about_them <= (1)::numeric))),
    CONSTRAINT competitors_avg_sentiment_vs_you_check CHECK (((avg_sentiment_vs_you >= ('-1'::integer)::numeric) AND (avg_sentiment_vs_you <= (1)::numeric)))
);


--
-- Name: TABLE competitors; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.competitors IS 'Tracks competitors mentioned in discovered feedback';


--
-- Name: COLUMN competitors.auto_detected; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitors.auto_detected IS 'True if AI discovered this competitor, false if manually added';


--
-- Name: COLUMN competitors.avg_sentiment_vs_you; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitors.avg_sentiment_vs_you IS 'Average sentiment when comparing you to this competitor (-1 to 1)';


--
-- Name: COLUMN competitors.switches_to_you; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitors.switches_to_you IS 'Count of users who switched FROM this competitor TO you';


--
-- Name: COLUMN competitors.switches_from_you; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.competitors.switches_from_you IS 'Count of users who switched FROM you TO this competitor';


--
-- Name: customer_health; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.customer_health (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    customer_id uuid,
    external_id character varying(255),
    email character varying(255),
    name character varying(255),
    company character varying(255),
    health_score integer DEFAULT 50 NOT NULL,
    previous_health_score integer,
    health_grade character varying(1),
    churn_risk character varying(20) DEFAULT 'medium'::character varying,
    churn_probability numeric(5,4),
    days_until_likely_churn integer,
    engagement_score integer DEFAULT 50,
    sentiment_score integer DEFAULT 50,
    support_score integer DEFAULT 50,
    product_usage_score integer DEFAULT 50,
    payment_score integer DEFAULT 100,
    nps_score integer,
    last_login_at timestamp with time zone,
    days_since_login integer,
    login_frequency_7d integer DEFAULT 0,
    login_frequency_30d integer DEFAULT 0,
    feature_adoption_rate numeric(5,2),
    key_features_used text[] DEFAULT '{}'::text[],
    support_tickets_open integer DEFAULT 0,
    support_tickets_30d integer DEFAULT 0,
    avg_ticket_resolution_hours numeric(10,2),
    last_support_contact_at timestamp with time zone,
    feedback_count_30d integer DEFAULT 0,
    avg_sentiment_30d numeric(3,2),
    negative_feedback_count_30d integer DEFAULT 0,
    payment_failures_90d integer DEFAULT 0,
    last_payment_failure_at timestamp with time zone,
    subscription_status character varying(50),
    mrr numeric(12,2),
    arr numeric(12,2),
    lifetime_value numeric(12,2),
    plan_name character varying(100),
    contract_end_date date,
    days_until_renewal integer,
    account_age_days integer,
    risk_factors jsonb DEFAULT '[]'::jsonb,
    positive_signals jsonb DEFAULT '[]'::jsonb,
    health_summary text,
    recommended_actions jsonb DEFAULT '[]'::jsonb,
    calculated_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: customer_health_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.customer_health_history (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    customer_health_id uuid NOT NULL,
    project_id uuid NOT NULL,
    health_score integer NOT NULL,
    churn_risk character varying(20),
    engagement_score integer,
    sentiment_score integer,
    support_score integer,
    product_usage_score integer,
    payment_score integer,
    change_reason text,
    change_factors jsonb DEFAULT '[]'::jsonb,
    recorded_at timestamp with time zone DEFAULT now()
);


--
-- Name: customer_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.customer_profiles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    email text NOT NULL,
    external_customer_id text,
    name text,
    company_name text,
    mrr numeric(10,2),
    arr numeric(10,2),
    lifetime_value numeric(10,2),
    plan_tier text,
    segment text,
    status text,
    health_score integer,
    churn_risk text,
    crm_provider text,
    crm_url text,
    crm_data jsonb DEFAULT '{}'::jsonb,
    account_owner text,
    account_owner_email text,
    industry text,
    company_size text,
    location text,
    customer_since timestamp with time zone,
    last_activity_at timestamp with time zone,
    last_synced_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT customer_profiles_churn_risk_check CHECK ((churn_risk = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text]))),
    CONSTRAINT customer_profiles_crm_provider_check CHECK ((crm_provider = ANY (ARRAY['salesforce'::text, 'hubspot'::text, 'custom'::text]))),
    CONSTRAINT customer_profiles_health_score_check CHECK (((health_score >= 0) AND (health_score <= 100))),
    CONSTRAINT customer_profiles_status_check CHECK ((status = ANY (ARRAY['active'::text, 'churned'::text, 'trial'::text, 'lead'::text])))
);


--
-- Name: TABLE customer_profiles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.customer_profiles IS 'Enriched customer data from Salesforce/HubSpot for revenue-based prioritization';


--
-- Name: COLUMN customer_profiles.mrr; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.customer_profiles.mrr IS 'Monthly Recurring Revenue - KEY metric for prioritization';


--
-- Name: COLUMN customer_profiles.segment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.customer_profiles.segment IS 'Customer segment (smb/mid-market/enterprise) - used for prioritization';


--
-- Name: customer_sync_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.customer_sync_log (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    sync_type text NOT NULL,
    provider text NOT NULL,
    status text NOT NULL,
    customers_synced integer DEFAULT 0,
    customers_created integer DEFAULT 0,
    customers_updated integer DEFAULT 0,
    error_message text,
    raw_response jsonb,
    synced_by uuid,
    synced_at timestamp with time zone DEFAULT now(),
    CONSTRAINT customer_sync_log_provider_check CHECK ((provider = ANY (ARRAY['salesforce'::text, 'hubspot'::text, 'custom'::text]))),
    CONSTRAINT customer_sync_log_status_check CHECK ((status = ANY (ARRAY['success'::text, 'partial'::text, 'failed'::text]))),
    CONSTRAINT customer_sync_log_sync_type_check CHECK ((sync_type = ANY (ARRAY['full'::text, 'incremental'::text, 'manual'::text, 'webhook'::text])))
);


--
-- Name: TABLE customer_sync_log; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.customer_sync_log IS 'Audit log of customer data synchronization from CRM systems';


--
-- Name: customers; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.customers (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    email character varying(255),
    name character varying(255),
    company character varying(255),
    avatar_url text,
    identities jsonb DEFAULT '{}'::jsonb,
    total_feedback_count integer DEFAULT 0,
    average_sentiment numeric(3,2) DEFAULT 0,
    last_feedback_at timestamp with time zone,
    first_seen_at timestamp with time zone DEFAULT now(),
    crm_id character varying(255),
    crm_source character varying(50),
    mrr numeric(12,2),
    arr numeric(12,2),
    plan_name character varying(100),
    customer_since timestamp with time zone,
    health_score integer,
    churn_risk character varying(20),
    tags text[] DEFAULT '{}'::text[],
    custom_fields jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: daily_briefings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.daily_briefings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    content jsonb NOT NULL,
    briefing_date date DEFAULT CURRENT_DATE NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    audio_url text,
    audio_voice text DEFAULT 'nova'::text,
    audio_duration_seconds integer
);


--
-- Name: TABLE daily_briefings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.daily_briefings IS 'AI-generated daily briefings for Mission Control dashboard';


--
-- Name: COLUMN daily_briefings.content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.daily_briefings.content IS 'JSONB containing briefing_text, sentiment_score, sentiment_trend, critical_alerts, and recommended_actions';


--
-- Name: COLUMN daily_briefings.briefing_date; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.daily_briefings.briefing_date IS 'Date of the briefing (used for unique constraint - one briefing per project per day)';


--
-- Name: deal_autopsies; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_autopsies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deal_id uuid NOT NULL,
    summary text NOT NULL,
    primary_reason public.loss_reason_category,
    primary_reason_detail text,
    objections jsonb DEFAULT '[]'::jsonb,
    competitor_signals jsonb DEFAULT '[]'::jsonb,
    key_themes text[] DEFAULT ARRAY[]::text[],
    recommendations text NOT NULL,
    action_items text[] DEFAULT ARRAY[]::text[],
    similar_open_deal_ids uuid[] DEFAULT ARRAY[]::uuid[],
    similar_lost_deal_ids uuid[] DEFAULT ARRAY[]::uuid[],
    confidence numeric(3,2) DEFAULT 0,
    ai_model text DEFAULT 'gpt-4o-mini'::text,
    processing_time_ms integer,
    generated_at timestamp with time zone DEFAULT now(),
    regenerated_count integer DEFAULT 0,
    last_regenerated_at timestamp with time zone,
    CONSTRAINT deal_autopsies_confidence_check CHECK (((confidence >= (0)::numeric) AND (confidence <= (1)::numeric)))
);


--
-- Name: TABLE deal_autopsies; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_autopsies IS 'AI-generated post-mortem analysis for closed deals';


--
-- Name: COLUMN deal_autopsies.summary; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_autopsies.summary IS '1-page executive summary of why deal was won/lost';


--
-- Name: COLUMN deal_autopsies.primary_reason; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_autopsies.primary_reason IS 'Main category of loss: pricing, features, competitor, timing, etc.';


--
-- Name: COLUMN deal_autopsies.objections; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_autopsies.objections IS 'Array of objection objects with category, description, and frequency';


--
-- Name: COLUMN deal_autopsies.competitor_signals; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_autopsies.competitor_signals IS 'Competitive intelligence extracted from deal notes';


--
-- Name: COLUMN deal_autopsies.similar_open_deal_ids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_autopsies.similar_open_deal_ids IS 'Open deals at risk based on similarity analysis';


--
-- Name: deal_battlecards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_battlecards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    competitor_name text NOT NULL,
    competitor_product text,
    total_deals_competing integer DEFAULT 0,
    deals_won integer DEFAULT 0,
    deals_lost integer DEFAULT 0,
    win_rate numeric(5,2) DEFAULT 0,
    total_revenue_at_stake numeric(12,2) DEFAULT 0,
    revenue_won numeric(12,2) DEFAULT 0,
    revenue_lost numeric(12,2) DEFAULT 0,
    common_objections text[] DEFAULT ARRAY[]::text[],
    common_win_factors text[] DEFAULT ARRAY[]::text[],
    common_loss_factors text[] DEFAULT ARRAY[]::text[],
    strengths text[] DEFAULT ARRAY[]::text[],
    weaknesses text[] DEFAULT ARRAY[]::text[],
    recommended_positioning text,
    last_analyzed_at timestamp with time zone,
    deal_ids uuid[] DEFAULT ARRAY[]::uuid[],
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE deal_battlecards; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_battlecards IS 'Competitor battle cards built from deal patterns';


--
-- Name: COLUMN deal_battlecards.win_rate; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_battlecards.win_rate IS 'Win rate percentage against this competitor';


--
-- Name: COLUMN deal_battlecards.common_objections; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_battlecards.common_objections IS 'Most frequent objections when competing against them';


--
-- Name: COLUMN deal_battlecards.recommended_positioning; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deal_battlecards.recommended_positioning IS 'AI-recommended positioning strategy';


--
-- Name: deal_digest_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_digest_subscriptions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    channel text NOT NULL,
    destination text NOT NULL,
    frequency text DEFAULT 'daily'::text,
    include_won boolean DEFAULT false,
    include_lost boolean DEFAULT true,
    include_at_risk boolean DEFAULT true,
    min_deal_amount numeric(12,2) DEFAULT 0,
    active boolean DEFAULT true,
    last_sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT deal_digest_subscriptions_channel_check CHECK ((channel = ANY (ARRAY['email'::text, 'slack'::text]))),
    CONSTRAINT deal_digest_subscriptions_frequency_check CHECK ((frequency = ANY (ARRAY['daily'::text, 'weekly'::text, 'immediate'::text])))
);


--
-- Name: TABLE deal_digest_subscriptions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_digest_subscriptions IS 'Email/Slack subscription settings for deal digests';


--
-- Name: deals; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deals (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name text NOT NULL,
    external_id text,
    amount numeric(12,2) DEFAULT 0 NOT NULL,
    stage public.deal_stage DEFAULT 'prospecting'::public.deal_stage,
    status public.deal_status DEFAULT 'open'::public.deal_status,
    competitor text,
    competitor_product text,
    notes text,
    close_reason text,
    contact_name text,
    contact_email text,
    contact_company text,
    source text DEFAULT 'manual'::text,
    metadata jsonb DEFAULT '{}'::jsonb,
    closed_at timestamp with time zone,
    expected_close_date date,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT closed_requires_timestamp CHECK (((status = 'open'::public.deal_status) OR ((status = ANY (ARRAY['won'::public.deal_status, 'lost'::public.deal_status])) AND (closed_at IS NOT NULL)))),
    CONSTRAINT valid_amount CHECK ((amount >= (0)::numeric))
);


--
-- Name: TABLE deals; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deals IS 'CRM deals with win/loss tracking for competitive analysis';


--
-- Name: COLUMN deals.external_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.external_id IS 'External CRM ID for bi-directional sync';


--
-- Name: COLUMN deals.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.status IS 'Deal outcome: won (closed-won), lost (closed-lost), open (in pipeline)';


--
-- Name: COLUMN deals.competitor; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.competitor IS 'Primary competitor in this deal (if any)';


--
-- Name: deals_dashboard_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.deals_dashboard_view WITH (security_barrier='true', security_invoker='true') AS
 SELECT d.id,
    d.project_id,
    d.name,
    d.amount,
    d.stage,
    d.status,
    d.competitor,
    d.contact_name,
    d.contact_company,
    d.closed_at,
    d.created_at,
    da.id AS autopsy_id,
    da.summary AS autopsy_summary,
    da.primary_reason,
    da.confidence AS autopsy_confidence,
    da.generated_at AS autopsy_generated_at,
        CASE
            WHEN ((d.status = 'lost'::public.deal_status) AND (da.id IS NULL)) THEN true
            ELSE false
        END AS needs_autopsy,
    (EXTRACT(epoch FROM (d.closed_at - d.created_at)) / (86400)::numeric) AS days_to_close
   FROM (public.deals d
     LEFT JOIN public.deal_autopsies da ON ((da.deal_id = d.id)));


--
-- Name: VIEW deals_dashboard_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.deals_dashboard_view IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: discord_integration_states; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discord_integration_states (
    state text NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid,
    redirect_to text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: discord_integrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discord_integrations (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    guild_id text NOT NULL,
    guild_name text,
    channel_id text,
    channel_name text,
    webhook_id text NOT NULL,
    webhook_token text NOT NULL,
    webhook_url text NOT NULL,
    application_id text,
    access_token text,
    refresh_token text,
    expires_at timestamp with time zone,
    scope text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: discount_code_usage; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discount_code_usage (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    discount_code_id uuid,
    user_id uuid,
    project_id uuid,
    amount_discounted numeric(10,2) NOT NULL,
    used_at timestamp with time zone DEFAULT now()
);


--
-- Name: discount_codes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discount_codes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    code character varying(50) NOT NULL,
    description text,
    discount_type character varying(20) DEFAULT 'percentage'::character varying,
    discount_value numeric(10,2) NOT NULL,
    min_amount numeric(10,2) DEFAULT 0,
    max_discount numeric(10,2),
    usage_limit integer,
    usage_count integer DEFAULT 0,
    target_email character varying(255),
    valid_from timestamp with time zone DEFAULT now(),
    valid_until timestamp with time zone,
    is_active boolean DEFAULT true,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    stripe_coupon_id character varying(255),
    stripe_promotion_code_id character varying(255),
    synced_to_stripe boolean DEFAULT false,
    stripe_sync_error text,
    duration character varying(20) DEFAULT 'once'::character varying,
    duration_in_months integer,
    CONSTRAINT discount_codes_discount_type_check CHECK (((discount_type)::text = ANY ((ARRAY['percentage'::character varying, 'fixed_amount'::character varying])::text[]))),
    CONSTRAINT discount_codes_duration_check CHECK (((duration)::text = ANY ((ARRAY['once'::character varying, 'repeating'::character varying, 'forever'::character varying])::text[])))
);


--
-- Name: discovered_feedback; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discovered_feedback (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    platform public.platform_type NOT NULL,
    platform_id text NOT NULL,
    platform_url text NOT NULL,
    author_username text,
    author_profile_url text,
    author_metadata jsonb DEFAULT '{}'::jsonb,
    title text,
    content text NOT NULL,
    content_html text,
    content_preview text GENERATED ALWAYS AS ("left"(content, 200)) STORED,
    classification public.feedback_classification,
    classification_confidence numeric(3,2),
    classification_reason text,
    urgency_score integer,
    urgency_reason text,
    sentiment_score numeric(3,2),
    sentiment_category text,
    sentiment_analysis_id uuid,
    engagement_score integer DEFAULT 0,
    engagement_metrics jsonb DEFAULT '{}'::jsonb,
    tags text[] DEFAULT ARRAY[]::text[],
    auto_tagged boolean DEFAULT true,
    discovered_at timestamp with time zone NOT NULL,
    processed_at timestamp with time zone,
    theme_analyzed_at timestamp with time zone,
    responded_at timestamp with time zone,
    response_content text,
    response_url text,
    is_duplicate boolean DEFAULT false,
    duplicate_of uuid,
    is_archived boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    customer_profile_id uuid,
    customer_email text,
    customer_company text,
    customer_segment text,
    customer_mrr numeric(10,2),
    customer_plan_tier text,
    relevance_score integer,
    relevance_reasoning text,
    needs_review boolean DEFAULT false,
    processing_status text DEFAULT 'complete'::text,
    CONSTRAINT discovered_feedback_classification_confidence_check CHECK (((classification_confidence >= (0)::numeric) AND (classification_confidence <= (1)::numeric))),
    CONSTRAINT discovered_feedback_processing_status_check CHECK ((processing_status = ANY (ARRAY['pending'::text, 'processing'::text, 'complete'::text, 'failed'::text]))),
    CONSTRAINT discovered_feedback_sentiment_score_check CHECK (((sentiment_score >= ('-1'::integer)::numeric) AND (sentiment_score <= (1)::numeric))),
    CONSTRAINT discovered_feedback_urgency_score_check CHECK (((urgency_score >= 1) AND (urgency_score <= 5)))
);


--
-- Name: TABLE discovered_feedback; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.discovered_feedback IS 'Feedback items discovered from external platforms';


--
-- Name: COLUMN discovered_feedback.urgency_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.discovered_feedback.urgency_score IS '1-5 scale where 5 = critical, needs response <2 hours';


--
-- Name: COLUMN discovered_feedback.engagement_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.discovered_feedback.engagement_score IS 'Calculated score based on likes, shares, comments, etc.';


--
-- Name: COLUMN discovered_feedback.customer_mrr; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.discovered_feedback.customer_mrr IS 'Denormalized MRR for quick filtering without JOIN';


--
-- Name: domain_verifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.domain_verifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    domain character varying(255) NOT NULL,
    verification_token character varying(255) NOT NULL,
    verification_method character varying(50) DEFAULT 'dns_txt'::character varying NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    verification_data jsonb,
    created_at timestamp with time zone DEFAULT now(),
    verified_at timestamp with time zone,
    expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
    attempts integer DEFAULT 0,
    last_attempt_at timestamp with time zone,
    error_message text
);


--
-- Name: TABLE domain_verifications; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.domain_verifications IS 'Records of domain verification attempts';


--
-- Name: COLUMN domain_verifications.domain; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.domain IS 'Domain being verified';


--
-- Name: COLUMN domain_verifications.verification_token; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.verification_token IS 'Token used for verification';


--
-- Name: COLUMN domain_verifications.verification_method; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.verification_method IS 'Method used for verification';


--
-- Name: COLUMN domain_verifications.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.status IS 'Verification status (pending, verified, failed, expired)';


--
-- Name: COLUMN domain_verifications.verification_data; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.verification_data IS 'Additional verification data (DNS records, etc.)';


--
-- Name: COLUMN domain_verifications.attempts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.attempts IS 'Number of verification attempts';


--
-- Name: COLUMN domain_verifications.error_message; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.domain_verifications.error_message IS 'Last error message if verification failed';


--
-- Name: email_batches; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_batches (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    to_email character varying(255) NOT NULL,
    batch_date date DEFAULT CURRENT_DATE,
    email_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: email_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    email_type character varying(50) NOT NULL,
    to_email character varying(255) NOT NULL,
    from_email character varying(255) DEFAULT 'noreply@signalsloop.com'::character varying,
    subject text,
    post_id uuid,
    comment_id uuid,
    project_id uuid,
    resend_id character varying(255),
    sent_at timestamp with time zone DEFAULT now(),
    delivered_at timestamp with time zone,
    opened_at timestamp with time zone,
    clicked_at timestamp with time zone,
    bounced_at timestamp with time zone,
    failed_at timestamp with time zone,
    error_message text,
    metadata jsonb,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: email_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid,
    email character varying(255),
    status_change_emails boolean DEFAULT true,
    comment_reply_emails boolean DEFAULT true,
    vote_milestone_emails boolean DEFAULT true,
    weekly_digest boolean DEFAULT true,
    mention_emails boolean DEFAULT true,
    unsubscribed_at timestamp with time zone,
    unsubscribe_token character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    team_feedback_alert_emails boolean DEFAULT true,
    CONSTRAINT email_preferences_check CHECK (((user_id IS NOT NULL) OR (email IS NOT NULL)))
);


--
-- Name: email_queue; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_queue (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    email_type character varying(50) NOT NULL,
    recipient_email character varying(255) NOT NULL,
    project_id uuid,
    email_data jsonb NOT NULL,
    status character varying(20) DEFAULT 'pending'::character varying,
    scheduled_at timestamp with time zone DEFAULT now(),
    processed_at timestamp with time zone,
    retry_count integer DEFAULT 0,
    max_retries integer DEFAULT 3,
    next_retry_at timestamp with time zone,
    error_message text,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT email_queue_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying, 'sent'::character varying, 'failed'::character varying])::text[])))
);


--
-- Name: email_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    template_type character varying(50) NOT NULL,
    subject_template text NOT NULL,
    html_template text NOT NULL,
    text_template text,
    brand_colors jsonb,
    logo_url character varying(500),
    custom_css text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: emerging_themes_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.emerging_themes_view AS
SELECT
    NULL::uuid AS id,
    NULL::uuid AS project_id,
    NULL::uuid AS cluster_id,
    NULL::text AS theme_name,
    NULL::text AS description,
    NULL::integer AS frequency,
    NULL::numeric(3,2) AS avg_sentiment,
    NULL::timestamp with time zone AS first_seen,
    NULL::timestamp with time zone AS last_seen,
    NULL::boolean AS is_emerging,
    NULL::timestamp with time zone AS created_at,
    NULL::timestamp with time zone AS updated_at,
    NULL::bigint AS recent_mentions,
    NULL::bigint AS previous_mentions;


--
-- Name: VIEW emerging_themes_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.emerging_themes_view IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    type text NOT NULL,
    aggregate_type text NOT NULL,
    aggregate_id uuid NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    processed boolean DEFAULT false,
    processed_at timestamp with time zone,
    processing_error text,
    retry_count integer DEFAULT 0
);

ALTER TABLE ONLY public.events REPLICA IDENTITY FULL;


--
-- Name: TABLE events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.events IS 'Domain events for event-driven architecture. RLS enabled - users can only see events for projects they are members of. Events without project_id are visible to all authenticated users.';


--
-- Name: COLUMN events.type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.type IS 'Event type in domain.action format (e.g., feedback.created, sentiment.analyzed)';


--
-- Name: COLUMN events.aggregate_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.aggregate_type IS 'Type of entity this event relates to (e.g., post, spec, theme)';


--
-- Name: COLUMN events.aggregate_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.aggregate_id IS 'UUID of the entity this event relates to';


--
-- Name: COLUMN events.payload; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.payload IS 'Event-specific data as JSON';


--
-- Name: COLUMN events.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.metadata IS 'Event metadata including user_id, project_id, timestamp, correlation_id for tracing';


--
-- Name: COLUMN events.version; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.version IS 'Schema version for backward compatibility during event schema evolution';


--
-- Name: COLUMN events.processed; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.processed IS 'Whether this event has been processed by an agent';


--
-- Name: COLUMN events.processed_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.processed_at IS 'Timestamp when this event was successfully processed';


--
-- Name: COLUMN events.processing_error; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.processing_error IS 'Error message if processing failed';


--
-- Name: COLUMN events.retry_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.retry_count IS 'Number of times we have attempted to process this event';


--
-- Name: executive_briefs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.executive_briefs (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    template_id uuid,
    title character varying(500) NOT NULL,
    period_start date NOT NULL,
    period_end date NOT NULL,
    brief_type character varying(50) DEFAULT 'weekly'::character varying,
    content_markdown text,
    content_html text,
    summary text,
    data jsonb DEFAULT '{}'::jsonb,
    metrics jsonb DEFAULT '{}'::jsonb,
    top_insights jsonb DEFAULT '[]'::jsonb,
    action_items jsonb DEFAULT '[]'::jsonb,
    revenue_at_risk numeric(12,2),
    accounts_at_risk integer DEFAULT 0,
    competitor_moves jsonb DEFAULT '[]'::jsonb,
    pdf_url text,
    notion_page_id text,
    status character varying(20) DEFAULT 'draft'::character varying,
    generation_started_at timestamp with time zone,
    generation_completed_at timestamp with time zone,
    generation_error text,
    sent_at timestamp with time zone,
    sent_to jsonb DEFAULT '[]'::jsonb,
    sent_via character varying(50),
    opened_count integer DEFAULT 0,
    clicked_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid
);


--
-- Name: experiment_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.experiment_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    experiment_id uuid NOT NULL,
    content text NOT NULL,
    content_type text DEFAULT 'full_experiment'::text,
    embedding public.vector(1536) NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT experiment_embeddings_content_type_check CHECK ((content_type = ANY (ARRAY['full_experiment'::text, 'hypothesis'::text, 'learnings'::text, 'results'::text])))
);


--
-- Name: TABLE experiment_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.experiment_embeddings IS 'Vector embeddings for semantic search over experiment knowledge base';


--
-- Name: experiment_learnings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.experiment_learnings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    experiment_id uuid NOT NULL,
    learning_type text NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    tags jsonb DEFAULT '[]'::jsonb,
    impact_score integer,
    applicable_to jsonb DEFAULT '[]'::jsonb,
    ai_generated boolean DEFAULT false,
    extraction_confidence numeric,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT experiment_learnings_impact_score_check CHECK (((impact_score >= 1) AND (impact_score <= 10))),
    CONSTRAINT experiment_learnings_learning_type_check CHECK ((learning_type = ANY (ARRAY['insight'::text, 'recommendation'::text, 'mistake'::text, 'success'::text, 'hypothesis_invalidated'::text, 'hypothesis_validated'::text])))
);


--
-- Name: TABLE experiment_learnings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.experiment_learnings IS 'Key learnings and insights extracted from experiments';


--
-- Name: COLUMN experiment_learnings.learning_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiment_learnings.learning_type IS 'Classification: insight, recommendation, mistake, success, hypothesis_validated/invalidated';


--
-- Name: experiment_results; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.experiment_results (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    experiment_id uuid NOT NULL,
    metric_name text NOT NULL,
    variant text NOT NULL,
    sample_size integer NOT NULL,
    mean_value numeric,
    std_dev numeric,
    median_value numeric,
    conversion_rate numeric,
    p_value numeric,
    confidence_interval jsonb,
    statistical_significance boolean DEFAULT false,
    effect_size numeric,
    relative_improvement numeric,
    data_source text,
    query_used text,
    measured_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE experiment_results; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.experiment_results IS 'Statistical results from experiment measurements';


--
-- Name: COLUMN experiment_results.statistical_significance; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiment_results.statistical_significance IS 'Whether result reached p < 0.05';


--
-- Name: experiment_snapshots; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.experiment_snapshots (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    experiment_id uuid NOT NULL,
    snapshot_type text NOT NULL,
    results_snapshot jsonb NOT NULL,
    notes text,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT experiment_snapshots_snapshot_type_check CHECK ((snapshot_type = ANY (ARRAY['daily'::text, 'milestone'::text, 'manual'::text])))
);


--
-- Name: TABLE experiment_snapshots; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.experiment_snapshots IS 'Point-in-time snapshots of experiment progress';


--
-- Name: experiment_sync_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.experiment_sync_log (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    experiment_id uuid NOT NULL,
    sync_type text NOT NULL,
    provider text NOT NULL,
    status text NOT NULL,
    results_synced integer DEFAULT 0,
    error_message text,
    raw_response jsonb,
    synced_by uuid,
    synced_at timestamp with time zone DEFAULT now(),
    CONSTRAINT experiment_sync_log_status_check CHECK ((status = ANY (ARRAY['success'::text, 'partial'::text, 'failed'::text]))),
    CONSTRAINT experiment_sync_log_sync_type_check CHECK ((sync_type = ANY (ARRAY['manual'::text, 'webhook'::text, 'scheduled'::text, 'auto'::text])))
);


--
-- Name: TABLE experiment_sync_log; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.experiment_sync_log IS 'Audit log of experiment data synchronization from external platforms';


--
-- Name: experiments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.experiments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    hypothesis text NOT NULL,
    expected_outcome text,
    experiment_type text NOT NULL,
    control_description text,
    treatment_description text,
    variants jsonb DEFAULT '[]'::jsonb,
    primary_metric text NOT NULL,
    secondary_metrics jsonb DEFAULT '[]'::jsonb,
    success_criteria text,
    sample_size_target integer,
    minimum_detectable_effect numeric,
    statistical_power numeric DEFAULT 0.8,
    confidence_level numeric DEFAULT 0.95,
    status text DEFAULT 'draft'::text,
    start_date timestamp with time zone,
    end_date timestamp with time zone,
    actual_end_date timestamp with time zone,
    feature_flag_key text,
    feature_flag_provider text,
    related_roadmap_item_id uuid,
    ai_generated boolean DEFAULT false,
    design_prompt text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    last_synced_at timestamp with time zone,
    sync_enabled boolean DEFAULT false,
    sync_frequency_minutes integer DEFAULT 15,
    external_experiment_id text,
    CONSTRAINT experiments_experiment_type_check CHECK ((experiment_type = ANY (ARRAY['ab_test'::text, 'multivariate'::text, 'feature_flag'::text, 'other'::text]))),
    CONSTRAINT experiments_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'ready'::text, 'running'::text, 'paused'::text, 'completed'::text, 'cancelled'::text])))
);


--
-- Name: TABLE experiments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.experiments IS 'Product experiments and A/B tests with AI-powered design assistance';


--
-- Name: COLUMN experiments.hypothesis; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.hypothesis IS 'If/Then hypothesis statement for the experiment';


--
-- Name: COLUMN experiments.experiment_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.experiment_type IS 'Type: ab_test, multivariate, feature_flag, or other';


--
-- Name: COLUMN experiments.minimum_detectable_effect; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.minimum_detectable_effect IS 'Smallest effect size worth detecting (as decimal, e.g., 0.05 for 5%)';


--
-- Name: COLUMN experiments.statistical_power; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.statistical_power IS 'Probability of detecting true effect (typically 0.8)';


--
-- Name: COLUMN experiments.sync_enabled; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.sync_enabled IS 'Whether to automatically sync results from feature flag provider';


--
-- Name: COLUMN experiments.sync_frequency_minutes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.sync_frequency_minutes IS 'How often to sync results (in minutes)';


--
-- Name: COLUMN experiments.external_experiment_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.experiments.external_experiment_id IS 'ID of experiment in external provider (LaunchDarkly, Optimizely)';


--
-- Name: feature_gaps; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_gaps (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    feature_name text NOT NULL,
    description text NOT NULL,
    mention_count integer DEFAULT 0,
    competitor_ids uuid[] DEFAULT ARRAY[]::uuid[],
    avg_sentiment numeric(3,2) DEFAULT 0,
    urgency_score numeric(5,2) DEFAULT 0,
    estimated_revenue_impact text,
    priority public.feature_gap_priority DEFAULT 'medium'::public.feature_gap_priority,
    status public.feature_gap_status DEFAULT 'identified'::public.feature_gap_status,
    user_quotes text[] DEFAULT ARRAY[]::text[],
    feedback_ids uuid[] DEFAULT ARRAY[]::uuid[],
    first_detected_at timestamp with time zone DEFAULT now(),
    last_updated_at timestamp with time zone DEFAULT now(),
    assigned_to uuid,
    roadmap_item_id uuid,
    shipped_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE feature_gaps; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.feature_gaps IS 'Features that competitors have which users are requesting';


--
-- Name: COLUMN feature_gaps.urgency_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feature_gaps.urgency_score IS 'AI-calculated urgency based on mention frequency, sentiment, and business impact';


--
-- Name: COLUMN feature_gaps.estimated_revenue_impact; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feature_gaps.estimated_revenue_impact IS 'Estimated revenue at risk or opportunity if feature built/not built';


--
-- Name: feature_gaps_with_competitors; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.feature_gaps_with_competitors AS
SELECT
    NULL::uuid AS id,
    NULL::uuid AS project_id,
    NULL::text AS feature_name,
    NULL::text AS description,
    NULL::integer AS mention_count,
    NULL::uuid[] AS competitor_ids,
    NULL::numeric(3,2) AS avg_sentiment,
    NULL::numeric(5,2) AS urgency_score,
    NULL::text AS estimated_revenue_impact,
    NULL::public.feature_gap_priority AS priority,
    NULL::public.feature_gap_status AS status,
    NULL::text[] AS user_quotes,
    NULL::uuid[] AS feedback_ids,
    NULL::timestamp with time zone AS first_detected_at,
    NULL::timestamp with time zone AS last_updated_at,
    NULL::uuid AS assigned_to,
    NULL::uuid AS roadmap_item_id,
    NULL::timestamp with time zone AS shipped_at,
    NULL::timestamp with time zone AS created_at,
    NULL::timestamp with time zone AS updated_at,
    NULL::text[] AS competitor_names,
    NULL::bigint AS actual_feedback_count;


--
-- Name: VIEW feature_gaps_with_competitors; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.feature_gaps_with_competitors IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: feature_impact_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_impact_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    suggestion_id uuid,
    feature_name text NOT NULL,
    feature_category text,
    launched_at timestamp with time zone,
    effort_estimate text,
    actual_effort_days integer,
    pre_sentiment_avg numeric(3,2),
    pre_feedback_volume_weekly integer,
    pre_churn_rate numeric(5,4),
    pre_nps_score integer,
    post_sentiment_avg numeric(3,2),
    post_feedback_volume_weekly integer,
    post_churn_rate numeric(5,4),
    post_nps_score integer,
    post_adoption_rate numeric(5,4),
    sentiment_impact numeric(3,2) GENERATED ALWAYS AS ((post_sentiment_avg - pre_sentiment_avg)) STORED,
    churn_impact numeric(5,4) GENERATED ALWAYS AS ((pre_churn_rate - post_churn_rate)) STORED,
    feedback_volume_impact integer GENERATED ALWAYS AS ((post_feedback_volume_weekly - pre_feedback_volume_weekly)) STORED,
    revenue_impact_estimate numeric(12,2),
    customer_segments_affected text[],
    success_rating integer,
    lessons_learned text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT feature_impact_history_effort_estimate_check CHECK ((effort_estimate = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'very_high'::text]))),
    CONSTRAINT feature_impact_history_success_rating_check CHECK (((success_rating >= 1) AND (success_rating <= 5)))
);


--
-- Name: TABLE feature_impact_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.feature_impact_history IS 'Historical data correlating features with outcomes for impact simulation and learning';


--
-- Name: feature_outcomes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_outcomes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    suggestion_id uuid NOT NULL,
    shipped_at timestamp with time zone NOT NULL,
    monitor_start timestamp with time zone DEFAULT now() NOT NULL,
    monitor_end timestamp with time zone DEFAULT (now() + '30 days'::interval) NOT NULL,
    pre_ship_sentiment numeric(5,4),
    pre_ship_theme_volume integer,
    pre_ship_churn_risk numeric(5,4),
    post_ship_sentiment numeric(5,4),
    post_ship_theme_volume integer,
    post_ship_churn_risk numeric(5,4),
    sentiment_delta numeric(5,4) GENERATED ALWAYS AS ((post_ship_sentiment - pre_ship_sentiment)) STORED,
    theme_volume_delta integer GENERATED ALWAYS AS ((post_ship_theme_volume - pre_ship_theme_volume)) STORED,
    outcome_classification text,
    classification_confidence numeric(5,4),
    classification_reasoning jsonb,
    related_themes text[],
    related_feedback_ids uuid[],
    sample_feedback jsonb DEFAULT '[]'::jsonb,
    status text DEFAULT 'monitoring'::text,
    notification_sent boolean DEFAULT false,
    notification_sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT feature_outcomes_outcome_classification_check CHECK ((outcome_classification = ANY (ARRAY['success'::text, 'partial_success'::text, 'no_impact'::text, 'negative_impact'::text, 'pending'::text]))),
    CONSTRAINT feature_outcomes_status_check CHECK ((status = ANY (ARRAY['monitoring'::text, 'completed'::text, 'cancelled'::text])))
);


--
-- Name: TABLE feature_outcomes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.feature_outcomes IS 'Tracks feature outcomes after shipping to enable learning from launches';


--
-- Name: COLUMN feature_outcomes.pre_ship_sentiment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feature_outcomes.pre_ship_sentiment IS 'Average sentiment of related feedback before feature shipped';


--
-- Name: COLUMN feature_outcomes.post_ship_sentiment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feature_outcomes.post_ship_sentiment IS 'Average sentiment of related feedback after feature shipped';


--
-- Name: COLUMN feature_outcomes.outcome_classification; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feature_outcomes.outcome_classification IS 'AI-generated classification of feature success';


--
-- Name: COLUMN feature_outcomes.classification_reasoning; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feature_outcomes.classification_reasoning IS 'JSON object with AI reasoning, key factors, and recommendations';


--
-- Name: roadmap_suggestions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_suggestions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    theme_id uuid NOT NULL,
    priority_score numeric(5,2) NOT NULL,
    priority_level text NOT NULL,
    frequency_score numeric(5,4) NOT NULL,
    sentiment_score numeric(5,4) NOT NULL,
    business_impact_score numeric(5,4) NOT NULL,
    effort_score numeric(5,4) NOT NULL,
    competitive_score numeric(5,4) NOT NULL,
    reasoning_text text,
    why_matters text,
    business_impact_text text,
    user_segments_affected text,
    implementation_strategy text,
    risks_dependencies text,
    trade_offs text,
    recommendation_text text,
    manual_priority_adjustment integer,
    pinned boolean DEFAULT false,
    status text DEFAULT 'suggested'::text NOT NULL,
    internal_notes text,
    generated_at timestamp with time zone DEFAULT now() NOT NULL,
    regenerated_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT roadmap_suggestions_business_impact_score_check CHECK (((business_impact_score >= (0)::numeric) AND (business_impact_score <= (1)::numeric))),
    CONSTRAINT roadmap_suggestions_competitive_score_check CHECK (((competitive_score >= (0)::numeric) AND (competitive_score <= (1)::numeric))),
    CONSTRAINT roadmap_suggestions_effort_score_check CHECK (((effort_score >= (0)::numeric) AND (effort_score <= (1)::numeric))),
    CONSTRAINT roadmap_suggestions_frequency_score_check CHECK (((frequency_score >= (0)::numeric) AND (frequency_score <= (1)::numeric))),
    CONSTRAINT roadmap_suggestions_manual_priority_adjustment_check CHECK (((manual_priority_adjustment >= '-50'::integer) AND (manual_priority_adjustment <= 50))),
    CONSTRAINT roadmap_suggestions_priority_level_check CHECK ((priority_level = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text]))),
    CONSTRAINT roadmap_suggestions_priority_score_check CHECK (((priority_score >= (0)::numeric) AND (priority_score <= (100)::numeric))),
    CONSTRAINT roadmap_suggestions_sentiment_score_check CHECK (((sentiment_score >= (0)::numeric) AND (sentiment_score <= (1)::numeric))),
    CONSTRAINT roadmap_suggestions_status_check CHECK ((status = ANY (ARRAY['suggested'::text, 'in_progress'::text, 'completed'::text, 'deferred'::text])))
);


--
-- Name: TABLE roadmap_suggestions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.roadmap_suggestions IS 'AI-generated roadmap suggestions with multi-factor scoring and strategic reasoning';


--
-- Name: COLUMN roadmap_suggestions.priority_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.priority_score IS 'Overall priority score (0-100) calculated from weighted factors';


--
-- Name: COLUMN roadmap_suggestions.priority_level; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.priority_level IS 'Priority bucket: critical (P0), high (P1), medium (P2), low (P3)';


--
-- Name: COLUMN roadmap_suggestions.frequency_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.frequency_score IS 'Normalized frequency score based on mention count (0-1)';


--
-- Name: COLUMN roadmap_suggestions.sentiment_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.sentiment_score IS 'Normalized sentiment score - negative sentiment = higher priority (0-1)';


--
-- Name: COLUMN roadmap_suggestions.business_impact_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.business_impact_score IS 'Business impact score from urgency, keywords, velocity (0-1)';


--
-- Name: COLUMN roadmap_suggestions.effort_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.effort_score IS 'Effort score - lower effort = higher score for quick wins (0-1)';


--
-- Name: COLUMN roadmap_suggestions.competitive_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.competitive_score IS 'Competitive pressure score based on competitor feature parity (0-1)';


--
-- Name: COLUMN roadmap_suggestions.manual_priority_adjustment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.manual_priority_adjustment IS 'Manual adjustment to priority score (-50 to +50 points)';


--
-- Name: COLUMN roadmap_suggestions.pinned; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.pinned IS 'Pin suggestion to top of list regardless of score';


--
-- Name: COLUMN roadmap_suggestions.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.roadmap_suggestions.status IS 'Roadmap item status: suggested, in_progress, completed, deferred';


--
-- Name: feature_outcomes_detailed; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.feature_outcomes_detailed WITH (security_barrier='true', security_invoker='true') AS
 SELECT fo.id,
    fo.project_id,
    fo.suggestion_id,
    fo.shipped_at,
    fo.monitor_start,
    fo.monitor_end,
    fo.pre_ship_sentiment,
    fo.pre_ship_theme_volume,
    fo.pre_ship_churn_risk,
    fo.post_ship_sentiment,
    fo.post_ship_theme_volume,
    fo.post_ship_churn_risk,
    fo.sentiment_delta,
    fo.theme_volume_delta,
    fo.outcome_classification,
    fo.classification_confidence,
    fo.classification_reasoning,
    fo.related_themes,
    fo.related_feedback_ids,
    fo.sample_feedback,
    fo.status,
    fo.notification_sent,
    fo.notification_sent_at,
    fo.created_at,
    fo.updated_at,
    rs.priority_score,
    rs.priority_level,
    t.theme_name,
    t.frequency AS mention_count,
    t.avg_sentiment AS theme_avg_sentiment,
    p.name AS project_name,
    p.owner_id,
        CASE
            WHEN (fo.monitor_end <= now()) THEN 'expired'::text
            WHEN (fo.status = 'monitoring'::text) THEN 'active'::text
            ELSE fo.status
        END AS monitor_status,
    EXTRACT(day FROM (fo.monitor_end - now())) AS days_remaining
   FROM (((public.feature_outcomes fo
     JOIN public.roadmap_suggestions rs ON ((fo.suggestion_id = rs.id)))
     JOIN public.themes t ON ((rs.theme_id = t.id)))
     JOIN public.projects p ON ((fo.project_id = p.id)));


--
-- Name: VIEW feature_outcomes_detailed; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.feature_outcomes_detailed IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: feature_predictions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_predictions (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    spec_id uuid,
    feature_name text NOT NULL,
    feature_description text,
    predicted_adoption_rate numeric(5,4),
    predicted_sentiment_impact numeric(3,2),
    predicted_revenue_impact numeric(12,2),
    predicted_churn_reduction numeric(5,4),
    confidence_score numeric(3,2) NOT NULL,
    confidence_interval_low numeric(3,2),
    confidence_interval_high numeric(3,2),
    input_features jsonb DEFAULT '{}'::jsonb NOT NULL,
    explanation_text text NOT NULL,
    explanation_factors jsonb DEFAULT '[]'::jsonb NOT NULL,
    prediction_strategy text NOT NULL,
    strategy_metadata jsonb DEFAULT '{}'::jsonb,
    similar_feature_ids uuid[] DEFAULT '{}'::uuid[],
    actual_adoption_rate numeric(5,4),
    actual_sentiment_impact numeric(3,2),
    actual_revenue_impact numeric(12,2),
    prediction_accuracy numeric(3,2),
    model_name character varying(100),
    model_version character varying(50),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT feature_predictions_adoption_range CHECK (((predicted_adoption_rate IS NULL) OR ((predicted_adoption_rate >= (0)::numeric) AND (predicted_adoption_rate <= (1)::numeric)))),
    CONSTRAINT feature_predictions_confidence_range CHECK (((confidence_score >= (0)::numeric) AND (confidence_score <= (1)::numeric))),
    CONSTRAINT feature_predictions_prediction_strategy_check CHECK ((prediction_strategy = ANY (ARRAY['heuristic'::text, 'similar_features'::text, 'ml_model'::text]))),
    CONSTRAINT feature_predictions_sentiment_range CHECK (((predicted_sentiment_impact IS NULL) OR ((predicted_sentiment_impact >= ('-1'::integer)::numeric) AND (predicted_sentiment_impact <= (1)::numeric))))
);


--
-- Name: feedback_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feedback_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    feedback_id uuid NOT NULL,
    project_id uuid NOT NULL,
    embedding public.vector(1536),
    content_hash text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE feedback_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.feedback_embeddings IS 'Vector embeddings of feedback items for semantic search';


--
-- Name: COLUMN feedback_embeddings.embedding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feedback_embeddings.embedding IS 'OpenAI text-embedding-3-small vector (1536 dimensions)';


--
-- Name: COLUMN feedback_embeddings.content_hash; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feedback_embeddings.content_hash IS 'Hash of content to detect when re-embedding is needed';


--
-- Name: feedback_integrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feedback_integrations (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    integration_type character varying(50) NOT NULL,
    display_name character varying(255),
    icon_url text,
    credentials jsonb DEFAULT '{}'::jsonb,
    config jsonb DEFAULT '{}'::jsonb,
    sync_enabled boolean DEFAULT true,
    sync_frequency_minutes integer DEFAULT 15,
    last_sync_at timestamp with time zone,
    last_sync_status character varying(20),
    last_sync_error text,
    last_sync_items_count integer DEFAULT 0,
    total_items_synced integer DEFAULT 0,
    total_items_this_month integer DEFAULT 0,
    is_active boolean DEFAULT true,
    is_connected boolean DEFAULT false,
    connection_verified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: feedback_merges; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feedback_merges (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    primary_post_id uuid NOT NULL,
    merged_post_id uuid NOT NULL,
    similarity_score numeric NOT NULL,
    merge_reason text,
    auto_merged boolean DEFAULT false,
    merged_by uuid,
    merged_at timestamp with time zone DEFAULT now(),
    CONSTRAINT feedback_merges_similarity_score_check CHECK (((similarity_score >= (0)::numeric) AND (similarity_score <= (1)::numeric)))
);


--
-- Name: TABLE feedback_merges; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.feedback_merges IS 'Track feedback merges (manual and automatic)';


--
-- Name: feedback_themes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feedback_themes (
    feedback_id uuid NOT NULL,
    theme_id uuid NOT NULL,
    confidence numeric(3,2) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT feedback_themes_confidence_check CHECK (((confidence >= (0)::numeric) AND (confidence <= (1)::numeric)))
);


--
-- Name: TABLE feedback_themes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.feedback_themes IS 'Many-to-many relationship between feedback posts and themes';


--
-- Name: COLUMN feedback_themes.confidence; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.feedback_themes.confidence IS 'AI confidence score (0-1) for theme assignment';


--
-- Name: feedback_webhooks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feedback_webhooks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    webhook_url text NOT NULL,
    webhook_secret character varying(255) NOT NULL,
    events text[] DEFAULT ARRAY['post.created'::text, 'post.status_changed'::text, 'post.deleted'::text, 'comment.created'::text, 'vote.created'::text],
    is_active boolean DEFAULT true,
    description text,
    last_triggered_at timestamp with time zone,
    last_status_code integer,
    failure_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: gift_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.gift_subscriptions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    gifter_id uuid,
    gifter_email character varying(255) NOT NULL,
    recipient_email character varying(255) NOT NULL,
    recipient_id uuid,
    gift_type character varying(50) DEFAULT 'pro'::character varying,
    duration_months integer DEFAULT 1,
    status character varying(50) DEFAULT 'pending'::character varying,
    expires_at timestamp with time zone,
    claimed_at timestamp with time zone,
    gift_message text,
    admin_notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    redemption_code character varying(50),
    recipient_name character varying(255),
    sender_name character varying(255),
    CONSTRAINT gift_subscriptions_duration_months_check CHECK ((duration_months > 0)),
    CONSTRAINT gift_subscriptions_gift_type_check CHECK (((gift_type)::text = ANY ((ARRAY['pro'::character varying, 'enterprise'::character varying])::text[]))),
    CONSTRAINT gift_subscriptions_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'claimed'::character varying, 'expired'::character varying, 'cancelled'::character varying])::text[])))
);


--
-- Name: health_scores; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.health_scores (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_id uuid,
    product_name text,
    score integer NOT NULL,
    grade text NOT NULL,
    components jsonb NOT NULL,
    actions jsonb NOT NULL,
    interpretation text,
    share_token text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT health_scores_score_check CHECK (((score >= 0) AND (score <= 100)))
);


--
-- Name: TABLE health_scores; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.health_scores IS 'Product health scores with shareable badges. RLS enabled - anyone can view shared scores.';


--
-- Name: hunter_configs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.hunter_configs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    company_name text NOT NULL,
    name_variations text[] DEFAULT ARRAY[]::text[],
    competitors text[] DEFAULT ARRAY[]::text[],
    industry text,
    keywords text[] DEFAULT ARRAY[]::text[],
    excluded_keywords text[] DEFAULT ARRAY[]::text[],
    auto_classify boolean DEFAULT true,
    auto_sentiment_analysis boolean DEFAULT true,
    auto_theme_detection boolean DEFAULT true,
    theme_detection_threshold integer DEFAULT 50,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    product_tagline text,
    product_category text,
    product_description text,
    target_audience text,
    website_url text,
    social_handles jsonb DEFAULT '{}'::jsonb,
    exclude_terms text[] DEFAULT '{}'::text[]
);


--
-- Name: TABLE hunter_configs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.hunter_configs IS 'Configuration for AI Feedback Hunter per project';


--
-- Name: hunter_dashboard_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.hunter_dashboard_stats WITH (security_barrier='true', security_invoker='true') AS
 SELECT project_id,
    count(DISTINCT id) AS total_feedback,
    count(DISTINCT id) FILTER (WHERE (discovered_at > (now() - '24:00:00'::interval))) AS feedback_last_24h,
    count(DISTINCT id) FILTER (WHERE (discovered_at > (now() - '7 days'::interval))) AS feedback_last_7d,
    count(DISTINCT platform) AS active_platforms,
    avg(sentiment_score) AS avg_sentiment,
    count(DISTINCT id) FILTER (WHERE (urgency_score >= 4)) AS urgent_items,
    count(DISTINCT id) FILTER (WHERE (classification = 'churn_risk'::public.feedback_classification)) AS churn_risks,
    count(DISTINCT id) FILTER (WHERE (classification = 'bug'::public.feedback_classification)) AS bugs,
    count(DISTINCT id) FILTER (WHERE (classification = 'feature_request'::public.feedback_classification)) AS feature_requests,
    count(DISTINCT id) FILTER (WHERE (responded_at IS NOT NULL)) AS responded_count,
    max(discovered_at) AS last_discovery
   FROM public.discovered_feedback df
  WHERE ((is_duplicate = false) AND (is_archived = false))
  GROUP BY project_id;


--
-- Name: VIEW hunter_dashboard_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.hunter_dashboard_stats IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: hunter_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.hunter_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    platform public.platform_type NOT NULL,
    integration_id uuid,
    scan_type text DEFAULT 'scheduled'::text,
    items_found integer DEFAULT 0,
    items_stored integer DEFAULT 0,
    items_duplicates integer DEFAULT 0,
    duration_ms integer,
    success boolean NOT NULL,
    error_message text,
    error_stack text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE hunter_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.hunter_logs IS 'Audit log of all hunter scans and results';


--
-- Name: hunter_raw_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.hunter_raw_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    scan_id uuid NOT NULL,
    project_id uuid NOT NULL,
    platform text NOT NULL,
    external_id text,
    external_url text,
    title text,
    content text NOT NULL,
    author text,
    posted_at timestamp with time zone,
    raw_metadata jsonb DEFAULT '{}'::jsonb,
    relevance_score integer,
    relevance_decision text,
    relevance_reason text,
    classification jsonb,
    stage text DEFAULT 'discovered'::text,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT hunter_raw_items_relevance_decision_check CHECK ((relevance_decision = ANY (ARRAY['include'::text, 'exclude'::text, 'human_review'::text]))),
    CONSTRAINT hunter_raw_items_stage_check CHECK ((stage = ANY (ARRAY['discovered'::text, 'filtered'::text, 'classified'::text, 'stored'::text, 'excluded'::text])))
);


--
-- Name: hunter_scans; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.hunter_scans (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    status text DEFAULT 'running'::text,
    platforms jsonb DEFAULT '{}'::jsonb NOT NULL,
    total_discovered integer DEFAULT 0,
    total_relevant integer DEFAULT 0,
    total_classified integer DEFAULT 0,
    started_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    triggered_by uuid,
    CONSTRAINT hunter_scans_status_check CHECK ((status = ANY (ARRAY['running'::text, 'complete'::text, 'partial'::text, 'failed'::text, 'cancelled'::text])))
);


--
-- Name: inbox_sync_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.inbox_sync_logs (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    integration_id uuid NOT NULL,
    sync_type character varying(20) NOT NULL,
    status character varying(20) NOT NULL,
    items_found integer DEFAULT 0,
    items_imported integer DEFAULT 0,
    items_duplicates integer DEFAULT 0,
    items_errors integer DEFAULT 0,
    error_message text,
    error_details jsonb,
    started_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    duration_ms integer,
    metadata jsonb DEFAULT '{}'::jsonb
);


--
-- Name: insight_reports; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.insight_reports (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    report_type character varying(50) NOT NULL,
    report_period_start timestamp with time zone NOT NULL,
    report_period_end timestamp with time zone NOT NULL,
    executive_summary text NOT NULL,
    key_insights jsonb DEFAULT '[]'::jsonb NOT NULL,
    total_feedback_analyzed integer NOT NULL,
    sentiment_trend character varying(20),
    sentiment_change_pct numeric(5,2),
    top_themes jsonb DEFAULT '[]'::jsonb,
    biggest_wins text[],
    critical_issues text[],
    emerging_trends text[],
    forecasted_sentiment_next_week numeric(3,2),
    churn_risk_alerts integer DEFAULT 0,
    recommended_actions jsonb DEFAULT '[]'::jsonb,
    model_name character varying(100) NOT NULL,
    model_version character varying(50),
    generation_time_ms integer,
    token_usage_input integer,
    token_usage_output integer,
    is_read boolean DEFAULT false,
    read_at timestamp with time zone,
    read_by uuid,
    user_rating integer,
    user_feedback text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: integration_credentials; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integration_credentials (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    provider text NOT NULL,
    api_key text NOT NULL,
    additional_config jsonb DEFAULT '{}'::jsonb,
    is_active boolean DEFAULT true,
    last_validated_at timestamp with time zone,
    validation_status text,
    validation_error text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT integration_credentials_provider_check CHECK ((provider = ANY (ARRAY['launchdarkly'::text, 'optimizely'::text, 'salesforce'::text, 'hubspot'::text, 'custom'::text]))),
    CONSTRAINT integration_credentials_validation_status_check CHECK ((validation_status = ANY (ARRAY['valid'::text, 'invalid'::text, 'pending'::text, 'error'::text])))
);


--
-- Name: TABLE integration_credentials; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.integration_credentials IS 'Stores encrypted API keys for LaunchDarkly, Optimizely, and other experiment platform integrations';


--
-- Name: jira_connections; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jira_connections (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    cloud_id text NOT NULL,
    site_url text NOT NULL,
    site_name text,
    access_token_encrypted text NOT NULL,
    refresh_token_encrypted text NOT NULL,
    token_expires_at timestamp with time zone NOT NULL,
    scopes text[] DEFAULT ARRAY[]::text[] NOT NULL,
    default_project_key text,
    default_issue_type text DEFAULT 'Bug'::text,
    default_priority text,
    default_assignee_id text,
    status public.jira_connection_status DEFAULT 'active'::public.jira_connection_status,
    last_error text,
    last_sync_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE jira_connections; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jira_connections IS 'OAuth connections to Jira Cloud workspaces with encrypted tokens';


--
-- Name: COLUMN jira_connections.cloud_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jira_connections.cloud_id IS 'Atlassian cloud ID from accessible-resources endpoint';


--
-- Name: COLUMN jira_connections.access_token_encrypted; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jira_connections.access_token_encrypted IS 'AES-256-GCM encrypted OAuth access token';


--
-- Name: COLUMN jira_connections.refresh_token_encrypted; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jira_connections.refresh_token_encrypted IS 'AES-256-GCM encrypted OAuth refresh token';


--
-- Name: jira_integration_overview; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.jira_integration_overview AS
SELECT
    NULL::uuid AS project_id,
    NULL::uuid AS connection_id,
    NULL::text AS site_url,
    NULL::text AS site_name,
    NULL::public.jira_connection_status AS connection_status,
    NULL::text AS default_project_key,
    NULL::timestamp with time zone AS last_sync_at,
    NULL::bigint AS total_issues_created,
    NULL::bigint AS issues_created_this_week,
    NULL::bigint AS issues_resolved,
    NULL::bigint AS issues_in_progress,
    NULL::bigint AS active_webhooks,
    NULL::bigint AS label_mappings;


--
-- Name: VIEW jira_integration_overview; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.jira_integration_overview IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: jira_issue_links; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jira_issue_links (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    feedback_id uuid NOT NULL,
    jira_connection_id uuid NOT NULL,
    issue_key text NOT NULL,
    issue_id text NOT NULL,
    issue_url text NOT NULL,
    project_key text NOT NULL,
    issue_type text NOT NULL,
    status text NOT NULL,
    priority text,
    summary text NOT NULL,
    assignee jsonb,
    sprint_id text,
    sprint_name text,
    epic_key text,
    sync_enabled boolean DEFAULT true,
    last_synced_at timestamp with time zone,
    created_in_jira_at timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE jira_issue_links; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jira_issue_links IS 'Links between SignalsLoop feedback items and Jira issues';


--
-- Name: COLUMN jira_issue_links.sync_enabled; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jira_issue_links.sync_enabled IS 'If false, status changes in Jira will not update SignalsLoop';


--
-- Name: jira_issues_with_feedback; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.jira_issues_with_feedback WITH (security_barrier='true', security_invoker='true') AS
 SELECT jil.id,
    jil.issue_key,
    jil.issue_url,
    jil.status AS jira_status,
    jil.priority,
    jil.summary,
    jil.assignee,
    jil.created_in_jira_at,
    jil.last_synced_at,
    df.id AS feedback_id,
    df.platform,
    df.content AS feedback_content,
    df.sentiment_score,
    df.classification,
    df.urgency_score,
    df.engagement_score,
    df.author_username,
    df.discovered_at,
    jc.site_url,
    jc.project_id
   FROM ((public.jira_issue_links jil
     JOIN public.discovered_feedback df ON ((jil.feedback_id = df.id)))
     JOIN public.jira_connections jc ON ((jil.jira_connection_id = jc.id)));


--
-- Name: VIEW jira_issues_with_feedback; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.jira_issues_with_feedback IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: jira_label_mappings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jira_label_mappings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    theme_id uuid NOT NULL,
    jira_labels text[] DEFAULT ARRAY[]::text[] NOT NULL,
    auto_apply boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE jira_label_mappings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jira_label_mappings IS 'Maps SignalsLoop themes to Jira labels for auto-tagging';


--
-- Name: COLUMN jira_label_mappings.auto_apply; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jira_label_mappings.auto_apply IS 'Automatically apply labels when creating issues from this theme';


--
-- Name: jira_oauth_states; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jira_oauth_states (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    state_token text NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() + '00:15:00'::interval) NOT NULL,
    consumed boolean DEFAULT false,
    consumed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE jira_oauth_states; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jira_oauth_states IS 'Temporary CSRF tokens for OAuth flow security';


--
-- Name: jira_sync_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jira_sync_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    jira_connection_id uuid,
    action public.jira_sync_action NOT NULL,
    jira_issue_key text,
    success boolean NOT NULL,
    error_message text,
    error_stack text,
    details jsonb DEFAULT '{}'::jsonb,
    duration_ms integer,
    user_id uuid,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE jira_sync_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jira_sync_logs IS 'Audit trail for all Jira integration activities';


--
-- Name: jira_webhooks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jira_webhooks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    jira_connection_id uuid NOT NULL,
    webhook_id text NOT NULL,
    webhook_url text NOT NULL,
    events text[] DEFAULT ARRAY[]::text[] NOT NULL,
    secret text NOT NULL,
    status public.jira_webhook_status DEFAULT 'active'::public.jira_webhook_status,
    last_error text,
    last_triggered_at timestamp with time zone,
    total_events_received integer DEFAULT 0,
    failed_events integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE jira_webhooks; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jira_webhooks IS 'Registered webhooks for bi-directional Jira sync';


--
-- Name: COLUMN jira_webhooks.secret; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jira_webhooks.secret IS 'Secret for HMAC signature verification of webhook payloads';


--
-- Name: launch_boards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.launch_boards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    feature_id uuid,
    title text NOT NULL,
    description text,
    target_date date,
    status text DEFAULT 'draft'::text,
    decision text,
    decision_at timestamp with time zone,
    decision_notes text,
    overall_score integer,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    share_token text,
    is_public boolean DEFAULT false,
    CONSTRAINT launch_boards_decision_check CHECK ((decision = ANY (ARRAY['go'::text, 'no_go'::text, 'conditional'::text]))),
    CONSTRAINT launch_boards_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'reviewing'::text, 'decided'::text])))
);


--
-- Name: launch_checklist_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.launch_checklist_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    board_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    is_ai boolean DEFAULT false,
    auto_verified boolean DEFAULT false,
    completed boolean DEFAULT false,
    completed_at timestamp with time zone,
    owner text,
    sort_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: launch_dimensions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.launch_dimensions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    board_id uuid NOT NULL,
    dimension_type text NOT NULL,
    ai_score integer,
    ai_insights jsonb DEFAULT '[]'::jsonb,
    team_notes text,
    customer_quotes jsonb DEFAULT '[]'::jsonb,
    prediction_data jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT launch_dimensions_ai_score_check CHECK (((ai_score >= 0) AND (ai_score <= 100))),
    CONSTRAINT launch_dimensions_dimension_type_check CHECK ((dimension_type = ANY (ARRAY['customer_readiness'::text, 'risk_assessment'::text, 'competitive_timing'::text, 'success_prediction'::text])))
);


--
-- Name: launch_risks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.launch_risks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    board_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    severity text DEFAULT 'medium'::text,
    status text DEFAULT 'open'::text,
    is_ai boolean DEFAULT false,
    source text,
    mitigation text,
    owner text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT launch_risks_severity_check CHECK ((severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text]))),
    CONSTRAINT launch_risks_status_check CHECK ((status = ANY (ARRAY['open'::text, 'mitigated'::text, 'acknowledged'::text])))
);


--
-- Name: launch_votes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.launch_votes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    board_id uuid NOT NULL,
    user_id uuid,
    name text NOT NULL,
    email text,
    role text,
    is_required boolean DEFAULT false,
    vote text,
    comment text,
    voted_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT launch_votes_vote_check CHECK ((vote = ANY (ARRAY['go'::text, 'no_go'::text, 'conditional'::text])))
);


--
-- Name: linear_connections; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.linear_connections (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    organization_id text NOT NULL,
    organization_name text NOT NULL,
    organization_url_key text,
    access_token_encrypted text NOT NULL,
    status text DEFAULT 'active'::text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT linear_connections_status_check CHECK ((status = ANY (ARRAY['active'::text, 'inactive'::text, 'error'::text])))
);


--
-- Name: lovable_generations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lovable_generations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    spec_id uuid,
    lovable_project_id text NOT NULL,
    lovable_url text NOT NULL,
    title text NOT NULL,
    design_preferences jsonb DEFAULT '{}'::jsonb,
    status text DEFAULT 'ready'::text,
    error_message text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT lovable_generations_status_check CHECK ((status = ANY (ARRAY['creating'::text, 'ready'::text, 'error'::text])))
);


--
-- Name: members; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.members (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    user_id uuid,
    role character varying(20) DEFAULT 'member'::character varying,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT members_role_check CHECK (((role)::text = ANY ((ARRAY['owner'::character varying, 'admin'::character varying, 'member'::character varying])::text[])))
);


--
-- Name: notification_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.notification_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    notification_type text NOT NULL,
    payload jsonb NOT NULL,
    sent_count integer DEFAULT 0,
    failed_count integer DEFAULT 0,
    target_user_ids uuid[] DEFAULT '{}'::uuid[],
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: persona_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.persona_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    persona_id uuid NOT NULL,
    project_id uuid NOT NULL,
    embedding public.vector(1536),
    content_hash text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE persona_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.persona_embeddings IS 'Vector embeddings for user personas';


--
-- Name: personas; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.personas (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name text NOT NULL,
    role text,
    description text NOT NULL,
    goals text,
    pain_points text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE personas; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.personas IS 'User personas captured for context-aware generation and search';


--
-- Name: platform_integrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.platform_integrations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    platform_type public.platform_type NOT NULL,
    config jsonb DEFAULT '{}'::jsonb NOT NULL,
    status public.integration_status DEFAULT 'setup'::public.integration_status,
    last_scan_at timestamp with time zone,
    next_scan_at timestamp with time zone,
    scan_frequency_minutes integer DEFAULT 15,
    total_scans integer DEFAULT 0,
    successful_scans integer DEFAULT 0,
    failed_scans integer DEFAULT 0,
    total_items_found integer DEFAULT 0,
    last_error text,
    error_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE platform_integrations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.platform_integrations IS 'Platform-specific integration settings and credentials';


--
-- Name: platform_health_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.platform_health_stats WITH (security_barrier='true', security_invoker='true') AS
 SELECT project_id,
    platform_type,
    status,
    last_scan_at,
    next_scan_at,
    total_scans,
    successful_scans,
    failed_scans,
    total_items_found,
        CASE
            WHEN (total_scans > 0) THEN round((((successful_scans)::numeric / (total_scans)::numeric) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS success_rate,
    error_count,
    last_error
   FROM public.platform_integrations pi;


--
-- Name: VIEW platform_health_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.platform_health_stats IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: pm_assignments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pm_assignments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    pm_user_id uuid,
    pm_name text NOT NULL,
    pm_email text NOT NULL,
    product_areas text[] DEFAULT '{}'::text[],
    priority_threshold integer DEFAULT 3,
    customer_segments text[] DEFAULT '{}'::text[],
    auto_assign_enabled boolean DEFAULT true,
    auto_merge_enabled boolean DEFAULT false,
    auto_merge_confidence_threshold numeric DEFAULT 0.85,
    notify_on_assignment boolean DEFAULT true,
    notify_on_merge boolean DEFAULT true,
    daily_digest_enabled boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT pm_assignments_auto_merge_confidence_threshold_check CHECK (((auto_merge_confidence_threshold >= (0)::numeric) AND (auto_merge_confidence_threshold <= (1)::numeric))),
    CONSTRAINT pm_assignments_priority_threshold_check CHECK (((priority_threshold >= 1) AND (priority_threshold <= 3)))
);


--
-- Name: TABLE pm_assignments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pm_assignments IS 'PM assignment rules and auto-triage configuration';


--
-- Name: poll_options; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.poll_options (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    poll_id uuid NOT NULL,
    option_text text NOT NULL,
    description text,
    linked_feedback_ids uuid[] DEFAULT '{}'::uuid[],
    ai_generated boolean DEFAULT false,
    display_order integer DEFAULT 0,
    vote_count integer DEFAULT 0,
    weighted_vote_count numeric DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE poll_options; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.poll_options IS 'Options for each poll with vote tracking';


--
-- Name: poll_votes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.poll_votes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    poll_id uuid NOT NULL,
    option_id uuid NOT NULL,
    voter_id uuid,
    voter_email text,
    voter_hash text NOT NULL,
    rank_position integer,
    explanation_text text,
    explanation_sentiment numeric,
    customer_id uuid,
    customer_mrr numeric,
    customer_segment text,
    ip_address inet,
    user_agent text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE poll_votes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.poll_votes IS 'Individual votes with CRM linking for revenue weighting';


--
-- Name: polls; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.polls (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    poll_type text NOT NULL,
    status text DEFAULT 'draft'::text,
    closes_at timestamp with time zone,
    created_by uuid,
    target_segments text[] DEFAULT '{}'::text[],
    target_customer_ids uuid[] DEFAULT '{}'::uuid[],
    related_theme_id uuid,
    related_feedback_ids uuid[] DEFAULT '{}'::uuid[],
    vote_count integer DEFAULT 0,
    unique_voter_count integer DEFAULT 0,
    allow_anonymous boolean DEFAULT true,
    require_explanation boolean DEFAULT false,
    show_results_before_vote boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT polls_poll_type_check CHECK ((poll_type = ANY (ARRAY['single_choice'::text, 'multiple_choice'::text, 'ranked'::text]))),
    CONSTRAINT polls_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'active'::text, 'closed'::text])))
);


--
-- Name: TABLE polls; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.polls IS 'Polls for gathering structured feedback from users';


--
-- Name: post_similarities; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.post_similarities (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid,
    similar_post_id uuid,
    similarity_score numeric(3,2) NOT NULL,
    similarity_reason text,
    status character varying(20) DEFAULT 'detected'::character varying,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT post_similarities_similarity_score_check CHECK (((similarity_score >= (0)::numeric) AND (similarity_score <= (1)::numeric))),
    CONSTRAINT post_similarities_status_check CHECK (((status)::text = ANY ((ARRAY['detected'::character varying, 'confirmed'::character varying, 'dismissed'::character varying, 'merged'::character varying])::text[])))
);


--
-- Name: sentiment_analysis; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sentiment_analysis (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid NOT NULL,
    sentiment_category text NOT NULL,
    sentiment_score numeric(3,2) NOT NULL,
    emotional_tone text,
    confidence_score numeric(3,2) NOT NULL,
    analyzed_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT sentiment_analysis_confidence_score_check CHECK (((confidence_score >= (0)::numeric) AND (confidence_score <= (1)::numeric))),
    CONSTRAINT sentiment_analysis_sentiment_category_check CHECK ((sentiment_category = ANY (ARRAY['positive'::text, 'negative'::text, 'neutral'::text, 'mixed'::text]))),
    CONSTRAINT sentiment_analysis_sentiment_score_check CHECK (((sentiment_score >= ('-1'::integer)::numeric) AND (sentiment_score <= (1)::numeric)))
);


--
-- Name: TABLE sentiment_analysis; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sentiment_analysis IS 'Stores AI-generated sentiment analysis results for feedback posts';


--
-- Name: COLUMN sentiment_analysis.sentiment_category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sentiment_analysis.sentiment_category IS 'Overall sentiment: positive, negative, neutral, or mixed';


--
-- Name: COLUMN sentiment_analysis.sentiment_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sentiment_analysis.sentiment_score IS 'Numerical score from -1 (very negative) to 1 (very positive)';


--
-- Name: COLUMN sentiment_analysis.emotional_tone; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sentiment_analysis.emotional_tone IS 'Detected emotional tone (e.g., frustrated, excited, concerned)';


--
-- Name: COLUMN sentiment_analysis.confidence_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sentiment_analysis.confidence_score IS 'AI confidence in the analysis from 0 to 1';


--
-- Name: posts_with_sentiment; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.posts_with_sentiment WITH (security_barrier='true', security_invoker='true') AS
 SELECT p.id,
    p.project_id,
    p.board_id,
    p.title,
    p.description,
    p.status,
    p.author_email,
    p.author_name,
    p.author_id,
    p.vote_count,
    p.comment_count,
    p.duplicate_of,
    p.created_at,
    p.updated_at,
    p.ai_category,
    p.ai_confidence,
    p.ai_reasoning,
    p.category,
    p.ai_categorized,
    p.estimated_completion,
    p.completion_date,
    p.priority_score,
    p.priority_reason,
    p.ai_analyzed_at,
    p.priority,
    p.effort_estimate,
    p.progress_percentage,
    p.estimated_timeline,
    p.tags,
    p.last_updated,
    p.must_have_votes,
    p.important_votes,
    p.nice_to_have_votes,
    p.total_priority_score,
    p.ai_duplicate_checked_at,
    sa.sentiment_category,
    sa.sentiment_score,
    sa.emotional_tone,
    sa.confidence_score,
    sa.analyzed_at AS sentiment_analyzed_at
   FROM (public.posts p
     LEFT JOIN public.sentiment_analysis sa ON ((p.id = sa.post_id)));


--
-- Name: VIEW posts_with_sentiment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.posts_with_sentiment IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: prd_risk_alerts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.prd_risk_alerts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    spec_id uuid NOT NULL,
    project_id uuid NOT NULL,
    risk_type text NOT NULL,
    severity text NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    evidence jsonb NOT NULL,
    recommended_action text NOT NULL,
    status text DEFAULT 'open'::text,
    resolution_notes text,
    resolved_by uuid,
    resolved_at timestamp with time zone,
    reasoning_trace jsonb,
    confidence_score numeric(3,2),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT prd_risk_alerts_risk_type_check CHECK ((risk_type = ANY (ARRAY['competitive_threat'::text, 'data_contradiction'::text, 'assumption_challenge'::text, 'market_shift'::text, 'technical_risk'::text, 'resource_constraint'::text]))),
    CONSTRAINT prd_risk_alerts_severity_check CHECK ((severity = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text]))),
    CONSTRAINT prd_risk_alerts_status_check CHECK ((status = ANY (ARRAY['open'::text, 'acknowledged'::text, 'resolved'::text, 'dismissed'::text])))
);


--
-- Name: TABLE prd_risk_alerts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.prd_risk_alerts IS 'AI-generated risk alerts that challenge PRDs based on competitor intelligence and internal data';


--
-- Name: COLUMN prd_risk_alerts.evidence; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.prd_risk_alerts.evidence IS 'Structured evidence supporting the alert: sources, data points, quotes';


--
-- Name: COLUMN prd_risk_alerts.reasoning_trace; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.prd_risk_alerts.reasoning_trace IS 'Detailed AI reasoning trace showing how the alert was generated';


--
-- Name: pre_mortem_analyses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pre_mortem_analyses (
    id text NOT NULL,
    project_id uuid NOT NULL,
    feature_id text NOT NULL,
    feature_name text NOT NULL,
    feature_description text,
    risks jsonb DEFAULT '[]'::jsonb NOT NULL,
    overall_risk_level text DEFAULT 'medium'::text NOT NULL,
    confidence_score numeric(3,2) DEFAULT 0.7,
    executive_summary text,
    top_concerns jsonb DEFAULT '[]'::jsonb,
    recommended_proceed boolean DEFAULT true,
    proceed_conditions jsonb DEFAULT '[]'::jsonb,
    spec_id uuid,
    analyzed_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT pre_mortem_analyses_overall_risk_level_check CHECK ((overall_risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])))
);


--
-- Name: product_doc_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.product_doc_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    product_doc_id uuid NOT NULL,
    project_id uuid NOT NULL,
    embedding public.vector(1536),
    content_hash text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE product_doc_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.product_doc_embeddings IS 'Vector embeddings for product documents and runbooks';


--
-- Name: product_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.product_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    title text NOT NULL,
    doc_type text DEFAULT 'internal'::text,
    content text NOT NULL,
    summary text,
    source_url text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    search_vector tsvector GENERATED ALWAYS AS (((setweight(to_tsvector('english'::regconfig, COALESCE(title, ''::text)), 'A'::"char") || setweight(to_tsvector('english'::regconfig, COALESCE(summary, ''::text)), 'B'::"char")) || setweight(to_tsvector('english'::regconfig, COALESCE(content, ''::text)), 'C'::"char"))) STORED,
    CONSTRAINT product_documents_doc_type_check CHECK ((doc_type = ANY (ARRAY['internal'::text, 'spec'::text, 'support'::text, 'runbook'::text, 'api'::text, 'other'::text])))
);


--
-- Name: TABLE product_documents; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.product_documents IS 'Internal product documents, specs, and runbooks used for RAG';


--
-- Name: project_notification_recipients; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.project_notification_recipients (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    email character varying(255) NOT NULL,
    name character varying(255),
    receive_weekly_digest boolean DEFAULT false,
    receive_team_alerts boolean DEFAULT true,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: push_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.push_subscriptions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    endpoint text NOT NULL,
    keys jsonb NOT NULL,
    preferences jsonb DEFAULT '{"specs": false, "weekly": false, "roadmap": false, "critical": true, "mentions": true, "anomalies": true, "competitive": true}'::jsonb,
    user_agent text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    last_used_at timestamp with time zone
);


--
-- Name: rate_limit_violations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.rate_limit_violations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    ip_address inet NOT NULL,
    type character varying(50) NOT NULL,
    user_agent text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: reasoning_traces; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.reasoning_traces (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    feature text NOT NULL,
    decision_type text NOT NULL,
    decision_summary text NOT NULL,
    inputs jsonb DEFAULT '{}'::jsonb NOT NULL,
    reasoning_steps jsonb DEFAULT '[]'::jsonb NOT NULL,
    outputs jsonb DEFAULT '{}'::jsonb NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    entity_type text,
    entity_id uuid,
    triggered_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT reasoning_traces_feature_check CHECK ((feature = ANY (ARRAY['devils_advocate'::text, 'prediction'::text, 'prioritization'::text, 'classification'::text, 'sentiment_analysis'::text, 'theme_detection'::text, 'spec_writer'::text, 'roadmap_suggestion'::text, 'competitive_intel'::text, 'anomaly_detection'::text, 'churn_prediction'::text, 'impact_simulation'::text, 'stakeholder_response'::text]))),
    CONSTRAINT reasoning_traces_valid_inputs CHECK ((jsonb_typeof(inputs) = 'object'::text)),
    CONSTRAINT reasoning_traces_valid_outputs CHECK ((jsonb_typeof(outputs) = 'object'::text)),
    CONSTRAINT reasoning_traces_valid_steps CHECK ((jsonb_typeof(reasoning_steps) = 'array'::text))
);


--
-- Name: recent_competitive_activity; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.recent_competitive_activity WITH (security_barrier='true', security_invoker='true') AS
 SELECT 'mention'::text AS activity_type,
    cm.id,
    c.project_id,
    c.name AS competitor_name,
    (cm.mention_type)::text AS activity_subtype,
    cm.context_snippet AS description,
    cm.sentiment_vs_you AS sentiment,
    cm.created_at
   FROM (public.competitive_mentions cm
     JOIN public.competitors c ON ((c.id = cm.competitor_id)))
  WHERE (cm.created_at >= (now() - '30 days'::interval))
UNION ALL
 SELECT 'event'::text AS activity_type,
    ce.id,
    c.project_id,
    c.name AS competitor_name,
    (ce.event_type)::text AS activity_subtype,
    ce.title AS description,
    ce.avg_sentiment AS sentiment,
    ce.created_at
   FROM (public.competitive_events ce
     JOIN public.competitors c ON ((c.id = ce.competitor_id)))
  WHERE (ce.created_at >= (now() - '30 days'::interval))
  ORDER BY 8 DESC;


--
-- Name: VIEW recent_competitive_activity; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.recent_competitive_activity IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: report_executions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.report_executions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    scheduled_report_id uuid NOT NULL,
    started_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    status text NOT NULL,
    component_count integer DEFAULT 0,
    generation_time_ms integer,
    delivery_status text,
    error_message text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT report_executions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'running'::text, 'completed'::text, 'failed'::text])))
);


--
-- Name: TABLE report_executions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.report_executions IS 'Tracks execution history of scheduled reports';


--
-- Name: retro_actions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retro_actions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    board_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    owner text,
    due_date date,
    status text DEFAULT 'not_started'::text,
    completed_at timestamp with time zone,
    from_card_id uuid,
    from_source text,
    external_id text,
    external_url text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT retro_actions_status_check CHECK ((status = ANY (ARRAY['not_started'::text, 'in_progress'::text, 'completed'::text])))
);


--
-- Name: retro_boards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retro_boards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    title text NOT NULL,
    period_type text NOT NULL,
    template text,
    start_date date NOT NULL,
    end_date date NOT NULL,
    team_happiness numeric(3,1),
    customer_sentiment numeric(3,2),
    metrics jsonb DEFAULT '[]'::jsonb,
    ai_summary text,
    status text DEFAULT 'active'::text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    share_token text,
    is_public boolean DEFAULT false,
    CONSTRAINT retro_boards_period_type_check CHECK ((period_type = ANY (ARRAY['sprint'::text, 'monthly'::text, 'quarterly'::text, 'yearly'::text, 'custom'::text]))),
    CONSTRAINT retro_boards_status_check CHECK ((status = ANY (ARRAY['active'::text, 'completed'::text, 'archived'::text])))
);


--
-- Name: retro_card_comments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retro_card_comments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    card_id uuid NOT NULL,
    text text NOT NULL,
    author text DEFAULT 'Anonymous'::text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: retro_card_votes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retro_card_votes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    card_id uuid NOT NULL,
    user_id uuid,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: retro_cards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retro_cards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    column_id uuid NOT NULL,
    content text NOT NULL,
    is_ai boolean DEFAULT false,
    source text,
    data_badge text,
    is_success boolean DEFAULT false,
    is_alert boolean DEFAULT false,
    vote_count integer DEFAULT 0,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    comments jsonb DEFAULT '[]'::jsonb
);


--
-- Name: retro_columns; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retro_columns (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    board_id uuid NOT NULL,
    column_key text NOT NULL,
    title text NOT NULL,
    emoji text,
    color text,
    sort_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: roadmap_adjustment_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_adjustment_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    proposal_id uuid NOT NULL,
    project_id uuid NOT NULL,
    suggestion_id uuid NOT NULL,
    theme_name text NOT NULL,
    old_priority text NOT NULL,
    new_priority text NOT NULL,
    old_score numeric(5,2),
    new_score numeric(5,2),
    outcome_validated boolean DEFAULT false,
    outcome_correct boolean,
    validated_at timestamp with time zone,
    validation_notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: roadmap_adjustment_proposals; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_adjustment_proposals (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    trigger_type text NOT NULL,
    trigger_severity text NOT NULL,
    trigger_description text NOT NULL,
    trigger_data jsonb DEFAULT '{}'::jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    proposed_changes jsonb DEFAULT '[]'::jsonb NOT NULL,
    ai_reasoning text,
    confidence_score numeric(3,2),
    reviewed_by uuid,
    reviewed_at timestamp with time zone,
    review_notes text,
    expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT roadmap_adjustment_proposals_confidence_score_check CHECK (((confidence_score >= (0)::numeric) AND (confidence_score <= (1)::numeric))),
    CONSTRAINT roadmap_adjustment_proposals_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'expired'::text]))),
    CONSTRAINT roadmap_adjustment_proposals_trigger_severity_check CHECK ((trigger_severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text]))),
    CONSTRAINT roadmap_adjustment_proposals_trigger_type_check CHECK ((trigger_type = ANY (ARRAY['sentiment_shift'::text, 'competitor_move'::text, 'theme_spike'::text, 'churn_signal'::text])))
);


--
-- Name: roadmap_exports; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_exports (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid NOT NULL,
    export_type text NOT NULL,
    file_path text NOT NULL,
    included_priorities text[] NOT NULL,
    filter_config jsonb,
    generated_at timestamp with time zone DEFAULT now() NOT NULL,
    download_count integer DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT roadmap_exports_export_type_check CHECK ((export_type = ANY (ARRAY['markdown'::text, 'pdf'::text])))
);


--
-- Name: TABLE roadmap_exports; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.roadmap_exports IS 'Exported roadmap documents (Markdown/PDF) for stakeholder sharing';


--
-- Name: roadmap_feedback; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_feedback (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid,
    author_email character varying(255),
    author_name character varying(100),
    content text NOT NULL,
    is_anonymous boolean DEFAULT false,
    ip_address inet,
    user_agent text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: roadmap_generation_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_generation_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    themes_analyzed integer NOT NULL,
    suggestions_generated integer NOT NULL,
    generation_time_ms integer NOT NULL,
    gpt4_api_calls integer DEFAULT 0,
    gpt4_tokens_used integer DEFAULT 0,
    success boolean NOT NULL,
    error_message text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE roadmap_generation_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.roadmap_generation_logs IS 'Logs of roadmap generation runs for analytics and debugging';


--
-- Name: roadmap_item_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_item_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    roadmap_item_id uuid NOT NULL,
    project_id uuid NOT NULL,
    embedding public.vector(1536),
    content_hash text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE roadmap_item_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.roadmap_item_embeddings IS 'Vector embeddings for roadmap suggestions';


--
-- Name: roadmap_priority_distribution; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.roadmap_priority_distribution WITH (security_barrier='true', security_invoker='true') AS
 SELECT project_id,
    priority_level,
    count(*) AS count,
    avg(priority_score) AS avg_score
   FROM public.roadmap_suggestions
  GROUP BY project_id, priority_level;


--
-- Name: VIEW roadmap_priority_distribution; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.roadmap_priority_distribution IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: roadmap_priority_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_priority_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    suggestion_id uuid NOT NULL,
    theme_name text NOT NULL,
    old_priority text NOT NULL,
    new_priority text NOT NULL,
    old_score numeric(5,2) NOT NULL,
    new_score numeric(5,2) NOT NULL,
    score_change numeric(5,2) GENERATED ALWAYS AS ((new_score - old_score)) STORED,
    adjustment_type text DEFAULT 'automatic'::text NOT NULL,
    adjustment_reason text NOT NULL,
    triggers text[] DEFAULT '{}'::text[] NOT NULL,
    adjusted_by_agent text,
    adjusted_by_user_id uuid,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT roadmap_priority_history_adjustment_type_check CHECK ((adjustment_type = ANY (ARRAY['automatic'::text, 'manual'::text]))),
    CONSTRAINT roadmap_priority_history_new_priority_check CHECK ((new_priority = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text]))),
    CONSTRAINT roadmap_priority_history_old_priority_check CHECK ((old_priority = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text])))
);


--
-- Name: TABLE roadmap_priority_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.roadmap_priority_history IS 'Tracks all automatic and manual priority adjustments to roadmap suggestions over time';


--
-- Name: roadmap_roast_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_roast_sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    session_token text NOT NULL,
    input_type text NOT NULL,
    raw_input text,
    screenshot_url text,
    industry text,
    company_stage text,
    team_size text,
    parsed_features jsonb,
    confidence_score integer,
    verdict text,
    one_liner text,
    blind_spots jsonb,
    demand_questions jsonb,
    assumption_challenges jsonb,
    quick_wins jsonb,
    score_breakdown jsonb,
    prioritization_notes jsonb,
    whats_good jsonb,
    share_token text,
    is_public boolean DEFAULT false,
    view_count integer DEFAULT 0,
    email text,
    converted_to_signup boolean DEFAULT false,
    status text DEFAULT 'pending'::text,
    created_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    CONSTRAINT roadmap_roast_sessions_confidence_score_check CHECK (((confidence_score >= 0) AND (confidence_score <= 100))),
    CONSTRAINT roadmap_roast_sessions_input_type_check CHECK ((input_type = ANY (ARRAY['screenshot'::text, 'text'::text, 'csv'::text, 'json'::text])))
);


--
-- Name: roadmap_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roadmap_subscriptions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    email character varying(255) NOT NULL,
    subscription_token character varying(255) NOT NULL,
    is_active boolean DEFAULT true,
    subscribed_at timestamp with time zone DEFAULT now(),
    last_notified_at timestamp with time zone
);


--
-- Name: roadmap_suggestions_detailed; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.roadmap_suggestions_detailed WITH (security_barrier='true', security_invoker='true') AS
 SELECT rs.id,
    rs.project_id,
    rs.theme_id,
    rs.priority_score,
    rs.priority_level,
    rs.frequency_score,
    rs.sentiment_score,
    rs.business_impact_score,
    rs.effort_score,
    rs.competitive_score,
    rs.reasoning_text,
    rs.why_matters,
    rs.business_impact_text,
    rs.user_segments_affected,
    rs.implementation_strategy,
    rs.risks_dependencies,
    rs.trade_offs,
    rs.recommendation_text,
    rs.manual_priority_adjustment,
    rs.pinned,
    rs.status,
    rs.internal_notes,
    rs.generated_at,
    rs.regenerated_at,
    rs.created_at,
    rs.updated_at,
    t.theme_name,
    t.frequency AS mention_count,
    t.avg_sentiment,
    t.first_seen AS theme_first_detected,
    p.name AS project_name,
    p.owner_id
   FROM ((public.roadmap_suggestions rs
     JOIN public.themes t ON ((rs.theme_id = t.id)))
     JOIN public.projects p ON ((rs.project_id = p.id)));


--
-- Name: VIEW roadmap_suggestions_detailed; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.roadmap_suggestions_detailed IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: scheduled_reports; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.scheduled_reports (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid NOT NULL,
    query_text text NOT NULL,
    user_role text NOT NULL,
    report_name text NOT NULL,
    frequency text NOT NULL,
    time_of_day time without time zone DEFAULT '09:00:00'::time without time zone,
    day_of_week integer,
    day_of_month integer,
    timezone text DEFAULT 'UTC'::text,
    recipients text[] NOT NULL,
    delivery_method text DEFAULT 'email'::text,
    slack_webhook_url text,
    is_active boolean DEFAULT true,
    last_run_at timestamp with time zone,
    next_run_at timestamp with time zone,
    run_count integer DEFAULT 0,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT scheduled_reports_day_of_month_check CHECK (((day_of_month >= 1) AND (day_of_month <= 31))),
    CONSTRAINT scheduled_reports_day_of_week_check CHECK (((day_of_week >= 0) AND (day_of_week <= 6))),
    CONSTRAINT scheduled_reports_delivery_method_check CHECK ((delivery_method = ANY (ARRAY['email'::text, 'slack'::text]))),
    CONSTRAINT scheduled_reports_frequency_check CHECK ((frequency = ANY (ARRAY['daily'::text, 'weekly'::text, 'monthly'::text]))),
    CONSTRAINT scheduled_reports_user_role_check CHECK ((user_role = ANY (ARRAY['ceo'::text, 'sales'::text, 'engineering'::text, 'marketing'::text, 'customer_success'::text, 'product'::text])))
);


--
-- Name: TABLE scheduled_reports; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.scheduled_reports IS 'Stores scheduled stakeholder intelligence reports';


--
-- Name: scrape_cache; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.scrape_cache (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    product_name_normalized text NOT NULL,
    source text NOT NULL,
    reviews jsonb NOT NULL,
    scraped_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone DEFAULT (now() + '24:00:00'::interval)
);


--
-- Name: security_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.security_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    type text NOT NULL,
    severity text NOT NULL,
    message text NOT NULL,
    ip text,
    user_agent text,
    path text,
    method text,
    user_id uuid,
    project_id uuid,
    metadata jsonb,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT security_events_severity_check CHECK ((severity = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text]))),
    CONSTRAINT security_events_type_check CHECK ((type = ANY (ARRAY['rate_limit_exceeded'::text, 'invalid_api_key'::text, 'csrf_validation_failed'::text, 'xss_attempt_blocked'::text, 'sql_injection_attempt'::text, 'unauthorized_access'::text, 'suspicious_request'::text, 'authentication_failed'::text, 'validation_error'::text, 'malicious_file_upload'::text])))
);


--
-- Name: TABLE security_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.security_events IS 'Stores security events for audit logging and monitoring';


--
-- Name: sentiment_forecasts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sentiment_forecasts (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    forecast_date timestamp with time zone NOT NULL,
    forecast_horizon integer NOT NULL,
    target_date timestamp with time zone NOT NULL,
    predicted_sentiment_score numeric(3,2) NOT NULL,
    confidence_lower numeric(3,2) NOT NULL,
    confidence_upper numeric(3,2) NOT NULL,
    confidence_level numeric(3,2) DEFAULT 0.95,
    model_name character varying(100) NOT NULL,
    model_version character varying(50),
    training_window_days integer,
    feature_volume integer,
    feature_avg_sentiment numeric(3,2),
    feature_sentiment_volatility numeric(5,4),
    feature_trend_direction character varying(20),
    actual_sentiment_score numeric(3,2),
    prediction_error numeric(5,4),
    is_accurate boolean,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT sentiment_forecasts_confidence_range CHECK ((((confidence_lower >= ('-1'::integer)::numeric) AND (confidence_lower <= (1)::numeric)) AND ((confidence_upper >= ('-1'::integer)::numeric) AND (confidence_upper <= (1)::numeric)) AND (confidence_lower <= confidence_upper))),
    CONSTRAINT sentiment_forecasts_score_range CHECK (((predicted_sentiment_score >= ('-1'::integer)::numeric) AND (predicted_sentiment_score <= (1)::numeric)))
);


--
-- Name: sentiment_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sentiment_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    date date NOT NULL,
    avg_sentiment numeric(5,3),
    total_posts integer DEFAULT 0,
    positive_count integer DEFAULT 0,
    neutral_count integer DEFAULT 0,
    negative_count integer DEFAULT 0,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE sentiment_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sentiment_history IS 'Daily sentiment snapshots for historical trend analysis';


--
-- Name: signal_correlations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.signal_correlations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    correlation_type text NOT NULL,
    source_type text NOT NULL,
    source_id uuid NOT NULL,
    source_description text,
    target_type text NOT NULL,
    target_id uuid NOT NULL,
    target_description text,
    correlation_score numeric NOT NULL,
    confidence_level text DEFAULT 'medium'::text,
    evidence jsonb DEFAULT '{}'::jsonb,
    detected_by text DEFAULT 'auto'::text,
    status text DEFAULT 'active'::text,
    dismissed_by uuid,
    dismissed_at timestamp with time zone,
    dismissed_reason text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT signal_correlations_confidence_level_check CHECK ((confidence_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text]))),
    CONSTRAINT signal_correlations_correlation_score_check CHECK (((correlation_score >= (0)::numeric) AND (correlation_score <= (1)::numeric))),
    CONSTRAINT signal_correlations_correlation_type_check CHECK ((correlation_type = ANY (ARRAY['feedback_to_competitor'::text, 'feedback_to_roadmap'::text, 'competitor_to_roadmap'::text, 'sentiment_to_feature'::text, 'feedback_to_theme'::text, 'theme_to_roadmap'::text]))),
    CONSTRAINT signal_correlations_source_type_check CHECK ((source_type = ANY (ARRAY['feedback'::text, 'competitor'::text, 'theme'::text, 'sentiment'::text, 'roadmap'::text]))),
    CONSTRAINT signal_correlations_status_check CHECK ((status = ANY (ARRAY['active'::text, 'dismissed'::text, 'resolved'::text]))),
    CONSTRAINT signal_correlations_target_type_check CHECK ((target_type = ANY (ARRAY['feedback'::text, 'competitor'::text, 'theme'::text, 'sentiment'::text, 'roadmap'::text])))
);


--
-- Name: TABLE signal_correlations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.signal_correlations IS 'Tracks correlations between feedback, competitors, and roadmap items';


--
-- Name: signal_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.signal_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    event_type text NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    entity_name text,
    metric_value numeric,
    baseline_value numeric,
    deviation numeric,
    metadata jsonb DEFAULT '{}'::jsonb,
    detected_at timestamp with time zone DEFAULT now(),
    CONSTRAINT signal_events_event_type_check CHECK ((event_type = ANY (ARRAY['feedback_spike'::text, 'sentiment_drop'::text, 'theme_emerged'::text, 'competitor_action'::text, 'roadmap_prioritized'::text, 'feature_released'::text, 'churn_risk_increase'::text])))
);


--
-- Name: TABLE signal_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.signal_events IS 'Time-series events for correlation detection';


--
-- Name: slack_alert_rules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_alert_rules (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    rule_type public.slack_rule_type NOT NULL,
    enabled boolean DEFAULT true,
    config jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE slack_alert_rules; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.slack_alert_rules IS 'Configurable rules for triggering alerts';


--
-- Name: slack_channel_mappings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_channel_mappings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slack_connection_id uuid NOT NULL,
    alert_type public.slack_alert_type NOT NULL,
    channel_id text NOT NULL,
    channel_name text NOT NULL,
    mention_users text[] DEFAULT '{}'::text[],
    use_threads boolean DEFAULT false,
    parent_message_ts text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE slack_channel_mappings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.slack_channel_mappings IS 'Routes different alert types to specific Slack channels';


--
-- Name: slack_connections; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_connections (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    team_id text NOT NULL,
    team_name text NOT NULL,
    bot_token_encrypted text NOT NULL,
    bot_user_id text NOT NULL,
    scope text NOT NULL,
    status public.slack_connection_status DEFAULT 'active'::public.slack_connection_status,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE slack_connections; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.slack_connections IS 'OAuth 2.0 connections to Slack workspaces';


--
-- Name: slack_integration_states; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_integration_states (
    state text NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid,
    redirect_to text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: slack_integrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_integrations (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    team_id text NOT NULL,
    team_name text,
    access_token text NOT NULL,
    bot_user_id text,
    authed_user_id text,
    scope text,
    webhook_url text NOT NULL,
    channel_id text,
    channel_name text,
    configuration_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: slack_interaction_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_interaction_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slack_connection_id uuid NOT NULL,
    slack_user_id text NOT NULL,
    action_id text NOT NULL,
    payload jsonb NOT NULL,
    response jsonb,
    message_ts text,
    channel_id text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE slack_interaction_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.slack_interaction_logs IS 'Logs of user interactions with Slack messages';


--
-- Name: slack_message_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.slack_message_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slack_connection_id uuid NOT NULL,
    alert_type public.slack_alert_type NOT NULL,
    channel_id text NOT NULL,
    message_ts text,
    blocks jsonb NOT NULL,
    text_fallback text,
    success boolean NOT NULL,
    error_message text,
    entity_id uuid,
    entity_type text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE slack_message_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.slack_message_logs IS 'Audit trail of all Slack messages sent';


--
-- Name: smart_replies; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.smart_replies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    post_id uuid NOT NULL,
    reply_text text NOT NULL,
    reply_type character varying(50) DEFAULT 'follow_up'::character varying NOT NULL,
    is_used boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: spec_context_sources; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.spec_context_sources (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    spec_id uuid NOT NULL,
    source_type character varying(50) NOT NULL,
    source_id uuid NOT NULL,
    relevance_score double precision,
    content_preview text,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE spec_context_sources; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.spec_context_sources IS 'Sources retrieved during spec generation (feedback, past specs, competitors, personas)';


--
-- Name: spec_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.spec_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    spec_id uuid NOT NULL,
    embedding public.vector(1536),
    content_hash character varying(64),
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE spec_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.spec_embeddings IS 'Vector embeddings for spec similarity search (RAG)';


--
-- Name: spec_versions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.spec_versions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    spec_id uuid NOT NULL,
    version_number integer NOT NULL,
    content text NOT NULL,
    changed_by uuid NOT NULL,
    change_summary character varying(500),
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE spec_versions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.spec_versions IS 'Version history for spec edits';


--
-- Name: specs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.specs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    created_by uuid NOT NULL,
    title character varying(500) NOT NULL,
    input_idea text,
    content text NOT NULL,
    status character varying(50) DEFAULT 'draft'::character varying,
    template character varying(100) DEFAULT 'standard'::character varying,
    generation_model character varying(100) DEFAULT 'gpt-4o'::character varying,
    generation_tokens integer,
    generation_time_ms integer,
    context_sources jsonb DEFAULT '[]'::jsonb,
    linked_feedback_ids uuid[] DEFAULT '{}'::uuid[],
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    published_at timestamp with time zone,
    search_vector tsvector GENERATED ALWAYS AS ((setweight(to_tsvector('english'::regconfig, (COALESCE(title, ''::character varying))::text), 'A'::"char") || setweight(to_tsvector('english'::regconfig, COALESCE(content, ''::text)), 'B'::"char"))) STORED,
    auto_generated boolean DEFAULT false,
    CONSTRAINT specs_status_check CHECK (((status)::text = ANY ((ARRAY['draft'::character varying, 'review'::character varying, 'approved'::character varying, 'archived'::character varying])::text[])))
);


--
-- Name: TABLE specs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.specs IS 'AI-generated Product Requirements Documents (PRDs) from the Spec Writer agent';


--
-- Name: COLUMN specs.title; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.title IS 'Title of the spec/feature';


--
-- Name: COLUMN specs.input_idea; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.input_idea IS 'Original one-line idea provided by user';


--
-- Name: COLUMN specs.content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.content IS 'Full PRD content in Markdown format';


--
-- Name: COLUMN specs.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.status IS 'Spec status: draft, review, approved, archived';


--
-- Name: COLUMN specs.template; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.template IS 'Template used for generation: standard, feature-launch, bug-fix, api-spec';


--
-- Name: COLUMN specs.generation_model; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.generation_model IS 'AI model used for generation (e.g., gpt-4o)';


--
-- Name: COLUMN specs.generation_tokens; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.generation_tokens IS 'Total tokens used during generation';


--
-- Name: COLUMN specs.generation_time_ms; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.generation_time_ms IS 'Time taken to generate spec in milliseconds';


--
-- Name: COLUMN specs.context_sources; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.context_sources IS 'JSONB array of context source metadata used during RAG';


--
-- Name: COLUMN specs.linked_feedback_ids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.linked_feedback_ids IS 'Array of feedback item UUIDs this spec addresses';


--
-- Name: COLUMN specs.search_vector; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.search_vector IS 'Full-text search vector for title and content';


--
-- Name: COLUMN specs.auto_generated; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.specs.auto_generated IS 'TRUE if spec was auto-generated by Proactive Spec Writer agent, FALSE if manually created by PM';


--
-- Name: sprints; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sprints (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    sprint_number integer NOT NULL,
    sprint_name text NOT NULL,
    sprint_goal text,
    start_date date NOT NULL,
    end_date date NOT NULL,
    capacity_points integer DEFAULT 0 NOT NULL,
    current_points integer DEFAULT 0,
    committed_points integer DEFAULT 0,
    status public.sprint_phase DEFAULT 'planning'::public.sprint_phase,
    team_members jsonb DEFAULT '[]'::jsonb,
    completed_points integer DEFAULT 0,
    retrospective_notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE sprints; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sprints IS 'Sprint planning and capacity management';


--
-- Name: COLUMN sprints.capacity_points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sprints.capacity_points IS 'Team velocity - total points the team can complete';


--
-- Name: COLUMN sprints.current_points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sprints.current_points IS 'Sum of story points currently in sprint';


--
-- Name: sprint_planning_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.sprint_planning_view WITH (security_barrier='true', security_invoker='true') AS
 SELECT id,
    project_id,
    sprint_number,
    sprint_name,
    sprint_goal,
    start_date,
    end_date,
    capacity_points,
    current_points,
    committed_points,
    status,
    team_members,
    completed_points,
    retrospective_notes,
    created_at,
    updated_at,
    ( SELECT count(*) AS count
           FROM public.user_stories
          WHERE (user_stories.sprint_id = s.id)) AS story_count,
    ( SELECT count(*) AS count
           FROM public.user_stories
          WHERE ((user_stories.sprint_id = s.id) AND (user_stories.sprint_status = 'done'::public.sprint_status))) AS completed_story_count,
        CASE
            WHEN (capacity_points > 0) THEN round((((current_points)::numeric / (capacity_points)::numeric) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS capacity_percentage
   FROM public.sprints s;


--
-- Name: VIEW sprint_planning_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.sprint_planning_view IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: stakeholder_interests; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.stakeholder_interests (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    stakeholder_id uuid NOT NULL,
    interest_type text NOT NULL,
    interest_id uuid,
    interest_name text NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT stakeholder_interests_interest_type_check CHECK ((interest_type = ANY (ARRAY['feature'::text, 'competitor'::text, 'customer'::text, 'metric'::text, 'theme'::text])))
);


--
-- Name: TABLE stakeholder_interests; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.stakeholder_interests IS 'Tracks what features/competitors/metrics each stakeholder cares about';


--
-- Name: COLUMN stakeholder_interests.interest_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.stakeholder_interests.interest_type IS 'Type of interest: feature, competitor, customer, metric, theme';


--
-- Name: stakeholder_queries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.stakeholder_queries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid NOT NULL,
    query_text text NOT NULL,
    user_role text,
    response_components jsonb NOT NULL,
    follow_up_questions jsonb DEFAULT '[]'::jsonb,
    generation_time_ms integer,
    model_used text DEFAULT 'gpt-4o'::text,
    tokens_used integer,
    rating integer,
    feedback_text text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    is_favorite boolean DEFAULT false,
    CONSTRAINT stakeholder_queries_rating_check CHECK (((rating >= 1) AND (rating <= 5))),
    CONSTRAINT stakeholder_queries_user_role_check CHECK ((user_role = ANY (ARRAY['ceo'::text, 'sales'::text, 'engineering'::text, 'marketing'::text, 'customer_success'::text, 'product'::text])))
);


--
-- Name: TABLE stakeholder_queries; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.stakeholder_queries IS 'Stores conversational queries from stakeholders with dynamically generated component-based responses';


--
-- Name: COLUMN stakeholder_queries.is_favorite; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.stakeholder_queries.is_favorite IS 'Marks query as favorite for quick access';


--
-- Name: stakeholder_query_analytics; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.stakeholder_query_analytics AS
 SELECT project_id,
    user_role,
    count(*) AS total_queries,
    avg(generation_time_ms) AS avg_generation_time,
    avg(rating) AS avg_rating,
    count(*) FILTER (WHERE (rating >= 4)) AS high_rated_queries,
    count(*) FILTER (WHERE is_favorite) AS favorite_queries,
    percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((generation_time_ms)::double precision)) AS median_generation_time,
    percentile_cont((0.95)::double precision) WITHIN GROUP (ORDER BY ((generation_time_ms)::double precision)) AS p95_generation_time,
    min(created_at) AS first_query_at,
    max(created_at) AS last_query_at
   FROM public.stakeholder_queries sq
  GROUP BY project_id, user_role
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW stakeholder_query_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.stakeholder_query_analytics IS 'Aggregated analytics for stakeholder queries by role';


--
-- Name: stakeholder_reports; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.stakeholder_reports (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    stakeholder_id uuid NOT NULL,
    report_type text NOT NULL,
    role text NOT NULL,
    content jsonb NOT NULL,
    html_content text,
    generated_at timestamp with time zone DEFAULT now(),
    sent_at timestamp with time zone,
    opened_at timestamp with time zone,
    click_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT stakeholder_reports_report_type_check CHECK ((report_type = ANY (ARRAY['weekly'::text, 'monthly'::text, 'ad_hoc'::text, 'on_demand'::text])))
);


--
-- Name: TABLE stakeholder_reports; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.stakeholder_reports IS 'History of generated and sent stakeholder reports';


--
-- Name: COLUMN stakeholder_reports.content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.stakeholder_reports.content IS 'Structured report data (JSONB)';


--
-- Name: COLUMN stakeholder_reports.html_content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.stakeholder_reports.html_content IS 'HTML email content for the report';


--
-- Name: stakeholders; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.stakeholders (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name text NOT NULL,
    email text NOT NULL,
    role text NOT NULL,
    interests jsonb DEFAULT '[]'::jsonb,
    notification_preferences jsonb DEFAULT '{"frequency": "weekly", "email_enabled": true, "slack_enabled": false, "include_sections": ["okrs", "roadmap", "competitive", "metrics", "feedback_themes"]}'::jsonb,
    access_token text,
    token_expires_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT stakeholders_role_check CHECK ((role = ANY (ARRAY['ceo'::text, 'sales'::text, 'engineering'::text, 'marketing'::text, 'customer_success'::text])))
);


--
-- Name: TABLE stakeholders; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.stakeholders IS 'Stakeholders who receive automated product intelligence reports';


--
-- Name: COLUMN stakeholders.role; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.stakeholders.role IS 'Role determines report content: ceo, sales, engineering, marketing, customer_success';


--
-- Name: COLUMN stakeholders.access_token; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.stakeholders.access_token IS 'Secure token for stakeholder portal access (no login required)';


--
-- Name: story_feedback_links; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.story_feedback_links (
    story_id uuid NOT NULL,
    feedback_id uuid NOT NULL,
    relevance_score numeric(3,2),
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT story_feedback_links_relevance_score_check CHECK (((relevance_score >= (0)::numeric) AND (relevance_score <= (1)::numeric)))
);


--
-- Name: TABLE story_feedback_links; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.story_feedback_links IS 'Links user stories to source feedback items for traceability';


--
-- Name: story_generation_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.story_generation_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    theme_id uuid,
    user_story_id uuid,
    model_used text NOT NULL,
    tokens_used integer,
    generation_time_ms integer,
    prompt_tokens integer,
    completion_tokens integer,
    success boolean NOT NULL,
    error_message text,
    error_stack text,
    input_context jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE story_generation_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.story_generation_logs IS 'Audit log of AI story generation attempts';


--
-- Name: story_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.story_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    template_name text NOT NULL,
    description text,
    category text,
    user_type_template text,
    goal_template text,
    benefit_template text,
    acceptance_criteria_templates jsonb DEFAULT '[]'::jsonb,
    default_labels text[] DEFAULT ARRAY[]::text[],
    default_story_points integer,
    usage_count integer DEFAULT 0,
    last_used_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE story_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.story_templates IS 'Reusable templates for generating user stories';


--
-- Name: strategic_recommendations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.strategic_recommendations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    recommendation_type public.recommendation_type NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    reasoning text NOT NULL,
    estimated_impact text,
    estimated_cost text,
    roi_estimate text,
    priority public.feature_gap_priority DEFAULT 'medium'::public.feature_gap_priority,
    status public.recommendation_status DEFAULT 'pending'::public.recommendation_status,
    related_competitor_ids uuid[] DEFAULT ARRAY[]::uuid[],
    related_feature_gap_ids uuid[] DEFAULT ARRAY[]::uuid[],
    related_feedback_ids uuid[] DEFAULT ARRAY[]::uuid[],
    assigned_to uuid,
    viewed_at timestamp with time zone,
    accepted_at timestamp with time zone,
    completed_at timestamp with time zone,
    dismissed_at timestamp with time zone,
    dismissal_reason text,
    outcome_notes text,
    actual_impact text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE strategic_recommendations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.strategic_recommendations IS 'AI-generated strategic recommendations based on competitive intelligence';


--
-- Name: COLUMN strategic_recommendations.recommendation_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.strategic_recommendations.recommendation_type IS 'ATTACK: exploit weakness, DEFEND: protect against strength, REACT: respond to shift, IGNORE: not worth it';


--
-- Name: COLUMN strategic_recommendations.roi_estimate; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.strategic_recommendations.roi_estimate IS 'Expected return on investment for implementing this recommendation';


--
-- Name: strategy_shift_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.strategy_shift_events (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    shift_id uuid NOT NULL,
    project_id uuid NOT NULL,
    event_type text NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE strategy_shift_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.strategy_shift_events IS 'Strategy shift events for autonomous product management. RLS enabled - users can only view events for their own projects.';


--
-- Name: strategy_shifts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.strategy_shifts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    type text NOT NULL,
    target_feature text NOT NULL,
    action text NOT NULL,
    rationale text NOT NULL,
    signals jsonb DEFAULT '[]'::jsonb NOT NULL,
    expected_impact text,
    confidence numeric(3,2),
    status text DEFAULT 'proposed'::text NOT NULL,
    experiment_id uuid,
    reviewed_by uuid,
    reviewed_at timestamp with time zone,
    review_notes text,
    expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT strategy_shifts_confidence_check CHECK (((confidence >= (0)::numeric) AND (confidence <= (1)::numeric))),
    CONSTRAINT strategy_shifts_status_check CHECK ((status = ANY (ARRAY['proposed'::text, 'approved'::text, 'rejected'::text, 'auto_applied'::text, 'expired'::text]))),
    CONSTRAINT strategy_shifts_type_check CHECK ((type = ANY (ARRAY['pause'::text, 'accelerate'::text, 'pivot'::text, 'deprioritize'::text, 'experiment'::text])))
);


--
-- Name: stripe_settings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.stripe_settings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid,
    stripe_publishable_key character varying(255),
    stripe_secret_key character varying(255),
    stripe_webhook_secret character varying(255),
    stripe_price_id character varying(255),
    payment_method character varying(50) DEFAULT 'checkout_link'::character varying,
    test_mode boolean DEFAULT true,
    configured boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: survey_questions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.survey_questions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    survey_id uuid NOT NULL,
    question_type text NOT NULL,
    question_text text NOT NULL,
    options jsonb,
    required boolean DEFAULT false,
    min_value integer DEFAULT 1,
    max_value integer DEFAULT 5,
    min_label text,
    max_label text,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT survey_questions_question_type_check CHECK ((question_type = ANY (ARRAY['text'::text, 'single_select'::text, 'multi_select'::text, 'rating'::text, 'nps'::text])))
);


--
-- Name: TABLE survey_questions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.survey_questions IS 'Question definitions for surveys';


--
-- Name: survey_responses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.survey_responses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    survey_id uuid NOT NULL,
    respondent_id uuid,
    respondent_email text,
    respondent_hash text NOT NULL,
    answers jsonb NOT NULL,
    sentiment_score numeric,
    detected_themes text[],
    customer_id uuid,
    customer_mrr numeric,
    customer_segment text,
    started_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    is_complete boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE survey_responses; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.survey_responses IS 'Individual survey responses with sentiment analysis';


--
-- Name: surveys; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.surveys (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    status text DEFAULT 'draft'::text,
    thank_you_message text DEFAULT 'Thank you for your feedback!'::text,
    closes_at timestamp with time zone,
    created_by uuid,
    response_count integer DEFAULT 0,
    completion_rate numeric,
    avg_sentiment numeric,
    allow_anonymous boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT surveys_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'active'::text, 'closed'::text])))
);


--
-- Name: TABLE surveys; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.surveys IS 'Multi-question surveys for detailed feedback collection';


--
-- Name: team_capacity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.team_capacity (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    week_start_date date NOT NULL,
    week_end_date date NOT NULL,
    team_size integer DEFAULT 1 NOT NULL,
    available_story_points numeric(5,1),
    available_dev_days numeric(5,1),
    completed_story_points numeric(5,1),
    completed_features integer DEFAULT 0,
    velocity_story_points numeric(5,1),
    velocity_features numeric(5,1),
    committed_story_points numeric(5,1),
    committed_features integer DEFAULT 0,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE team_capacity; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.team_capacity IS 'Stores team capacity and velocity metrics for capacity-aware roadmap planning';


--
-- Name: team_invitations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.team_invitations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    email character varying(255) NOT NULL,
    role character varying(20) DEFAULT 'member'::character varying NOT NULL,
    token character varying(255) NOT NULL,
    invited_by uuid NOT NULL,
    status character varying(20) DEFAULT 'pending'::character varying NOT NULL,
    expires_at timestamp with time zone NOT NULL,
    accepted_at timestamp with time zone,
    accepted_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT team_invitations_role_check CHECK (((role)::text = ANY ((ARRAY['admin'::character varying, 'member'::character varying])::text[]))),
    CONSTRAINT team_invitations_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'accepted'::character varying, 'expired'::character varying, 'cancelled'::character varying])::text[])))
);


--
-- Name: team_velocity; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.team_velocity (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    jira_connection_id uuid,
    board_id text,
    board_name text,
    sprint_id text,
    sprint_name text,
    sprint_start_date date,
    sprint_end_date date,
    committed_points numeric(6,2),
    completed_points numeric(6,2),
    committed_issues integer,
    completed_issues integer,
    velocity_points numeric(6,2),
    source text DEFAULT 'jira'::text NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE team_velocity; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.team_velocity IS 'Sprint-level execution velocity ingested from Jira Agile';


--
-- Name: COLUMN team_velocity.velocity_points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.team_velocity.velocity_points IS 'Points completed (Jira velocity)';


--
-- Name: theme_clusters; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.theme_clusters (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    cluster_name text NOT NULL,
    description text,
    theme_count integer DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE theme_clusters; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.theme_clusters IS 'Stores high-level theme clusters/groups for organizing related themes';


--
-- Name: theme_sentiment_cache; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.theme_sentiment_cache AS
 SELECT t.project_id,
    t.theme_name,
    t.frequency,
    count(DISTINCT p.id) AS post_count,
    avg(sa.sentiment_score) AS avg_sentiment,
    percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((sa.sentiment_score)::double precision)) AS median_sentiment,
    min(p.created_at) AS first_seen,
    max(p.created_at) AS last_seen
   FROM ((public.themes t
     LEFT JOIN public.posts p ON (((p.project_id = t.project_id) AND (p.category = t.theme_name))))
     LEFT JOIN public.sentiment_analysis sa ON ((sa.post_id = p.id)))
  GROUP BY t.project_id, t.theme_name, t.frequency
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW theme_sentiment_cache; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.theme_sentiment_cache IS 'Cached theme sentiment calculations for better performance. Refresh periodically.';


--
-- Name: themes_with_details; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.themes_with_details AS
SELECT
    NULL::uuid AS id,
    NULL::uuid AS project_id,
    NULL::uuid AS cluster_id,
    NULL::text AS theme_name,
    NULL::text AS description,
    NULL::integer AS frequency,
    NULL::numeric(3,2) AS avg_sentiment,
    NULL::timestamp with time zone AS first_seen,
    NULL::timestamp with time zone AS last_seen,
    NULL::boolean AS is_emerging,
    NULL::timestamp with time zone AS created_at,
    NULL::timestamp with time zone AS updated_at,
    NULL::text AS cluster_name,
    NULL::bigint AS actual_feedback_count,
    NULL::text[] AS related_categories;


--
-- Name: VIEW themes_with_details; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.themes_with_details IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: timeline_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.timeline_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    event_type text NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    event_date timestamp with time zone DEFAULT now() NOT NULL,
    severity text,
    metadata jsonb DEFAULT '{}'::jsonb,
    source_id uuid,
    source_type text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT timeline_events_event_type_check CHECK ((event_type = ANY (ARRAY['feature_launch'::text, 'feedback_spike'::text, 'competitor_move'::text, 'milestone'::text, 'issue'::text]))),
    CONSTRAINT timeline_events_severity_check CHECK ((severity = ANY (ARRAY['critical'::text, 'high'::text, 'medium'::text, 'low'::text])))
);


--
-- Name: TABLE timeline_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.timeline_events IS 'Tracks important events for stakeholder intelligence timeline visualization';


--
-- Name: triage_queue; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.triage_queue (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    post_id uuid NOT NULL,
    status text DEFAULT 'pending'::text,
    suggested_category text,
    suggested_priority integer,
    suggested_pm_id uuid,
    duplicate_of uuid,
    similarity_score numeric,
    auto_categorized boolean DEFAULT false,
    auto_prioritized boolean DEFAULT false,
    auto_assigned boolean DEFAULT false,
    auto_merged boolean DEFAULT false,
    error_message text,
    processed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT triage_queue_similarity_score_check CHECK (((similarity_score IS NULL) OR ((similarity_score >= (0)::numeric) AND (similarity_score <= (1)::numeric)))),
    CONSTRAINT triage_queue_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text]))),
    CONSTRAINT triage_queue_suggested_priority_check CHECK (((suggested_priority >= 1) AND (suggested_priority <= 3)))
);


--
-- Name: TABLE triage_queue; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.triage_queue IS 'Queue for automatic feedback triage processing';


--
-- Name: unified_action_queue; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.unified_action_queue (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    action_type text NOT NULL,
    priority integer DEFAULT 2,
    severity text DEFAULT 'info'::text,
    title text NOT NULL,
    description text,
    related_post_id uuid,
    related_roadmap_id uuid,
    related_competitor_id uuid,
    related_spec_id uuid,
    metadata jsonb DEFAULT '{}'::jsonb,
    requires_approval boolean DEFAULT true,
    approved boolean DEFAULT false,
    approved_by uuid,
    approved_at timestamp with time zone,
    executed boolean DEFAULT false,
    executed_by uuid,
    executed_at timestamp with time zone,
    execution_result jsonb,
    dismissed boolean DEFAULT false,
    dismissed_by uuid,
    dismissed_at timestamp with time zone,
    dismissed_reason text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone,
    related_poll_id uuid,
    CONSTRAINT unified_action_queue_action_type_check CHECK ((action_type = ANY (ARRAY['merge_suggestion'::text, 'priority_change'::text, 'competitive_threat'::text, 'anomaly_detected'::text, 'spec_ready_for_review'::text, 'roadmap_adjustment'::text, 'customer_at_risk'::text, 'opportunity_identified'::text, 'release_ready'::text, 'feature_gap_detected'::text, 'sentiment_drop'::text, 'feedback_spike'::text, 'pm_assignment_needed'::text, 'poll_suggested'::text, 'knowledge_gap_detected'::text]))),
    CONSTRAINT unified_action_queue_priority_check CHECK (((priority >= 1) AND (priority <= 3))),
    CONSTRAINT unified_action_queue_severity_check CHECK ((severity = ANY (ARRAY['critical'::text, 'warning'::text, 'info'::text, 'success'::text])))
);


--
-- Name: TABLE unified_action_queue; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.unified_action_queue IS 'Centralized AI-recommended actions requiring PM attention';


--
-- Name: unified_feedback_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.unified_feedback_items (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    project_id uuid NOT NULL,
    integration_id uuid,
    source_type character varying(50) NOT NULL,
    source_id character varying(500),
    source_url text,
    source_channel character varying(255),
    source_thread_id character varying(255),
    title text,
    content text NOT NULL,
    content_html text,
    content_plain text,
    language character varying(10) DEFAULT 'en'::character varying,
    author_id character varying(255),
    author_name character varying(255),
    author_email character varying(255),
    author_username character varying(255),
    author_avatar_url text,
    author_metadata jsonb DEFAULT '{}'::jsonb,
    customer_id uuid,
    category character varying(50),
    category_confidence numeric(3,2),
    sentiment_score numeric(3,2),
    sentiment_label character varying(20),
    urgency_score integer,
    urgency_reason text,
    tags text[] DEFAULT '{}'::text[],
    ai_summary text,
    content_hash character varying(64),
    embedding public.vector(1536),
    duplicate_of uuid,
    duplicate_confidence numeric(3,2),
    is_duplicate boolean DEFAULT false,
    engagement_metrics jsonb DEFAULT '{}'::jsonb,
    engagement_score integer DEFAULT 0,
    status character varying(20) DEFAULT 'new'::character varying,
    starred boolean DEFAULT false,
    read_at timestamp with time zone,
    read_by uuid,
    replied_at timestamp with time zone,
    replied_by uuid,
    reply_content text,
    reply_sent_via character varying(50),
    converted_to_post_id uuid,
    converted_at timestamp with time zone,
    converted_by uuid,
    original_created_at timestamp with time zone NOT NULL,
    imported_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    processed_at timestamp with time zone,
    search_vector tsvector,
    CONSTRAINT unified_feedback_items_urgency_score_check CHECK (((urgency_score >= 1) AND (urgency_score <= 5)))
);


--
-- Name: unsubscribe_tokens; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.unsubscribe_tokens (
    token character varying(255) NOT NULL,
    email character varying(255) NOT NULL,
    project_id uuid,
    email_type character varying(50),
    expires_at timestamp with time zone DEFAULT (now() + '1 year'::interval),
    used_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: usage_analytics_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.usage_analytics_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    source text NOT NULL,
    event_name text NOT NULL,
    user_id uuid,
    distinct_id text,
    properties jsonb DEFAULT '{}'::jsonb,
    occurred_at timestamp with time zone NOT NULL,
    received_at timestamp with time zone DEFAULT now() NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb,
    CONSTRAINT usage_analytics_events_source_check CHECK ((source = ANY (ARRAY['mixpanel'::text, 'amplitude'::text, 'segment'::text, 'custom'::text])))
);


--
-- Name: TABLE usage_analytics_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.usage_analytics_events IS 'Normalized product usage events ingested from analytics providers';


--
-- Name: COLUMN usage_analytics_events.properties; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.usage_analytics_events.properties IS 'Provider-specific event properties (flattened)';


--
-- Name: user_intelligence; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_intelligence (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    email text NOT NULL,
    name text,
    company_name text,
    company_domain text,
    company_size text,
    industry text,
    role text,
    seniority_level text,
    linkedin_url text,
    twitter_url text,
    github_url text,
    github_username text,
    bio text,
    location text,
    website text,
    confidence_score numeric(3,2),
    data_sources jsonb DEFAULT '[]'::jsonb,
    raw_data jsonb DEFAULT '{}'::jsonb,
    plan_type text,
    discount_code text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    enriched_at timestamp with time zone,
    CONSTRAINT confidence_score_range CHECK (((confidence_score >= (0)::numeric) AND (confidence_score <= (1)::numeric)))
);


--
-- Name: TABLE user_intelligence; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_intelligence IS 'Stores enriched user intelligence data gathered from various sources including web search, GitHub, LinkedIn, Twitter, and other APIs';


--
-- Name: COLUMN user_intelligence.confidence_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_intelligence.confidence_score IS 'Overall confidence score (0-1) of the enriched data quality';


--
-- Name: COLUMN user_intelligence.data_sources; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_intelligence.data_sources IS 'Array of data sources used for enrichment: github, web_search, emailrep, twitter, hunter, etc.';


--
-- Name: COLUMN user_intelligence.raw_data; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_intelligence.raw_data IS 'Raw API responses stored as JSONB for debugging and future re-processing';


--
-- Name: user_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    tts_voice text DEFAULT 'nova'::text,
    notification_preferences jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    tour_progress jsonb DEFAULT '{}'::jsonb
);


--
-- Name: TABLE user_preferences; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_preferences IS 'User preferences including TTS voice settings. RLS enabled - users can only access their own preferences.';


--
-- Name: user_stories_with_details; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.user_stories_with_details WITH (security_barrier='true', security_invoker='true') AS
 SELECT us.id,
    us.project_id,
    us.theme_id,
    us.title,
    us.user_type,
    us.user_goal,
    us.user_benefit,
    us.full_story,
    us.acceptance_criteria,
    us.story_points,
    us.complexity_score,
    us.uncertainty_score,
    us.effort_score,
    us.estimation_reasoning,
    us.labels,
    us.technical_notes,
    us.definition_of_done,
    us.priority_level,
    us.jira_issue_key,
    us.jira_issue_id,
    us.exported_to_jira,
    us.export_timestamp,
    us.jira_export_error,
    us.sprint_id,
    us.sprint_status,
    us.assigned_to,
    us.generated_by_ai,
    us.generation_model,
    us.generation_timestamp,
    us.generation_tokens_used,
    us.manually_edited,
    us.manually_edited_at,
    us.supporting_feedback_ids,
    us.feedback_count,
    us.created_at,
    us.updated_at,
    t.theme_name,
    t.frequency AS theme_frequency,
    s.sprint_name,
    s.sprint_number,
    s.start_date AS sprint_start_date,
    s.end_date AS sprint_end_date,
    p.name AS project_name,
    ( SELECT count(*) AS count
           FROM public.story_feedback_links sfl
          WHERE (sfl.story_id = us.id)) AS linked_feedback_count
   FROM (((public.user_stories us
     LEFT JOIN public.themes t ON ((us.theme_id = t.id)))
     LEFT JOIN public.sprints s ON ((us.sprint_id = s.id)))
     LEFT JOIN public.projects p ON ((us.project_id = p.id)));


--
-- Name: VIEW user_stories_with_details; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.user_stories_with_details IS 'SECURITY REVIEWED: This view is flagged by Supabase Security Advisor but is safe.
It uses simple SELECT statements and inherits RLS policies from all underlying tables.\nThe view does not bypass any security checks. Users see only data they have permission to access.\nTo resolve the warning, underlying tables must have proper RLS policies (which they do).';


--
-- Name: users; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.users (
    id uuid NOT NULL,
    email character varying(255) NOT NULL,
    full_name character varying(255),
    avatar_url text,
    google_id character varying(255),
    provider character varying(50) DEFAULT 'email'::character varying,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    plan text DEFAULT 'free'::text,
    welcome_email_sent_at timestamp with time zone,
    name text,
    CONSTRAINT users_plan_check CHECK ((plan = ANY (ARRAY['free'::text, 'pro'::text, 'premium'::text]))),
    CONSTRAINT users_provider_check CHECK (((provider)::text = ANY ((ARRAY['email'::character varying, 'google'::character varying])::text[])))
);


--
-- Name: COLUMN users.name; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.users.name IS 'User display name - can be customized by the user';


--
-- Name: webhook_deliveries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.webhook_deliveries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    webhook_id uuid,
    event_type character varying(50) NOT NULL,
    payload jsonb NOT NULL,
    status_code integer,
    response_body text,
    error_message text,
    delivery_duration_ms integer,
    delivered_at timestamp with time zone DEFAULT now(),
    success boolean DEFAULT false
);


--
-- Name: workflows; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflows (
    id text NOT NULL,
    project_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    trigger text NOT NULL,
    trigger_data jsonb DEFAULT '{}'::jsonb,
    steps jsonb DEFAULT '[]'::jsonb NOT NULL,
    current_step_index integer DEFAULT 0,
    status text DEFAULT 'pending'::text NOT NULL,
    progress integer DEFAULT 0,
    final_output jsonb,
    error_message text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    CONSTRAINT workflows_progress_check CHECK (((progress >= 0) AND (progress <= 100))),
    CONSTRAINT workflows_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'running'::text, 'completed'::text, 'failed'::text, 'paused'::text])))
);


--
-- Name: account_billing_profiles account_billing_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_billing_profiles
    ADD CONSTRAINT account_billing_profiles_pkey PRIMARY KEY (user_id);


--
-- Name: account_billing_profiles account_billing_profiles_stripe_customer_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_billing_profiles
    ADD CONSTRAINT account_billing_profiles_stripe_customer_id_key UNIQUE (stripe_customer_id);


--
-- Name: action_recommendations action_recommendations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.action_recommendations
    ADD CONSTRAINT action_recommendations_pkey PRIMARY KEY (id);


--
-- Name: admin_email_preferences admin_email_preferences_admin_email_project_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_email_preferences
    ADD CONSTRAINT admin_email_preferences_admin_email_project_id_key UNIQUE (admin_email, project_id);


--
-- Name: admin_email_preferences admin_email_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_email_preferences
    ADD CONSTRAINT admin_email_preferences_pkey PRIMARY KEY (id);


--
-- Name: agent_memory agent_memory_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agent_memory
    ADD CONSTRAINT agent_memory_pkey PRIMARY KEY (id);


--
-- Name: ai_usage_tracking ai_usage_tracking_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_usage_tracking
    ADD CONSTRAINT ai_usage_tracking_pkey PRIMARY KEY (id);


--
-- Name: ai_usage_tracking ai_usage_tracking_project_id_feature_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_usage_tracking
    ADD CONSTRAINT ai_usage_tracking_project_id_feature_type_key UNIQUE (project_id, feature_type);


--
-- Name: ai_weight_preferences ai_weight_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_weight_preferences
    ADD CONSTRAINT ai_weight_preferences_pkey PRIMARY KEY (id);


--
-- Name: analytics_events analytics_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.analytics_events
    ADD CONSTRAINT analytics_events_pkey PRIMARY KEY (id);


--
-- Name: anomaly_detections anomaly_detections_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.anomaly_detections
    ADD CONSTRAINT anomaly_detections_pkey PRIMARY KEY (id);


--
-- Name: api_keys api_keys_key_hash_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_keys
    ADD CONSTRAINT api_keys_key_hash_key UNIQUE (key_hash);


--
-- Name: api_keys api_keys_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_keys
    ADD CONSTRAINT api_keys_pkey PRIMARY KEY (id);


--
-- Name: ask_action_executions ask_action_executions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_action_executions
    ADD CONSTRAINT ask_action_executions_pkey PRIMARY KEY (id);


--
-- Name: ask_analytics ask_analytics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_analytics
    ADD CONSTRAINT ask_analytics_pkey PRIMARY KEY (id);


--
-- Name: ask_conversations ask_conversations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_conversations
    ADD CONSTRAINT ask_conversations_pkey PRIMARY KEY (id);


--
-- Name: ask_messages ask_messages_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_messages
    ADD CONSTRAINT ask_messages_pkey PRIMARY KEY (id);


--
-- Name: ask_proactive_suggestions ask_proactive_suggestions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_proactive_suggestions
    ADD CONSTRAINT ask_proactive_suggestions_pkey PRIMARY KEY (id);


--
-- Name: ask_scheduled_queries ask_scheduled_queries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_scheduled_queries
    ADD CONSTRAINT ask_scheduled_queries_pkey PRIMARY KEY (id);


--
-- Name: audio_briefings audio_briefings_briefing_id_voice_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audio_briefings
    ADD CONSTRAINT audio_briefings_briefing_id_voice_key UNIQUE (briefing_id, voice);


--
-- Name: audio_briefings audio_briefings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audio_briefings
    ADD CONSTRAINT audio_briefings_pkey PRIMARY KEY (id);


--
-- Name: audit_logs audit_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_pkey PRIMARY KEY (id);


--
-- Name: billing_events billing_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.billing_events
    ADD CONSTRAINT billing_events_pkey PRIMARY KEY (id);


--
-- Name: boards boards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.boards
    ADD CONSTRAINT boards_pkey PRIMARY KEY (id);


--
-- Name: brief_schedules brief_schedules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_schedules
    ADD CONSTRAINT brief_schedules_pkey PRIMARY KEY (id);


--
-- Name: brief_templates brief_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_templates
    ADD CONSTRAINT brief_templates_pkey PRIMARY KEY (id);


--
-- Name: call_ingests call_ingests_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.call_ingests
    ADD CONSTRAINT call_ingests_pkey PRIMARY KEY (id);


--
-- Name: call_records call_records_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.call_records
    ADD CONSTRAINT call_records_pkey PRIMARY KEY (id);


--
-- Name: changelog_entries changelog_entries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_entries
    ADD CONSTRAINT changelog_entries_pkey PRIMARY KEY (id);


--
-- Name: changelog_feedback_links changelog_feedback_links_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_feedback_links
    ADD CONSTRAINT changelog_feedback_links_pkey PRIMARY KEY (id);


--
-- Name: changelog_feedback_links changelog_feedback_links_release_id_post_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_feedback_links
    ADD CONSTRAINT changelog_feedback_links_release_id_post_id_key UNIQUE (release_id, post_id);


--
-- Name: changelog_media changelog_media_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_media
    ADD CONSTRAINT changelog_media_pkey PRIMARY KEY (id);


--
-- Name: changelog_releases changelog_releases_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_releases
    ADD CONSTRAINT changelog_releases_pkey PRIMARY KEY (id);


--
-- Name: changelog_releases changelog_releases_project_id_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_releases
    ADD CONSTRAINT changelog_releases_project_id_slug_key UNIQUE (project_id, slug);


--
-- Name: changelog_subscriptions changelog_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_subscriptions
    ADD CONSTRAINT changelog_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: changelog_subscriptions changelog_subscriptions_project_id_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_subscriptions
    ADD CONSTRAINT changelog_subscriptions_project_id_email_key UNIQUE (project_id, email);


--
-- Name: changelog_subscriptions changelog_subscriptions_subscription_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_subscriptions
    ADD CONSTRAINT changelog_subscriptions_subscription_token_key UNIQUE (subscription_token);


--
-- Name: changelog_webhooks changelog_webhooks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_webhooks
    ADD CONSTRAINT changelog_webhooks_pkey PRIMARY KEY (id);


--
-- Name: churn_alert_rules churn_alert_rules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alert_rules
    ADD CONSTRAINT churn_alert_rules_pkey PRIMARY KEY (id);


--
-- Name: churn_alerts churn_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alerts
    ADD CONSTRAINT churn_alerts_pkey PRIMARY KEY (id);


--
-- Name: churn_risk_predictions churn_risk_predictions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_risk_predictions
    ADD CONSTRAINT churn_risk_predictions_pkey PRIMARY KEY (id);


--
-- Name: collected_reviews collected_reviews_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.collected_reviews
    ADD CONSTRAINT collected_reviews_pkey PRIMARY KEY (id);


--
-- Name: comment_mentions comment_mentions_comment_id_mentioned_user_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comment_mentions
    ADD CONSTRAINT comment_mentions_comment_id_mentioned_user_email_key UNIQUE (comment_id, mentioned_user_email);


--
-- Name: comment_mentions comment_mentions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comment_mentions
    ADD CONSTRAINT comment_mentions_pkey PRIMARY KEY (id);


--
-- Name: comments comments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_pkey PRIMARY KEY (id);


--
-- Name: competitive_events competitive_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_events
    ADD CONSTRAINT competitive_events_pkey PRIMARY KEY (id);


--
-- Name: competitive_intel_sessions competitive_intel_sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_intel_sessions
    ADD CONSTRAINT competitive_intel_sessions_pkey PRIMARY KEY (id);


--
-- Name: competitive_intel_sessions competitive_intel_sessions_session_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_intel_sessions
    ADD CONSTRAINT competitive_intel_sessions_session_token_key UNIQUE (session_token);


--
-- Name: competitive_mentions competitive_mentions_feedback_id_competitor_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_mentions
    ADD CONSTRAINT competitive_mentions_feedback_id_competitor_id_key UNIQUE (feedback_id, competitor_id);


--
-- Name: competitive_mentions competitive_mentions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_mentions
    ADD CONSTRAINT competitive_mentions_pkey PRIMARY KEY (id);


--
-- Name: competitor_alerts competitor_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_alerts
    ADD CONSTRAINT competitor_alerts_pkey PRIMARY KEY (id);


--
-- Name: competitor_embeddings competitor_embeddings_competitor_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_embeddings
    ADD CONSTRAINT competitor_embeddings_competitor_id_key UNIQUE (competitor_id);


--
-- Name: competitor_embeddings competitor_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_embeddings
    ADD CONSTRAINT competitor_embeddings_pkey PRIMARY KEY (id);


--
-- Name: competitor_events competitor_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_events
    ADD CONSTRAINT competitor_events_pkey PRIMARY KEY (id);


--
-- Name: competitor_features competitor_features_competitor_product_id_feature_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_features
    ADD CONSTRAINT competitor_features_competitor_product_id_feature_name_key UNIQUE (competitor_product_id, feature_name);


--
-- Name: competitor_features competitor_features_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_features
    ADD CONSTRAINT competitor_features_pkey PRIMARY KEY (id);


--
-- Name: competitor_job_postings competitor_job_postings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_job_postings
    ADD CONSTRAINT competitor_job_postings_pkey PRIMARY KEY (id);


--
-- Name: competitor_monitoring_config competitor_monitoring_config_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_monitoring_config
    ADD CONSTRAINT competitor_monitoring_config_pkey PRIMARY KEY (id);


--
-- Name: competitor_products competitor_products_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_products
    ADD CONSTRAINT competitor_products_pkey PRIMARY KEY (id);


--
-- Name: competitor_reviews competitor_reviews_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_reviews
    ADD CONSTRAINT competitor_reviews_pkey PRIMARY KEY (id);


--
-- Name: competitor_reviews competitor_reviews_platform_external_review_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_reviews
    ADD CONSTRAINT competitor_reviews_platform_external_review_id_key UNIQUE (platform, external_review_id);


--
-- Name: competitor_strengths competitor_strengths_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_strengths
    ADD CONSTRAINT competitor_strengths_pkey PRIMARY KEY (id);


--
-- Name: competitor_weaknesses competitor_weaknesses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_weaknesses
    ADD CONSTRAINT competitor_weaknesses_pkey PRIMARY KEY (id);


--
-- Name: competitors competitors_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitors
    ADD CONSTRAINT competitors_pkey PRIMARY KEY (id);


--
-- Name: competitors competitors_project_id_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitors
    ADD CONSTRAINT competitors_project_id_name_key UNIQUE (project_id, name);


--
-- Name: customer_health customer_health_email_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health
    ADD CONSTRAINT customer_health_email_unique UNIQUE (project_id, email);


--
-- Name: customer_health_history customer_health_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health_history
    ADD CONSTRAINT customer_health_history_pkey PRIMARY KEY (id);


--
-- Name: customer_health customer_health_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health
    ADD CONSTRAINT customer_health_pkey PRIMARY KEY (id);


--
-- Name: customer_health customer_health_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health
    ADD CONSTRAINT customer_health_unique UNIQUE (project_id, customer_id);


--
-- Name: customer_profiles customer_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_profiles
    ADD CONSTRAINT customer_profiles_pkey PRIMARY KEY (id);


--
-- Name: customer_profiles customer_profiles_project_id_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_profiles
    ADD CONSTRAINT customer_profiles_project_id_email_key UNIQUE (project_id, email);


--
-- Name: customer_sync_log customer_sync_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_sync_log
    ADD CONSTRAINT customer_sync_log_pkey PRIMARY KEY (id);


--
-- Name: customers customers_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customers
    ADD CONSTRAINT customers_pkey PRIMARY KEY (id);


--
-- Name: customers customers_project_email_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customers
    ADD CONSTRAINT customers_project_email_unique UNIQUE (project_id, email);


--
-- Name: daily_briefings daily_briefings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.daily_briefings
    ADD CONSTRAINT daily_briefings_pkey PRIMARY KEY (id);


--
-- Name: deal_autopsies deal_autopsies_deal_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_autopsies
    ADD CONSTRAINT deal_autopsies_deal_id_key UNIQUE (deal_id);


--
-- Name: deal_autopsies deal_autopsies_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_autopsies
    ADD CONSTRAINT deal_autopsies_pkey PRIMARY KEY (id);


--
-- Name: deal_battlecards deal_battlecards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_battlecards
    ADD CONSTRAINT deal_battlecards_pkey PRIMARY KEY (id);


--
-- Name: deal_battlecards deal_battlecards_project_id_competitor_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_battlecards
    ADD CONSTRAINT deal_battlecards_project_id_competitor_name_key UNIQUE (project_id, competitor_name);


--
-- Name: deal_digest_subscriptions deal_digest_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_digest_subscriptions
    ADD CONSTRAINT deal_digest_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: deal_digest_subscriptions deal_digest_subscriptions_project_id_channel_destination_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_digest_subscriptions
    ADD CONSTRAINT deal_digest_subscriptions_project_id_channel_destination_key UNIQUE (project_id, channel, destination);


--
-- Name: deals deals_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_pkey PRIMARY KEY (id);


--
-- Name: discord_integration_states discord_integration_states_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discord_integration_states
    ADD CONSTRAINT discord_integration_states_pkey PRIMARY KEY (state);


--
-- Name: discord_integrations discord_integrations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discord_integrations
    ADD CONSTRAINT discord_integrations_pkey PRIMARY KEY (id);


--
-- Name: discount_code_usage discount_code_usage_discount_code_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_discount_code_id_user_id_key UNIQUE (discount_code_id, user_id);


--
-- Name: discount_code_usage discount_code_usage_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_pkey PRIMARY KEY (id);


--
-- Name: discount_codes discount_codes_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_codes
    ADD CONSTRAINT discount_codes_code_key UNIQUE (code);


--
-- Name: discount_codes discount_codes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_codes
    ADD CONSTRAINT discount_codes_pkey PRIMARY KEY (id);


--
-- Name: discovered_feedback discovered_feedback_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discovered_feedback
    ADD CONSTRAINT discovered_feedback_pkey PRIMARY KEY (id);


--
-- Name: discovered_feedback discovered_feedback_project_id_platform_platform_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discovered_feedback
    ADD CONSTRAINT discovered_feedback_project_id_platform_platform_id_key UNIQUE (project_id, platform, platform_id);


--
-- Name: domain_verifications domain_verifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.domain_verifications
    ADD CONSTRAINT domain_verifications_pkey PRIMARY KEY (id);


--
-- Name: email_batches email_batches_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_batches
    ADD CONSTRAINT email_batches_pkey PRIMARY KEY (id);


--
-- Name: email_batches email_batches_to_email_batch_date_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_batches
    ADD CONSTRAINT email_batches_to_email_batch_date_key UNIQUE (to_email, batch_date);


--
-- Name: email_logs email_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_logs
    ADD CONSTRAINT email_logs_pkey PRIMARY KEY (id);


--
-- Name: email_preferences email_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_preferences
    ADD CONSTRAINT email_preferences_pkey PRIMARY KEY (id);


--
-- Name: email_preferences email_preferences_unsubscribe_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_preferences
    ADD CONSTRAINT email_preferences_unsubscribe_token_key UNIQUE (unsubscribe_token);


--
-- Name: email_queue email_queue_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_queue
    ADD CONSTRAINT email_queue_pkey PRIMARY KEY (id);


--
-- Name: email_templates email_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_pkey PRIMARY KEY (id);


--
-- Name: email_templates email_templates_project_id_template_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_project_id_template_type_key UNIQUE (project_id, template_type);


--
-- Name: events events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.events
    ADD CONSTRAINT events_pkey PRIMARY KEY (id);


--
-- Name: executive_briefs executive_briefs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.executive_briefs
    ADD CONSTRAINT executive_briefs_pkey PRIMARY KEY (id);


--
-- Name: experiment_embeddings experiment_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_embeddings
    ADD CONSTRAINT experiment_embeddings_pkey PRIMARY KEY (id);


--
-- Name: experiment_learnings experiment_learnings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_learnings
    ADD CONSTRAINT experiment_learnings_pkey PRIMARY KEY (id);


--
-- Name: experiment_results experiment_results_experiment_id_metric_name_variant_measur_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_results
    ADD CONSTRAINT experiment_results_experiment_id_metric_name_variant_measur_key UNIQUE (experiment_id, metric_name, variant, measured_at);


--
-- Name: experiment_results experiment_results_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_results
    ADD CONSTRAINT experiment_results_pkey PRIMARY KEY (id);


--
-- Name: experiment_snapshots experiment_snapshots_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_snapshots
    ADD CONSTRAINT experiment_snapshots_pkey PRIMARY KEY (id);


--
-- Name: experiment_sync_log experiment_sync_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_sync_log
    ADD CONSTRAINT experiment_sync_log_pkey PRIMARY KEY (id);


--
-- Name: experiments experiments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiments
    ADD CONSTRAINT experiments_pkey PRIMARY KEY (id);


--
-- Name: feature_gaps feature_gaps_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_gaps
    ADD CONSTRAINT feature_gaps_pkey PRIMARY KEY (id);


--
-- Name: feature_gaps feature_gaps_project_id_feature_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_gaps
    ADD CONSTRAINT feature_gaps_project_id_feature_name_key UNIQUE (project_id, feature_name);


--
-- Name: feature_impact_history feature_impact_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_impact_history
    ADD CONSTRAINT feature_impact_history_pkey PRIMARY KEY (id);


--
-- Name: feature_outcomes feature_outcomes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_outcomes
    ADD CONSTRAINT feature_outcomes_pkey PRIMARY KEY (id);


--
-- Name: feature_outcomes feature_outcomes_suggestion_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_outcomes
    ADD CONSTRAINT feature_outcomes_suggestion_id_key UNIQUE (suggestion_id);


--
-- Name: feature_predictions feature_predictions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_predictions
    ADD CONSTRAINT feature_predictions_pkey PRIMARY KEY (id);


--
-- Name: feedback_embeddings feedback_embeddings_feedback_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_embeddings
    ADD CONSTRAINT feedback_embeddings_feedback_id_key UNIQUE (feedback_id);


--
-- Name: feedback_embeddings feedback_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_embeddings
    ADD CONSTRAINT feedback_embeddings_pkey PRIMARY KEY (id);


--
-- Name: feedback_integrations feedback_integrations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_integrations
    ADD CONSTRAINT feedback_integrations_pkey PRIMARY KEY (id);


--
-- Name: feedback_integrations feedback_integrations_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_integrations
    ADD CONSTRAINT feedback_integrations_unique UNIQUE (project_id, integration_type);


--
-- Name: feedback_merges feedback_merges_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_merges
    ADD CONSTRAINT feedback_merges_pkey PRIMARY KEY (id);


--
-- Name: feedback_metadata feedback_metadata_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_metadata
    ADD CONSTRAINT feedback_metadata_pkey PRIMARY KEY (id);


--
-- Name: feedback_metadata feedback_metadata_verification_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_metadata
    ADD CONSTRAINT feedback_metadata_verification_token_key UNIQUE (verification_token);


--
-- Name: feedback_themes feedback_themes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_themes
    ADD CONSTRAINT feedback_themes_pkey PRIMARY KEY (feedback_id, theme_id);


--
-- Name: feedback_webhooks feedback_webhooks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_webhooks
    ADD CONSTRAINT feedback_webhooks_pkey PRIMARY KEY (id);


--
-- Name: gift_subscriptions gift_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gift_subscriptions
    ADD CONSTRAINT gift_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: health_scores health_scores_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.health_scores
    ADD CONSTRAINT health_scores_pkey PRIMARY KEY (id);


--
-- Name: health_scores health_scores_share_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.health_scores
    ADD CONSTRAINT health_scores_share_token_key UNIQUE (share_token);


--
-- Name: hunter_configs hunter_configs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_configs
    ADD CONSTRAINT hunter_configs_pkey PRIMARY KEY (id);


--
-- Name: hunter_configs hunter_configs_project_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_configs
    ADD CONSTRAINT hunter_configs_project_id_key UNIQUE (project_id);


--
-- Name: hunter_jobs hunter_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_jobs
    ADD CONSTRAINT hunter_jobs_pkey PRIMARY KEY (id);


--
-- Name: hunter_logs hunter_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_logs
    ADD CONSTRAINT hunter_logs_pkey PRIMARY KEY (id);


--
-- Name: hunter_raw_items hunter_raw_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_raw_items
    ADD CONSTRAINT hunter_raw_items_pkey PRIMARY KEY (id);


--
-- Name: hunter_scans hunter_scans_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_scans
    ADD CONSTRAINT hunter_scans_pkey PRIMARY KEY (id);


--
-- Name: inbox_sync_logs inbox_sync_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.inbox_sync_logs
    ADD CONSTRAINT inbox_sync_logs_pkey PRIMARY KEY (id);


--
-- Name: insight_reports insight_reports_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insight_reports
    ADD CONSTRAINT insight_reports_pkey PRIMARY KEY (id);


--
-- Name: integration_credentials integration_credentials_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_credentials
    ADD CONSTRAINT integration_credentials_pkey PRIMARY KEY (id);


--
-- Name: integration_credentials integration_credentials_project_id_provider_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_credentials
    ADD CONSTRAINT integration_credentials_project_id_provider_key UNIQUE (project_id, provider);


--
-- Name: jira_connections jira_connections_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_connections
    ADD CONSTRAINT jira_connections_pkey PRIMARY KEY (id);


--
-- Name: jira_connections jira_connections_user_id_project_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_connections
    ADD CONSTRAINT jira_connections_user_id_project_id_key UNIQUE (user_id, project_id);


--
-- Name: jira_issue_links jira_issue_links_feedback_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_issue_links
    ADD CONSTRAINT jira_issue_links_feedback_id_key UNIQUE (feedback_id);


--
-- Name: jira_issue_links jira_issue_links_jira_connection_id_issue_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_issue_links
    ADD CONSTRAINT jira_issue_links_jira_connection_id_issue_key_key UNIQUE (jira_connection_id, issue_key);


--
-- Name: jira_issue_links jira_issue_links_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_issue_links
    ADD CONSTRAINT jira_issue_links_pkey PRIMARY KEY (id);


--
-- Name: jira_label_mappings jira_label_mappings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_label_mappings
    ADD CONSTRAINT jira_label_mappings_pkey PRIMARY KEY (id);


--
-- Name: jira_label_mappings jira_label_mappings_project_id_theme_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_label_mappings
    ADD CONSTRAINT jira_label_mappings_project_id_theme_id_key UNIQUE (project_id, theme_id);


--
-- Name: jira_oauth_states jira_oauth_states_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_oauth_states
    ADD CONSTRAINT jira_oauth_states_pkey PRIMARY KEY (id);


--
-- Name: jira_oauth_states jira_oauth_states_state_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_oauth_states
    ADD CONSTRAINT jira_oauth_states_state_token_key UNIQUE (state_token);


--
-- Name: jira_sync_logs jira_sync_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_sync_logs
    ADD CONSTRAINT jira_sync_logs_pkey PRIMARY KEY (id);


--
-- Name: jira_webhooks jira_webhooks_jira_connection_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_webhooks
    ADD CONSTRAINT jira_webhooks_jira_connection_id_key UNIQUE (jira_connection_id);


--
-- Name: jira_webhooks jira_webhooks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_webhooks
    ADD CONSTRAINT jira_webhooks_pkey PRIMARY KEY (id);


--
-- Name: launch_boards launch_boards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_boards
    ADD CONSTRAINT launch_boards_pkey PRIMARY KEY (id);


--
-- Name: launch_boards launch_boards_share_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_boards
    ADD CONSTRAINT launch_boards_share_token_key UNIQUE (share_token);


--
-- Name: launch_checklist_items launch_checklist_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_checklist_items
    ADD CONSTRAINT launch_checklist_items_pkey PRIMARY KEY (id);


--
-- Name: launch_dimensions launch_dimensions_board_id_dimension_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_dimensions
    ADD CONSTRAINT launch_dimensions_board_id_dimension_type_key UNIQUE (board_id, dimension_type);


--
-- Name: launch_dimensions launch_dimensions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_dimensions
    ADD CONSTRAINT launch_dimensions_pkey PRIMARY KEY (id);


--
-- Name: launch_risks launch_risks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_risks
    ADD CONSTRAINT launch_risks_pkey PRIMARY KEY (id);


--
-- Name: launch_votes launch_votes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_votes
    ADD CONSTRAINT launch_votes_pkey PRIMARY KEY (id);


--
-- Name: linear_connections linear_connections_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.linear_connections
    ADD CONSTRAINT linear_connections_pkey PRIMARY KEY (id);


--
-- Name: lovable_generations lovable_generations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lovable_generations
    ADD CONSTRAINT lovable_generations_pkey PRIMARY KEY (id);


--
-- Name: members members_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.members
    ADD CONSTRAINT members_pkey PRIMARY KEY (id);


--
-- Name: members members_project_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.members
    ADD CONSTRAINT members_project_id_user_id_key UNIQUE (project_id, user_id);


--
-- Name: notification_logs notification_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notification_logs
    ADD CONSTRAINT notification_logs_pkey PRIMARY KEY (id);


--
-- Name: persona_embeddings persona_embeddings_persona_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.persona_embeddings
    ADD CONSTRAINT persona_embeddings_persona_id_key UNIQUE (persona_id);


--
-- Name: persona_embeddings persona_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.persona_embeddings
    ADD CONSTRAINT persona_embeddings_pkey PRIMARY KEY (id);


--
-- Name: personas personas_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.personas
    ADD CONSTRAINT personas_pkey PRIMARY KEY (id);


--
-- Name: personas personas_project_id_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.personas
    ADD CONSTRAINT personas_project_id_name_key UNIQUE (project_id, name);


--
-- Name: platform_integrations platform_integrations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.platform_integrations
    ADD CONSTRAINT platform_integrations_pkey PRIMARY KEY (id);


--
-- Name: platform_integrations platform_integrations_project_id_platform_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.platform_integrations
    ADD CONSTRAINT platform_integrations_project_id_platform_type_key UNIQUE (project_id, platform_type);


--
-- Name: pm_assignments pm_assignments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pm_assignments
    ADD CONSTRAINT pm_assignments_pkey PRIMARY KEY (id);


--
-- Name: poll_options poll_options_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_options
    ADD CONSTRAINT poll_options_pkey PRIMARY KEY (id);


--
-- Name: poll_votes poll_votes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_votes
    ADD CONSTRAINT poll_votes_pkey PRIMARY KEY (id);


--
-- Name: polls polls_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.polls
    ADD CONSTRAINT polls_pkey PRIMARY KEY (id);


--
-- Name: post_similarities post_similarities_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.post_similarities
    ADD CONSTRAINT post_similarities_pkey PRIMARY KEY (id);


--
-- Name: posts posts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_pkey PRIMARY KEY (id);


--
-- Name: prd_risk_alerts prd_risk_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prd_risk_alerts
    ADD CONSTRAINT prd_risk_alerts_pkey PRIMARY KEY (id);


--
-- Name: pre_mortem_analyses pre_mortem_analyses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pre_mortem_analyses
    ADD CONSTRAINT pre_mortem_analyses_pkey PRIMARY KEY (id);


--
-- Name: product_doc_embeddings product_doc_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_doc_embeddings
    ADD CONSTRAINT product_doc_embeddings_pkey PRIMARY KEY (id);


--
-- Name: product_doc_embeddings product_doc_embeddings_product_doc_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_doc_embeddings
    ADD CONSTRAINT product_doc_embeddings_product_doc_id_key UNIQUE (product_doc_id);


--
-- Name: product_documents product_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_documents
    ADD CONSTRAINT product_documents_pkey PRIMARY KEY (id);


--
-- Name: project_notification_recipients project_notification_recipients_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_notification_recipients
    ADD CONSTRAINT project_notification_recipients_pkey PRIMARY KEY (id);


--
-- Name: project_notification_recipients project_notification_recipients_project_id_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_notification_recipients
    ADD CONSTRAINT project_notification_recipients_project_id_email_key UNIQUE (project_id, email);


--
-- Name: projects projects_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.projects
    ADD CONSTRAINT projects_pkey PRIMARY KEY (id);


--
-- Name: projects projects_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.projects
    ADD CONSTRAINT projects_slug_key UNIQUE (slug);


--
-- Name: push_subscriptions push_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.push_subscriptions
    ADD CONSTRAINT push_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: push_subscriptions push_subscriptions_user_id_endpoint_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.push_subscriptions
    ADD CONSTRAINT push_subscriptions_user_id_endpoint_key UNIQUE (user_id, endpoint);


--
-- Name: rate_limit_violations rate_limit_violations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_limit_violations
    ADD CONSTRAINT rate_limit_violations_pkey PRIMARY KEY (id);


--
-- Name: reasoning_traces reasoning_traces_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reasoning_traces
    ADD CONSTRAINT reasoning_traces_pkey PRIMARY KEY (id);


--
-- Name: report_executions report_executions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.report_executions
    ADD CONSTRAINT report_executions_pkey PRIMARY KEY (id);


--
-- Name: retro_actions retro_actions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_actions
    ADD CONSTRAINT retro_actions_pkey PRIMARY KEY (id);


--
-- Name: retro_boards retro_boards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_boards
    ADD CONSTRAINT retro_boards_pkey PRIMARY KEY (id);


--
-- Name: retro_boards retro_boards_share_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_boards
    ADD CONSTRAINT retro_boards_share_token_key UNIQUE (share_token);


--
-- Name: retro_card_comments retro_card_comments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_card_comments
    ADD CONSTRAINT retro_card_comments_pkey PRIMARY KEY (id);


--
-- Name: retro_card_votes retro_card_votes_card_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_card_votes
    ADD CONSTRAINT retro_card_votes_card_id_user_id_key UNIQUE (card_id, user_id);


--
-- Name: retro_card_votes retro_card_votes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_card_votes
    ADD CONSTRAINT retro_card_votes_pkey PRIMARY KEY (id);


--
-- Name: retro_cards retro_cards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_cards
    ADD CONSTRAINT retro_cards_pkey PRIMARY KEY (id);


--
-- Name: retro_columns retro_columns_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_columns
    ADD CONSTRAINT retro_columns_pkey PRIMARY KEY (id);


--
-- Name: roadmap_adjustment_history roadmap_adjustment_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_history
    ADD CONSTRAINT roadmap_adjustment_history_pkey PRIMARY KEY (id);


--
-- Name: roadmap_adjustment_proposals roadmap_adjustment_proposals_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_proposals
    ADD CONSTRAINT roadmap_adjustment_proposals_pkey PRIMARY KEY (id);


--
-- Name: roadmap_exports roadmap_exports_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_exports
    ADD CONSTRAINT roadmap_exports_pkey PRIMARY KEY (id);


--
-- Name: roadmap_feedback roadmap_feedback_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_feedback
    ADD CONSTRAINT roadmap_feedback_pkey PRIMARY KEY (id);


--
-- Name: roadmap_generation_logs roadmap_generation_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_generation_logs
    ADD CONSTRAINT roadmap_generation_logs_pkey PRIMARY KEY (id);


--
-- Name: roadmap_item_embeddings roadmap_item_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_item_embeddings
    ADD CONSTRAINT roadmap_item_embeddings_pkey PRIMARY KEY (id);


--
-- Name: roadmap_item_embeddings roadmap_item_embeddings_roadmap_item_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_item_embeddings
    ADD CONSTRAINT roadmap_item_embeddings_roadmap_item_id_key UNIQUE (roadmap_item_id);


--
-- Name: roadmap_priority_history roadmap_priority_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_priority_history
    ADD CONSTRAINT roadmap_priority_history_pkey PRIMARY KEY (id);


--
-- Name: roadmap_roast_sessions roadmap_roast_sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_roast_sessions
    ADD CONSTRAINT roadmap_roast_sessions_pkey PRIMARY KEY (id);


--
-- Name: roadmap_roast_sessions roadmap_roast_sessions_session_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_roast_sessions
    ADD CONSTRAINT roadmap_roast_sessions_session_token_key UNIQUE (session_token);


--
-- Name: roadmap_roast_sessions roadmap_roast_sessions_share_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_roast_sessions
    ADD CONSTRAINT roadmap_roast_sessions_share_token_key UNIQUE (share_token);


--
-- Name: roadmap_subscriptions roadmap_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_subscriptions
    ADD CONSTRAINT roadmap_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: roadmap_subscriptions roadmap_subscriptions_project_id_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_subscriptions
    ADD CONSTRAINT roadmap_subscriptions_project_id_email_key UNIQUE (project_id, email);


--
-- Name: roadmap_subscriptions roadmap_subscriptions_subscription_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_subscriptions
    ADD CONSTRAINT roadmap_subscriptions_subscription_token_key UNIQUE (subscription_token);


--
-- Name: roadmap_suggestions roadmap_suggestions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_suggestions
    ADD CONSTRAINT roadmap_suggestions_pkey PRIMARY KEY (id);


--
-- Name: roadmap_suggestions roadmap_suggestions_project_id_theme_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_suggestions
    ADD CONSTRAINT roadmap_suggestions_project_id_theme_id_key UNIQUE (project_id, theme_id);


--
-- Name: scheduled_reports scheduled_reports_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.scheduled_reports
    ADD CONSTRAINT scheduled_reports_pkey PRIMARY KEY (id);


--
-- Name: scrape_cache scrape_cache_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.scrape_cache
    ADD CONSTRAINT scrape_cache_pkey PRIMARY KEY (id);


--
-- Name: scrape_cache scrape_cache_product_name_normalized_source_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.scrape_cache
    ADD CONSTRAINT scrape_cache_product_name_normalized_source_key UNIQUE (product_name_normalized, source);


--
-- Name: security_events security_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_events
    ADD CONSTRAINT security_events_pkey PRIMARY KEY (id);


--
-- Name: sentiment_analysis sentiment_analysis_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_analysis
    ADD CONSTRAINT sentiment_analysis_pkey PRIMARY KEY (id);


--
-- Name: sentiment_analysis sentiment_analysis_post_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_analysis
    ADD CONSTRAINT sentiment_analysis_post_id_key UNIQUE (post_id);


--
-- Name: sentiment_forecasts sentiment_forecasts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_forecasts
    ADD CONSTRAINT sentiment_forecasts_pkey PRIMARY KEY (id);


--
-- Name: sentiment_history sentiment_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_history
    ADD CONSTRAINT sentiment_history_pkey PRIMARY KEY (id);


--
-- Name: sentiment_history sentiment_history_project_id_date_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_history
    ADD CONSTRAINT sentiment_history_project_id_date_key UNIQUE (project_id, date);


--
-- Name: signal_correlations signal_correlations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.signal_correlations
    ADD CONSTRAINT signal_correlations_pkey PRIMARY KEY (id);


--
-- Name: signal_events signal_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.signal_events
    ADD CONSTRAINT signal_events_pkey PRIMARY KEY (id);


--
-- Name: slack_alert_rules slack_alert_rules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_alert_rules
    ADD CONSTRAINT slack_alert_rules_pkey PRIMARY KEY (id);


--
-- Name: slack_alert_rules slack_alert_rules_project_id_rule_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_alert_rules
    ADD CONSTRAINT slack_alert_rules_project_id_rule_type_key UNIQUE (project_id, rule_type);


--
-- Name: slack_channel_mappings slack_channel_mappings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_channel_mappings
    ADD CONSTRAINT slack_channel_mappings_pkey PRIMARY KEY (id);


--
-- Name: slack_channel_mappings slack_channel_mappings_slack_connection_id_alert_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_channel_mappings
    ADD CONSTRAINT slack_channel_mappings_slack_connection_id_alert_type_key UNIQUE (slack_connection_id, alert_type);


--
-- Name: slack_connections slack_connections_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_connections
    ADD CONSTRAINT slack_connections_pkey PRIMARY KEY (id);


--
-- Name: slack_connections slack_connections_project_id_team_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_connections
    ADD CONSTRAINT slack_connections_project_id_team_id_key UNIQUE (project_id, team_id);


--
-- Name: slack_integration_states slack_integration_states_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_integration_states
    ADD CONSTRAINT slack_integration_states_pkey PRIMARY KEY (state);


--
-- Name: slack_integrations slack_integrations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_integrations
    ADD CONSTRAINT slack_integrations_pkey PRIMARY KEY (id);


--
-- Name: slack_interaction_logs slack_interaction_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_interaction_logs
    ADD CONSTRAINT slack_interaction_logs_pkey PRIMARY KEY (id);


--
-- Name: slack_message_logs slack_message_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_message_logs
    ADD CONSTRAINT slack_message_logs_pkey PRIMARY KEY (id);


--
-- Name: smart_replies smart_replies_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.smart_replies
    ADD CONSTRAINT smart_replies_pkey PRIMARY KEY (id);


--
-- Name: spec_context_sources spec_context_sources_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_context_sources
    ADD CONSTRAINT spec_context_sources_pkey PRIMARY KEY (id);


--
-- Name: spec_embeddings spec_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_embeddings
    ADD CONSTRAINT spec_embeddings_pkey PRIMARY KEY (id);


--
-- Name: spec_versions spec_versions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_versions
    ADD CONSTRAINT spec_versions_pkey PRIMARY KEY (id);


--
-- Name: specs specs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.specs
    ADD CONSTRAINT specs_pkey PRIMARY KEY (id);


--
-- Name: sprints sprints_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sprints
    ADD CONSTRAINT sprints_pkey PRIMARY KEY (id);


--
-- Name: sprints sprints_project_id_sprint_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sprints
    ADD CONSTRAINT sprints_project_id_sprint_number_key UNIQUE (project_id, sprint_number);


--
-- Name: stakeholder_interests stakeholder_interests_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_interests
    ADD CONSTRAINT stakeholder_interests_pkey PRIMARY KEY (id);


--
-- Name: stakeholder_interests stakeholder_interests_stakeholder_id_interest_type_interest_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_interests
    ADD CONSTRAINT stakeholder_interests_stakeholder_id_interest_type_interest_key UNIQUE (stakeholder_id, interest_type, interest_id);


--
-- Name: stakeholder_queries stakeholder_queries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_queries
    ADD CONSTRAINT stakeholder_queries_pkey PRIMARY KEY (id);


--
-- Name: stakeholder_reports stakeholder_reports_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_reports
    ADD CONSTRAINT stakeholder_reports_pkey PRIMARY KEY (id);


--
-- Name: stakeholders stakeholders_access_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholders
    ADD CONSTRAINT stakeholders_access_token_key UNIQUE (access_token);


--
-- Name: stakeholders stakeholders_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholders
    ADD CONSTRAINT stakeholders_pkey PRIMARY KEY (id);


--
-- Name: story_feedback_links story_feedback_links_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_feedback_links
    ADD CONSTRAINT story_feedback_links_pkey PRIMARY KEY (story_id, feedback_id);


--
-- Name: story_generation_logs story_generation_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_generation_logs
    ADD CONSTRAINT story_generation_logs_pkey PRIMARY KEY (id);


--
-- Name: story_templates story_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_templates
    ADD CONSTRAINT story_templates_pkey PRIMARY KEY (id);


--
-- Name: story_templates story_templates_project_id_template_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_templates
    ADD CONSTRAINT story_templates_project_id_template_name_key UNIQUE (project_id, template_name);


--
-- Name: strategic_recommendations strategic_recommendations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategic_recommendations
    ADD CONSTRAINT strategic_recommendations_pkey PRIMARY KEY (id);


--
-- Name: strategy_shift_events strategy_shift_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategy_shift_events
    ADD CONSTRAINT strategy_shift_events_pkey PRIMARY KEY (id);


--
-- Name: strategy_shifts strategy_shifts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategy_shifts
    ADD CONSTRAINT strategy_shifts_pkey PRIMARY KEY (id);


--
-- Name: stripe_settings stripe_settings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stripe_settings
    ADD CONSTRAINT stripe_settings_pkey PRIMARY KEY (id);


--
-- Name: stripe_settings stripe_settings_project_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stripe_settings
    ADD CONSTRAINT stripe_settings_project_id_key UNIQUE (project_id);


--
-- Name: survey_questions survey_questions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.survey_questions
    ADD CONSTRAINT survey_questions_pkey PRIMARY KEY (id);


--
-- Name: survey_responses survey_responses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.survey_responses
    ADD CONSTRAINT survey_responses_pkey PRIMARY KEY (id);


--
-- Name: surveys surveys_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.surveys
    ADD CONSTRAINT surveys_pkey PRIMARY KEY (id);


--
-- Name: team_capacity team_capacity_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_capacity
    ADD CONSTRAINT team_capacity_pkey PRIMARY KEY (id);


--
-- Name: team_capacity team_capacity_project_id_week_start_date_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_capacity
    ADD CONSTRAINT team_capacity_project_id_week_start_date_key UNIQUE (project_id, week_start_date);


--
-- Name: team_invitations team_invitations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_pkey PRIMARY KEY (id);


--
-- Name: team_invitations team_invitations_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_token_key UNIQUE (token);


--
-- Name: team_velocity team_velocity_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_velocity
    ADD CONSTRAINT team_velocity_pkey PRIMARY KEY (id);


--
-- Name: team_velocity team_velocity_project_id_sprint_id_board_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_velocity
    ADD CONSTRAINT team_velocity_project_id_sprint_id_board_id_key UNIQUE (project_id, sprint_id, board_id);


--
-- Name: theme_clusters theme_clusters_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.theme_clusters
    ADD CONSTRAINT theme_clusters_pkey PRIMARY KEY (id);


--
-- Name: theme_clusters theme_clusters_project_id_cluster_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.theme_clusters
    ADD CONSTRAINT theme_clusters_project_id_cluster_name_key UNIQUE (project_id, cluster_name);


--
-- Name: themes themes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.themes
    ADD CONSTRAINT themes_pkey PRIMARY KEY (id);


--
-- Name: themes themes_project_id_theme_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.themes
    ADD CONSTRAINT themes_project_id_theme_name_key UNIQUE (project_id, theme_name);


--
-- Name: timeline_events timeline_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.timeline_events
    ADD CONSTRAINT timeline_events_pkey PRIMARY KEY (id);


--
-- Name: triage_queue triage_queue_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.triage_queue
    ADD CONSTRAINT triage_queue_pkey PRIMARY KEY (id);


--
-- Name: unified_action_queue unified_action_queue_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_pkey PRIMARY KEY (id);


--
-- Name: unified_feedback_items unified_feedback_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_pkey PRIMARY KEY (id);


--
-- Name: competitor_monitoring_config unique_competitor_config; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_monitoring_config
    ADD CONSTRAINT unique_competitor_config UNIQUE (project_id, competitor_name);


--
-- Name: ai_weight_preferences unique_default_weights; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_weight_preferences
    ADD CONSTRAINT unique_default_weights UNIQUE (project_id, feature_type, is_default) DEFERRABLE INITIALLY DEFERRED;


--
-- Name: competitor_job_postings unique_job_posting; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_job_postings
    ADD CONSTRAINT unique_job_posting UNIQUE (project_id, competitor_name, job_title, source_url);


--
-- Name: feedback_merges unique_merge_pair; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_merges
    ADD CONSTRAINT unique_merge_pair UNIQUE (primary_post_id, merged_post_id);


--
-- Name: poll_votes unique_poll_vote; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_votes
    ADD CONSTRAINT unique_poll_vote UNIQUE (poll_id, voter_hash);


--
-- Name: triage_queue unique_post_in_queue; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.triage_queue
    ADD CONSTRAINT unique_post_in_queue UNIQUE (post_id);


--
-- Name: gift_subscriptions unique_redemption_code; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gift_subscriptions
    ADD CONSTRAINT unique_redemption_code UNIQUE (redemption_code);


--
-- Name: survey_responses unique_survey_response; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.survey_responses
    ADD CONSTRAINT unique_survey_response UNIQUE (survey_id, respondent_hash);


--
-- Name: unsubscribe_tokens unsubscribe_tokens_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unsubscribe_tokens
    ADD CONSTRAINT unsubscribe_tokens_pkey PRIMARY KEY (token);


--
-- Name: usage_analytics_events usage_analytics_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.usage_analytics_events
    ADD CONSTRAINT usage_analytics_events_pkey PRIMARY KEY (id);


--
-- Name: user_intelligence user_intelligence_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_intelligence
    ADD CONSTRAINT user_intelligence_pkey PRIMARY KEY (id);


--
-- Name: user_intelligence user_intelligence_user_id_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_intelligence
    ADD CONSTRAINT user_intelligence_user_id_unique UNIQUE (user_id);


--
-- Name: user_preferences user_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_preferences
    ADD CONSTRAINT user_preferences_pkey PRIMARY KEY (id);


--
-- Name: user_preferences user_preferences_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_preferences
    ADD CONSTRAINT user_preferences_user_id_key UNIQUE (user_id);


--
-- Name: user_stories user_stories_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_stories
    ADD CONSTRAINT user_stories_pkey PRIMARY KEY (id);


--
-- Name: users users_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_email_key UNIQUE (email);


--
-- Name: users users_google_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_google_id_key UNIQUE (google_id);


--
-- Name: users users_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


--
-- Name: vote_metadata vote_metadata_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vote_metadata
    ADD CONSTRAINT vote_metadata_pkey PRIMARY KEY (id);


--
-- Name: vote_metadata vote_metadata_verification_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vote_metadata
    ADD CONSTRAINT vote_metadata_verification_token_key UNIQUE (verification_token);


--
-- Name: votes votes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.votes
    ADD CONSTRAINT votes_pkey PRIMARY KEY (id);


--
-- Name: webhook_deliveries webhook_deliveries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_pkey PRIMARY KEY (id);


--
-- Name: workflows workflows_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows
    ADD CONSTRAINT workflows_pkey PRIMARY KEY (id);


--
-- Name: agent_memory_agent_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX agent_memory_agent_idx ON public.agent_memory USING btree (agent_name);


--
-- Name: agent_memory_embedding_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX agent_memory_embedding_idx ON public.agent_memory USING ivfflat (embedding public.vector_cosine_ops);


--
-- Name: agent_memory_importance_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX agent_memory_importance_idx ON public.agent_memory USING btree (importance);


--
-- Name: agent_memory_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX agent_memory_project_idx ON public.agent_memory USING btree (project_id, created_at DESC);


--
-- Name: ask_analytics_message_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_analytics_message_idx ON public.ask_analytics USING btree (message_id);


--
-- Name: ask_analytics_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_analytics_project_idx ON public.ask_analytics USING btree (project_id, created_at DESC);


--
-- Name: ask_analytics_rating_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_analytics_rating_idx ON public.ask_analytics USING btree (response_rating) WHERE (response_rating IS NOT NULL);


--
-- Name: ask_conversations_pinned_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_conversations_pinned_idx ON public.ask_conversations USING btree (user_id, is_pinned, last_message_at DESC) WHERE (is_pinned = true);


--
-- Name: ask_conversations_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_conversations_project_idx ON public.ask_conversations USING btree (project_id, last_message_at DESC);


--
-- Name: ask_conversations_user_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_conversations_user_idx ON public.ask_conversations USING btree (user_id, last_message_at DESC);


--
-- Name: ask_messages_conversation_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_messages_conversation_idx ON public.ask_messages USING btree (conversation_id, created_at DESC);


--
-- Name: ask_messages_query_type_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_messages_query_type_idx ON public.ask_messages USING btree (query_type) WHERE (query_type IS NOT NULL);


--
-- Name: ask_messages_sources_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX ask_messages_sources_idx ON public.ask_messages USING gin (sources);


--
-- Name: competitor_embeddings_competitor_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX competitor_embeddings_competitor_idx ON public.competitor_embeddings USING btree (competitor_id);


--
-- Name: competitor_embeddings_hnsw_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX competitor_embeddings_hnsw_idx ON public.competitor_embeddings USING hnsw (embedding public.vector_cosine_ops);


--
-- Name: competitor_embeddings_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX competitor_embeddings_project_idx ON public.competitor_embeddings USING btree (project_id);


--
-- Name: discord_integration_states_project_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX discord_integration_states_project_id_idx ON public.discord_integration_states USING btree (project_id);


--
-- Name: discord_integrations_project_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX discord_integrations_project_id_idx ON public.discord_integrations USING btree (project_id);


--
-- Name: feedback_embeddings_feedback_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX feedback_embeddings_feedback_idx ON public.feedback_embeddings USING btree (feedback_id);


--
-- Name: feedback_embeddings_hnsw_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX feedback_embeddings_hnsw_idx ON public.feedback_embeddings USING hnsw (embedding public.vector_cosine_ops);


--
-- Name: feedback_embeddings_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX feedback_embeddings_project_idx ON public.feedback_embeddings USING btree (project_id);


--
-- Name: idx_account_billing_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_account_billing_customer ON public.account_billing_profiles USING btree (stripe_customer_id) WHERE (stripe_customer_id IS NOT NULL);


--
-- Name: idx_account_billing_plan; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_billing_plan ON public.account_billing_profiles USING btree (plan);


--
-- Name: idx_action_executions_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_executions_created ON public.ask_action_executions USING btree (created_at DESC);


--
-- Name: idx_action_executions_message; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_executions_message ON public.ask_action_executions USING btree (message_id);


--
-- Name: idx_action_executions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_executions_status ON public.ask_action_executions USING btree (status);


--
-- Name: idx_action_executions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_executions_user ON public.ask_action_executions USING btree (user_id);


--
-- Name: idx_action_queue_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_queue_expires ON public.unified_action_queue USING btree (expires_at) WHERE (expires_at IS NOT NULL);


--
-- Name: idx_action_queue_poll; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_queue_poll ON public.unified_action_queue USING btree (related_poll_id) WHERE (related_poll_id IS NOT NULL);


--
-- Name: idx_action_queue_project_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_queue_project_active ON public.unified_action_queue USING btree (project_id, priority, created_at DESC) WHERE ((executed = false) AND (dismissed = false));


--
-- Name: idx_action_queue_related_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_queue_related_post ON public.unified_action_queue USING btree (related_post_id) WHERE (related_post_id IS NOT NULL);


--
-- Name: idx_action_queue_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_queue_severity ON public.unified_action_queue USING btree (severity, project_id) WHERE ((executed = false) AND (dismissed = false));


--
-- Name: idx_action_queue_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_queue_type ON public.unified_action_queue USING btree (action_type, project_id);


--
-- Name: idx_action_recommendations_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_recommendations_created_at ON public.action_recommendations USING btree (created_at DESC);


--
-- Name: idx_action_recommendations_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_recommendations_priority ON public.action_recommendations USING btree (priority);


--
-- Name: idx_action_recommendations_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_recommendations_project_id ON public.action_recommendations USING btree (project_id);


--
-- Name: idx_action_recommendations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_action_recommendations_status ON public.action_recommendations USING btree (status);


--
-- Name: idx_adj_history_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_history_project ON public.roadmap_adjustment_history USING btree (project_id);


--
-- Name: idx_adj_history_proposal; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_history_proposal ON public.roadmap_adjustment_history USING btree (proposal_id);


--
-- Name: idx_adj_history_suggestion; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_history_suggestion ON public.roadmap_adjustment_history USING btree (suggestion_id);


--
-- Name: idx_adj_proposals_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_proposals_created_at ON public.roadmap_adjustment_proposals USING btree (created_at DESC);


--
-- Name: idx_adj_proposals_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_proposals_expires ON public.roadmap_adjustment_proposals USING btree (expires_at) WHERE (status = 'pending'::text);


--
-- Name: idx_adj_proposals_project_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_proposals_project_status ON public.roadmap_adjustment_proposals USING btree (project_id, status);


--
-- Name: idx_adj_proposals_trigger_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_adj_proposals_trigger_type ON public.roadmap_adjustment_proposals USING btree (trigger_type);


--
-- Name: idx_ai_usage_feature; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_usage_feature ON public.ai_usage_tracking USING btree (feature_type);


--
-- Name: idx_ai_usage_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_usage_project ON public.ai_usage_tracking USING btree (project_id);


--
-- Name: idx_alert_rules_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_alert_rules_active ON public.churn_alert_rules USING btree (project_id, is_active);


--
-- Name: idx_alert_rules_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_alert_rules_project ON public.churn_alert_rules USING btree (project_id);


--
-- Name: idx_analytics_events_api_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_analytics_events_api_key ON public.analytics_events USING btree (api_key);


--
-- Name: idx_analytics_events_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_analytics_events_created_at ON public.analytics_events USING btree (created_at);


--
-- Name: idx_analytics_events_event_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_analytics_events_event_name ON public.analytics_events USING btree (event_name);


--
-- Name: idx_analytics_events_ip_address; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_analytics_events_ip_address ON public.analytics_events USING btree (ip_address);


--
-- Name: idx_analytics_events_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_analytics_events_project ON public.analytics_events USING btree (project_id);


--
-- Name: idx_analytics_events_timestamp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_analytics_events_timestamp ON public.analytics_events USING btree ("timestamp");


--
-- Name: idx_anomaly_detected_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_anomaly_detected_at ON public.anomaly_detections USING btree (detected_at DESC);


--
-- Name: idx_anomaly_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_anomaly_project ON public.anomaly_detections USING btree (project_id);


--
-- Name: idx_anomaly_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_anomaly_severity ON public.anomaly_detections USING btree (severity, detected_at DESC);


--
-- Name: idx_anomaly_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_anomaly_status ON public.anomaly_detections USING btree (status) WHERE ((status)::text = 'active'::text);


--
-- Name: idx_anomaly_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_anomaly_type ON public.anomaly_detections USING btree (anomaly_type);


--
-- Name: idx_api_keys_hash; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_api_keys_hash ON public.api_keys USING btree (key_hash);


--
-- Name: idx_api_keys_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_api_keys_is_active ON public.api_keys USING btree (is_active);


--
-- Name: idx_api_keys_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_api_keys_project ON public.api_keys USING btree (project_id);


--
-- Name: idx_ask_messages_action_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ask_messages_action_status ON public.ask_messages USING btree (action_status) WHERE (action_status IS NOT NULL);


--
-- Name: idx_audio_briefings_briefing_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audio_briefings_briefing_id ON public.audio_briefings USING btree (briefing_id);


--
-- Name: idx_audio_briefings_expires_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audio_briefings_expires_at ON public.audio_briefings USING btree (expires_at);


--
-- Name: idx_audio_briefings_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audio_briefings_project_id ON public.audio_briefings USING btree (project_id);


--
-- Name: idx_audit_logs_action_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_action_status ON public.audit_logs USING btree (action_status);


--
-- Name: idx_audit_logs_actor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_actor ON public.audit_logs USING btree (actor_id);


--
-- Name: idx_audit_logs_actor_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_actor_created ON public.audit_logs USING btree (actor_id, created_at DESC);


--
-- Name: idx_audit_logs_correlation; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_correlation ON public.audit_logs USING btree (correlation_id);


--
-- Name: idx_audit_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_created_at ON public.audit_logs USING btree (created_at DESC);


--
-- Name: idx_audit_logs_event_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_event_category ON public.audit_logs USING btree (event_category);


--
-- Name: idx_audit_logs_event_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_event_type ON public.audit_logs USING btree (event_type);


--
-- Name: idx_audit_logs_ip; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_ip ON public.audit_logs USING btree (ip_address);


--
-- Name: idx_audit_logs_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_project ON public.audit_logs USING btree (project_id);


--
-- Name: idx_audit_logs_project_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_project_created ON public.audit_logs USING btree (project_id, created_at DESC);


--
-- Name: idx_audit_logs_resource; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_resource ON public.audit_logs USING btree (resource_type, resource_id);


--
-- Name: idx_battlecards_competitor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_battlecards_competitor ON public.deal_battlecards USING btree (competitor_name);


--
-- Name: idx_battlecards_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_battlecards_project_id ON public.deal_battlecards USING btree (project_id);


--
-- Name: idx_battlecards_revenue_lost; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_battlecards_revenue_lost ON public.deal_battlecards USING btree (revenue_lost DESC);


--
-- Name: idx_battlecards_win_rate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_battlecards_win_rate ON public.deal_battlecards USING btree (win_rate DESC);


--
-- Name: idx_billing_events_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_billing_events_created ON public.billing_events USING btree (created_at DESC);


--
-- Name: idx_billing_events_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_billing_events_customer ON public.billing_events USING btree (stripe_customer_id);


--
-- Name: idx_billing_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_billing_events_type ON public.billing_events USING btree (event_type);


--
-- Name: idx_boards_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_boards_project ON public.boards USING btree (project_id);


--
-- Name: idx_brief_schedules_next_run; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_brief_schedules_next_run ON public.brief_schedules USING btree (is_active, next_run_at);


--
-- Name: idx_brief_schedules_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_brief_schedules_project ON public.brief_schedules USING btree (project_id);


--
-- Name: idx_brief_templates_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_brief_templates_project ON public.brief_templates USING btree (project_id);


--
-- Name: idx_call_ingests_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_ingests_created_at ON public.call_ingests USING btree (created_at DESC);


--
-- Name: idx_call_ingests_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_ingests_project_id ON public.call_ingests USING btree (project_id);


--
-- Name: idx_call_ingests_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_ingests_status ON public.call_ingests USING btree (status);


--
-- Name: idx_call_records_analyzed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_analyzed_at ON public.call_records USING btree (analyzed_at);


--
-- Name: idx_call_records_competitors; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_competitors ON public.call_records USING gin (competitors);


--
-- Name: idx_call_records_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_created_at ON public.call_records USING btree (created_at DESC);


--
-- Name: idx_call_records_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_customer ON public.call_records USING btree (customer);


--
-- Name: idx_call_records_feature_requests; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_feature_requests ON public.call_records USING gin (feature_requests);


--
-- Name: idx_call_records_ingest_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_ingest_id ON public.call_records USING btree (ingest_id);


--
-- Name: idx_call_records_objections; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_objections ON public.call_records USING gin (objections);


--
-- Name: idx_call_records_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_call_records_project_id ON public.call_records USING btree (project_id);


--
-- Name: idx_changelog_entries_order; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_entries_order ON public.changelog_entries USING btree (release_id, order_index);


--
-- Name: idx_changelog_entries_release; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_entries_release ON public.changelog_entries USING btree (release_id);


--
-- Name: idx_changelog_entries_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_entries_type ON public.changelog_entries USING btree (entry_type);


--
-- Name: idx_changelog_feedback_links_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_feedback_links_post ON public.changelog_feedback_links USING btree (post_id);


--
-- Name: idx_changelog_feedback_links_release; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_feedback_links_release ON public.changelog_feedback_links USING btree (release_id);


--
-- Name: idx_changelog_media_release; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_media_release ON public.changelog_media USING btree (release_id);


--
-- Name: idx_changelog_releases_featured; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_releases_featured ON public.changelog_releases USING btree (is_featured, published_at DESC);


--
-- Name: idx_changelog_releases_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_releases_project ON public.changelog_releases USING btree (project_id);


--
-- Name: idx_changelog_releases_published; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_releases_published ON public.changelog_releases USING btree (published_at DESC);


--
-- Name: idx_changelog_releases_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_releases_slug ON public.changelog_releases USING btree (slug);


--
-- Name: idx_changelog_subscriptions_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_subscriptions_email ON public.changelog_subscriptions USING btree (email);


--
-- Name: idx_changelog_subscriptions_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_subscriptions_project ON public.changelog_subscriptions USING btree (project_id);


--
-- Name: idx_changelog_webhooks_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_changelog_webhooks_project ON public.changelog_webhooks USING btree (project_id);


--
-- Name: idx_churn_alerts_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_alerts_created ON public.churn_alerts USING btree (project_id, created_at DESC);


--
-- Name: idx_churn_alerts_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_alerts_customer ON public.churn_alerts USING btree (customer_health_id);


--
-- Name: idx_churn_alerts_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_alerts_project ON public.churn_alerts USING btree (project_id);


--
-- Name: idx_churn_alerts_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_alerts_severity ON public.churn_alerts USING btree (project_id, severity);


--
-- Name: idx_churn_alerts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_alerts_status ON public.churn_alerts USING btree (project_id, status);


--
-- Name: idx_churn_alerts_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_alerts_type ON public.churn_alerts USING btree (project_id, alert_type);


--
-- Name: idx_churn_risk_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_risk_date ON public.churn_risk_predictions USING btree (prediction_date DESC);


--
-- Name: idx_churn_risk_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_risk_level ON public.churn_risk_predictions USING btree (risk_level, prediction_date DESC);


--
-- Name: idx_churn_risk_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_risk_project ON public.churn_risk_predictions USING btree (project_id);


--
-- Name: idx_churn_risk_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_churn_risk_user ON public.churn_risk_predictions USING btree (user_identifier);


--
-- Name: idx_collected_reviews_product; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_collected_reviews_product ON public.collected_reviews USING btree (product_name_normalized);


--
-- Name: idx_collected_reviews_session; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_collected_reviews_session ON public.collected_reviews USING btree (session_id);


--
-- Name: idx_comment_mentions_comment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comment_mentions_comment ON public.comment_mentions USING btree (comment_id);


--
-- Name: idx_comment_mentions_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comment_mentions_email ON public.comment_mentions USING btree (mentioned_user_email);


--
-- Name: idx_comment_mentions_notified; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comment_mentions_notified ON public.comment_mentions USING btree (notified_at) WHERE (notified_at IS NULL);


--
-- Name: idx_comment_mentions_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comment_mentions_post ON public.comment_mentions USING btree (post_id);


--
-- Name: idx_comment_mentions_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comment_mentions_project ON public.comment_mentions USING btree (project_id);


--
-- Name: idx_comments_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_created ON public.comments USING btree (created_at DESC);


--
-- Name: idx_comments_parent_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_parent_id ON public.comments USING btree (parent_id);


--
-- Name: idx_comments_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_post ON public.comments USING btree (post_id);


--
-- Name: idx_competitive_events_competitor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_events_competitor_id ON public.competitive_events USING btree (competitor_id);


--
-- Name: idx_competitive_events_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_events_date ON public.competitive_events USING btree (event_date DESC);


--
-- Name: idx_competitive_events_impact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_events_impact ON public.competitive_events USING btree (impact_level);


--
-- Name: idx_competitive_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_events_type ON public.competitive_events USING btree (event_type);


--
-- Name: idx_competitive_mentions_competitor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_mentions_competitor_id ON public.competitive_mentions USING btree (competitor_id);


--
-- Name: idx_competitive_mentions_extracted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_mentions_extracted_at ON public.competitive_mentions USING btree (extracted_at DESC);


--
-- Name: idx_competitive_mentions_feedback_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_mentions_feedback_id ON public.competitive_mentions USING btree (feedback_id);


--
-- Name: idx_competitive_mentions_sentiment_vs_you; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_mentions_sentiment_vs_you ON public.competitive_mentions USING btree (sentiment_vs_you);


--
-- Name: idx_competitive_mentions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitive_mentions_type ON public.competitive_mentions USING btree (mention_type);


--
-- Name: idx_competitor_alerts_detected; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_alerts_detected ON public.competitor_alerts USING btree (detected_at DESC);


--
-- Name: idx_competitor_alerts_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_alerts_project ON public.competitor_alerts USING btree (project_id);


--
-- Name: idx_competitor_alerts_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_alerts_severity ON public.competitor_alerts USING btree (severity);


--
-- Name: idx_competitor_alerts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_alerts_status ON public.competitor_alerts USING btree (status);


--
-- Name: idx_competitor_alerts_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_alerts_type ON public.competitor_alerts USING btree (alert_type);


--
-- Name: idx_competitor_events_competitor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_events_competitor ON public.competitor_events USING btree (competitor_id);


--
-- Name: idx_competitor_events_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_events_date ON public.competitor_events USING btree (event_date DESC);


--
-- Name: idx_competitor_events_embedding; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_events_embedding ON public.competitor_events USING ivfflat (embedding public.vector_cosine_ops) WITH (lists='100');


--
-- Name: idx_competitor_events_impact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_events_impact ON public.competitor_events USING btree (impact_assessment);


--
-- Name: idx_competitor_events_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_events_project ON public.competitor_events USING btree (project_id);


--
-- Name: idx_competitor_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_events_type ON public.competitor_events USING btree (event_type);


--
-- Name: idx_competitor_features_mentions; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_features_mentions ON public.competitor_features USING btree (mention_count DESC);


--
-- Name: idx_competitor_features_product; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_features_product ON public.competitor_features USING btree (competitor_product_id);


--
-- Name: idx_competitor_products_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_products_active ON public.competitor_products USING btree (is_active) WHERE (is_active = true);


--
-- Name: idx_competitor_products_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_products_project ON public.competitor_products USING btree (project_id);


--
-- Name: idx_competitor_reviews_platform; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_reviews_platform ON public.competitor_reviews USING btree (platform);


--
-- Name: idx_competitor_reviews_processed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_reviews_processed ON public.competitor_reviews USING btree (processed) WHERE (processed = false);


--
-- Name: idx_competitor_reviews_product; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_reviews_product ON public.competitor_reviews USING btree (competitor_product_id);


--
-- Name: idx_competitor_reviews_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_reviews_project ON public.competitor_reviews USING btree (project_id);


--
-- Name: idx_competitor_reviews_published; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_reviews_published ON public.competitor_reviews USING btree (published_at DESC);


--
-- Name: idx_competitor_strengths_product; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_strengths_product ON public.competitor_strengths USING btree (competitor_product_id);


--
-- Name: idx_competitor_weaknesses_product; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitor_weaknesses_product ON public.competitor_weaknesses USING btree (competitor_product_id);


--
-- Name: idx_competitors_auto_detected; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitors_auto_detected ON public.competitors USING btree (auto_detected);


--
-- Name: idx_competitors_last_mentioned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitors_last_mentioned ON public.competitors USING btree (last_mentioned_at DESC);


--
-- Name: idx_competitors_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitors_project_id ON public.competitors USING btree (project_id);


--
-- Name: idx_competitors_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitors_status ON public.competitors USING btree (status);


--
-- Name: idx_competitors_total_mentions; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_competitors_total_mentions ON public.competitors USING btree (total_mentions DESC);


--
-- Name: idx_customer_health_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_health_customer ON public.customer_health USING btree (customer_id);


--
-- Name: idx_customer_health_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_health_email ON public.customer_health USING btree (email);


--
-- Name: idx_customer_health_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_health_project ON public.customer_health USING btree (project_id);


--
-- Name: idx_customer_health_risk; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_health_risk ON public.customer_health USING btree (project_id, churn_risk);


--
-- Name: idx_customer_health_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_health_score ON public.customer_health USING btree (project_id, health_score);


--
-- Name: idx_customer_profiles_churn_risk; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_churn_risk ON public.customer_profiles USING btree (churn_risk);


--
-- Name: idx_customer_profiles_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_email ON public.customer_profiles USING btree (email);


--
-- Name: idx_customer_profiles_external_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_external_id ON public.customer_profiles USING btree (external_customer_id);


--
-- Name: idx_customer_profiles_mrr; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_mrr ON public.customer_profiles USING btree (mrr DESC NULLS LAST);


--
-- Name: idx_customer_profiles_plan_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_plan_tier ON public.customer_profiles USING btree (plan_tier);


--
-- Name: idx_customer_profiles_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_project_id ON public.customer_profiles USING btree (project_id);


--
-- Name: idx_customer_profiles_segment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_segment ON public.customer_profiles USING btree (segment);


--
-- Name: idx_customer_profiles_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_profiles_status ON public.customer_profiles USING btree (status);


--
-- Name: idx_customer_sync_log_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_sync_log_project_id ON public.customer_sync_log USING btree (project_id);


--
-- Name: idx_customer_sync_log_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_sync_log_status ON public.customer_sync_log USING btree (status);


--
-- Name: idx_customer_sync_log_synced_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customer_sync_log_synced_at ON public.customer_sync_log USING btree (synced_at DESC);


--
-- Name: idx_customers_churn_risk; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customers_churn_risk ON public.customers USING btree (project_id, churn_risk);


--
-- Name: idx_customers_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customers_email ON public.customers USING btree (email);


--
-- Name: idx_customers_health_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customers_health_score ON public.customers USING btree (project_id, health_score);


--
-- Name: idx_customers_identities; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customers_identities ON public.customers USING gin (identities);


--
-- Name: idx_customers_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_customers_project_id ON public.customers USING btree (project_id);


--
-- Name: idx_daily_briefings_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_daily_briefings_created_at ON public.daily_briefings USING btree (created_at DESC);


--
-- Name: idx_daily_briefings_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_daily_briefings_date ON public.daily_briefings USING btree (briefing_date DESC);


--
-- Name: idx_daily_briefings_project_date_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_daily_briefings_project_date_unique ON public.daily_briefings USING btree (project_id, briefing_date);


--
-- Name: idx_daily_briefings_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_daily_briefings_project_id ON public.daily_briefings USING btree (project_id);


--
-- Name: idx_deal_autopsies_confidence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_autopsies_confidence ON public.deal_autopsies USING btree (confidence DESC);


--
-- Name: idx_deal_autopsies_deal_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_autopsies_deal_id ON public.deal_autopsies USING btree (deal_id);


--
-- Name: idx_deal_autopsies_generated_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_autopsies_generated_at ON public.deal_autopsies USING btree (generated_at DESC);


--
-- Name: idx_deal_autopsies_primary_reason; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_autopsies_primary_reason ON public.deal_autopsies USING btree (primary_reason) WHERE (primary_reason IS NOT NULL);


--
-- Name: idx_deals_amount; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_amount ON public.deals USING btree (amount DESC);


--
-- Name: idx_deals_closed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_closed_at ON public.deals USING btree (closed_at DESC NULLS LAST);


--
-- Name: idx_deals_competitor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_competitor ON public.deals USING btree (competitor) WHERE (competitor IS NOT NULL);


--
-- Name: idx_deals_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_created_at ON public.deals USING btree (created_at DESC);


--
-- Name: idx_deals_external_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_external_id ON public.deals USING btree (external_id) WHERE (external_id IS NOT NULL);


--
-- Name: idx_deals_project_closed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_project_closed ON public.deals USING btree (project_id, closed_at DESC NULLS LAST);


--
-- Name: idx_deals_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_project_id ON public.deals USING btree (project_id);


--
-- Name: idx_deals_project_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_project_status ON public.deals USING btree (project_id, status);


--
-- Name: idx_deals_stage; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_stage ON public.deals USING btree (stage);


--
-- Name: idx_deals_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_status ON public.deals USING btree (status);


--
-- Name: idx_digest_subs_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_digest_subs_active ON public.deal_digest_subscriptions USING btree (active) WHERE (active = true);


--
-- Name: idx_digest_subs_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_digest_subs_project_id ON public.deal_digest_subscriptions USING btree (project_id);


--
-- Name: idx_discount_code_usage_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_code_usage_code ON public.discount_code_usage USING btree (discount_code_id);


--
-- Name: idx_discount_code_usage_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_code_usage_user ON public.discount_code_usage USING btree (user_id);


--
-- Name: idx_discount_codes_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_active ON public.discount_codes USING btree (is_active);


--
-- Name: idx_discount_codes_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_code ON public.discount_codes USING btree (code);


--
-- Name: idx_discount_codes_stripe_coupon; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_stripe_coupon ON public.discount_codes USING btree (stripe_coupon_id);


--
-- Name: idx_discount_codes_stripe_promo; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_stripe_promo ON public.discount_codes USING btree (stripe_promotion_code_id);


--
-- Name: idx_discount_codes_valid_dates; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_valid_dates ON public.discount_codes USING btree (valid_from, valid_until);


--
-- Name: idx_discovered_feedback_classification; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_classification ON public.discovered_feedback USING btree (classification);


--
-- Name: idx_discovered_feedback_customer_mrr; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_customer_mrr ON public.discovered_feedback USING btree (customer_mrr DESC NULLS LAST);


--
-- Name: idx_discovered_feedback_customer_profile; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_customer_profile ON public.discovered_feedback USING btree (customer_profile_id);


--
-- Name: idx_discovered_feedback_customer_segment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_customer_segment ON public.discovered_feedback USING btree (customer_segment);


--
-- Name: idx_discovered_feedback_discovered_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_discovered_at ON public.discovered_feedback USING btree (discovered_at DESC);


--
-- Name: idx_discovered_feedback_is_duplicate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_is_duplicate ON public.discovered_feedback USING btree (is_duplicate);


--
-- Name: idx_discovered_feedback_platform; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_platform ON public.discovered_feedback USING btree (platform);


--
-- Name: idx_discovered_feedback_processed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_processed ON public.discovered_feedback USING btree (processed_at);


--
-- Name: idx_discovered_feedback_processing_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_processing_status ON public.discovered_feedback USING btree (processing_status) WHERE (processing_status = 'pending'::text);


--
-- Name: idx_discovered_feedback_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_project_id ON public.discovered_feedback USING btree (project_id);


--
-- Name: idx_discovered_feedback_project_platform; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_project_platform ON public.discovered_feedback USING btree (project_id, platform);


--
-- Name: idx_discovered_feedback_sentiment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_sentiment ON public.discovered_feedback USING btree (sentiment_score);


--
-- Name: idx_discovered_feedback_theme_analyzed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_theme_analyzed ON public.discovered_feedback USING btree (theme_analyzed_at);


--
-- Name: idx_discovered_feedback_urgency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discovered_feedback_urgency ON public.discovered_feedback USING btree (urgency_score);


--
-- Name: idx_domain_verifications_domain; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_domain_verifications_domain ON public.domain_verifications USING btree (domain);


--
-- Name: idx_domain_verifications_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_domain_verifications_project_id ON public.domain_verifications USING btree (project_id);


--
-- Name: idx_domain_verifications_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_domain_verifications_status ON public.domain_verifications USING btree (status);


--
-- Name: idx_domain_verifications_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_domain_verifications_token ON public.domain_verifications USING btree (verification_token);


--
-- Name: idx_email_batches_to_email_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_batches_to_email_date ON public.email_batches USING btree (to_email, batch_date);


--
-- Name: idx_email_logs_email_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_email_type ON public.email_logs USING btree (email_type);


--
-- Name: idx_email_logs_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_post_id ON public.email_logs USING btree (post_id);


--
-- Name: idx_email_logs_resend_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_resend_id ON public.email_logs USING btree (resend_id);


--
-- Name: idx_email_logs_sent_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_sent_at ON public.email_logs USING btree (sent_at);


--
-- Name: idx_email_logs_to_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_to_email ON public.email_logs USING btree (to_email);


--
-- Name: idx_email_preferences_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_preferences_email ON public.email_preferences USING btree (email);


--
-- Name: idx_email_preferences_unsubscribe_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_preferences_unsubscribe_token ON public.email_preferences USING btree (unsubscribe_token);


--
-- Name: idx_email_preferences_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_preferences_user_id ON public.email_preferences USING btree (user_id);


--
-- Name: idx_email_queue_processing; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_queue_processing ON public.email_queue USING btree (status, scheduled_at);


--
-- Name: idx_email_queue_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_queue_project ON public.email_queue USING btree (project_id);


--
-- Name: idx_email_queue_scheduled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_queue_scheduled ON public.email_queue USING btree (scheduled_at);


--
-- Name: idx_email_queue_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_queue_status ON public.email_queue USING btree (status);


--
-- Name: idx_events_aggregate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_aggregate ON public.events USING btree (aggregate_type, aggregate_id);


--
-- Name: idx_events_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_created_at ON public.events USING btree (created_at DESC);


--
-- Name: idx_events_project_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_project_type ON public.events USING btree (((metadata ->> 'project_id'::text)), type, created_at DESC);


--
-- Name: idx_events_project_unprocessed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_project_unprocessed ON public.events USING btree (((metadata ->> 'project_id'::text)), processed, created_at) WHERE (processed = false);


--
-- Name: idx_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_type ON public.events USING btree (type);


--
-- Name: idx_events_unprocessed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_unprocessed ON public.events USING btree (processed, created_at) WHERE (processed = false);


--
-- Name: idx_executive_briefs_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_executive_briefs_period ON public.executive_briefs USING btree (project_id, period_start, period_end);


--
-- Name: idx_executive_briefs_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_executive_briefs_project ON public.executive_briefs USING btree (project_id);


--
-- Name: idx_executive_briefs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_executive_briefs_status ON public.executive_briefs USING btree (project_id, status);


--
-- Name: idx_executive_briefs_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_executive_briefs_type ON public.executive_briefs USING btree (project_id, brief_type);


--
-- Name: idx_experiment_embeddings_experiment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_embeddings_experiment_id ON public.experiment_embeddings USING btree (experiment_id);


--
-- Name: idx_experiment_embeddings_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_embeddings_type ON public.experiment_embeddings USING btree (content_type);


--
-- Name: idx_experiment_embeddings_vector; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_embeddings_vector ON public.experiment_embeddings USING hnsw (embedding public.vector_cosine_ops);


--
-- Name: idx_experiment_learnings_experiment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_learnings_experiment_id ON public.experiment_learnings USING btree (experiment_id);


--
-- Name: idx_experiment_learnings_impact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_learnings_impact ON public.experiment_learnings USING btree (impact_score DESC);


--
-- Name: idx_experiment_learnings_tags; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_learnings_tags ON public.experiment_learnings USING gin (tags);


--
-- Name: idx_experiment_learnings_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_learnings_type ON public.experiment_learnings USING btree (learning_type);


--
-- Name: idx_experiment_results_experiment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_results_experiment_id ON public.experiment_results USING btree (experiment_id);


--
-- Name: idx_experiment_results_measured_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_results_measured_at ON public.experiment_results USING btree (measured_at DESC);


--
-- Name: idx_experiment_results_metric; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_results_metric ON public.experiment_results USING btree (metric_name);


--
-- Name: idx_experiment_results_significance; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_results_significance ON public.experiment_results USING btree (statistical_significance);


--
-- Name: idx_experiment_results_variant; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_results_variant ON public.experiment_results USING btree (variant);


--
-- Name: idx_experiment_snapshots_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_snapshots_created_at ON public.experiment_snapshots USING btree (created_at DESC);


--
-- Name: idx_experiment_snapshots_experiment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_snapshots_experiment_id ON public.experiment_snapshots USING btree (experiment_id);


--
-- Name: idx_experiment_sync_log_experiment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_sync_log_experiment_id ON public.experiment_sync_log USING btree (experiment_id);


--
-- Name: idx_experiment_sync_log_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_sync_log_status ON public.experiment_sync_log USING btree (status);


--
-- Name: idx_experiment_sync_log_synced_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiment_sync_log_synced_at ON public.experiment_sync_log USING btree (synced_at DESC);


--
-- Name: idx_experiments_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_created_at ON public.experiments USING btree (created_at DESC);


--
-- Name: idx_experiments_feature_flag; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_feature_flag ON public.experiments USING btree (feature_flag_key);


--
-- Name: idx_experiments_last_synced; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_last_synced ON public.experiments USING btree (last_synced_at DESC NULLS LAST);


--
-- Name: idx_experiments_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_project_id ON public.experiments USING btree (project_id);


--
-- Name: idx_experiments_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_status ON public.experiments USING btree (status);


--
-- Name: idx_experiments_sync_enabled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_sync_enabled ON public.experiments USING btree (sync_enabled) WHERE (sync_enabled = true);


--
-- Name: idx_experiments_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_experiments_type ON public.experiments USING btree (experiment_type);


--
-- Name: idx_feature_gaps_first_detected; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_gaps_first_detected ON public.feature_gaps USING btree (first_detected_at DESC);


--
-- Name: idx_feature_gaps_mention_count; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_gaps_mention_count ON public.feature_gaps USING btree (mention_count DESC);


--
-- Name: idx_feature_gaps_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_gaps_priority ON public.feature_gaps USING btree (priority);


--
-- Name: idx_feature_gaps_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_gaps_project_id ON public.feature_gaps USING btree (project_id);


--
-- Name: idx_feature_gaps_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_gaps_status ON public.feature_gaps USING btree (status);


--
-- Name: idx_feature_gaps_urgency_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_gaps_urgency_score ON public.feature_gaps USING btree (urgency_score DESC);


--
-- Name: idx_feature_impact_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_impact_category ON public.feature_impact_history USING btree (feature_category);


--
-- Name: idx_feature_impact_launched_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_impact_launched_at ON public.feature_impact_history USING btree (launched_at DESC);


--
-- Name: idx_feature_impact_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_impact_project ON public.feature_impact_history USING btree (project_id);


--
-- Name: idx_feature_impact_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_impact_success ON public.feature_impact_history USING btree (success_rating DESC) WHERE (success_rating IS NOT NULL);


--
-- Name: idx_feature_impact_suggestion; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_impact_suggestion ON public.feature_impact_history USING btree (suggestion_id);


--
-- Name: idx_feature_outcomes_active_monitors; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_active_monitors ON public.feature_outcomes USING btree (status, monitor_end) WHERE (status = 'monitoring'::text);


--
-- Name: idx_feature_outcomes_classification; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_classification ON public.feature_outcomes USING btree (outcome_classification);


--
-- Name: idx_feature_outcomes_monitor_end; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_monitor_end ON public.feature_outcomes USING btree (monitor_end);


--
-- Name: idx_feature_outcomes_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_project ON public.feature_outcomes USING btree (project_id);


--
-- Name: idx_feature_outcomes_project_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_project_status ON public.feature_outcomes USING btree (project_id, status);


--
-- Name: idx_feature_outcomes_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_status ON public.feature_outcomes USING btree (status);


--
-- Name: idx_feature_outcomes_suggestion; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_outcomes_suggestion ON public.feature_outcomes USING btree (suggestion_id);


--
-- Name: idx_feature_predictions_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_predictions_created ON public.feature_predictions USING btree (created_at DESC);


--
-- Name: idx_feature_predictions_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_predictions_project ON public.feature_predictions USING btree (project_id);


--
-- Name: idx_feature_predictions_spec; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_predictions_spec ON public.feature_predictions USING btree (spec_id);


--
-- Name: idx_feature_predictions_strategy; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_predictions_strategy ON public.feature_predictions USING btree (prediction_strategy);


--
-- Name: idx_feedback_integrations_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_integrations_active ON public.feedback_integrations USING btree (project_id, is_active);


--
-- Name: idx_feedback_integrations_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_integrations_project ON public.feedback_integrations USING btree (project_id);


--
-- Name: idx_feedback_integrations_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_integrations_type ON public.feedback_integrations USING btree (integration_type);


--
-- Name: idx_feedback_merges_merged; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_merges_merged ON public.feedback_merges USING btree (merged_post_id);


--
-- Name: idx_feedback_merges_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_merges_primary ON public.feedback_merges USING btree (primary_post_id);


--
-- Name: idx_feedback_merges_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_merges_project ON public.feedback_merges USING btree (project_id, merged_at DESC);


--
-- Name: idx_feedback_metadata_admin_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_admin_id ON public.feedback_metadata USING btree (submitted_by_admin_id);


--
-- Name: idx_feedback_metadata_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_created_at ON public.feedback_metadata USING btree (created_at);


--
-- Name: idx_feedback_metadata_customer_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_customer_company ON public.feedback_metadata USING btree (customer_company);


--
-- Name: idx_feedback_metadata_customer_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_customer_email ON public.feedback_metadata USING btree (customer_email);


--
-- Name: idx_feedback_metadata_feedback_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_feedback_source ON public.feedback_metadata USING btree (feedback_source);


--
-- Name: idx_feedback_metadata_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_post_id ON public.feedback_metadata USING btree (post_id);


--
-- Name: idx_feedback_metadata_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_priority ON public.feedback_metadata USING btree (priority);


--
-- Name: idx_feedback_metadata_verification_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_metadata_verification_token ON public.feedback_metadata USING btree (verification_token);


--
-- Name: idx_feedback_themes_confidence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_themes_confidence ON public.feedback_themes USING btree (confidence DESC);


--
-- Name: idx_feedback_themes_feedback_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_themes_feedback_id ON public.feedback_themes USING btree (feedback_id);


--
-- Name: idx_feedback_themes_theme_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_themes_theme_id ON public.feedback_themes USING btree (theme_id);


--
-- Name: idx_feedback_webhooks_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_webhooks_active ON public.feedback_webhooks USING btree (is_active);


--
-- Name: idx_feedback_webhooks_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feedback_webhooks_project ON public.feedback_webhooks USING btree (project_id);


--
-- Name: idx_gift_subscriptions_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gift_subscriptions_expires ON public.gift_subscriptions USING btree (expires_at);


--
-- Name: idx_gift_subscriptions_gifter; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gift_subscriptions_gifter ON public.gift_subscriptions USING btree (gifter_id);


--
-- Name: idx_gift_subscriptions_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gift_subscriptions_project ON public.gift_subscriptions USING btree (project_id);


--
-- Name: idx_gift_subscriptions_recipient; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gift_subscriptions_recipient ON public.gift_subscriptions USING btree (recipient_email);


--
-- Name: idx_gift_subscriptions_redemption_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gift_subscriptions_redemption_code ON public.gift_subscriptions USING btree (redemption_code);


--
-- Name: idx_gift_subscriptions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gift_subscriptions_status ON public.gift_subscriptions USING btree (status);


--
-- Name: idx_health_history_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_history_customer ON public.customer_health_history USING btree (customer_health_id);


--
-- Name: idx_health_history_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_history_project ON public.customer_health_history USING btree (project_id);


--
-- Name: idx_health_history_recorded; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_history_recorded ON public.customer_health_history USING btree (recorded_at DESC);


--
-- Name: idx_health_scores_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_scores_created_at ON public.health_scores USING btree (created_at DESC);


--
-- Name: idx_health_scores_session_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_scores_session_id ON public.health_scores USING btree (session_id) WHERE (session_id IS NOT NULL);


--
-- Name: idx_health_scores_share_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_scores_share_token ON public.health_scores USING btree (share_token) WHERE (share_token IS NOT NULL);


--
-- Name: idx_hunter_configs_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_configs_is_active ON public.hunter_configs USING btree (is_active);


--
-- Name: idx_hunter_configs_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_configs_project_id ON public.hunter_configs USING btree (project_id);


--
-- Name: idx_hunter_jobs_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_jobs_pending ON public.hunter_jobs USING btree (job_type, created_at) WHERE (status = 'pending'::text);


--
-- Name: idx_hunter_jobs_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_jobs_priority ON public.hunter_jobs USING btree (status, priority DESC, created_at);


--
-- Name: idx_hunter_jobs_scan; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_jobs_scan ON public.hunter_jobs USING btree (scan_id);


--
-- Name: idx_hunter_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_logs_created_at ON public.hunter_logs USING btree (created_at DESC);


--
-- Name: idx_hunter_logs_platform; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_logs_platform ON public.hunter_logs USING btree (platform);


--
-- Name: idx_hunter_logs_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_logs_project_id ON public.hunter_logs USING btree (project_id);


--
-- Name: idx_hunter_logs_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_logs_success ON public.hunter_logs USING btree (success);


--
-- Name: idx_hunter_raw_items_dedup; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_hunter_raw_items_dedup ON public.hunter_raw_items USING btree (scan_id, platform, external_id) WHERE (external_id IS NOT NULL);


--
-- Name: idx_hunter_raw_items_scan_stage; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_raw_items_scan_stage ON public.hunter_raw_items USING btree (scan_id, stage);


--
-- Name: idx_hunter_scans_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hunter_scans_project ON public.hunter_scans USING btree (project_id, status);


--
-- Name: idx_insight_reports_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_insight_reports_period ON public.insight_reports USING btree (report_period_end DESC);


--
-- Name: idx_insight_reports_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_insight_reports_project ON public.insight_reports USING btree (project_id);


--
-- Name: idx_insight_reports_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_insight_reports_type ON public.insight_reports USING btree (report_type);


--
-- Name: idx_insight_reports_unread; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_insight_reports_unread ON public.insight_reports USING btree (is_read) WHERE (is_read = false);


--
-- Name: idx_integration_credentials_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integration_credentials_active ON public.integration_credentials USING btree (is_active);


--
-- Name: idx_integration_credentials_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integration_credentials_project_id ON public.integration_credentials USING btree (project_id);


--
-- Name: idx_integration_credentials_provider; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integration_credentials_provider ON public.integration_credentials USING btree (provider);


--
-- Name: idx_jira_connections_cloud_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_connections_cloud_id ON public.jira_connections USING btree (cloud_id);


--
-- Name: idx_jira_connections_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_connections_project_id ON public.jira_connections USING btree (project_id);


--
-- Name: idx_jira_connections_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_connections_status ON public.jira_connections USING btree (status);


--
-- Name: idx_jira_connections_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_connections_user_id ON public.jira_connections USING btree (user_id);


--
-- Name: idx_jira_issue_links_connection_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_connection_id ON public.jira_issue_links USING btree (jira_connection_id);


--
-- Name: idx_jira_issue_links_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_created_at ON public.jira_issue_links USING btree (created_at DESC);


--
-- Name: idx_jira_issue_links_feedback_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_feedback_id ON public.jira_issue_links USING btree (feedback_id);


--
-- Name: idx_jira_issue_links_issue_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_issue_key ON public.jira_issue_links USING btree (issue_key);


--
-- Name: idx_jira_issue_links_project_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_project_key ON public.jira_issue_links USING btree (project_key);


--
-- Name: idx_jira_issue_links_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_status ON public.jira_issue_links USING btree (status);


--
-- Name: idx_jira_issue_links_sync_enabled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_issue_links_sync_enabled ON public.jira_issue_links USING btree (sync_enabled) WHERE (sync_enabled = true);


--
-- Name: idx_jira_label_mappings_auto_apply; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_label_mappings_auto_apply ON public.jira_label_mappings USING btree (auto_apply) WHERE (auto_apply = true);


--
-- Name: idx_jira_label_mappings_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_label_mappings_project_id ON public.jira_label_mappings USING btree (project_id);


--
-- Name: idx_jira_label_mappings_theme_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_label_mappings_theme_id ON public.jira_label_mappings USING btree (theme_id);


--
-- Name: idx_jira_oauth_states_expires_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_oauth_states_expires_at ON public.jira_oauth_states USING btree (expires_at);


--
-- Name: idx_jira_oauth_states_state_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_oauth_states_state_token ON public.jira_oauth_states USING btree (state_token);


--
-- Name: idx_jira_oauth_states_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_oauth_states_user_id ON public.jira_oauth_states USING btree (user_id);


--
-- Name: idx_jira_sync_logs_action; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_sync_logs_action ON public.jira_sync_logs USING btree (action);


--
-- Name: idx_jira_sync_logs_connection_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_sync_logs_connection_id ON public.jira_sync_logs USING btree (jira_connection_id);


--
-- Name: idx_jira_sync_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_sync_logs_created_at ON public.jira_sync_logs USING btree (created_at DESC);


--
-- Name: idx_jira_sync_logs_issue_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_sync_logs_issue_key ON public.jira_sync_logs USING btree (jira_issue_key);


--
-- Name: idx_jira_sync_logs_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_sync_logs_success ON public.jira_sync_logs USING btree (success);


--
-- Name: idx_jira_sync_logs_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_sync_logs_user_id ON public.jira_sync_logs USING btree (user_id);


--
-- Name: idx_jira_webhooks_connection_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_webhooks_connection_id ON public.jira_webhooks USING btree (jira_connection_id);


--
-- Name: idx_jira_webhooks_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_webhooks_status ON public.jira_webhooks USING btree (status);


--
-- Name: idx_jira_webhooks_webhook_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jira_webhooks_webhook_id ON public.jira_webhooks USING btree (webhook_id);


--
-- Name: idx_job_postings_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_postings_active ON public.competitor_job_postings USING btree (is_active);


--
-- Name: idx_job_postings_competitor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_postings_competitor ON public.competitor_job_postings USING btree (competitor_name);


--
-- Name: idx_job_postings_department; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_postings_department ON public.competitor_job_postings USING btree (department);


--
-- Name: idx_job_postings_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_postings_project ON public.competitor_job_postings USING btree (project_id);


--
-- Name: idx_launch_boards_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_boards_project ON public.launch_boards USING btree (project_id);


--
-- Name: idx_launch_boards_share_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_boards_share_token ON public.launch_boards USING btree (share_token) WHERE (share_token IS NOT NULL);


--
-- Name: idx_launch_boards_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_boards_status ON public.launch_boards USING btree (status);


--
-- Name: idx_launch_checklist_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_checklist_board ON public.launch_checklist_items USING btree (board_id);


--
-- Name: idx_launch_dimensions_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_dimensions_board ON public.launch_dimensions USING btree (board_id);


--
-- Name: idx_launch_risks_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_risks_board ON public.launch_risks USING btree (board_id);


--
-- Name: idx_launch_votes_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_launch_votes_board ON public.launch_votes USING btree (board_id);


--
-- Name: idx_linear_connections_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_linear_connections_org ON public.linear_connections USING btree (organization_id);


--
-- Name: idx_linear_connections_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_linear_connections_project ON public.linear_connections USING btree (project_id);


--
-- Name: idx_linear_connections_project_org; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_linear_connections_project_org ON public.linear_connections USING btree (project_id, organization_id);


--
-- Name: idx_lovable_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lovable_created ON public.lovable_generations USING btree (created_at DESC);


--
-- Name: idx_lovable_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lovable_project ON public.lovable_generations USING btree (project_id);


--
-- Name: idx_lovable_spec; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lovable_spec ON public.lovable_generations USING btree (spec_id);


--
-- Name: idx_members_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_members_project ON public.members USING btree (project_id);


--
-- Name: idx_members_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_members_user ON public.members USING btree (user_id);


--
-- Name: idx_monitoring_config_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_monitoring_config_active ON public.competitor_monitoring_config USING btree (is_active);


--
-- Name: idx_monitoring_config_next_check; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_monitoring_config_next_check ON public.competitor_monitoring_config USING btree (next_check_at);


--
-- Name: idx_monitoring_config_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_monitoring_config_project ON public.competitor_monitoring_config USING btree (project_id);


--
-- Name: idx_notification_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notification_logs_created_at ON public.notification_logs USING btree (created_at);


--
-- Name: idx_notification_logs_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notification_logs_project_id ON public.notification_logs USING btree (project_id);


--
-- Name: idx_platform_integrations_next_scan; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_platform_integrations_next_scan ON public.platform_integrations USING btree (next_scan_at) WHERE (status = 'active'::public.integration_status);


--
-- Name: idx_platform_integrations_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_platform_integrations_project_id ON public.platform_integrations USING btree (project_id);


--
-- Name: idx_platform_integrations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_platform_integrations_status ON public.platform_integrations USING btree (status);


--
-- Name: idx_pm_assignments_enabled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pm_assignments_enabled ON public.pm_assignments USING btree (project_id, auto_assign_enabled) WHERE (auto_assign_enabled = true);


--
-- Name: idx_pm_assignments_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pm_assignments_project ON public.pm_assignments USING btree (project_id);


--
-- Name: idx_poll_options_order; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_options_order ON public.poll_options USING btree (poll_id, display_order);


--
-- Name: idx_poll_options_poll; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_options_poll ON public.poll_options USING btree (poll_id);


--
-- Name: idx_poll_votes_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_votes_customer ON public.poll_votes USING btree (customer_id) WHERE (customer_id IS NOT NULL);


--
-- Name: idx_poll_votes_option; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_votes_option ON public.poll_votes USING btree (option_id);


--
-- Name: idx_poll_votes_poll; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_votes_poll ON public.poll_votes USING btree (poll_id);


--
-- Name: idx_poll_votes_segment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_votes_segment ON public.poll_votes USING btree (poll_id, customer_segment);


--
-- Name: idx_poll_votes_voter; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_poll_votes_voter ON public.poll_votes USING btree (voter_id) WHERE (voter_id IS NOT NULL);


--
-- Name: idx_polls_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_polls_created ON public.polls USING btree (project_id, created_at DESC);


--
-- Name: idx_polls_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_polls_project ON public.polls USING btree (project_id);


--
-- Name: idx_polls_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_polls_status ON public.polls USING btree (project_id, status);


--
-- Name: idx_polls_theme; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_polls_theme ON public.polls USING btree (related_theme_id) WHERE (related_theme_id IS NOT NULL);


--
-- Name: idx_post_similarities_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_post_similarities_post_id ON public.post_similarities USING btree (post_id);


--
-- Name: idx_post_similarities_similar_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_post_similarities_similar_post_id ON public.post_similarities USING btree (similar_post_id);


--
-- Name: idx_post_similarities_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_post_similarities_status ON public.post_similarities USING btree (status);


--
-- Name: idx_posts_ai_analyzed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_ai_analyzed_at ON public.posts USING btree (ai_analyzed_at);


--
-- Name: idx_posts_ai_categorized; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_ai_categorized ON public.posts USING btree (ai_categorized);


--
-- Name: idx_posts_ai_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_ai_category ON public.posts USING btree (ai_category);


--
-- Name: idx_posts_assigned_pm; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_assigned_pm ON public.posts USING btree (assigned_pm_id) WHERE (assigned_pm_id IS NOT NULL);


--
-- Name: idx_posts_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_board ON public.posts USING btree (board_id);


--
-- Name: idx_posts_call_metadata; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_call_metadata ON public.posts USING gin (call_metadata);


--
-- Name: idx_posts_call_record_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_call_record_id ON public.posts USING btree (call_record_id);


--
-- Name: idx_posts_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_category ON public.posts USING btree (category);


--
-- Name: idx_posts_competitor_mentioned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_competitor_mentioned ON public.posts USING btree (competitor_mentioned) WHERE (competitor_mentioned IS NOT NULL);


--
-- Name: idx_posts_completion_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_completion_date ON public.posts USING btree (completion_date);


--
-- Name: idx_posts_content_gin; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_content_gin ON public.posts USING gin (to_tsvector('english'::regconfig, content));


--
-- Name: idx_posts_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_created ON public.posts USING btree (created_at DESC);


--
-- Name: idx_posts_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_created_at ON public.posts USING btree (created_at DESC) WHERE ((status)::text = 'open'::text);


--
-- Name: idx_posts_effort_estimate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_effort_estimate ON public.posts USING btree (effort_estimate);


--
-- Name: idx_posts_important_votes; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_important_votes ON public.posts USING btree (important_votes);


--
-- Name: idx_posts_last_updated; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_last_updated ON public.posts USING btree (last_updated);


--
-- Name: idx_posts_must_have_votes; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_must_have_votes ON public.posts USING btree (must_have_votes);


--
-- Name: idx_posts_nice_to_have_votes; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_nice_to_have_votes ON public.posts USING btree (nice_to_have_votes);


--
-- Name: idx_posts_objection_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_objection_type ON public.posts USING btree (objection_type) WHERE (objection_type IS NOT NULL);


--
-- Name: idx_posts_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_priority ON public.posts USING btree (priority);


--
-- Name: idx_posts_priority_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_priority_score ON public.posts USING btree (priority_score);


--
-- Name: idx_posts_progress_percentage; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_progress_percentage ON public.posts USING btree (progress_percentage);


--
-- Name: idx_posts_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project ON public.posts USING btree (project_id);


--
-- Name: idx_posts_project_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_category ON public.posts USING btree (project_id, category);


--
-- Name: INDEX idx_posts_project_category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_posts_project_category IS 'Optimizes theme-based queries';


--
-- Name: idx_posts_project_category_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_category_status ON public.posts USING btree (project_id, category, status) WHERE ((status)::text = 'open'::text);


--
-- Name: idx_posts_project_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_created ON public.posts USING btree (project_id, created_at DESC);


--
-- Name: INDEX idx_posts_project_created; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_posts_project_created IS 'Optimizes queries for recent posts by project';


--
-- Name: idx_posts_project_id_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_id_created_at ON public.posts USING btree (project_id, created_at DESC);


--
-- Name: idx_posts_project_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_status ON public.posts USING btree (project_id, status);


--
-- Name: idx_posts_project_status_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_status_created ON public.posts USING btree (project_id, status, created_at DESC);


--
-- Name: idx_posts_project_status_votes; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_project_status_votes ON public.posts USING btree (project_id, status, vote_count DESC);


--
-- Name: idx_posts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_status ON public.posts USING btree (status);


--
-- Name: idx_posts_total_priority_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_total_priority_score ON public.posts USING btree (total_priority_score);


--
-- Name: idx_posts_vote_count; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_posts_vote_count ON public.posts USING btree (vote_count DESC) WHERE ((status)::text = 'open'::text);


--
-- Name: idx_prd_risk_alerts_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prd_risk_alerts_created ON public.prd_risk_alerts USING btree (created_at DESC);


--
-- Name: idx_prd_risk_alerts_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prd_risk_alerts_project ON public.prd_risk_alerts USING btree (project_id);


--
-- Name: idx_prd_risk_alerts_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prd_risk_alerts_severity ON public.prd_risk_alerts USING btree (severity);


--
-- Name: idx_prd_risk_alerts_spec; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prd_risk_alerts_spec ON public.prd_risk_alerts USING btree (spec_id);


--
-- Name: idx_prd_risk_alerts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prd_risk_alerts_status ON public.prd_risk_alerts USING btree (status);


--
-- Name: idx_prd_risk_alerts_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_prd_risk_alerts_type ON public.prd_risk_alerts USING btree (risk_type);


--
-- Name: idx_pre_mortem_feature; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pre_mortem_feature ON public.pre_mortem_analyses USING btree (feature_id);


--
-- Name: idx_pre_mortem_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pre_mortem_project ON public.pre_mortem_analyses USING btree (project_id);


--
-- Name: idx_pre_mortem_risk_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pre_mortem_risk_level ON public.pre_mortem_analyses USING btree (overall_risk_level);


--
-- Name: idx_priority_history_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_priority_history_created_at ON public.roadmap_priority_history USING btree (created_at DESC);


--
-- Name: idx_priority_history_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_priority_history_project ON public.roadmap_priority_history USING btree (project_id);


--
-- Name: idx_priority_history_project_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_priority_history_project_created ON public.roadmap_priority_history USING btree (project_id, created_at DESC);


--
-- Name: idx_priority_history_suggestion; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_priority_history_suggestion ON public.roadmap_priority_history USING btree (suggestion_id);


--
-- Name: idx_priority_history_triggers; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_priority_history_triggers ON public.roadmap_priority_history USING gin (triggers);


--
-- Name: idx_proactive_suggestions_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_proactive_suggestions_priority ON public.ask_proactive_suggestions USING btree (priority, created_at DESC);


--
-- Name: idx_proactive_suggestions_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_proactive_suggestions_project ON public.ask_proactive_suggestions USING btree (project_id);


--
-- Name: idx_proactive_suggestions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_proactive_suggestions_status ON public.ask_proactive_suggestions USING btree (status) WHERE (status = 'active'::text);


--
-- Name: idx_project_notification_recipients_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_project_notification_recipients_email ON public.project_notification_recipients USING btree (email);


--
-- Name: idx_project_notification_recipients_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_project_notification_recipients_project_id ON public.project_notification_recipients USING btree (project_id);


--
-- Name: idx_projects_cancellation_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_cancellation_email ON public.projects USING btree (cancellation_email_sent_at) WHERE (cancellation_email_sent_at IS NOT NULL);


--
-- Name: idx_projects_current_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_current_period ON public.projects USING btree (current_period_end);


--
-- Name: idx_projects_custom_domain; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_custom_domain ON public.projects USING btree (custom_domain) WHERE (custom_domain IS NOT NULL);


--
-- Name: idx_projects_domain_verified; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_domain_verified ON public.projects USING btree (domain_verified) WHERE (domain_verified = true);


--
-- Name: idx_projects_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_owner ON public.projects USING btree (owner_id);


--
-- Name: idx_projects_owner_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_owner_id ON public.projects USING btree (owner_id);


--
-- Name: idx_projects_pro_welcome_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_pro_welcome_email ON public.projects USING btree (pro_welcome_email_sent_at) WHERE (pro_welcome_email_sent_at IS NOT NULL);


--
-- Name: idx_projects_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_slug ON public.projects USING btree (slug);


--
-- Name: idx_projects_stripe_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_stripe_customer ON public.projects USING btree (stripe_customer_id);


--
-- Name: idx_projects_subscription_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_subscription_status ON public.projects USING btree (subscription_status);


--
-- Name: idx_projects_trial_end_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_trial_end_date ON public.projects USING btree (trial_end_date) WHERE (trial_end_date IS NOT NULL);


--
-- Name: idx_projects_trial_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_projects_trial_status ON public.projects USING btree (trial_status);


--
-- Name: idx_push_subscriptions_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_push_subscriptions_project_id ON public.push_subscriptions USING btree (project_id);


--
-- Name: idx_push_subscriptions_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_push_subscriptions_user_id ON public.push_subscriptions USING btree (user_id);


--
-- Name: idx_query_analytics_project_role; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_query_analytics_project_role ON public.stakeholder_query_analytics USING btree (project_id, user_role);


--
-- Name: idx_rate_limit_ip; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_limit_ip ON public.rate_limit_violations USING btree (ip_address, created_at);


--
-- Name: idx_rate_limit_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_limit_project ON public.rate_limit_violations USING btree (project_id);


--
-- Name: idx_reasoning_traces_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_created ON public.reasoning_traces USING btree (created_at DESC);


--
-- Name: idx_reasoning_traces_decision_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_decision_type ON public.reasoning_traces USING btree (decision_type);


--
-- Name: idx_reasoning_traces_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_entity ON public.reasoning_traces USING btree (entity_type, entity_id);


--
-- Name: idx_reasoning_traces_feature; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_feature ON public.reasoning_traces USING btree (feature);


--
-- Name: idx_reasoning_traces_inputs_gin; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_inputs_gin ON public.reasoning_traces USING gin (inputs);


--
-- Name: idx_reasoning_traces_outputs_gin; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_outputs_gin ON public.reasoning_traces USING gin (outputs);


--
-- Name: idx_reasoning_traces_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_project ON public.reasoning_traces USING btree (project_id);


--
-- Name: idx_reasoning_traces_project_feature; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reasoning_traces_project_feature ON public.reasoning_traces USING btree (project_id, feature, created_at DESC);


--
-- Name: idx_report_executions_scheduled_report; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_report_executions_scheduled_report ON public.report_executions USING btree (scheduled_report_id, created_at DESC);


--
-- Name: idx_report_executions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_report_executions_status ON public.report_executions USING btree (status, created_at DESC);


--
-- Name: idx_retro_actions_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_actions_board ON public.retro_actions USING btree (board_id);


--
-- Name: idx_retro_boards_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_boards_period ON public.retro_boards USING btree (period_type);


--
-- Name: idx_retro_boards_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_boards_project ON public.retro_boards USING btree (project_id);


--
-- Name: idx_retro_boards_share_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_boards_share_token ON public.retro_boards USING btree (share_token) WHERE (share_token IS NOT NULL);


--
-- Name: idx_retro_card_comments_card_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_card_comments_card_id ON public.retro_card_comments USING btree (card_id);


--
-- Name: idx_retro_card_votes_card; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_card_votes_card ON public.retro_card_votes USING btree (card_id);


--
-- Name: idx_retro_cards_column; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_cards_column ON public.retro_cards USING btree (column_id);


--
-- Name: idx_retro_columns_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retro_columns_board ON public.retro_columns USING btree (board_id);


--
-- Name: idx_roadmap_exports_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_exports_created_at ON public.roadmap_exports USING btree (created_at DESC);


--
-- Name: idx_roadmap_exports_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_exports_project_id ON public.roadmap_exports USING btree (project_id);


--
-- Name: idx_roadmap_exports_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_exports_user_id ON public.roadmap_exports USING btree (user_id);


--
-- Name: idx_roadmap_feedback_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_feedback_created ON public.roadmap_feedback USING btree (created_at DESC);


--
-- Name: idx_roadmap_feedback_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_feedback_post ON public.roadmap_feedback USING btree (post_id);


--
-- Name: idx_roadmap_generation_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_generation_logs_created_at ON public.roadmap_generation_logs USING btree (created_at DESC);


--
-- Name: idx_roadmap_generation_logs_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_generation_logs_project_id ON public.roadmap_generation_logs USING btree (project_id);


--
-- Name: idx_roadmap_generation_logs_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_generation_logs_success ON public.roadmap_generation_logs USING btree (success);


--
-- Name: idx_roadmap_subscriptions_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_subscriptions_email ON public.roadmap_subscriptions USING btree (email);


--
-- Name: idx_roadmap_subscriptions_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_subscriptions_project ON public.roadmap_subscriptions USING btree (project_id);


--
-- Name: idx_roadmap_suggestions_pinned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_pinned ON public.roadmap_suggestions USING btree (pinned) WHERE (pinned = true);


--
-- Name: idx_roadmap_suggestions_priority_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_priority_level ON public.roadmap_suggestions USING btree (priority_level);


--
-- Name: idx_roadmap_suggestions_priority_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_priority_score ON public.roadmap_suggestions USING btree (priority_score DESC);


--
-- Name: idx_roadmap_suggestions_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_project_id ON public.roadmap_suggestions USING btree (project_id);


--
-- Name: idx_roadmap_suggestions_project_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_project_priority ON public.roadmap_suggestions USING btree (project_id, priority_score DESC);


--
-- Name: idx_roadmap_suggestions_project_status_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_project_status_priority ON public.roadmap_suggestions USING btree (project_id, status, priority_score DESC);


--
-- Name: idx_roadmap_suggestions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_status ON public.roadmap_suggestions USING btree (status);


--
-- Name: idx_roadmap_suggestions_theme_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roadmap_suggestions_theme_id ON public.roadmap_suggestions USING btree (theme_id);


--
-- Name: idx_roast_share; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roast_share ON public.roadmap_roast_sessions USING btree (share_token) WHERE (share_token IS NOT NULL);


--
-- Name: idx_scheduled_queries_next_run; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_queries_next_run ON public.ask_scheduled_queries USING btree (next_run_at) WHERE (is_active = true);


--
-- Name: idx_scheduled_queries_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_queries_project ON public.ask_scheduled_queries USING btree (project_id);


--
-- Name: idx_scheduled_queries_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_queries_user ON public.ask_scheduled_queries USING btree (user_id);


--
-- Name: idx_scheduled_reports_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_reports_active ON public.scheduled_reports USING btree (is_active, next_run_at);


--
-- Name: idx_scheduled_reports_next_run; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_reports_next_run ON public.scheduled_reports USING btree (next_run_at) WHERE (is_active = true);


--
-- Name: idx_scheduled_reports_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_reports_project ON public.scheduled_reports USING btree (project_id);


--
-- Name: idx_scheduled_reports_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scheduled_reports_user ON public.scheduled_reports USING btree (user_id);


--
-- Name: idx_scrape_cache_lookup; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_scrape_cache_lookup ON public.scrape_cache USING btree (product_name_normalized, source);


--
-- Name: idx_security_events_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_created_at ON public.security_events USING btree (created_at DESC);


--
-- Name: idx_security_events_ip; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_ip ON public.security_events USING btree (ip);


--
-- Name: idx_security_events_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_project_id ON public.security_events USING btree (project_id);


--
-- Name: idx_security_events_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_severity ON public.security_events USING btree (severity);


--
-- Name: idx_security_events_severity_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_severity_created_at ON public.security_events USING btree (severity, created_at DESC);


--
-- Name: idx_security_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_type ON public.security_events USING btree (type);


--
-- Name: idx_security_events_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_events_user_id ON public.security_events USING btree (user_id);


--
-- Name: idx_sentiment_analysis_analyzed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_analysis_analyzed_at ON public.sentiment_analysis USING btree (analyzed_at DESC);


--
-- Name: idx_sentiment_analysis_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_analysis_category ON public.sentiment_analysis USING btree (sentiment_category);


--
-- Name: idx_sentiment_analysis_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_analysis_post_id ON public.sentiment_analysis USING btree (post_id);


--
-- Name: idx_sentiment_forecasts_accuracy; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_forecasts_accuracy ON public.sentiment_forecasts USING btree (is_accurate) WHERE (is_accurate IS NOT NULL);


--
-- Name: idx_sentiment_forecasts_forecast_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_forecasts_forecast_date ON public.sentiment_forecasts USING btree (forecast_date DESC);


--
-- Name: idx_sentiment_forecasts_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_forecasts_project ON public.sentiment_forecasts USING btree (project_id);


--
-- Name: idx_sentiment_forecasts_target_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_forecasts_target_date ON public.sentiment_forecasts USING btree (target_date);


--
-- Name: idx_sentiment_history_project_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_history_project_date ON public.sentiment_history USING btree (project_id, date DESC);


--
-- Name: idx_sentiment_post_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_post_score ON public.sentiment_analysis USING btree (post_id, sentiment_score);


--
-- Name: INDEX idx_sentiment_post_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_sentiment_post_score IS 'Fast sentiment lookup for posts';


--
-- Name: idx_sentiment_score_range; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sentiment_score_range ON public.sentiment_analysis USING btree (sentiment_score) WHERE (sentiment_score IS NOT NULL);


--
-- Name: idx_signal_correlations_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_correlations_active ON public.signal_correlations USING btree (project_id, status) WHERE (status = 'active'::text);


--
-- Name: idx_signal_correlations_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_correlations_project ON public.signal_correlations USING btree (project_id, created_at DESC);


--
-- Name: idx_signal_correlations_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_correlations_score ON public.signal_correlations USING btree (correlation_score DESC, project_id) WHERE (status = 'active'::text);


--
-- Name: idx_signal_correlations_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_correlations_source ON public.signal_correlations USING btree (source_type, source_id);


--
-- Name: idx_signal_correlations_target; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_correlations_target ON public.signal_correlations USING btree (target_type, target_id);


--
-- Name: idx_signal_correlations_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_correlations_type ON public.signal_correlations USING btree (correlation_type, project_id);


--
-- Name: idx_signal_events_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_events_entity ON public.signal_events USING btree (entity_type, entity_id);


--
-- Name: idx_signal_events_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_events_project ON public.signal_events USING btree (project_id, detected_at DESC);


--
-- Name: idx_signal_events_time; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_events_time ON public.signal_events USING btree (detected_at DESC);


--
-- Name: idx_signal_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_signal_events_type ON public.signal_events USING btree (event_type, project_id);


--
-- Name: idx_slack_alert_rules_enabled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_alert_rules_enabled ON public.slack_alert_rules USING btree (enabled);


--
-- Name: idx_slack_alert_rules_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_alert_rules_project_id ON public.slack_alert_rules USING btree (project_id);


--
-- Name: idx_slack_channel_mappings_alert_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_channel_mappings_alert_type ON public.slack_channel_mappings USING btree (alert_type);


--
-- Name: idx_slack_channel_mappings_connection_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_channel_mappings_connection_id ON public.slack_channel_mappings USING btree (slack_connection_id);


--
-- Name: idx_slack_connections_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_connections_project_id ON public.slack_connections USING btree (project_id);


--
-- Name: idx_slack_connections_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_connections_status ON public.slack_connections USING btree (status);


--
-- Name: idx_slack_interaction_logs_connection_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_interaction_logs_connection_id ON public.slack_interaction_logs USING btree (slack_connection_id);


--
-- Name: idx_slack_interaction_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_interaction_logs_created_at ON public.slack_interaction_logs USING btree (created_at DESC);


--
-- Name: idx_slack_message_logs_connection_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_message_logs_connection_id ON public.slack_message_logs USING btree (slack_connection_id);


--
-- Name: idx_slack_message_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_message_logs_created_at ON public.slack_message_logs USING btree (created_at DESC);


--
-- Name: idx_slack_message_logs_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_slack_message_logs_entity ON public.slack_message_logs USING btree (entity_id, entity_type);


--
-- Name: idx_smart_replies_post_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_smart_replies_post_id ON public.smart_replies USING btree (post_id);


--
-- Name: idx_smart_replies_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_smart_replies_type ON public.smart_replies USING btree (reply_type);


--
-- Name: idx_smart_replies_used; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_smart_replies_used ON public.smart_replies USING btree (is_used);


--
-- Name: idx_specs_auto_generated; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_specs_auto_generated ON public.specs USING btree (auto_generated, project_id);


--
-- Name: idx_sprints_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sprints_project_id ON public.sprints USING btree (project_id);


--
-- Name: idx_sprints_sprint_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sprints_sprint_number ON public.sprints USING btree (sprint_number);


--
-- Name: idx_sprints_start_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sprints_start_date ON public.sprints USING btree (start_date DESC);


--
-- Name: idx_sprints_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sprints_status ON public.sprints USING btree (status);


--
-- Name: idx_stakeholder_interests_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_interests_id ON public.stakeholder_interests USING btree (interest_id);


--
-- Name: idx_stakeholder_interests_stakeholder_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_interests_stakeholder_id ON public.stakeholder_interests USING btree (stakeholder_id);


--
-- Name: idx_stakeholder_interests_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_interests_type ON public.stakeholder_interests USING btree (interest_type);


--
-- Name: idx_stakeholder_queries_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_created ON public.stakeholder_queries USING btree (created_at DESC);


--
-- Name: idx_stakeholder_queries_favorite; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_favorite ON public.stakeholder_queries USING btree (project_id, is_favorite) WHERE (is_favorite = true);


--
-- Name: idx_stakeholder_queries_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_project ON public.stakeholder_queries USING btree (project_id);


--
-- Name: idx_stakeholder_queries_project_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_project_created ON public.stakeholder_queries USING btree (project_id, created_at DESC);


--
-- Name: idx_stakeholder_queries_rated; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_rated ON public.stakeholder_queries USING btree (project_id, rating DESC) WHERE (rating >= 4);


--
-- Name: idx_stakeholder_queries_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_role ON public.stakeholder_queries USING btree (user_role);


--
-- Name: idx_stakeholder_queries_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_user ON public.stakeholder_queries USING btree (user_id);


--
-- Name: idx_stakeholder_queries_user_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_queries_user_created ON public.stakeholder_queries USING btree (user_id, created_at DESC);


--
-- Name: idx_stakeholder_reports_generated_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_reports_generated_at ON public.stakeholder_reports USING btree (generated_at DESC);


--
-- Name: idx_stakeholder_reports_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_reports_role ON public.stakeholder_reports USING btree (role);


--
-- Name: idx_stakeholder_reports_stakeholder_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_reports_stakeholder_id ON public.stakeholder_reports USING btree (stakeholder_id);


--
-- Name: idx_stakeholder_reports_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholder_reports_type ON public.stakeholder_reports USING btree (report_type);


--
-- Name: idx_stakeholders_access_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholders_access_token ON public.stakeholders USING btree (access_token);


--
-- Name: idx_stakeholders_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholders_email ON public.stakeholders USING btree (email);


--
-- Name: idx_stakeholders_project_email_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_stakeholders_project_email_unique ON public.stakeholders USING btree (project_id, email);


--
-- Name: idx_stakeholders_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholders_project_id ON public.stakeholders USING btree (project_id);


--
-- Name: idx_stakeholders_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stakeholders_role ON public.stakeholders USING btree (role);


--
-- Name: idx_story_feedback_links_feedback_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_feedback_links_feedback_id ON public.story_feedback_links USING btree (feedback_id);


--
-- Name: idx_story_feedback_links_story_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_feedback_links_story_id ON public.story_feedback_links USING btree (story_id);


--
-- Name: idx_story_generation_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_generation_logs_created_at ON public.story_generation_logs USING btree (created_at DESC);


--
-- Name: idx_story_generation_logs_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_generation_logs_project_id ON public.story_generation_logs USING btree (project_id);


--
-- Name: idx_story_generation_logs_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_generation_logs_success ON public.story_generation_logs USING btree (success);


--
-- Name: idx_story_generation_logs_theme_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_generation_logs_theme_id ON public.story_generation_logs USING btree (theme_id);


--
-- Name: idx_story_templates_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_templates_category ON public.story_templates USING btree (category);


--
-- Name: idx_story_templates_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_templates_project_id ON public.story_templates USING btree (project_id);


--
-- Name: idx_story_templates_usage_count; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_story_templates_usage_count ON public.story_templates USING btree (usage_count DESC);


--
-- Name: idx_strategic_recommendations_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategic_recommendations_created_at ON public.strategic_recommendations USING btree (created_at DESC);


--
-- Name: idx_strategic_recommendations_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategic_recommendations_priority ON public.strategic_recommendations USING btree (priority);


--
-- Name: idx_strategic_recommendations_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategic_recommendations_project_id ON public.strategic_recommendations USING btree (project_id);


--
-- Name: idx_strategic_recommendations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategic_recommendations_status ON public.strategic_recommendations USING btree (status);


--
-- Name: idx_strategic_recommendations_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategic_recommendations_type ON public.strategic_recommendations USING btree (recommendation_type);


--
-- Name: idx_strategy_shift_events_shift; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategy_shift_events_shift ON public.strategy_shift_events USING btree (shift_id);


--
-- Name: idx_strategy_shifts_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategy_shifts_created ON public.strategy_shifts USING btree (created_at DESC);


--
-- Name: idx_strategy_shifts_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategy_shifts_expires ON public.strategy_shifts USING btree (expires_at) WHERE (status = 'proposed'::text);


--
-- Name: idx_strategy_shifts_project_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_strategy_shifts_project_status ON public.strategy_shifts USING btree (project_id, status);


--
-- Name: idx_stripe_settings_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_stripe_settings_project ON public.stripe_settings USING btree (project_id);


--
-- Name: idx_survey_questions_order; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_survey_questions_order ON public.survey_questions USING btree (survey_id, display_order);


--
-- Name: idx_survey_questions_survey; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_survey_questions_survey ON public.survey_questions USING btree (survey_id);


--
-- Name: idx_survey_responses_complete; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_survey_responses_complete ON public.survey_responses USING btree (survey_id, is_complete);


--
-- Name: idx_survey_responses_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_survey_responses_customer ON public.survey_responses USING btree (customer_id) WHERE (customer_id IS NOT NULL);


--
-- Name: idx_survey_responses_survey; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_survey_responses_survey ON public.survey_responses USING btree (survey_id);


--
-- Name: idx_surveys_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_surveys_created ON public.surveys USING btree (project_id, created_at DESC);


--
-- Name: idx_surveys_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_surveys_project ON public.surveys USING btree (project_id);


--
-- Name: idx_surveys_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_surveys_status ON public.surveys USING btree (project_id, status);


--
-- Name: idx_sync_logs_integration; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sync_logs_integration ON public.inbox_sync_logs USING btree (integration_id);


--
-- Name: idx_sync_logs_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sync_logs_project ON public.inbox_sync_logs USING btree (project_id);


--
-- Name: idx_sync_logs_started; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sync_logs_started ON public.inbox_sync_logs USING btree (started_at DESC);


--
-- Name: idx_team_capacity_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_capacity_project ON public.team_capacity USING btree (project_id);


--
-- Name: idx_team_capacity_project_week; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_capacity_project_week ON public.team_capacity USING btree (project_id, week_start_date DESC);


--
-- Name: idx_team_capacity_week; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_capacity_week ON public.team_capacity USING btree (week_start_date DESC);


--
-- Name: idx_team_invitations_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_invitations_email ON public.team_invitations USING btree (email);


--
-- Name: idx_team_invitations_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_invitations_project ON public.team_invitations USING btree (project_id);


--
-- Name: idx_team_invitations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_invitations_status ON public.team_invitations USING btree (status);


--
-- Name: idx_team_invitations_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_invitations_token ON public.team_invitations USING btree (token);


--
-- Name: idx_team_velocity_board; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_velocity_board ON public.team_velocity USING btree (board_id, sprint_end_date DESC);


--
-- Name: idx_team_velocity_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_team_velocity_project ON public.team_velocity USING btree (project_id, sprint_end_date DESC);


--
-- Name: idx_theme_clusters_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_theme_clusters_created_at ON public.theme_clusters USING btree (created_at DESC);


--
-- Name: idx_theme_clusters_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_theme_clusters_project_id ON public.theme_clusters USING btree (project_id);


--
-- Name: idx_theme_sentiment_cache_frequency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_theme_sentiment_cache_frequency ON public.theme_sentiment_cache USING btree (project_id, frequency DESC);


--
-- Name: idx_theme_sentiment_cache_project_theme; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_theme_sentiment_cache_project_theme ON public.theme_sentiment_cache USING btree (project_id, theme_name);


--
-- Name: idx_themes_avg_sentiment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_avg_sentiment ON public.themes USING btree (avg_sentiment);


--
-- Name: idx_themes_cluster_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_cluster_id ON public.themes USING btree (cluster_id);


--
-- Name: idx_themes_first_seen; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_first_seen ON public.themes USING btree (first_seen DESC);


--
-- Name: idx_themes_frequency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_frequency ON public.themes USING btree (frequency DESC);


--
-- Name: idx_themes_is_emerging; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_is_emerging ON public.themes USING btree (is_emerging) WHERE (is_emerging = true);


--
-- Name: idx_themes_last_seen; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_last_seen ON public.themes USING btree (last_seen DESC);


--
-- Name: idx_themes_project_frequency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_project_frequency ON public.themes USING btree (project_id, frequency DESC);


--
-- Name: INDEX idx_themes_project_frequency; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_themes_project_frequency IS 'Optimizes theme ranking queries';


--
-- Name: idx_themes_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_project_id ON public.themes USING btree (project_id);


--
-- Name: idx_themes_project_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_project_name ON public.themes USING btree (project_id, theme_name);


--
-- Name: idx_themes_theme_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_themes_theme_name ON public.themes USING btree (theme_name);


--
-- Name: idx_timeline_events_project_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_events_project_date ON public.timeline_events USING btree (project_id, event_date DESC);


--
-- Name: idx_timeline_events_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_events_severity ON public.timeline_events USING btree (project_id, severity) WHERE (severity IS NOT NULL);


--
-- Name: idx_timeline_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_events_type ON public.timeline_events USING btree (project_id, event_type);


--
-- Name: idx_triage_queue_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_triage_queue_pending ON public.triage_queue USING btree (project_id, created_at DESC) WHERE (status = 'pending'::text);


--
-- Name: idx_triage_queue_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_triage_queue_post ON public.triage_queue USING btree (post_id);


--
-- Name: idx_triage_queue_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_triage_queue_status ON public.triage_queue USING btree (project_id, status, created_at DESC);


--
-- Name: idx_ufi_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_category ON public.unified_feedback_items USING btree (project_id, category);


--
-- Name: idx_ufi_content_hash; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_content_hash ON public.unified_feedback_items USING btree (project_id, content_hash);


--
-- Name: idx_ufi_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_customer ON public.unified_feedback_items USING btree (customer_id);


--
-- Name: idx_ufi_imported; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_imported ON public.unified_feedback_items USING btree (project_id, imported_at DESC);


--
-- Name: idx_ufi_original_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_original_created ON public.unified_feedback_items USING btree (project_id, original_created_at DESC);


--
-- Name: idx_ufi_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_project_id ON public.unified_feedback_items USING btree (project_id);


--
-- Name: idx_ufi_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_search ON public.unified_feedback_items USING gin (search_vector);


--
-- Name: idx_ufi_sentiment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_sentiment ON public.unified_feedback_items USING btree (project_id, sentiment_score);


--
-- Name: idx_ufi_source_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_source_id ON public.unified_feedback_items USING btree (project_id, source_type, source_id);


--
-- Name: idx_ufi_source_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_source_type ON public.unified_feedback_items USING btree (project_id, source_type);


--
-- Name: idx_ufi_starred; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_starred ON public.unified_feedback_items USING btree (project_id, starred) WHERE (starred = true);


--
-- Name: idx_ufi_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_status ON public.unified_feedback_items USING btree (project_id, status);


--
-- Name: idx_ufi_tags; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_tags ON public.unified_feedback_items USING gin (tags);


--
-- Name: idx_ufi_urgency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ufi_urgency ON public.unified_feedback_items USING btree (project_id, urgency_score DESC);


--
-- Name: idx_usage_events_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_usage_events_name ON public.usage_analytics_events USING btree (event_name);


--
-- Name: idx_usage_events_project_time; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_usage_events_project_time ON public.usage_analytics_events USING btree (project_id, occurred_at DESC);


--
-- Name: idx_usage_events_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_usage_events_source ON public.usage_analytics_events USING btree (source);


--
-- Name: idx_user_intelligence_company_domain; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_intelligence_company_domain ON public.user_intelligence USING btree (company_domain);


--
-- Name: idx_user_intelligence_confidence_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_intelligence_confidence_score ON public.user_intelligence USING btree (confidence_score DESC);


--
-- Name: idx_user_intelligence_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_intelligence_created_at ON public.user_intelligence USING btree (created_at DESC);


--
-- Name: idx_user_intelligence_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_intelligence_user_id ON public.user_intelligence USING btree (user_id);


--
-- Name: idx_user_preferences_tour_progress; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_preferences_tour_progress ON public.user_preferences USING gin (tour_progress);


--
-- Name: idx_user_preferences_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_preferences_user_id ON public.user_preferences USING btree (user_id);


--
-- Name: idx_user_stories_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_created_at ON public.user_stories USING btree (created_at DESC);


--
-- Name: idx_user_stories_exported_to_jira; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_exported_to_jira ON public.user_stories USING btree (exported_to_jira);


--
-- Name: idx_user_stories_jira_issue_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_jira_issue_key ON public.user_stories USING btree (jira_issue_key) WHERE (jira_issue_key IS NOT NULL);


--
-- Name: idx_user_stories_labels; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_labels ON public.user_stories USING gin (labels);


--
-- Name: idx_user_stories_priority_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_priority_level ON public.user_stories USING btree (priority_level);


--
-- Name: idx_user_stories_project_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_project_id ON public.user_stories USING btree (project_id);


--
-- Name: idx_user_stories_sprint_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_sprint_id ON public.user_stories USING btree (sprint_id);


--
-- Name: idx_user_stories_sprint_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_sprint_status ON public.user_stories USING btree (sprint_status);


--
-- Name: idx_user_stories_story_points; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_story_points ON public.user_stories USING btree (story_points);


--
-- Name: idx_user_stories_theme_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_stories_theme_id ON public.user_stories USING btree (theme_id);


--
-- Name: idx_users_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_email ON public.users USING btree (email);


--
-- Name: idx_users_google_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_google_id ON public.users USING btree (google_id);


--
-- Name: idx_users_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_name ON public.users USING btree (name);


--
-- Name: idx_vote_metadata_admin_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_admin_id ON public.vote_metadata USING btree (voted_by_admin_id);


--
-- Name: idx_vote_metadata_customer_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_customer_company ON public.vote_metadata USING btree (customer_company);


--
-- Name: idx_vote_metadata_customer_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_customer_email ON public.vote_metadata USING btree (customer_email);


--
-- Name: idx_vote_metadata_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_priority ON public.vote_metadata USING btree (priority);


--
-- Name: idx_vote_metadata_verification_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_verification_token ON public.vote_metadata USING btree (verification_token);


--
-- Name: idx_vote_metadata_vote_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_vote_id ON public.vote_metadata USING btree (vote_id);


--
-- Name: idx_vote_metadata_vote_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vote_metadata_vote_source ON public.vote_metadata USING btree (vote_source);


--
-- Name: idx_votes_anonymous_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_anonymous_id ON public.votes USING btree (anonymous_id);


--
-- Name: idx_votes_ip_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_ip_post ON public.votes USING btree (ip_address, post_id);


--
-- Name: idx_votes_post; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_post ON public.votes USING btree (post_id);


--
-- Name: idx_votes_post_anonymous_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_votes_post_anonymous_unique ON public.votes USING btree (post_id, anonymous_id) WHERE (anonymous_id IS NOT NULL);


--
-- Name: idx_votes_post_ip; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_post_ip ON public.votes USING btree (post_id, ip_address);


--
-- Name: idx_votes_post_user_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_votes_post_user_unique ON public.votes USING btree (post_id, user_id) WHERE (user_id IS NOT NULL);


--
-- Name: idx_votes_post_voter; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_post_voter ON public.votes USING btree (post_id, voter_hash);


--
-- Name: idx_votes_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_priority ON public.votes USING btree (priority);


--
-- Name: idx_votes_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_user ON public.votes USING btree (user_id);


--
-- Name: idx_votes_voter_hash; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_votes_voter_hash ON public.votes USING btree (voter_hash);


--
-- Name: idx_webhook_deliveries_delivered_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_delivered_at ON public.webhook_deliveries USING btree (delivered_at DESC);


--
-- Name: idx_webhook_deliveries_event_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_event_type ON public.webhook_deliveries USING btree (event_type);


--
-- Name: idx_webhook_deliveries_webhook; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_webhook ON public.webhook_deliveries USING btree (webhook_id);


--
-- Name: idx_weight_preferences_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_weight_preferences_project ON public.ai_weight_preferences USING btree (project_id);


--
-- Name: idx_weight_preferences_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_weight_preferences_type ON public.ai_weight_preferences USING btree (feature_type);


--
-- Name: idx_weight_preferences_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_weight_preferences_user ON public.ai_weight_preferences USING btree (user_id);


--
-- Name: idx_workflows_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_created ON public.workflows USING btree (created_at DESC);


--
-- Name: idx_workflows_project; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_project ON public.workflows USING btree (project_id);


--
-- Name: idx_workflows_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_status ON public.workflows USING btree (status);


--
-- Name: idx_workflows_trigger; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_trigger ON public.workflows USING btree (trigger);


--
-- Name: persona_embeddings_hnsw_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX persona_embeddings_hnsw_idx ON public.persona_embeddings USING hnsw (embedding public.vector_cosine_ops);


--
-- Name: persona_embeddings_persona_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX persona_embeddings_persona_idx ON public.persona_embeddings USING btree (persona_id);


--
-- Name: persona_embeddings_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX persona_embeddings_project_idx ON public.persona_embeddings USING btree (project_id);


--
-- Name: personas_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX personas_project_idx ON public.personas USING btree (project_id);


--
-- Name: product_doc_embeddings_doc_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX product_doc_embeddings_doc_idx ON public.product_doc_embeddings USING btree (product_doc_id);


--
-- Name: product_doc_embeddings_hnsw_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX product_doc_embeddings_hnsw_idx ON public.product_doc_embeddings USING hnsw (embedding public.vector_cosine_ops);


--
-- Name: product_doc_embeddings_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX product_doc_embeddings_project_idx ON public.product_doc_embeddings USING btree (project_id);


--
-- Name: product_documents_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX product_documents_project_idx ON public.product_documents USING btree (project_id, created_at DESC);


--
-- Name: product_documents_search_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX product_documents_search_idx ON public.product_documents USING gin (search_vector);


--
-- Name: roadmap_item_embeddings_hnsw_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX roadmap_item_embeddings_hnsw_idx ON public.roadmap_item_embeddings USING hnsw (embedding public.vector_cosine_ops);


--
-- Name: roadmap_item_embeddings_item_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX roadmap_item_embeddings_item_idx ON public.roadmap_item_embeddings USING btree (roadmap_item_id);


--
-- Name: roadmap_item_embeddings_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX roadmap_item_embeddings_project_idx ON public.roadmap_item_embeddings USING btree (project_id);


--
-- Name: slack_integration_states_project_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX slack_integration_states_project_id_idx ON public.slack_integration_states USING btree (project_id);


--
-- Name: slack_integrations_project_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX slack_integrations_project_id_idx ON public.slack_integrations USING btree (project_id);


--
-- Name: spec_context_sources_spec_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX spec_context_sources_spec_idx ON public.spec_context_sources USING btree (spec_id);


--
-- Name: spec_context_sources_type_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX spec_context_sources_type_idx ON public.spec_context_sources USING btree (source_type);


--
-- Name: spec_embeddings_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX spec_embeddings_idx ON public.spec_embeddings USING ivfflat (embedding public.vector_cosine_ops);


--
-- Name: spec_versions_spec_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX spec_versions_spec_idx ON public.spec_versions USING btree (spec_id, version_number DESC);


--
-- Name: specs_feedback_ids_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX specs_feedback_ids_idx ON public.specs USING gin (linked_feedback_ids);


--
-- Name: specs_project_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX specs_project_idx ON public.specs USING btree (project_id, created_at DESC);


--
-- Name: specs_search_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX specs_search_idx ON public.specs USING gin (search_vector);


--
-- Name: specs_status_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX specs_status_idx ON public.specs USING btree (status, created_at DESC);


--
-- Name: specs_user_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX specs_user_idx ON public.specs USING btree (created_by, created_at DESC);


--
-- Name: competitive_dashboard_overview _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.competitive_dashboard_overview WITH (security_barrier='true', security_invoker='true') AS
 SELECT c.project_id,
    c.id AS competitor_id,
    c.name AS competitor_name,
    c.category,
    c.status,
    c.total_mentions,
    c.avg_sentiment_vs_you,
    c.avg_sentiment_about_them,
    c.switches_to_you,
    c.switches_from_you,
    (c.switches_to_you - c.switches_from_you) AS net_switches,
    c.last_mentioned_at,
    count(DISTINCT cm.id) FILTER (WHERE (cm.created_at >= (now() - '7 days'::interval))) AS mentions_last_7d,
    count(DISTINCT cm.id) FILTER (WHERE (cm.created_at >= (now() - '30 days'::interval))) AS mentions_last_30d,
    count(DISTINCT cm.id) FILTER (WHERE (cm.mention_type = 'comparison'::public.mention_type)) AS comparison_count,
    count(DISTINCT cm.id) FILTER (WHERE (cm.mention_type = 'feature_comparison'::public.mention_type)) AS feature_comparison_count
   FROM (public.competitors c
     LEFT JOIN public.competitive_mentions cm ON ((c.id = cm.competitor_id)))
  WHERE (c.status = ANY (ARRAY['active'::public.competitor_status, 'monitoring'::public.competitor_status]))
  GROUP BY c.id;


--
-- Name: competitor_products_overview _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.competitor_products_overview WITH (security_barrier='true', security_invoker='true') AS
 SELECT cp.id,
    cp.project_id,
    cp.product_name,
    cp.company_name,
    cp.is_active,
    cp.monitoring_enabled,
    cp.platforms,
    cp.last_synced_at,
    count(DISTINCT cr.id) AS total_reviews,
    count(DISTINCT cr.id) FILTER (WHERE (cr.platform = 'g2'::text)) AS g2_reviews,
    count(DISTINCT cr.id) FILTER (WHERE (cr.platform = 'capterra'::text)) AS capterra_reviews,
    count(DISTINCT cr.id) FILTER (WHERE (cr.platform = 'trustradius'::text)) AS trustradius_reviews,
    avg(cr.rating) AS avg_rating,
    avg(cr.rating) FILTER (WHERE (cr.platform = 'g2'::text)) AS avg_g2_rating,
    avg(cr.rating) FILTER (WHERE (cr.platform = 'capterra'::text)) AS avg_capterra_rating,
    avg(cr.rating) FILTER (WHERE (cr.platform = 'trustradius'::text)) AS avg_trustradius_rating,
    count(DISTINCT cf.id) AS features_identified,
    count(DISTINCT cs.id) AS strengths_identified,
    count(DISTINCT cw.id) AS weaknesses_identified,
    max(cr.published_at) AS latest_review_date,
    count(DISTINCT cr.id) FILTER (WHERE (cr.published_at >= (now() - '30 days'::interval))) AS reviews_last_30_days
   FROM ((((public.competitor_products cp
     LEFT JOIN public.competitor_reviews cr ON ((cr.competitor_product_id = cp.id)))
     LEFT JOIN public.competitor_features cf ON ((cf.competitor_product_id = cp.id)))
     LEFT JOIN public.competitor_strengths cs ON ((cs.competitor_product_id = cp.id)))
     LEFT JOIN public.competitor_weaknesses cw ON ((cw.competitor_product_id = cp.id)))
  GROUP BY cp.id;


--
-- Name: emerging_themes_view _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.emerging_themes_view WITH (security_barrier='true', security_invoker='true') AS
 SELECT t.id,
    t.project_id,
    t.cluster_id,
    t.theme_name,
    t.description,
    t.frequency,
    t.avg_sentiment,
    t.first_seen,
    t.last_seen,
    t.is_emerging,
    t.created_at,
    t.updated_at,
    count(ft.feedback_id) FILTER (WHERE (ft.created_at >= (now() - '7 days'::interval))) AS recent_mentions,
    count(ft.feedback_id) FILTER (WHERE ((ft.created_at >= (now() - '14 days'::interval)) AND (ft.created_at < (now() - '7 days'::interval)))) AS previous_mentions
   FROM (public.themes t
     LEFT JOIN public.feedback_themes ft ON ((t.id = ft.theme_id)))
  GROUP BY t.id
 HAVING (count(ft.feedback_id) FILTER (WHERE (ft.created_at >= (now() - '7 days'::interval))) > 0);


--
-- Name: feature_gaps_with_competitors _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.feature_gaps_with_competitors WITH (security_barrier='true', security_invoker='true') AS
 SELECT fg.id,
    fg.project_id,
    fg.feature_name,
    fg.description,
    fg.mention_count,
    fg.competitor_ids,
    fg.avg_sentiment,
    fg.urgency_score,
    fg.estimated_revenue_impact,
    fg.priority,
    fg.status,
    fg.user_quotes,
    fg.feedback_ids,
    fg.first_detected_at,
    fg.last_updated_at,
    fg.assigned_to,
    fg.roadmap_item_id,
    fg.shipped_at,
    fg.created_at,
    fg.updated_at,
    array_agg(DISTINCT c.name) FILTER (WHERE (c.id = ANY (fg.competitor_ids))) AS competitor_names,
    ( SELECT count(DISTINCT x.x) AS count
           FROM unnest(fg.feedback_ids) x(x)) AS actual_feedback_count
   FROM (public.feature_gaps fg
     LEFT JOIN public.competitors c ON ((c.id = ANY (fg.competitor_ids))))
  WHERE (fg.status <> 'dismissed'::public.feature_gap_status)
  GROUP BY fg.id;


--
-- Name: jira_integration_overview _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.jira_integration_overview WITH (security_barrier='true', security_invoker='true') AS
 SELECT jc.project_id,
    jc.id AS connection_id,
    jc.site_url,
    jc.site_name,
    jc.status AS connection_status,
    jc.default_project_key,
    jc.last_sync_at,
    count(DISTINCT jil.id) AS total_issues_created,
    count(DISTINCT jil.id) FILTER (WHERE (jil.created_at >= (now() - '7 days'::interval))) AS issues_created_this_week,
    count(DISTINCT jil.id) FILTER (WHERE (jil.status = ANY (ARRAY['Done'::text, 'Closed'::text, 'Resolved'::text]))) AS issues_resolved,
    count(DISTINCT jil.id) FILTER (WHERE (jil.status = 'In Progress'::text)) AS issues_in_progress,
    count(DISTINCT jw.id) AS active_webhooks,
    count(DISTINCT jlm.id) AS label_mappings
   FROM (((public.jira_connections jc
     LEFT JOIN public.jira_issue_links jil ON ((jc.id = jil.jira_connection_id)))
     LEFT JOIN public.jira_webhooks jw ON (((jc.id = jw.jira_connection_id) AND (jw.status = 'active'::public.jira_webhook_status))))
     LEFT JOIN public.jira_label_mappings jlm ON ((jc.project_id = jlm.project_id)))
  GROUP BY jc.id;


--
-- Name: themes_with_details _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.themes_with_details WITH (security_barrier='true', security_invoker='true') AS
 SELECT t.id,
    t.project_id,
    t.cluster_id,
    t.theme_name,
    t.description,
    t.frequency,
    t.avg_sentiment,
    t.first_seen,
    t.last_seen,
    t.is_emerging,
    t.created_at,
    t.updated_at,
    tc.cluster_name,
    count(DISTINCT ft.feedback_id) AS actual_feedback_count,
    array_agg(DISTINCT p.category) FILTER (WHERE (p.category IS NOT NULL)) AS related_categories
   FROM (((public.themes t
     LEFT JOIN public.theme_clusters tc ON ((t.cluster_id = tc.id)))
     LEFT JOIN public.feedback_themes ft ON ((t.id = ft.theme_id)))
     LEFT JOIN public.posts p ON ((ft.feedback_id = p.id)))
  GROUP BY t.id, tc.cluster_name;


--
-- Name: call_ingests call_ingests_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER call_ingests_updated_at BEFORE UPDATE ON public.call_ingests FOR EACH ROW EXECUTE FUNCTION public.update_call_ingests_updated_at();


--
-- Name: call_records call_records_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER call_records_updated_at BEFORE UPDATE ON public.call_records FOR EACH ROW EXECUTE FUNCTION public.update_call_records_updated_at();


--
-- Name: discovered_feedback check_theme_detection_on_insert; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER check_theme_detection_on_insert AFTER INSERT ON public.discovered_feedback FOR EACH ROW EXECUTE FUNCTION public.check_theme_detection_trigger();


--
-- Name: projects create_default_slack_rules_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER create_default_slack_rules_trigger AFTER INSERT ON public.projects FOR EACH ROW EXECUTE FUNCTION public.create_default_slack_alert_rules();


--
-- Name: customer_health customer_health_derived_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER customer_health_derived_update BEFORE INSERT OR UPDATE ON public.customer_health FOR EACH ROW EXECUTE FUNCTION public.update_health_derived_fields();


--
-- Name: health_scores health_scores_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER health_scores_updated_at BEFORE UPDATE ON public.health_scores FOR EACH ROW EXECUTE FUNCTION public.update_health_scores_updated_at();


--
-- Name: slack_alert_rules slack_alert_rules_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER slack_alert_rules_updated_at BEFORE UPDATE ON public.slack_alert_rules FOR EACH ROW EXECUTE FUNCTION public.update_slack_updated_at();


--
-- Name: slack_channel_mappings slack_channel_mappings_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER slack_channel_mappings_updated_at BEFORE UPDATE ON public.slack_channel_mappings FOR EACH ROW EXECUTE FUNCTION public.update_slack_updated_at();


--
-- Name: slack_connections slack_connections_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER slack_connections_updated_at BEFORE UPDATE ON public.slack_connections FOR EACH ROW EXECUTE FUNCTION public.update_slack_updated_at();


--
-- Name: jira_issue_links sync_feedback_on_jira_status_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER sync_feedback_on_jira_status_change AFTER UPDATE OF status ON public.jira_issue_links FOR EACH ROW EXECUTE FUNCTION public.sync_jira_issue_status();


--
-- Name: user_stories track_manual_edits_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER track_manual_edits_trigger BEFORE UPDATE ON public.user_stories FOR EACH ROW EXECUTE FUNCTION public.track_manual_edits();


--
-- Name: account_billing_profiles trg_account_billing_profiles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_account_billing_profiles_updated_at BEFORE INSERT OR UPDATE ON public.account_billing_profiles FOR EACH ROW EXECUTE FUNCTION public.account_billing_profiles_set_updated_at();


--
-- Name: project_notification_recipients trg_project_notification_recipients_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_project_notification_recipients_updated_at BEFORE UPDATE ON public.project_notification_recipients FOR EACH ROW EXECUTE FUNCTION public.update_project_notification_recipients_updated_at();


--
-- Name: projects trg_projects_sync_billing; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_projects_sync_billing AFTER INSERT OR UPDATE OF plan, stripe_customer_id, subscription_id, subscription_status, current_period_end, cancel_at_period_end, trial_start_date, trial_end_date, trial_status, is_trial, trial_cancelled_at ON public.projects FOR EACH ROW EXECUTE FUNCTION public.sync_account_billing_from_project();


--
-- Name: roadmap_adjustment_proposals trigger_adj_proposals_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_adj_proposals_updated_at BEFORE UPDATE ON public.roadmap_adjustment_proposals FOR EACH ROW EXECUTE FUNCTION public.update_adj_proposals_updated_at();


--
-- Name: posts trigger_auto_enqueue_for_triage; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_auto_enqueue_for_triage AFTER INSERT ON public.posts FOR EACH ROW EXECUTE FUNCTION public.auto_enqueue_for_triage();


--
-- Name: customer_profiles trigger_customer_profile_changed; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_customer_profile_changed AFTER INSERT OR UPDATE ON public.customer_profiles FOR EACH ROW EXECUTE FUNCTION public.trigger_enrich_feedback_on_customer_change();


--
-- Name: posts trigger_feedback_created; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_feedback_created AFTER INSERT ON public.posts FOR EACH ROW EXECUTE FUNCTION public.publish_feedback_created_event();


--
-- Name: posts trigger_feedback_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_feedback_updated AFTER UPDATE ON public.posts FOR EACH ROW EXECUTE FUNCTION public.publish_feedback_updated_event();


--
-- Name: posts trigger_feedback_voted; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_feedback_voted AFTER UPDATE OF vote_count ON public.posts FOR EACH ROW EXECUTE FUNCTION public.publish_feedback_voted_event();


--
-- Name: launch_boards trigger_launch_boards_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_launch_boards_updated BEFORE UPDATE ON public.launch_boards FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: launch_dimensions trigger_launch_dimensions_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_launch_dimensions_updated BEFORE UPDATE ON public.launch_dimensions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: personas trigger_personas_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_personas_updated_at BEFORE UPDATE ON public.personas FOR EACH ROW EXECUTE FUNCTION public.update_personas_updated_at();


--
-- Name: product_documents trigger_product_documents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_product_documents_updated_at BEFORE UPDATE ON public.product_documents FOR EACH ROW EXECUTE FUNCTION public.update_product_documents_updated_at();


--
-- Name: retro_actions trigger_retro_actions_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_retro_actions_updated BEFORE UPDATE ON public.retro_actions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: retro_boards trigger_retro_boards_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_retro_boards_updated BEFORE UPDATE ON public.retro_boards FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: retro_cards trigger_retro_cards_updated; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_retro_cards_updated BEFORE UPDATE ON public.retro_cards FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: sentiment_analysis trigger_sentiment_analyzed; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_sentiment_analyzed AFTER INSERT ON public.sentiment_analysis FOR EACH ROW EXECUTE FUNCTION public.publish_sentiment_analyzed_event();


--
-- Name: specs trigger_spec_approved; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_spec_approved AFTER UPDATE OF status ON public.specs FOR EACH ROW EXECUTE FUNCTION public.publish_spec_approved_event();


--
-- Name: specs trigger_spec_auto_drafted; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_spec_auto_drafted AFTER INSERT ON public.specs FOR EACH ROW EXECUTE FUNCTION public.publish_spec_auto_drafted_event();


--
-- Name: strategy_shifts trigger_strategy_shifts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_strategy_shifts_updated_at BEFORE UPDATE ON public.strategy_shifts FOR EACH ROW EXECUTE FUNCTION public.update_strategy_shifts_updated_at();


--
-- Name: themes trigger_theme_detected; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_theme_detected AFTER INSERT ON public.themes FOR EACH ROW EXECUTE FUNCTION public.publish_theme_detected_event();


--
-- Name: themes trigger_theme_threshold_reached; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_theme_threshold_reached AFTER UPDATE OF frequency ON public.themes FOR EACH ROW EXECUTE FUNCTION public.publish_theme_threshold_reached_event();


--
-- Name: unified_action_queue trigger_update_action_queue_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_action_queue_timestamp BEFORE UPDATE ON public.unified_action_queue FOR EACH ROW EXECUTE FUNCTION public.update_action_queue_timestamp();


--
-- Name: comments trigger_update_comment_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_comment_count AFTER INSERT OR DELETE ON public.comments FOR EACH ROW EXECUTE FUNCTION public.update_post_comment_count();


--
-- Name: signal_correlations trigger_update_correlation_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_correlation_timestamp BEFORE UPDATE ON public.signal_correlations FOR EACH ROW EXECUTE FUNCTION public.update_correlation_timestamp();


--
-- Name: customer_profiles trigger_update_customer_profiles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_customer_profiles_updated_at BEFORE UPDATE ON public.customer_profiles FOR EACH ROW EXECUTE FUNCTION public.update_customer_profiles_updated_at();


--
-- Name: experiments trigger_update_experiments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_experiments_updated_at BEFORE UPDATE ON public.experiments FOR EACH ROW EXECUTE FUNCTION public.update_experiments_updated_at();


--
-- Name: feature_impact_history trigger_update_feature_impact_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_feature_impact_updated_at BEFORE UPDATE ON public.feature_impact_history FOR EACH ROW EXECUTE FUNCTION public.update_feature_impact_updated_at();


--
-- Name: feature_outcomes trigger_update_feature_outcomes_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_feature_outcomes_updated_at BEFORE UPDATE ON public.feature_outcomes FOR EACH ROW EXECUTE FUNCTION public.update_feature_outcomes_updated_at();


--
-- Name: integration_credentials trigger_update_integration_credentials_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_integration_credentials_updated_at BEFORE UPDATE ON public.integration_credentials FOR EACH ROW EXECUTE FUNCTION public.update_integration_credentials_updated_at();


--
-- Name: pm_assignments trigger_update_pm_assignment_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_pm_assignment_timestamp BEFORE UPDATE ON public.pm_assignments FOR EACH ROW EXECUTE FUNCTION public.update_pm_assignment_timestamp();


--
-- Name: poll_votes trigger_update_poll_vote_counts; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_poll_vote_counts AFTER INSERT OR DELETE ON public.poll_votes FOR EACH ROW EXECUTE FUNCTION public.update_poll_vote_counts();


--
-- Name: polls trigger_update_polls_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_polls_timestamp BEFORE UPDATE ON public.polls FOR EACH ROW EXECUTE FUNCTION public.update_polls_timestamp();


--
-- Name: retro_card_votes trigger_update_retro_card_vote_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_retro_card_vote_count AFTER INSERT OR DELETE ON public.retro_card_votes FOR EACH ROW EXECUTE FUNCTION public.update_retro_card_vote_count();


--
-- Name: roadmap_suggestions trigger_update_roadmap_suggestions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_roadmap_suggestions_updated_at BEFORE UPDATE ON public.roadmap_suggestions FOR EACH ROW EXECUTE FUNCTION public.update_roadmap_suggestions_updated_at();


--
-- Name: ask_scheduled_queries trigger_update_scheduled_query_next_run; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_scheduled_query_next_run BEFORE INSERT OR UPDATE ON public.ask_scheduled_queries FOR EACH ROW EXECUTE FUNCTION public.update_scheduled_query_next_run();


--
-- Name: stakeholders trigger_update_stakeholders_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_stakeholders_updated_at BEFORE UPDATE ON public.stakeholders FOR EACH ROW EXECUTE FUNCTION public.update_stakeholders_updated_at();


--
-- Name: survey_responses trigger_update_survey_response_counts; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_survey_response_counts AFTER INSERT OR DELETE OR UPDATE ON public.survey_responses FOR EACH ROW EXECUTE FUNCTION public.update_survey_response_counts();


--
-- Name: surveys trigger_update_surveys_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_surveys_timestamp BEFORE UPDATE ON public.surveys FOR EACH ROW EXECUTE FUNCTION public.update_polls_timestamp();


--
-- Name: team_capacity trigger_update_team_capacity_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_team_capacity_updated_at BEFORE UPDATE ON public.team_capacity FOR EACH ROW EXECUTE FUNCTION public.update_team_capacity_updated_at();


--
-- Name: user_intelligence trigger_update_user_intelligence_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_user_intelligence_updated_at BEFORE UPDATE ON public.user_intelligence FOR EACH ROW EXECUTE FUNCTION public.update_user_intelligence_updated_at();


--
-- Name: votes trigger_update_vote_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_vote_count AFTER INSERT OR DELETE ON public.votes FOR EACH ROW EXECUTE FUNCTION public.update_post_vote_count();


--
-- Name: unified_feedback_items ufi_search_vector_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER ufi_search_vector_update BEFORE INSERT OR UPDATE ON public.unified_feedback_items FOR EACH ROW EXECUTE FUNCTION public.update_ufi_search_vector();


--
-- Name: action_recommendations update_action_recommendations_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_action_recommendations_timestamp BEFORE UPDATE ON public.action_recommendations FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: admin_email_preferences update_admin_email_preferences_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_admin_email_preferences_updated_at BEFORE UPDATE ON public.admin_email_preferences FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: anomaly_detections update_anomaly_detections_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_anomaly_detections_updated_at BEFORE UPDATE ON public.anomaly_detections FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: ask_conversations update_ask_conversations_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_ask_conversations_timestamp_trigger BEFORE UPDATE ON public.ask_conversations FOR EACH ROW EXECUTE FUNCTION public.update_ask_conversations_timestamp();


--
-- Name: deals update_battlecard_on_deal_close; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_battlecard_on_deal_close AFTER INSERT OR UPDATE ON public.deals FOR EACH ROW EXECUTE FUNCTION public.trigger_update_battlecard();


--
-- Name: deal_battlecards update_battlecards_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_battlecards_timestamp BEFORE UPDATE ON public.deal_battlecards FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: changelog_entries update_changelog_entries_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_changelog_entries_updated_at BEFORE UPDATE ON public.changelog_entries FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: changelog_releases update_changelog_releases_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_changelog_releases_updated_at BEFORE UPDATE ON public.changelog_releases FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: changelog_webhooks update_changelog_webhooks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_changelog_webhooks_updated_at BEFORE UPDATE ON public.changelog_webhooks FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: churn_risk_predictions update_churn_risk_predictions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_churn_risk_predictions_updated_at BEFORE UPDATE ON public.churn_risk_predictions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: themes update_cluster_theme_count_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_cluster_theme_count_trigger AFTER INSERT OR DELETE OR UPDATE ON public.themes FOR EACH ROW EXECUTE FUNCTION public.trigger_update_cluster_theme_count();


--
-- Name: competitive_events update_competitive_events_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_competitive_events_timestamp BEFORE UPDATE ON public.competitive_events FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: competitor_alerts update_competitor_alerts_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_competitor_alerts_timestamp BEFORE UPDATE ON public.competitor_alerts FOR EACH ROW EXECUTE FUNCTION public.update_war_room_timestamp();


--
-- Name: competitive_mentions update_competitor_stats_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_competitor_stats_trigger AFTER INSERT OR DELETE OR UPDATE ON public.competitive_mentions FOR EACH ROW EXECUTE FUNCTION public.trigger_update_competitor_stats();


--
-- Name: competitors update_competitors_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_competitors_timestamp BEFORE UPDATE ON public.competitors FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: unified_feedback_items update_customer_stats_on_feedback; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_customer_stats_on_feedback AFTER INSERT ON public.unified_feedback_items FOR EACH ROW EXECUTE FUNCTION public.update_customer_feedback_stats();


--
-- Name: daily_briefings update_daily_briefings_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_daily_briefings_timestamp_trigger BEFORE UPDATE ON public.daily_briefings FOR EACH ROW EXECUTE FUNCTION public.update_daily_briefings_timestamp();


--
-- Name: deals update_deals_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_deals_timestamp BEFORE UPDATE ON public.deals FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: deal_digest_subscriptions update_digest_subs_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_digest_subs_timestamp BEFORE UPDATE ON public.deal_digest_subscriptions FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: discount_codes update_discount_codes_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_discount_codes_updated_at BEFORE UPDATE ON public.discount_codes FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: discovered_feedback update_discovered_feedback_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_discovered_feedback_timestamp BEFORE UPDATE ON public.discovered_feedback FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: email_batches update_email_batches_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_email_batches_updated_at BEFORE UPDATE ON public.email_batches FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: email_preferences update_email_preferences_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_email_preferences_updated_at BEFORE UPDATE ON public.email_preferences FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: email_templates update_email_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_email_templates_updated_at BEFORE UPDATE ON public.email_templates FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: feature_gaps update_feature_gaps_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_feature_gaps_timestamp BEFORE UPDATE ON public.feature_gaps FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: feature_predictions update_feature_predictions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_feature_predictions_updated_at BEFORE UPDATE ON public.feature_predictions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: feedback_metadata update_feedback_metadata_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_feedback_metadata_updated_at BEFORE UPDATE ON public.feedback_metadata FOR EACH ROW EXECUTE FUNCTION public.update_feedback_metadata_updated_at();


--
-- Name: feedback_webhooks update_feedback_webhooks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_feedback_webhooks_updated_at BEFORE UPDATE ON public.feedback_webhooks FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: hunter_configs update_hunter_configs_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_hunter_configs_timestamp BEFORE UPDATE ON public.hunter_configs FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: insight_reports update_insight_reports_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_insight_reports_updated_at BEFORE UPDATE ON public.insight_reports FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: jira_connections update_jira_connections_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_jira_connections_timestamp BEFORE UPDATE ON public.jira_connections FOR EACH ROW EXECUTE FUNCTION public.update_jira_timestamp();


--
-- Name: jira_issue_links update_jira_issue_links_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_jira_issue_links_timestamp BEFORE UPDATE ON public.jira_issue_links FOR EACH ROW EXECUTE FUNCTION public.update_jira_timestamp();


--
-- Name: jira_label_mappings update_jira_label_mappings_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_jira_label_mappings_timestamp BEFORE UPDATE ON public.jira_label_mappings FOR EACH ROW EXECUTE FUNCTION public.update_jira_timestamp();


--
-- Name: jira_webhooks update_jira_webhooks_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_jira_webhooks_timestamp BEFORE UPDATE ON public.jira_webhooks FOR EACH ROW EXECUTE FUNCTION public.update_jira_timestamp();


--
-- Name: competitor_job_postings update_job_postings_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_job_postings_timestamp BEFORE UPDATE ON public.competitor_job_postings FOR EACH ROW EXECUTE FUNCTION public.update_war_room_timestamp();


--
-- Name: competitor_monitoring_config update_monitoring_config_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_monitoring_config_timestamp BEFORE UPDATE ON public.competitor_monitoring_config FOR EACH ROW EXECUTE FUNCTION public.update_war_room_timestamp();


--
-- Name: platform_integrations update_platform_integrations_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_platform_integrations_timestamp BEFORE UPDATE ON public.platform_integrations FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: prd_risk_alerts update_prd_risk_alerts_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_prd_risk_alerts_timestamp BEFORE UPDATE ON public.prd_risk_alerts FOR EACH ROW EXECUTE FUNCTION public.update_prd_risk_alerts_timestamp();


--
-- Name: pre_mortem_analyses update_pre_mortem_analyses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_pre_mortem_analyses_updated_at BEFORE UPDATE ON public.pre_mortem_analyses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: scheduled_reports update_scheduled_reports_next_run; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_scheduled_reports_next_run BEFORE INSERT OR UPDATE ON public.scheduled_reports FOR EACH ROW EXECUTE FUNCTION public.update_next_run_time();


--
-- Name: scheduled_reports update_scheduled_reports_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_scheduled_reports_updated_at BEFORE UPDATE ON public.scheduled_reports FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: sentiment_forecasts update_sentiment_forecasts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_sentiment_forecasts_updated_at BEFORE UPDATE ON public.sentiment_forecasts FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: post_similarities update_similarity_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_similarity_timestamp_trigger BEFORE UPDATE ON public.post_similarities FOR EACH ROW EXECUTE FUNCTION public.update_similarity_timestamp();


--
-- Name: specs update_specs_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_specs_timestamp_trigger BEFORE UPDATE ON public.specs FOR EACH ROW EXECUTE FUNCTION public.update_specs_timestamp();


--
-- Name: user_stories update_sprint_points_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_sprint_points_trigger AFTER INSERT OR DELETE OR UPDATE ON public.user_stories FOR EACH ROW EXECUTE FUNCTION public.update_sprint_points();


--
-- Name: sprints update_sprints_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_sprints_timestamp_trigger BEFORE UPDATE ON public.sprints FOR EACH ROW EXECUTE FUNCTION public.update_user_stories_timestamp();


--
-- Name: stakeholder_queries update_stakeholder_queries_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_stakeholder_queries_updated_at BEFORE UPDATE ON public.stakeholder_queries FOR EACH ROW EXECUTE FUNCTION public.update_stakeholder_queries_updated_at();


--
-- Name: story_templates update_story_templates_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_story_templates_timestamp_trigger BEFORE UPDATE ON public.story_templates FOR EACH ROW EXECUTE FUNCTION public.update_user_stories_timestamp();


--
-- Name: strategic_recommendations update_strategic_recommendations_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_strategic_recommendations_timestamp BEFORE UPDATE ON public.strategic_recommendations FOR EACH ROW EXECUTE FUNCTION public.update_hunter_timestamp();


--
-- Name: feedback_themes update_theme_metrics_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_theme_metrics_trigger AFTER INSERT OR DELETE OR UPDATE ON public.feedback_themes FOR EACH ROW EXECUTE FUNCTION public.trigger_update_theme_metrics();


--
-- Name: timeline_events update_timeline_events_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_timeline_events_updated_at BEFORE UPDATE ON public.timeline_events FOR EACH ROW EXECUTE FUNCTION public.update_timeline_events_updated_at();


--
-- Name: user_stories update_user_stories_timestamp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_user_stories_timestamp_trigger BEFORE UPDATE ON public.user_stories FOR EACH ROW EXECUTE FUNCTION public.update_user_stories_timestamp();


--
-- Name: vote_metadata update_vote_metadata_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_vote_metadata_updated_at BEFORE UPDATE ON public.vote_metadata FOR EACH ROW EXECUTE FUNCTION public.update_vote_metadata_updated_at();


--
-- Name: ai_weight_preferences update_weight_preferences_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_weight_preferences_timestamp BEFORE UPDATE ON public.ai_weight_preferences FOR EACH ROW EXECUTE FUNCTION public.update_war_room_timestamp();


--
-- Name: account_billing_profiles account_billing_profiles_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_billing_profiles
    ADD CONSTRAINT account_billing_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: action_recommendations action_recommendations_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.action_recommendations
    ADD CONSTRAINT action_recommendations_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: action_recommendations action_recommendations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.action_recommendations
    ADD CONSTRAINT action_recommendations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: admin_email_preferences admin_email_preferences_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.admin_email_preferences
    ADD CONSTRAINT admin_email_preferences_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: agent_memory agent_memory_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agent_memory
    ADD CONSTRAINT agent_memory_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ai_usage_tracking ai_usage_tracking_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_usage_tracking
    ADD CONSTRAINT ai_usage_tracking_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ai_weight_preferences ai_weight_preferences_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_weight_preferences
    ADD CONSTRAINT ai_weight_preferences_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ai_weight_preferences ai_weight_preferences_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_weight_preferences
    ADD CONSTRAINT ai_weight_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: analytics_events analytics_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.analytics_events
    ADD CONSTRAINT analytics_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: anomaly_detections anomaly_detections_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.anomaly_detections
    ADD CONSTRAINT anomaly_detections_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: api_keys api_keys_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_keys
    ADD CONSTRAINT api_keys_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ask_action_executions ask_action_executions_message_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_action_executions
    ADD CONSTRAINT ask_action_executions_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.ask_messages(id) ON DELETE CASCADE;


--
-- Name: ask_action_executions ask_action_executions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_action_executions
    ADD CONSTRAINT ask_action_executions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ask_action_executions ask_action_executions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_action_executions
    ADD CONSTRAINT ask_action_executions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: ask_analytics ask_analytics_message_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_analytics
    ADD CONSTRAINT ask_analytics_message_id_fkey FOREIGN KEY (message_id) REFERENCES public.ask_messages(id) ON DELETE CASCADE;


--
-- Name: ask_analytics ask_analytics_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_analytics
    ADD CONSTRAINT ask_analytics_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ask_conversations ask_conversations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_conversations
    ADD CONSTRAINT ask_conversations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ask_conversations ask_conversations_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_conversations
    ADD CONSTRAINT ask_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: ask_messages ask_messages_conversation_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_messages
    ADD CONSTRAINT ask_messages_conversation_id_fkey FOREIGN KEY (conversation_id) REFERENCES public.ask_conversations(id) ON DELETE CASCADE;


--
-- Name: ask_proactive_suggestions ask_proactive_suggestions_dismissed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_proactive_suggestions
    ADD CONSTRAINT ask_proactive_suggestions_dismissed_by_fkey FOREIGN KEY (dismissed_by) REFERENCES public.users(id) ON DELETE SET NULL;


--
-- Name: ask_proactive_suggestions ask_proactive_suggestions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_proactive_suggestions
    ADD CONSTRAINT ask_proactive_suggestions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ask_scheduled_queries ask_scheduled_queries_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_scheduled_queries
    ADD CONSTRAINT ask_scheduled_queries_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: ask_scheduled_queries ask_scheduled_queries_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ask_scheduled_queries
    ADD CONSTRAINT ask_scheduled_queries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: audio_briefings audio_briefings_briefing_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audio_briefings
    ADD CONSTRAINT audio_briefings_briefing_id_fkey FOREIGN KEY (briefing_id) REFERENCES public.daily_briefings(id) ON DELETE CASCADE;


--
-- Name: audio_briefings audio_briefings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audio_briefings
    ADD CONSTRAINT audio_briefings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: audit_logs audit_logs_actor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: audit_logs audit_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE SET NULL;


--
-- Name: boards boards_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.boards
    ADD CONSTRAINT boards_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: brief_schedules brief_schedules_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_schedules
    ADD CONSTRAINT brief_schedules_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: brief_schedules brief_schedules_last_brief_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_schedules
    ADD CONSTRAINT brief_schedules_last_brief_id_fkey FOREIGN KEY (last_brief_id) REFERENCES public.executive_briefs(id);


--
-- Name: brief_schedules brief_schedules_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_schedules
    ADD CONSTRAINT brief_schedules_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: brief_schedules brief_schedules_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_schedules
    ADD CONSTRAINT brief_schedules_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.brief_templates(id) ON DELETE SET NULL;


--
-- Name: brief_templates brief_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_templates
    ADD CONSTRAINT brief_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: brief_templates brief_templates_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.brief_templates
    ADD CONSTRAINT brief_templates_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: call_ingests call_ingests_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.call_ingests
    ADD CONSTRAINT call_ingests_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: call_records call_records_ingest_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.call_records
    ADD CONSTRAINT call_records_ingest_id_fkey FOREIGN KEY (ingest_id) REFERENCES public.call_ingests(id) ON DELETE CASCADE;


--
-- Name: call_records call_records_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.call_records
    ADD CONSTRAINT call_records_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: changelog_entries changelog_entries_release_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_entries
    ADD CONSTRAINT changelog_entries_release_id_fkey FOREIGN KEY (release_id) REFERENCES public.changelog_releases(id) ON DELETE CASCADE;


--
-- Name: changelog_feedback_links changelog_feedback_links_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_feedback_links
    ADD CONSTRAINT changelog_feedback_links_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: changelog_feedback_links changelog_feedback_links_release_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_feedback_links
    ADD CONSTRAINT changelog_feedback_links_release_id_fkey FOREIGN KEY (release_id) REFERENCES public.changelog_releases(id) ON DELETE CASCADE;


--
-- Name: changelog_media changelog_media_release_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_media
    ADD CONSTRAINT changelog_media_release_id_fkey FOREIGN KEY (release_id) REFERENCES public.changelog_releases(id) ON DELETE CASCADE;


--
-- Name: changelog_releases changelog_releases_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_releases
    ADD CONSTRAINT changelog_releases_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: changelog_releases changelog_releases_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_releases
    ADD CONSTRAINT changelog_releases_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: changelog_subscriptions changelog_subscriptions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_subscriptions
    ADD CONSTRAINT changelog_subscriptions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: changelog_webhooks changelog_webhooks_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.changelog_webhooks
    ADD CONSTRAINT changelog_webhooks_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: churn_alert_rules churn_alert_rules_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alert_rules
    ADD CONSTRAINT churn_alert_rules_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: churn_alert_rules churn_alert_rules_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alert_rules
    ADD CONSTRAINT churn_alert_rules_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: churn_alerts churn_alerts_acknowledged_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alerts
    ADD CONSTRAINT churn_alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES auth.users(id);


--
-- Name: churn_alerts churn_alerts_customer_health_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alerts
    ADD CONSTRAINT churn_alerts_customer_health_id_fkey FOREIGN KEY (customer_health_id) REFERENCES public.customer_health(id) ON DELETE CASCADE;


--
-- Name: churn_alerts churn_alerts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alerts
    ADD CONSTRAINT churn_alerts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: churn_alerts churn_alerts_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_alerts
    ADD CONSTRAINT churn_alerts_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES auth.users(id);


--
-- Name: churn_risk_predictions churn_risk_predictions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.churn_risk_predictions
    ADD CONSTRAINT churn_risk_predictions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: collected_reviews collected_reviews_session_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.collected_reviews
    ADD CONSTRAINT collected_reviews_session_id_fkey FOREIGN KEY (session_id) REFERENCES public.competitive_intel_sessions(id) ON DELETE CASCADE;


--
-- Name: comment_mentions comment_mentions_comment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comment_mentions
    ADD CONSTRAINT comment_mentions_comment_id_fkey FOREIGN KEY (comment_id) REFERENCES public.comments(id) ON DELETE CASCADE;


--
-- Name: comment_mentions comment_mentions_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comment_mentions
    ADD CONSTRAINT comment_mentions_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: comment_mentions comment_mentions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comment_mentions
    ADD CONSTRAINT comment_mentions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: comments comments_parent_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.comments(id) ON DELETE CASCADE;


--
-- Name: comments comments_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: competitive_events competitive_events_competitor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_events
    ADD CONSTRAINT competitive_events_competitor_id_fkey FOREIGN KEY (competitor_id) REFERENCES public.competitors(id) ON DELETE CASCADE;


--
-- Name: competitive_mentions competitive_mentions_competitor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_mentions
    ADD CONSTRAINT competitive_mentions_competitor_id_fkey FOREIGN KEY (competitor_id) REFERENCES public.competitors(id) ON DELETE CASCADE;


--
-- Name: competitive_mentions competitive_mentions_feedback_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitive_mentions
    ADD CONSTRAINT competitive_mentions_feedback_id_fkey FOREIGN KEY (feedback_id) REFERENCES public.discovered_feedback(id) ON DELETE CASCADE;


--
-- Name: competitor_alerts competitor_alerts_acknowledged_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_alerts
    ADD CONSTRAINT competitor_alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES auth.users(id);


--
-- Name: competitor_alerts competitor_alerts_addressed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_alerts
    ADD CONSTRAINT competitor_alerts_addressed_by_fkey FOREIGN KEY (addressed_by) REFERENCES auth.users(id);


--
-- Name: competitor_alerts competitor_alerts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_alerts
    ADD CONSTRAINT competitor_alerts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_embeddings competitor_embeddings_competitor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_embeddings
    ADD CONSTRAINT competitor_embeddings_competitor_id_fkey FOREIGN KEY (competitor_id) REFERENCES public.competitors(id) ON DELETE CASCADE;


--
-- Name: competitor_embeddings competitor_embeddings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_embeddings
    ADD CONSTRAINT competitor_embeddings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_events competitor_events_competitor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_events
    ADD CONSTRAINT competitor_events_competitor_id_fkey FOREIGN KEY (competitor_id) REFERENCES public.competitors(id) ON DELETE CASCADE;


--
-- Name: competitor_events competitor_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_events
    ADD CONSTRAINT competitor_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_features competitor_features_competitor_product_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_features
    ADD CONSTRAINT competitor_features_competitor_product_id_fkey FOREIGN KEY (competitor_product_id) REFERENCES public.competitor_products(id) ON DELETE CASCADE;


--
-- Name: competitor_features competitor_features_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_features
    ADD CONSTRAINT competitor_features_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_job_postings competitor_job_postings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_job_postings
    ADD CONSTRAINT competitor_job_postings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_monitoring_config competitor_monitoring_config_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_monitoring_config
    ADD CONSTRAINT competitor_monitoring_config_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_products competitor_products_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_products
    ADD CONSTRAINT competitor_products_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_reviews competitor_reviews_competitor_product_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_reviews
    ADD CONSTRAINT competitor_reviews_competitor_product_id_fkey FOREIGN KEY (competitor_product_id) REFERENCES public.competitor_products(id) ON DELETE CASCADE;


--
-- Name: competitor_reviews competitor_reviews_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_reviews
    ADD CONSTRAINT competitor_reviews_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_strengths competitor_strengths_competitor_product_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_strengths
    ADD CONSTRAINT competitor_strengths_competitor_product_id_fkey FOREIGN KEY (competitor_product_id) REFERENCES public.competitor_products(id) ON DELETE CASCADE;


--
-- Name: competitor_strengths competitor_strengths_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_strengths
    ADD CONSTRAINT competitor_strengths_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitor_weaknesses competitor_weaknesses_competitor_product_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_weaknesses
    ADD CONSTRAINT competitor_weaknesses_competitor_product_id_fkey FOREIGN KEY (competitor_product_id) REFERENCES public.competitor_products(id) ON DELETE CASCADE;


--
-- Name: competitor_weaknesses competitor_weaknesses_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitor_weaknesses
    ADD CONSTRAINT competitor_weaknesses_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: competitors competitors_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.competitors
    ADD CONSTRAINT competitors_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: customer_health customer_health_customer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health
    ADD CONSTRAINT customer_health_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id) ON DELETE CASCADE;


--
-- Name: customer_health_history customer_health_history_customer_health_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health_history
    ADD CONSTRAINT customer_health_history_customer_health_id_fkey FOREIGN KEY (customer_health_id) REFERENCES public.customer_health(id) ON DELETE CASCADE;


--
-- Name: customer_health_history customer_health_history_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health_history
    ADD CONSTRAINT customer_health_history_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: customer_health customer_health_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_health
    ADD CONSTRAINT customer_health_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: customer_profiles customer_profiles_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_profiles
    ADD CONSTRAINT customer_profiles_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: customer_sync_log customer_sync_log_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customer_sync_log
    ADD CONSTRAINT customer_sync_log_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: customers customers_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.customers
    ADD CONSTRAINT customers_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: daily_briefings daily_briefings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.daily_briefings
    ADD CONSTRAINT daily_briefings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: deal_autopsies deal_autopsies_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_autopsies
    ADD CONSTRAINT deal_autopsies_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id) ON DELETE CASCADE;


--
-- Name: deal_battlecards deal_battlecards_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_battlecards
    ADD CONSTRAINT deal_battlecards_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: deal_digest_subscriptions deal_digest_subscriptions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_digest_subscriptions
    ADD CONSTRAINT deal_digest_subscriptions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: deals deals_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: discord_integration_states discord_integration_states_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discord_integration_states
    ADD CONSTRAINT discord_integration_states_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: discord_integrations discord_integrations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discord_integrations
    ADD CONSTRAINT discord_integrations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: discount_code_usage discount_code_usage_discount_code_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_discount_code_id_fkey FOREIGN KEY (discount_code_id) REFERENCES public.discount_codes(id) ON DELETE CASCADE;


--
-- Name: discount_code_usage discount_code_usage_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: discount_code_usage discount_code_usage_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: discount_codes discount_codes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_codes
    ADD CONSTRAINT discount_codes_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: discovered_feedback discovered_feedback_customer_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discovered_feedback
    ADD CONSTRAINT discovered_feedback_customer_profile_id_fkey FOREIGN KEY (customer_profile_id) REFERENCES public.customer_profiles(id) ON DELETE SET NULL;


--
-- Name: discovered_feedback discovered_feedback_duplicate_of_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discovered_feedback
    ADD CONSTRAINT discovered_feedback_duplicate_of_fkey FOREIGN KEY (duplicate_of) REFERENCES public.discovered_feedback(id) ON DELETE SET NULL;


--
-- Name: discovered_feedback discovered_feedback_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discovered_feedback
    ADD CONSTRAINT discovered_feedback_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: discovered_feedback discovered_feedback_sentiment_analysis_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discovered_feedback
    ADD CONSTRAINT discovered_feedback_sentiment_analysis_id_fkey FOREIGN KEY (sentiment_analysis_id) REFERENCES public.sentiment_analysis(id) ON DELETE SET NULL;


--
-- Name: domain_verifications domain_verifications_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.domain_verifications
    ADD CONSTRAINT domain_verifications_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: email_queue email_queue_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_queue
    ADD CONSTRAINT email_queue_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: email_templates email_templates_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: executive_briefs executive_briefs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.executive_briefs
    ADD CONSTRAINT executive_briefs_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: executive_briefs executive_briefs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.executive_briefs
    ADD CONSTRAINT executive_briefs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: executive_briefs executive_briefs_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.executive_briefs
    ADD CONSTRAINT executive_briefs_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.brief_templates(id) ON DELETE SET NULL;


--
-- Name: experiment_embeddings experiment_embeddings_experiment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_embeddings
    ADD CONSTRAINT experiment_embeddings_experiment_id_fkey FOREIGN KEY (experiment_id) REFERENCES public.experiments(id) ON DELETE CASCADE;


--
-- Name: experiment_learnings experiment_learnings_experiment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_learnings
    ADD CONSTRAINT experiment_learnings_experiment_id_fkey FOREIGN KEY (experiment_id) REFERENCES public.experiments(id) ON DELETE CASCADE;


--
-- Name: experiment_results experiment_results_experiment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_results
    ADD CONSTRAINT experiment_results_experiment_id_fkey FOREIGN KEY (experiment_id) REFERENCES public.experiments(id) ON DELETE CASCADE;


--
-- Name: experiment_snapshots experiment_snapshots_experiment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_snapshots
    ADD CONSTRAINT experiment_snapshots_experiment_id_fkey FOREIGN KEY (experiment_id) REFERENCES public.experiments(id) ON DELETE CASCADE;


--
-- Name: experiment_sync_log experiment_sync_log_experiment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiment_sync_log
    ADD CONSTRAINT experiment_sync_log_experiment_id_fkey FOREIGN KEY (experiment_id) REFERENCES public.experiments(id) ON DELETE CASCADE;


--
-- Name: experiments experiments_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.experiments
    ADD CONSTRAINT experiments_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feature_gaps feature_gaps_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_gaps
    ADD CONSTRAINT feature_gaps_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: feature_gaps feature_gaps_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_gaps
    ADD CONSTRAINT feature_gaps_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feature_impact_history feature_impact_history_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_impact_history
    ADD CONSTRAINT feature_impact_history_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feature_impact_history feature_impact_history_suggestion_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_impact_history
    ADD CONSTRAINT feature_impact_history_suggestion_id_fkey FOREIGN KEY (suggestion_id) REFERENCES public.roadmap_suggestions(id) ON DELETE SET NULL;


--
-- Name: feature_outcomes feature_outcomes_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_outcomes
    ADD CONSTRAINT feature_outcomes_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feature_outcomes feature_outcomes_suggestion_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_outcomes
    ADD CONSTRAINT feature_outcomes_suggestion_id_fkey FOREIGN KEY (suggestion_id) REFERENCES public.roadmap_suggestions(id) ON DELETE CASCADE;


--
-- Name: feature_predictions feature_predictions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_predictions
    ADD CONSTRAINT feature_predictions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feature_predictions feature_predictions_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_predictions
    ADD CONSTRAINT feature_predictions_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE CASCADE;


--
-- Name: feedback_embeddings feedback_embeddings_feedback_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_embeddings
    ADD CONSTRAINT feedback_embeddings_feedback_id_fkey FOREIGN KEY (feedback_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: feedback_embeddings feedback_embeddings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_embeddings
    ADD CONSTRAINT feedback_embeddings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feedback_integrations feedback_integrations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_integrations
    ADD CONSTRAINT feedback_integrations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feedback_merges feedback_merges_merged_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_merges
    ADD CONSTRAINT feedback_merges_merged_by_fkey FOREIGN KEY (merged_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: feedback_merges feedback_merges_merged_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_merges
    ADD CONSTRAINT feedback_merges_merged_post_id_fkey FOREIGN KEY (merged_post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: feedback_merges feedback_merges_primary_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_merges
    ADD CONSTRAINT feedback_merges_primary_post_id_fkey FOREIGN KEY (primary_post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: feedback_merges feedback_merges_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_merges
    ADD CONSTRAINT feedback_merges_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: feedback_metadata feedback_metadata_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_metadata
    ADD CONSTRAINT feedback_metadata_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: feedback_themes feedback_themes_feedback_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_themes
    ADD CONSTRAINT feedback_themes_feedback_id_fkey FOREIGN KEY (feedback_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: feedback_themes feedback_themes_theme_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_themes
    ADD CONSTRAINT feedback_themes_theme_id_fkey FOREIGN KEY (theme_id) REFERENCES public.themes(id) ON DELETE CASCADE;


--
-- Name: feedback_webhooks feedback_webhooks_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feedback_webhooks
    ADD CONSTRAINT feedback_webhooks_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: gift_subscriptions gift_subscriptions_gifter_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gift_subscriptions
    ADD CONSTRAINT gift_subscriptions_gifter_id_fkey FOREIGN KEY (gifter_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: gift_subscriptions gift_subscriptions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gift_subscriptions
    ADD CONSTRAINT gift_subscriptions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: gift_subscriptions gift_subscriptions_recipient_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gift_subscriptions
    ADD CONSTRAINT gift_subscriptions_recipient_id_fkey FOREIGN KEY (recipient_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: hunter_configs hunter_configs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_configs
    ADD CONSTRAINT hunter_configs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: hunter_jobs hunter_jobs_scan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_jobs
    ADD CONSTRAINT hunter_jobs_scan_id_fkey FOREIGN KEY (scan_id) REFERENCES public.hunter_scans(id) ON DELETE CASCADE;


--
-- Name: hunter_logs hunter_logs_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_logs
    ADD CONSTRAINT hunter_logs_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.platform_integrations(id) ON DELETE CASCADE;


--
-- Name: hunter_logs hunter_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_logs
    ADD CONSTRAINT hunter_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: hunter_raw_items hunter_raw_items_scan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_raw_items
    ADD CONSTRAINT hunter_raw_items_scan_id_fkey FOREIGN KEY (scan_id) REFERENCES public.hunter_scans(id) ON DELETE CASCADE;


--
-- Name: hunter_scans hunter_scans_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_scans
    ADD CONSTRAINT hunter_scans_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: hunter_scans hunter_scans_triggered_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hunter_scans
    ADD CONSTRAINT hunter_scans_triggered_by_fkey FOREIGN KEY (triggered_by) REFERENCES auth.users(id);


--
-- Name: inbox_sync_logs inbox_sync_logs_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.inbox_sync_logs
    ADD CONSTRAINT inbox_sync_logs_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.feedback_integrations(id) ON DELETE CASCADE;


--
-- Name: inbox_sync_logs inbox_sync_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.inbox_sync_logs
    ADD CONSTRAINT inbox_sync_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: insight_reports insight_reports_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.insight_reports
    ADD CONSTRAINT insight_reports_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: integration_credentials integration_credentials_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_credentials
    ADD CONSTRAINT integration_credentials_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: jira_connections jira_connections_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_connections
    ADD CONSTRAINT jira_connections_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: jira_connections jira_connections_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_connections
    ADD CONSTRAINT jira_connections_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: jira_issue_links jira_issue_links_feedback_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_issue_links
    ADD CONSTRAINT jira_issue_links_feedback_id_fkey FOREIGN KEY (feedback_id) REFERENCES public.discovered_feedback(id) ON DELETE CASCADE;


--
-- Name: jira_issue_links jira_issue_links_jira_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_issue_links
    ADD CONSTRAINT jira_issue_links_jira_connection_id_fkey FOREIGN KEY (jira_connection_id) REFERENCES public.jira_connections(id) ON DELETE CASCADE;


--
-- Name: jira_label_mappings jira_label_mappings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_label_mappings
    ADD CONSTRAINT jira_label_mappings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: jira_label_mappings jira_label_mappings_theme_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_label_mappings
    ADD CONSTRAINT jira_label_mappings_theme_id_fkey FOREIGN KEY (theme_id) REFERENCES public.themes(id) ON DELETE CASCADE;


--
-- Name: jira_oauth_states jira_oauth_states_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_oauth_states
    ADD CONSTRAINT jira_oauth_states_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: jira_oauth_states jira_oauth_states_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_oauth_states
    ADD CONSTRAINT jira_oauth_states_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: jira_sync_logs jira_sync_logs_jira_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_sync_logs
    ADD CONSTRAINT jira_sync_logs_jira_connection_id_fkey FOREIGN KEY (jira_connection_id) REFERENCES public.jira_connections(id) ON DELETE CASCADE;


--
-- Name: jira_sync_logs jira_sync_logs_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_sync_logs
    ADD CONSTRAINT jira_sync_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: jira_webhooks jira_webhooks_jira_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jira_webhooks
    ADD CONSTRAINT jira_webhooks_jira_connection_id_fkey FOREIGN KEY (jira_connection_id) REFERENCES public.jira_connections(id) ON DELETE CASCADE;


--
-- Name: launch_boards launch_boards_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_boards
    ADD CONSTRAINT launch_boards_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: launch_boards launch_boards_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_boards
    ADD CONSTRAINT launch_boards_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: launch_checklist_items launch_checklist_items_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_checklist_items
    ADD CONSTRAINT launch_checklist_items_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.launch_boards(id) ON DELETE CASCADE;


--
-- Name: launch_dimensions launch_dimensions_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_dimensions
    ADD CONSTRAINT launch_dimensions_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.launch_boards(id) ON DELETE CASCADE;


--
-- Name: launch_risks launch_risks_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_risks
    ADD CONSTRAINT launch_risks_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.launch_boards(id) ON DELETE CASCADE;


--
-- Name: launch_votes launch_votes_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_votes
    ADD CONSTRAINT launch_votes_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.launch_boards(id) ON DELETE CASCADE;


--
-- Name: launch_votes launch_votes_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.launch_votes
    ADD CONSTRAINT launch_votes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id);


--
-- Name: linear_connections linear_connections_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.linear_connections
    ADD CONSTRAINT linear_connections_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: linear_connections linear_connections_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.linear_connections
    ADD CONSTRAINT linear_connections_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: lovable_generations lovable_generations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lovable_generations
    ADD CONSTRAINT lovable_generations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: lovable_generations lovable_generations_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lovable_generations
    ADD CONSTRAINT lovable_generations_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE SET NULL;


--
-- Name: members members_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.members
    ADD CONSTRAINT members_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: notification_logs notification_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notification_logs
    ADD CONSTRAINT notification_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: persona_embeddings persona_embeddings_persona_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.persona_embeddings
    ADD CONSTRAINT persona_embeddings_persona_id_fkey FOREIGN KEY (persona_id) REFERENCES public.personas(id) ON DELETE CASCADE;


--
-- Name: persona_embeddings persona_embeddings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.persona_embeddings
    ADD CONSTRAINT persona_embeddings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: personas personas_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.personas
    ADD CONSTRAINT personas_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: platform_integrations platform_integrations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.platform_integrations
    ADD CONSTRAINT platform_integrations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: pm_assignments pm_assignments_pm_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pm_assignments
    ADD CONSTRAINT pm_assignments_pm_user_id_fkey FOREIGN KEY (pm_user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: pm_assignments pm_assignments_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pm_assignments
    ADD CONSTRAINT pm_assignments_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: poll_options poll_options_poll_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_options
    ADD CONSTRAINT poll_options_poll_id_fkey FOREIGN KEY (poll_id) REFERENCES public.polls(id) ON DELETE CASCADE;


--
-- Name: poll_votes poll_votes_option_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_votes
    ADD CONSTRAINT poll_votes_option_id_fkey FOREIGN KEY (option_id) REFERENCES public.poll_options(id) ON DELETE CASCADE;


--
-- Name: poll_votes poll_votes_poll_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_votes
    ADD CONSTRAINT poll_votes_poll_id_fkey FOREIGN KEY (poll_id) REFERENCES public.polls(id) ON DELETE CASCADE;


--
-- Name: poll_votes poll_votes_voter_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.poll_votes
    ADD CONSTRAINT poll_votes_voter_id_fkey FOREIGN KEY (voter_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: polls polls_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.polls
    ADD CONSTRAINT polls_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: polls polls_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.polls
    ADD CONSTRAINT polls_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: post_similarities post_similarities_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.post_similarities
    ADD CONSTRAINT post_similarities_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: post_similarities post_similarities_similar_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.post_similarities
    ADD CONSTRAINT post_similarities_similar_post_id_fkey FOREIGN KEY (similar_post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: posts posts_assigned_pm_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_assigned_pm_id_fkey FOREIGN KEY (assigned_pm_id) REFERENCES public.pm_assignments(id) ON DELETE SET NULL;


--
-- Name: posts posts_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.boards(id) ON DELETE CASCADE;


--
-- Name: posts posts_call_record_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_call_record_id_fkey FOREIGN KEY (call_record_id) REFERENCES public.call_records(id) ON DELETE SET NULL;


--
-- Name: posts posts_duplicate_of_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_duplicate_of_fkey FOREIGN KEY (duplicate_of) REFERENCES public.posts(id);


--
-- Name: posts posts_merged_into_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_merged_into_fkey FOREIGN KEY (merged_into) REFERENCES public.posts(id) ON DELETE SET NULL;


--
-- Name: posts posts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: posts posts_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.posts
    ADD CONSTRAINT posts_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: prd_risk_alerts prd_risk_alerts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prd_risk_alerts
    ADD CONSTRAINT prd_risk_alerts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: prd_risk_alerts prd_risk_alerts_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prd_risk_alerts
    ADD CONSTRAINT prd_risk_alerts_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES auth.users(id);


--
-- Name: prd_risk_alerts prd_risk_alerts_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.prd_risk_alerts
    ADD CONSTRAINT prd_risk_alerts_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE CASCADE;


--
-- Name: pre_mortem_analyses pre_mortem_analyses_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pre_mortem_analyses
    ADD CONSTRAINT pre_mortem_analyses_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: pre_mortem_analyses pre_mortem_analyses_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pre_mortem_analyses
    ADD CONSTRAINT pre_mortem_analyses_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE SET NULL;


--
-- Name: product_doc_embeddings product_doc_embeddings_product_doc_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_doc_embeddings
    ADD CONSTRAINT product_doc_embeddings_product_doc_id_fkey FOREIGN KEY (product_doc_id) REFERENCES public.product_documents(id) ON DELETE CASCADE;


--
-- Name: product_doc_embeddings product_doc_embeddings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_doc_embeddings
    ADD CONSTRAINT product_doc_embeddings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: product_documents product_documents_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_documents
    ADD CONSTRAINT product_documents_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: product_documents product_documents_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.product_documents
    ADD CONSTRAINT product_documents_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: project_notification_recipients project_notification_recipients_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_notification_recipients
    ADD CONSTRAINT project_notification_recipients_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: push_subscriptions push_subscriptions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.push_subscriptions
    ADD CONSTRAINT push_subscriptions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: rate_limit_violations rate_limit_violations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_limit_violations
    ADD CONSTRAINT rate_limit_violations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: reasoning_traces reasoning_traces_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reasoning_traces
    ADD CONSTRAINT reasoning_traces_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: reasoning_traces reasoning_traces_triggered_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reasoning_traces
    ADD CONSTRAINT reasoning_traces_triggered_by_fkey FOREIGN KEY (triggered_by) REFERENCES auth.users(id);


--
-- Name: report_executions report_executions_scheduled_report_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.report_executions
    ADD CONSTRAINT report_executions_scheduled_report_id_fkey FOREIGN KEY (scheduled_report_id) REFERENCES public.scheduled_reports(id) ON DELETE CASCADE;


--
-- Name: retro_actions retro_actions_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_actions
    ADD CONSTRAINT retro_actions_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.retro_boards(id) ON DELETE CASCADE;


--
-- Name: retro_actions retro_actions_from_card_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_actions
    ADD CONSTRAINT retro_actions_from_card_id_fkey FOREIGN KEY (from_card_id) REFERENCES public.retro_cards(id) ON DELETE SET NULL;


--
-- Name: retro_boards retro_boards_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_boards
    ADD CONSTRAINT retro_boards_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: retro_boards retro_boards_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_boards
    ADD CONSTRAINT retro_boards_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: retro_card_comments retro_card_comments_card_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_card_comments
    ADD CONSTRAINT retro_card_comments_card_id_fkey FOREIGN KEY (card_id) REFERENCES public.retro_cards(id) ON DELETE CASCADE;


--
-- Name: retro_card_votes retro_card_votes_card_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_card_votes
    ADD CONSTRAINT retro_card_votes_card_id_fkey FOREIGN KEY (card_id) REFERENCES public.retro_cards(id) ON DELETE CASCADE;


--
-- Name: retro_card_votes retro_card_votes_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_card_votes
    ADD CONSTRAINT retro_card_votes_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id);


--
-- Name: retro_cards retro_cards_column_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_cards
    ADD CONSTRAINT retro_cards_column_id_fkey FOREIGN KEY (column_id) REFERENCES public.retro_columns(id) ON DELETE CASCADE;


--
-- Name: retro_cards retro_cards_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_cards
    ADD CONSTRAINT retro_cards_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: retro_columns retro_columns_board_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retro_columns
    ADD CONSTRAINT retro_columns_board_id_fkey FOREIGN KEY (board_id) REFERENCES public.retro_boards(id) ON DELETE CASCADE;


--
-- Name: roadmap_adjustment_history roadmap_adjustment_history_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_history
    ADD CONSTRAINT roadmap_adjustment_history_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_adjustment_history roadmap_adjustment_history_proposal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_history
    ADD CONSTRAINT roadmap_adjustment_history_proposal_id_fkey FOREIGN KEY (proposal_id) REFERENCES public.roadmap_adjustment_proposals(id) ON DELETE CASCADE;


--
-- Name: roadmap_adjustment_history roadmap_adjustment_history_suggestion_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_history
    ADD CONSTRAINT roadmap_adjustment_history_suggestion_id_fkey FOREIGN KEY (suggestion_id) REFERENCES public.roadmap_suggestions(id) ON DELETE CASCADE;


--
-- Name: roadmap_adjustment_proposals roadmap_adjustment_proposals_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_proposals
    ADD CONSTRAINT roadmap_adjustment_proposals_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_adjustment_proposals roadmap_adjustment_proposals_reviewed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_adjustment_proposals
    ADD CONSTRAINT roadmap_adjustment_proposals_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES auth.users(id);


--
-- Name: roadmap_exports roadmap_exports_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_exports
    ADD CONSTRAINT roadmap_exports_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_exports roadmap_exports_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_exports
    ADD CONSTRAINT roadmap_exports_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: roadmap_feedback roadmap_feedback_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_feedback
    ADD CONSTRAINT roadmap_feedback_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: roadmap_generation_logs roadmap_generation_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_generation_logs
    ADD CONSTRAINT roadmap_generation_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_item_embeddings roadmap_item_embeddings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_item_embeddings
    ADD CONSTRAINT roadmap_item_embeddings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_item_embeddings roadmap_item_embeddings_roadmap_item_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_item_embeddings
    ADD CONSTRAINT roadmap_item_embeddings_roadmap_item_id_fkey FOREIGN KEY (roadmap_item_id) REFERENCES public.roadmap_suggestions(id) ON DELETE CASCADE;


--
-- Name: roadmap_priority_history roadmap_priority_history_adjusted_by_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_priority_history
    ADD CONSTRAINT roadmap_priority_history_adjusted_by_user_id_fkey FOREIGN KEY (adjusted_by_user_id) REFERENCES public.users(id) ON DELETE SET NULL;


--
-- Name: roadmap_priority_history roadmap_priority_history_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_priority_history
    ADD CONSTRAINT roadmap_priority_history_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_priority_history roadmap_priority_history_suggestion_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_priority_history
    ADD CONSTRAINT roadmap_priority_history_suggestion_id_fkey FOREIGN KEY (suggestion_id) REFERENCES public.roadmap_suggestions(id) ON DELETE CASCADE;


--
-- Name: roadmap_subscriptions roadmap_subscriptions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_subscriptions
    ADD CONSTRAINT roadmap_subscriptions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_suggestions roadmap_suggestions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_suggestions
    ADD CONSTRAINT roadmap_suggestions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: roadmap_suggestions roadmap_suggestions_theme_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roadmap_suggestions
    ADD CONSTRAINT roadmap_suggestions_theme_id_fkey FOREIGN KEY (theme_id) REFERENCES public.themes(id) ON DELETE CASCADE;


--
-- Name: scheduled_reports scheduled_reports_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.scheduled_reports
    ADD CONSTRAINT scheduled_reports_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: scheduled_reports scheduled_reports_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.scheduled_reports
    ADD CONSTRAINT scheduled_reports_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: security_events security_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_events
    ADD CONSTRAINT security_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE SET NULL;


--
-- Name: security_events security_events_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_events
    ADD CONSTRAINT security_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: sentiment_analysis sentiment_analysis_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_analysis
    ADD CONSTRAINT sentiment_analysis_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: sentiment_forecasts sentiment_forecasts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_forecasts
    ADD CONSTRAINT sentiment_forecasts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: sentiment_history sentiment_history_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sentiment_history
    ADD CONSTRAINT sentiment_history_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: signal_correlations signal_correlations_dismissed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.signal_correlations
    ADD CONSTRAINT signal_correlations_dismissed_by_fkey FOREIGN KEY (dismissed_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: signal_correlations signal_correlations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.signal_correlations
    ADD CONSTRAINT signal_correlations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: signal_events signal_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.signal_events
    ADD CONSTRAINT signal_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: slack_alert_rules slack_alert_rules_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_alert_rules
    ADD CONSTRAINT slack_alert_rules_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: slack_channel_mappings slack_channel_mappings_slack_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_channel_mappings
    ADD CONSTRAINT slack_channel_mappings_slack_connection_id_fkey FOREIGN KEY (slack_connection_id) REFERENCES public.slack_connections(id) ON DELETE CASCADE;


--
-- Name: slack_connections slack_connections_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_connections
    ADD CONSTRAINT slack_connections_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: slack_connections slack_connections_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_connections
    ADD CONSTRAINT slack_connections_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: slack_integration_states slack_integration_states_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_integration_states
    ADD CONSTRAINT slack_integration_states_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: slack_integrations slack_integrations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_integrations
    ADD CONSTRAINT slack_integrations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: slack_interaction_logs slack_interaction_logs_slack_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_interaction_logs
    ADD CONSTRAINT slack_interaction_logs_slack_connection_id_fkey FOREIGN KEY (slack_connection_id) REFERENCES public.slack_connections(id) ON DELETE CASCADE;


--
-- Name: slack_message_logs slack_message_logs_slack_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.slack_message_logs
    ADD CONSTRAINT slack_message_logs_slack_connection_id_fkey FOREIGN KEY (slack_connection_id) REFERENCES public.slack_connections(id) ON DELETE CASCADE;


--
-- Name: smart_replies smart_replies_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.smart_replies
    ADD CONSTRAINT smart_replies_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: spec_context_sources spec_context_sources_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_context_sources
    ADD CONSTRAINT spec_context_sources_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE CASCADE;


--
-- Name: spec_embeddings spec_embeddings_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_embeddings
    ADD CONSTRAINT spec_embeddings_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE CASCADE;


--
-- Name: spec_versions spec_versions_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_versions
    ADD CONSTRAINT spec_versions_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id);


--
-- Name: spec_versions spec_versions_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.spec_versions
    ADD CONSTRAINT spec_versions_spec_id_fkey FOREIGN KEY (spec_id) REFERENCES public.specs(id) ON DELETE CASCADE;


--
-- Name: specs specs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.specs
    ADD CONSTRAINT specs_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id);


--
-- Name: specs specs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.specs
    ADD CONSTRAINT specs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: sprints sprints_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sprints
    ADD CONSTRAINT sprints_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: stakeholder_interests stakeholder_interests_stakeholder_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_interests
    ADD CONSTRAINT stakeholder_interests_stakeholder_id_fkey FOREIGN KEY (stakeholder_id) REFERENCES public.stakeholders(id) ON DELETE CASCADE;


--
-- Name: stakeholder_queries stakeholder_queries_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_queries
    ADD CONSTRAINT stakeholder_queries_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: stakeholder_queries stakeholder_queries_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_queries
    ADD CONSTRAINT stakeholder_queries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: stakeholder_reports stakeholder_reports_stakeholder_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholder_reports
    ADD CONSTRAINT stakeholder_reports_stakeholder_id_fkey FOREIGN KEY (stakeholder_id) REFERENCES public.stakeholders(id) ON DELETE CASCADE;


--
-- Name: stakeholders stakeholders_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stakeholders
    ADD CONSTRAINT stakeholders_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: story_feedback_links story_feedback_links_feedback_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_feedback_links
    ADD CONSTRAINT story_feedback_links_feedback_id_fkey FOREIGN KEY (feedback_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: story_feedback_links story_feedback_links_story_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_feedback_links
    ADD CONSTRAINT story_feedback_links_story_id_fkey FOREIGN KEY (story_id) REFERENCES public.user_stories(id) ON DELETE CASCADE;


--
-- Name: story_generation_logs story_generation_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_generation_logs
    ADD CONSTRAINT story_generation_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: story_generation_logs story_generation_logs_theme_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_generation_logs
    ADD CONSTRAINT story_generation_logs_theme_id_fkey FOREIGN KEY (theme_id) REFERENCES public.themes(id) ON DELETE CASCADE;


--
-- Name: story_generation_logs story_generation_logs_user_story_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_generation_logs
    ADD CONSTRAINT story_generation_logs_user_story_id_fkey FOREIGN KEY (user_story_id) REFERENCES public.user_stories(id) ON DELETE SET NULL;


--
-- Name: story_templates story_templates_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.story_templates
    ADD CONSTRAINT story_templates_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: strategic_recommendations strategic_recommendations_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategic_recommendations
    ADD CONSTRAINT strategic_recommendations_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: strategic_recommendations strategic_recommendations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategic_recommendations
    ADD CONSTRAINT strategic_recommendations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: strategy_shift_events strategy_shift_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategy_shift_events
    ADD CONSTRAINT strategy_shift_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: strategy_shifts strategy_shifts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategy_shifts
    ADD CONSTRAINT strategy_shifts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: strategy_shifts strategy_shifts_reviewed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.strategy_shifts
    ADD CONSTRAINT strategy_shifts_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES auth.users(id);


--
-- Name: stripe_settings stripe_settings_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.stripe_settings
    ADD CONSTRAINT stripe_settings_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: survey_questions survey_questions_survey_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.survey_questions
    ADD CONSTRAINT survey_questions_survey_id_fkey FOREIGN KEY (survey_id) REFERENCES public.surveys(id) ON DELETE CASCADE;


--
-- Name: survey_responses survey_responses_respondent_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.survey_responses
    ADD CONSTRAINT survey_responses_respondent_id_fkey FOREIGN KEY (respondent_id) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: survey_responses survey_responses_survey_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.survey_responses
    ADD CONSTRAINT survey_responses_survey_id_fkey FOREIGN KEY (survey_id) REFERENCES public.surveys(id) ON DELETE CASCADE;


--
-- Name: surveys surveys_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.surveys
    ADD CONSTRAINT surveys_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: surveys surveys_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.surveys
    ADD CONSTRAINT surveys_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: team_capacity team_capacity_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_capacity
    ADD CONSTRAINT team_capacity_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: team_invitations team_invitations_accepted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_accepted_by_fkey FOREIGN KEY (accepted_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: team_invitations team_invitations_invited_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: team_invitations team_invitations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: team_velocity team_velocity_jira_connection_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_velocity
    ADD CONSTRAINT team_velocity_jira_connection_id_fkey FOREIGN KEY (jira_connection_id) REFERENCES public.jira_connections(id) ON DELETE SET NULL;


--
-- Name: team_velocity team_velocity_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_velocity
    ADD CONSTRAINT team_velocity_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: theme_clusters theme_clusters_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.theme_clusters
    ADD CONSTRAINT theme_clusters_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: themes themes_cluster_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.themes
    ADD CONSTRAINT themes_cluster_id_fkey FOREIGN KEY (cluster_id) REFERENCES public.theme_clusters(id) ON DELETE SET NULL;


--
-- Name: themes themes_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.themes
    ADD CONSTRAINT themes_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: timeline_events timeline_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.timeline_events
    ADD CONSTRAINT timeline_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: triage_queue triage_queue_duplicate_of_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.triage_queue
    ADD CONSTRAINT triage_queue_duplicate_of_fkey FOREIGN KEY (duplicate_of) REFERENCES public.posts(id) ON DELETE SET NULL;


--
-- Name: triage_queue triage_queue_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.triage_queue
    ADD CONSTRAINT triage_queue_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: triage_queue triage_queue_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.triage_queue
    ADD CONSTRAINT triage_queue_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: triage_queue triage_queue_suggested_pm_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.triage_queue
    ADD CONSTRAINT triage_queue_suggested_pm_id_fkey FOREIGN KEY (suggested_pm_id) REFERENCES public.pm_assignments(id) ON DELETE SET NULL;


--
-- Name: unified_action_queue unified_action_queue_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: unified_action_queue unified_action_queue_dismissed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_dismissed_by_fkey FOREIGN KEY (dismissed_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: unified_action_queue unified_action_queue_executed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_executed_by_fkey FOREIGN KEY (executed_by) REFERENCES auth.users(id) ON DELETE SET NULL;


--
-- Name: unified_action_queue unified_action_queue_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: unified_action_queue unified_action_queue_related_poll_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_related_poll_id_fkey FOREIGN KEY (related_poll_id) REFERENCES public.polls(id) ON DELETE SET NULL;


--
-- Name: unified_action_queue unified_action_queue_related_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_related_post_id_fkey FOREIGN KEY (related_post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: unified_action_queue unified_action_queue_related_spec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_action_queue
    ADD CONSTRAINT unified_action_queue_related_spec_id_fkey FOREIGN KEY (related_spec_id) REFERENCES public.specs(id) ON DELETE CASCADE;


--
-- Name: unified_feedback_items unified_feedback_items_converted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_converted_by_fkey FOREIGN KEY (converted_by) REFERENCES auth.users(id);


--
-- Name: unified_feedback_items unified_feedback_items_converted_to_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_converted_to_post_id_fkey FOREIGN KEY (converted_to_post_id) REFERENCES public.posts(id) ON DELETE SET NULL;


--
-- Name: unified_feedback_items unified_feedback_items_customer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id) ON DELETE SET NULL;


--
-- Name: unified_feedback_items unified_feedback_items_duplicate_of_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_duplicate_of_fkey FOREIGN KEY (duplicate_of) REFERENCES public.unified_feedback_items(id) ON DELETE SET NULL;


--
-- Name: unified_feedback_items unified_feedback_items_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.feedback_integrations(id) ON DELETE SET NULL;


--
-- Name: unified_feedback_items unified_feedback_items_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: unified_feedback_items unified_feedback_items_read_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_read_by_fkey FOREIGN KEY (read_by) REFERENCES auth.users(id);


--
-- Name: unified_feedback_items unified_feedback_items_replied_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unified_feedback_items
    ADD CONSTRAINT unified_feedback_items_replied_by_fkey FOREIGN KEY (replied_by) REFERENCES auth.users(id);


--
-- Name: unsubscribe_tokens unsubscribe_tokens_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.unsubscribe_tokens
    ADD CONSTRAINT unsubscribe_tokens_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: usage_analytics_events usage_analytics_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.usage_analytics_events
    ADD CONSTRAINT usage_analytics_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: usage_analytics_events usage_analytics_events_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.usage_analytics_events
    ADD CONSTRAINT usage_analytics_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE SET NULL;


--
-- Name: user_intelligence user_intelligence_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_intelligence
    ADD CONSTRAINT user_intelligence_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: user_stories user_stories_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_stories
    ADD CONSTRAINT user_stories_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: user_stories user_stories_sprint_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_stories
    ADD CONSTRAINT user_stories_sprint_id_fkey FOREIGN KEY (sprint_id) REFERENCES public.sprints(id) ON DELETE SET NULL;


--
-- Name: user_stories user_stories_theme_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_stories
    ADD CONSTRAINT user_stories_theme_id_fkey FOREIGN KEY (theme_id) REFERENCES public.themes(id) ON DELETE SET NULL;


--
-- Name: users users_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE;


--
-- Name: votes votes_post_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.votes
    ADD CONSTRAINT votes_post_id_fkey FOREIGN KEY (post_id) REFERENCES public.posts(id) ON DELETE CASCADE;


--
-- Name: webhook_deliveries webhook_deliveries_webhook_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_webhook_id_fkey FOREIGN KEY (webhook_id) REFERENCES public.feedback_webhooks(id) ON DELETE CASCADE;


--
-- Name: workflows workflows_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows
    ADD CONSTRAINT workflows_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;


--
-- Name: discount_codes Admins can manage discount codes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage discount codes" ON public.discount_codes USING ((auth.uid() IN ( SELECT users.id
   FROM auth.users
  WHERE ((users.email)::text = 'your-admin-email@example.com'::text))));


--
-- Name: email_templates Admins can manage email templates for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage email templates for their projects" ON public.email_templates USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: admin_email_preferences Admins can manage their email preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage their email preferences" ON public.admin_email_preferences USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: audit_logs Admins can read audit logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can read audit logs" ON public.audit_logs FOR SELECT USING (((auth.uid() IN ( SELECT (unnest(string_to_array(current_setting('app.admin_user_ids'::text, true), ','::text)))::uuid AS unnest)) OR (EXISTS ( SELECT 1
   FROM auth.users u
  WHERE ((u.id = auth.uid()) AND ((u.email)::text = ANY (string_to_array(current_setting('app.admin_emails'::text, true), ','::text))))))));


--
-- Name: discount_code_usage Admins can view all usage; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all usage" ON public.discount_code_usage USING ((auth.uid() IN ( SELECT users.id
   FROM auth.users
  WHERE ((users.email)::text = 'your-admin-email@example.com'::text))));


--
-- Name: votes Allow anonymous voting; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow anonymous voting" ON public.votes TO anon USING (((anonymous_id IS NOT NULL) OR (ip_address IS NOT NULL))) WITH CHECK (((anonymous_id IS NOT NULL) OR (ip_address IS NOT NULL)));


--
-- Name: feedback_themes Allow authenticated users to delete feedback themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to delete feedback themes" ON public.feedback_themes FOR DELETE TO authenticated USING (true);


--
-- Name: theme_clusters Allow authenticated users to delete theme clusters; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to delete theme clusters" ON public.theme_clusters FOR DELETE TO authenticated USING (true);


--
-- Name: themes Allow authenticated users to delete themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to delete themes" ON public.themes FOR DELETE TO authenticated USING (true);


--
-- Name: feedback_themes Allow authenticated users to insert feedback themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to insert feedback themes" ON public.feedback_themes FOR INSERT TO authenticated WITH CHECK (true);


--
-- Name: sentiment_analysis Allow authenticated users to insert sentiment analysis; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to insert sentiment analysis" ON public.sentiment_analysis FOR INSERT TO authenticated WITH CHECK (true);


--
-- Name: theme_clusters Allow authenticated users to insert theme clusters; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to insert theme clusters" ON public.theme_clusters FOR INSERT TO authenticated WITH CHECK (true);


--
-- Name: themes Allow authenticated users to insert themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to insert themes" ON public.themes FOR INSERT TO authenticated WITH CHECK (true);


--
-- Name: feedback_themes Allow authenticated users to read feedback themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to read feedback themes" ON public.feedback_themes FOR SELECT TO authenticated USING (true);


--
-- Name: sentiment_analysis Allow authenticated users to read sentiment analysis; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to read sentiment analysis" ON public.sentiment_analysis FOR SELECT TO authenticated USING (true);


--
-- Name: theme_clusters Allow authenticated users to read theme clusters; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to read theme clusters" ON public.theme_clusters FOR SELECT TO authenticated USING (true);


--
-- Name: themes Allow authenticated users to read themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to read themes" ON public.themes FOR SELECT TO authenticated USING (true);


--
-- Name: feedback_themes Allow authenticated users to update feedback themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to update feedback themes" ON public.feedback_themes FOR UPDATE TO authenticated USING (true) WITH CHECK (true);


--
-- Name: sentiment_analysis Allow authenticated users to update sentiment analysis; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to update sentiment analysis" ON public.sentiment_analysis FOR UPDATE TO authenticated USING (true) WITH CHECK (true);


--
-- Name: theme_clusters Allow authenticated users to update theme clusters; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to update theme clusters" ON public.theme_clusters FOR UPDATE TO authenticated USING (true) WITH CHECK (true);


--
-- Name: themes Allow authenticated users to update themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated users to update themes" ON public.themes FOR UPDATE TO authenticated USING (true) WITH CHECK (true);


--
-- Name: votes Allow authenticated voting; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow authenticated voting" ON public.votes TO authenticated USING (true) WITH CHECK (true);


--
-- Name: scrape_cache Allow public insert cache; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public insert cache" ON public.scrape_cache FOR INSERT WITH CHECK (true);


--
-- Name: collected_reviews Allow public insert reviews; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public insert reviews" ON public.collected_reviews FOR INSERT WITH CHECK (true);


--
-- Name: competitive_intel_sessions Allow public insert sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public insert sessions" ON public.competitive_intel_sessions FOR INSERT WITH CHECK (true);


--
-- Name: scrape_cache Allow public select cache; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public select cache" ON public.scrape_cache FOR SELECT USING (true);


--
-- Name: collected_reviews Allow public select reviews; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public select reviews" ON public.collected_reviews FOR SELECT USING (true);


--
-- Name: competitive_intel_sessions Allow public select sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public select sessions" ON public.competitive_intel_sessions FOR SELECT USING (true);


--
-- Name: competitive_intel_sessions Allow public update sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow public update sessions" ON public.competitive_intel_sessions FOR UPDATE USING (true);


--
-- Name: feedback_themes Allow service role full access to feedback themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow service role full access to feedback themes" ON public.feedback_themes TO service_role USING (true) WITH CHECK (true);


--
-- Name: sentiment_analysis Allow service role full access to sentiment analysis; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow service role full access to sentiment analysis" ON public.sentiment_analysis TO service_role USING (true) WITH CHECK (true);


--
-- Name: theme_clusters Allow service role full access to theme clusters; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow service role full access to theme clusters" ON public.theme_clusters TO service_role USING (true) WITH CHECK (true);


--
-- Name: themes Allow service role full access to themes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow service role full access to themes" ON public.themes TO service_role USING (true) WITH CHECK (true);


--
-- Name: retro_card_comments Anyone can add comments to cards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can add comments to cards" ON public.retro_card_comments FOR INSERT WITH CHECK (true);


--
-- Name: comments Anyone can create comments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can create comments" ON public.comments FOR INSERT WITH CHECK (true);


--
-- Name: posts Anyone can create posts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can create posts" ON public.posts FOR INSERT WITH CHECK (true);


--
-- Name: projects Anyone can create projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can create projects" ON public.projects FOR INSERT WITH CHECK (true);


--
-- Name: votes Anyone can create votes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can create votes" ON public.votes FOR INSERT WITH CHECK (true);


--
-- Name: comment_mentions Anyone can read mentions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can read mentions" ON public.comment_mentions FOR SELECT USING (true);


--
-- Name: changelog_subscriptions Anyone can subscribe to changelog updates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can subscribe to changelog updates" ON public.changelog_subscriptions FOR INSERT WITH CHECK (true);


--
-- Name: retro_card_comments Anyone can view comments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can view comments" ON public.retro_card_comments FOR SELECT USING (true);


--
-- Name: health_scores Anyone can view shared health scores; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Anyone can view shared health scores" ON public.health_scores FOR SELECT USING ((share_token IS NOT NULL));


--
-- Name: comment_mentions Authenticated users can create mentions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Authenticated users can create mentions" ON public.comment_mentions FOR INSERT WITH CHECK (((auth.role() = 'authenticated'::text) OR (auth.role() = 'anon'::text)));


--
-- Name: health_scores Authenticated users can insert health scores; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Authenticated users can insert health scores" ON public.health_scores FOR INSERT TO authenticated WITH CHECK (true);


--
-- Name: boards Boards are viewable by everyone; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Boards are viewable by everyone" ON public.boards FOR SELECT USING (true);


--
-- Name: comments Comments are viewable by everyone; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Comments are viewable by everyone" ON public.comments FOR SELECT USING (true);


--
-- Name: security_events Only service role can read security events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only service role can read security events" ON public.security_events FOR SELECT TO service_role USING (true);


--
-- Name: posts Posts are viewable by everyone; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Posts are viewable by everyone" ON public.posts FOR SELECT USING (true);


--
-- Name: changelog_releases Project members can delete changelog releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can delete changelog releases" ON public.changelog_releases FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = changelog_releases.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_releases Project members can insert changelog releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can insert changelog releases" ON public.changelog_releases FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = changelog_releases.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_entries Project members can manage changelog entries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can manage changelog entries" ON public.changelog_entries USING ((EXISTS ( SELECT 1
   FROM (public.changelog_releases
     JOIN public.projects ON ((projects.id = changelog_releases.project_id)))
  WHERE ((changelog_releases.id = changelog_entries.release_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_media Project members can manage changelog media; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can manage changelog media" ON public.changelog_media USING ((EXISTS ( SELECT 1
   FROM (public.changelog_releases
     JOIN public.projects ON ((projects.id = changelog_releases.project_id)))
  WHERE ((changelog_releases.id = changelog_media.release_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_feedback_links Project members can manage feedback links; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can manage feedback links" ON public.changelog_feedback_links USING ((EXISTS ( SELECT 1
   FROM (public.changelog_releases
     JOIN public.projects ON ((projects.id = changelog_releases.project_id)))
  WHERE ((changelog_releases.id = changelog_feedback_links.release_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_webhooks Project members can manage webhooks; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can manage webhooks" ON public.changelog_webhooks USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = changelog_webhooks.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_releases Project members can update changelog releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can update changelog releases" ON public.changelog_releases FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = changelog_releases.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: changelog_releases Project members can view all changelog releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project members can view all changelog releases" ON public.changelog_releases FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = changelog_releases.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: members Project owners can add members; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can add members" ON public.members FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = members.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: api_keys Project owners can create API keys; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can create API keys" ON public.api_keys FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = api_keys.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: boards Project owners can create boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can create boards" ON public.boards FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = boards.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discord_integrations Project owners can create discord_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can create discord_integrations" ON public.discord_integrations FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discord_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: gift_subscriptions Project owners can create gifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can create gifts" ON public.gift_subscriptions FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = gift_subscriptions.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_invitations Project owners can create invitations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can create invitations" ON public.team_invitations FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_invitations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: slack_integrations Project owners can create slack_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can create slack_integrations" ON public.slack_integrations FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = slack_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: api_keys Project owners can delete API keys; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete API keys" ON public.api_keys FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = api_keys.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: boards Project owners can delete boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete boards" ON public.boards FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = boards.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discord_integrations Project owners can delete discord_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete discord_integrations" ON public.discord_integrations FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discord_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiments Project owners can delete experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete experiments" ON public.experiments FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = experiments.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_invitations Project owners can delete invitations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete invitations" ON public.team_invitations FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_invitations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: posts Project owners can delete posts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete posts" ON public.posts FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = posts.project_id) AND ((projects.owner_id = auth.uid()) OR (projects.owner_id IS NULL))))));


--
-- Name: projects Project owners can delete projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete projects" ON public.projects FOR DELETE USING (((auth.uid() = owner_id) OR (owner_id IS NULL)));


--
-- Name: slack_integrations Project owners can delete slack_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete slack_integrations" ON public.slack_integrations FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = slack_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: stakeholders Project owners can delete stakeholders; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can delete stakeholders" ON public.stakeholders FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = stakeholders.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiments Project owners can insert experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can insert experiments" ON public.experiments FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = experiments.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_metadata Project owners can insert feedback metadata; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can insert feedback metadata" ON public.feedback_metadata FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (public.posts p
     JOIN public.projects pr ON ((p.project_id = pr.id)))
  WHERE ((p.id = feedback_metadata.post_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: stakeholders Project owners can insert stakeholders; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can insert stakeholders" ON public.stakeholders FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = stakeholders.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_capacity Project owners can manage capacity for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can manage capacity for their projects" ON public.team_capacity USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = team_capacity.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: customer_profiles Project owners can manage customer profiles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can manage customer profiles" ON public.customer_profiles USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = customer_profiles.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feature_impact_history Project owners can manage impact history for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can manage impact history for their projects" ON public.feature_impact_history USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = feature_impact_history.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: integration_credentials Project owners can manage integration credentials; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can manage integration credentials" ON public.integration_credentials USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = integration_credentials.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: stakeholder_interests Project owners can manage stakeholder interests; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can manage stakeholder interests" ON public.stakeholder_interests USING ((EXISTS ( SELECT 1
   FROM (public.stakeholders s
     JOIN public.projects p ON ((p.id = s.project_id)))
  WHERE ((s.id = stakeholder_interests.stakeholder_id) AND (p.owner_id = auth.uid())))));


--
-- Name: members Project owners can remove members; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can remove members" ON public.members FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = members.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: boards Project owners can update boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update boards" ON public.boards FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = boards.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discord_integrations Project owners can update discord_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update discord_integrations" ON public.discord_integrations FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discord_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiments Project owners can update experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update experiments" ON public.experiments FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = experiments.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_metadata Project owners can update feedback metadata; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update feedback metadata" ON public.feedback_metadata FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.posts p
     JOIN public.projects pr ON ((p.project_id = pr.id)))
  WHERE ((p.id = feedback_metadata.post_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: gift_subscriptions Project owners can update gifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update gifts" ON public.gift_subscriptions FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = gift_subscriptions.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_invitations Project owners can update invitations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update invitations" ON public.team_invitations FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_invitations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: members Project owners can update members; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update members" ON public.members FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = members.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: posts Project owners can update posts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update posts" ON public.posts FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = posts.project_id) AND ((projects.owner_id = auth.uid()) OR (projects.owner_id IS NULL))))));


--
-- Name: projects Project owners can update projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update projects" ON public.projects FOR UPDATE USING (((auth.uid() = owner_id) OR (owner_id IS NULL)));


--
-- Name: slack_integrations Project owners can update slack_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update slack_integrations" ON public.slack_integrations FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = slack_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: stakeholder_reports Project owners can update stakeholder reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update stakeholder reports" ON public.stakeholder_reports FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.stakeholders s
     JOIN public.projects p ON ((p.id = s.project_id)))
  WHERE ((s.id = stakeholder_reports.stakeholder_id) AND (p.owner_id = auth.uid())))));


--
-- Name: stakeholders Project owners can update stakeholders; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can update stakeholders" ON public.stakeholders FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = stakeholders.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: api_keys Project owners can view API keys; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view API keys" ON public.api_keys FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = api_keys.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: ai_usage_tracking Project owners can view ai_usage; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view ai_usage" ON public.ai_usage_tracking FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = ai_usage_tracking.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_capacity Project owners can view capacity for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view capacity for their projects" ON public.team_capacity FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = team_capacity.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: discord_integration_states Project owners can view discord_integration_states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view discord_integration_states" ON public.discord_integration_states FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discord_integration_states.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discord_integrations Project owners can view discord_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view discord_integrations" ON public.discord_integrations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discord_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiments Project owners can view experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view experiments" ON public.experiments FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = experiments.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_metadata Project owners can view feedback metadata; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view feedback metadata" ON public.feedback_metadata FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.posts p
     JOIN public.projects pr ON ((p.project_id = pr.id)))
  WHERE ((p.id = feedback_metadata.post_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: gift_subscriptions Project owners can view gifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view gifts" ON public.gift_subscriptions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = gift_subscriptions.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feature_impact_history Project owners can view impact history for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view impact history for their projects" ON public.feature_impact_history FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = feature_impact_history.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: team_invitations Project owners can view invitations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view invitations" ON public.team_invitations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_invitations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: members Project owners can view members; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view members" ON public.members FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = members.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: notification_logs Project owners can view notification logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view notification logs" ON public.notification_logs FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: push_subscriptions Project owners can view project subscriptions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view project subscriptions" ON public.push_subscriptions FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: slack_integration_states Project owners can view slack_integration_states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view slack_integration_states" ON public.slack_integration_states FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = slack_integration_states.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: slack_integrations Project owners can view slack_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view slack_integrations" ON public.slack_integrations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = slack_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: stakeholder_reports Project owners can view stakeholder reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view stakeholder reports" ON public.stakeholder_reports FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.stakeholders s
     JOIN public.projects p ON ((p.id = s.project_id)))
  WHERE ((s.id = stakeholder_reports.stakeholder_id) AND (p.owner_id = auth.uid())))));


--
-- Name: stakeholders Project owners can view stakeholders; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view stakeholders" ON public.stakeholders FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = stakeholders.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: billing_events Project owners can view their billing events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view their billing events" ON public.billing_events FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE (((projects.stripe_customer_id)::text = (billing_events.stripe_customer_id)::text) AND (projects.owner_id = auth.uid())))));


--
-- Name: vote_metadata Project owners can view vote metadata; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners can view vote metadata" ON public.vote_metadata FOR SELECT USING ((EXISTS ( SELECT 1
   FROM ((public.votes v
     JOIN public.posts p ON ((v.post_id = p.id)))
     JOIN public.projects pr ON ((p.project_id = pr.id)))
  WHERE ((v.id = vote_metadata.vote_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: project_notification_recipients Project owners manage notification recipients; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Project owners manage notification recipients" ON public.project_notification_recipients USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = project_notification_recipients.project_id) AND (p.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = project_notification_recipients.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: unsubscribe_tokens Public access to unsubscribe tokens; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public access to unsubscribe tokens" ON public.unsubscribe_tokens FOR SELECT USING (true);


--
-- Name: unsubscribe_tokens Public access to update unsubscribe tokens; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public access to update unsubscribe tokens" ON public.unsubscribe_tokens FOR UPDATE USING (true);


--
-- Name: changelog_entries Public can view entries for published releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public can view entries for published releases" ON public.changelog_entries FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.changelog_releases
  WHERE ((changelog_releases.id = changelog_entries.release_id) AND (changelog_releases.is_published = true)))));


--
-- Name: changelog_feedback_links Public can view feedback links for published releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public can view feedback links for published releases" ON public.changelog_feedback_links FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.changelog_releases
  WHERE ((changelog_releases.id = changelog_feedback_links.release_id) AND (changelog_releases.is_published = true)))));


--
-- Name: changelog_media Public can view media for published releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public can view media for published releases" ON public.changelog_media FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.changelog_releases
  WHERE ((changelog_releases.id = changelog_media.release_id) AND (changelog_releases.is_published = true)))));


--
-- Name: changelog_releases Public can view published changelog releases; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public can view published changelog releases" ON public.changelog_releases FOR SELECT USING ((is_published = true));


--
-- Name: roadmap_roast_sessions Public insert access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public insert access" ON public.roadmap_roast_sessions FOR INSERT WITH CHECK (true);


--
-- Name: projects Public projects are viewable by everyone; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public projects are viewable by everyone" ON public.projects FOR SELECT USING (true);


--
-- Name: roadmap_roast_sessions Read by session token; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Read by session token" ON public.roadmap_roast_sessions FOR SELECT USING (((session_token = ((current_setting('request.headers'::text, true))::json ->> 'session_token'::text)) OR (session_token IS NOT NULL)));


--
-- Name: roadmap_roast_sessions Read via share token; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Read via share token" ON public.roadmap_roast_sessions FOR SELECT USING (((share_token IS NOT NULL) AND (is_public = true)));


--
-- Name: gift_subscriptions Recipients can claim gifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Recipients can claim gifts" ON public.gift_subscriptions FOR UPDATE USING (((recipient_id = auth.uid()) OR ((recipient_email)::text = auth.email())));


--
-- Name: gift_subscriptions Recipients can view own gifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Recipients can view own gifts" ON public.gift_subscriptions FOR SELECT USING (((recipient_id = auth.uid()) OR ((recipient_email)::text = auth.email())));


--
-- Name: linear_connections Service role can access all linear connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can access all linear connections" ON public.linear_connections USING ((auth.role() = 'service_role'::text));


--
-- Name: analytics_events Service role can insert analytics events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert analytics events" ON public.analytics_events FOR INSERT TO service_role WITH CHECK (true);


--
-- Name: retro_cards Service role can insert cards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert cards" ON public.retro_cards FOR INSERT TO service_role WITH CHECK (true);


--
-- Name: security_events Service role can insert security events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert security events" ON public.security_events FOR INSERT TO service_role WITH CHECK (true);


--
-- Name: smart_replies Service role can insert smart replies; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert smart replies" ON public.smart_replies FOR INSERT WITH CHECK (true);


--
-- Name: customer_sync_log Service role can insert sync logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert sync logs" ON public.customer_sync_log FOR INSERT WITH CHECK (true);


--
-- Name: experiment_sync_log Service role can insert sync logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert sync logs" ON public.experiment_sync_log FOR INSERT WITH CHECK (true);


--
-- Name: ai_usage_tracking Service role can manage ai_usage_tracking; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage ai_usage_tracking" ON public.ai_usage_tracking USING (true) WITH CHECK (true);


--
-- Name: user_intelligence Service role can manage all intelligence data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage all intelligence data" ON public.user_intelligence USING (true);


--
-- Name: analytics_events Service role can manage analytics events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage analytics events" ON public.analytics_events TO service_role USING (true);


--
-- Name: discord_integration_states Service role can manage discord_integration_states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage discord_integration_states" ON public.discord_integration_states USING (true) WITH CHECK (true);


--
-- Name: discord_integrations Service role can manage discord_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage discord_integrations" ON public.discord_integrations USING (true) WITH CHECK (true);


--
-- Name: members Service role can manage members; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage members" ON public.members USING (true) WITH CHECK (true);


--
-- Name: slack_integration_states Service role can manage slack_integration_states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage slack_integration_states" ON public.slack_integration_states USING (true) WITH CHECK (true);


--
-- Name: slack_integrations Service role can manage slack_integrations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage slack_integrations" ON public.slack_integrations USING (true) WITH CHECK (true);


--
-- Name: team_invitations Service role can manage team_invitations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage team_invitations" ON public.team_invitations USING (true) WITH CHECK (true);


--
-- Name: votes Service role can manage votes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can manage votes" ON public.votes TO service_role USING (true) WITH CHECK (true);


--
-- Name: retro_cards Service role can update cards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can update cards" ON public.retro_cards FOR UPDATE TO service_role USING (true) WITH CHECK (true);


--
-- Name: email_batches Service role full access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access" ON public.email_batches USING (true) WITH CHECK (true);


--
-- Name: email_logs Service role full access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access" ON public.email_logs USING (true) WITH CHECK (true);


--
-- Name: email_preferences Service role full access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access" ON public.email_preferences USING (true) WITH CHECK (true);


--
-- Name: agent_memory Service role full access to agent_memory; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to agent_memory" ON public.agent_memory TO service_role USING (true) WITH CHECK (true);


--
-- Name: competitor_alerts Service role full access to alerts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to alerts" ON public.competitor_alerts USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: ask_analytics Service role full access to ask_analytics; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to ask_analytics" ON public.ask_analytics TO service_role USING (true) WITH CHECK (true);


--
-- Name: ask_conversations Service role full access to ask_conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to ask_conversations" ON public.ask_conversations TO service_role USING (true) WITH CHECK (true);


--
-- Name: ask_messages Service role full access to ask_messages; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to ask_messages" ON public.ask_messages TO service_role USING (true) WITH CHECK (true);


--
-- Name: call_ingests Service role full access to call_ingests; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to call_ingests" ON public.call_ingests TO service_role USING (true) WITH CHECK (true);


--
-- Name: call_records Service role full access to call_records; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to call_records" ON public.call_records TO service_role USING (true) WITH CHECK (true);


--
-- Name: competitor_embeddings Service role full access to competitor embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to competitor embeddings" ON public.competitor_embeddings TO service_role USING (true) WITH CHECK (true);


--
-- Name: customer_profiles Service role full access to customer profiles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to customer profiles" ON public.customer_profiles TO service_role USING (true) WITH CHECK (true);


--
-- Name: daily_briefings Service role full access to daily briefings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to daily briefings" ON public.daily_briefings TO service_role USING (true) WITH CHECK (true);


--
-- Name: feedback_embeddings Service role full access to feedback_embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to feedback_embeddings" ON public.feedback_embeddings TO service_role USING (true) WITH CHECK (true);


--
-- Name: feedback_metadata Service role full access to feedback_metadata; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to feedback_metadata" ON public.feedback_metadata USING (true) WITH CHECK (true);


--
-- Name: health_scores Service role full access to health_scores; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to health_scores" ON public.health_scores TO service_role USING (true) WITH CHECK (true);


--
-- Name: integration_credentials Service role full access to integration credentials; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to integration credentials" ON public.integration_credentials TO service_role USING (true) WITH CHECK (true);


--
-- Name: jira_connections Service role full access to jira_connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to jira_connections" ON public.jira_connections TO service_role USING (true) WITH CHECK (true);


--
-- Name: jira_issue_links Service role full access to jira_issue_links; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to jira_issue_links" ON public.jira_issue_links TO service_role USING (true) WITH CHECK (true);


--
-- Name: jira_label_mappings Service role full access to jira_label_mappings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to jira_label_mappings" ON public.jira_label_mappings TO service_role USING (true) WITH CHECK (true);


--
-- Name: jira_oauth_states Service role full access to jira_oauth_states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to jira_oauth_states" ON public.jira_oauth_states TO service_role USING (true) WITH CHECK (true);


--
-- Name: jira_sync_logs Service role full access to jira_sync_logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to jira_sync_logs" ON public.jira_sync_logs TO service_role USING (true) WITH CHECK (true);


--
-- Name: jira_webhooks Service role full access to jira_webhooks; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to jira_webhooks" ON public.jira_webhooks TO service_role USING (true) WITH CHECK (true);


--
-- Name: competitor_job_postings Service role full access to job postings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to job postings" ON public.competitor_job_postings USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: lovable_generations Service role full access to lovable_generations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to lovable_generations" ON public.lovable_generations USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: persona_embeddings Service role full access to persona embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to persona embeddings" ON public.persona_embeddings TO service_role USING (true) WITH CHECK (true);


--
-- Name: personas Service role full access to personas; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to personas" ON public.personas TO service_role USING (true) WITH CHECK (true);


--
-- Name: pre_mortem_analyses Service role full access to pre_mortem_analyses; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to pre_mortem_analyses" ON public.pre_mortem_analyses USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: product_doc_embeddings Service role full access to product doc embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to product doc embeddings" ON public.product_doc_embeddings TO service_role USING (true) WITH CHECK (true);


--
-- Name: product_documents Service role full access to product documents; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to product documents" ON public.product_documents TO service_role USING (true) WITH CHECK (true);


--
-- Name: project_notification_recipients Service role full access to project_notification_recipients; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to project_notification_recipients" ON public.project_notification_recipients USING ((auth.role() = 'service_role'::text)) WITH CHECK ((auth.role() = 'service_role'::text));


--
-- Name: roadmap_item_embeddings Service role full access to roadmap embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to roadmap embeddings" ON public.roadmap_item_embeddings TO service_role USING (true) WITH CHECK (true);


--
-- Name: spec_context_sources Service role full access to spec_context_sources; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to spec_context_sources" ON public.spec_context_sources TO service_role USING (true) WITH CHECK (true);


--
-- Name: spec_embeddings Service role full access to spec_embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to spec_embeddings" ON public.spec_embeddings TO service_role USING (true) WITH CHECK (true);


--
-- Name: spec_versions Service role full access to spec_versions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to spec_versions" ON public.spec_versions TO service_role USING (true) WITH CHECK (true);


--
-- Name: specs Service role full access to specs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to specs" ON public.specs TO service_role USING (true) WITH CHECK (true);


--
-- Name: sprints Service role full access to sprints; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to sprints" ON public.sprints TO service_role USING (true) WITH CHECK (true);


--
-- Name: story_feedback_links Service role full access to story feedback links; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to story feedback links" ON public.story_feedback_links TO service_role USING (true) WITH CHECK (true);


--
-- Name: story_generation_logs Service role full access to story generation logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to story generation logs" ON public.story_generation_logs TO service_role USING (true) WITH CHECK (true);


--
-- Name: story_templates Service role full access to story templates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to story templates" ON public.story_templates TO service_role USING (true) WITH CHECK (true);


--
-- Name: strategy_shift_events Service role full access to strategy_shift_events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to strategy_shift_events" ON public.strategy_shift_events TO service_role USING (true) WITH CHECK (true);


--
-- Name: strategy_shifts Service role full access to strategy_shifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to strategy_shifts" ON public.strategy_shifts USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: team_velocity Service role full access to team_velocity; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to team_velocity" ON public.team_velocity TO service_role USING (true) WITH CHECK (true);


--
-- Name: usage_analytics_events Service role full access to usage_analytics_events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to usage_analytics_events" ON public.usage_analytics_events TO service_role USING (true) WITH CHECK (true);


--
-- Name: user_stories Service role full access to user stories; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to user stories" ON public.user_stories TO service_role USING (true) WITH CHECK (true);


--
-- Name: user_preferences Service role full access to user_preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to user_preferences" ON public.user_preferences TO service_role USING (true) WITH CHECK (true);


--
-- Name: vote_metadata Service role full access to vote_metadata; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to vote_metadata" ON public.vote_metadata USING (true) WITH CHECK (true);


--
-- Name: ai_weight_preferences Service role full access to weight preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to weight preferences" ON public.ai_weight_preferences USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: workflows Service role full access to workflows; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role full access to workflows" ON public.workflows USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: events Service role has full access to events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to events" ON public.events TO service_role USING (true) WITH CHECK (true);


--
-- Name: feature_impact_history Service role has full access to feature impact history; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to feature impact history" ON public.feature_impact_history USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: feature_outcomes Service role has full access to feature outcomes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to feature outcomes" ON public.feature_outcomes USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: roadmap_priority_history Service role has full access to priority history; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to priority history" ON public.roadmap_priority_history USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: team_capacity Service role has full access to team capacity; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to team capacity" ON public.team_capacity USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: webhook_deliveries Service role has full access to webhook_deliveries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role has full access to webhook_deliveries" ON public.webhook_deliveries USING (((auth.jwt() ->> 'role'::text) = 'service_role'::text)) WITH CHECK (((auth.jwt() ->> 'role'::text) = 'service_role'::text));


--
-- Name: stakeholders Stakeholders can view their own data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Stakeholders can view their own data" ON public.stakeholders FOR SELECT USING (((access_token IS NOT NULL) AND (token_expires_at > now())));


--
-- Name: stakeholder_reports Stakeholders can view their own reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Stakeholders can view their own reports" ON public.stakeholder_reports FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.stakeholders s
  WHERE ((s.id = stakeholder_reports.stakeholder_id) AND (s.access_token IS NOT NULL) AND (s.token_expires_at > now())))));


--
-- Name: ask_action_executions System can insert action executions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert action executions" ON public.ask_action_executions FOR INSERT WITH CHECK (true);


--
-- Name: action_recommendations System can insert action recommendations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert action recommendations" ON public.action_recommendations FOR INSERT WITH CHECK (true);


--
-- Name: deal_autopsies System can insert autopsies; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert autopsies" ON public.deal_autopsies FOR INSERT WITH CHECK (true);


--
-- Name: competitive_events System can insert competitive events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert competitive events" ON public.competitive_events FOR INSERT WITH CHECK (true);


--
-- Name: competitive_mentions System can insert competitive mentions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert competitive mentions" ON public.competitive_mentions FOR INSERT WITH CHECK (true);


--
-- Name: competitor_events System can insert competitor events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert competitor events" ON public.competitor_events FOR INSERT WITH CHECK (true);


--
-- Name: competitors System can insert competitors; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert competitors" ON public.competitors FOR INSERT WITH CHECK (true);


--
-- Name: deals System can insert deals; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert deals" ON public.deals FOR INSERT WITH CHECK (true);


--
-- Name: discovered_feedback System can insert discovered feedback; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert discovered feedback" ON public.discovered_feedback FOR INSERT WITH CHECK (true);


--
-- Name: experiment_results System can insert experiment results; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert experiment results" ON public.experiment_results FOR INSERT WITH CHECK (true);


--
-- Name: feature_gaps System can insert feature gaps; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert feature gaps" ON public.feature_gaps FOR INSERT WITH CHECK (true);


--
-- Name: hunter_logs System can insert hunter logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert hunter logs" ON public.hunter_logs FOR INSERT WITH CHECK (true);


--
-- Name: ask_proactive_suggestions System can insert proactive suggestions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert proactive suggestions" ON public.ask_proactive_suggestions FOR INSERT WITH CHECK (true);


--
-- Name: prd_risk_alerts System can insert risk alerts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert risk alerts" ON public.prd_risk_alerts FOR INSERT WITH CHECK (true);


--
-- Name: post_similarities System can insert similarities; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert similarities" ON public.post_similarities FOR INSERT WITH CHECK (true);


--
-- Name: stakeholder_interests System can insert stakeholder interests; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert stakeholder interests" ON public.stakeholder_interests FOR INSERT WITH CHECK (true);


--
-- Name: stakeholder_reports System can insert stakeholder reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert stakeholder reports" ON public.stakeholder_reports FOR INSERT WITH CHECK (true);


--
-- Name: story_generation_logs System can insert story generation logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert story generation logs" ON public.story_generation_logs FOR INSERT WITH CHECK (true);


--
-- Name: strategic_recommendations System can insert strategic recommendations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert strategic recommendations" ON public.strategic_recommendations FOR INSERT WITH CHECK (true);


--
-- Name: users System can insert users; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert users" ON public.users FOR INSERT WITH CHECK (true);


--
-- Name: deal_battlecards System can manage battlecards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can manage battlecards" ON public.deal_battlecards USING (true);


--
-- Name: deal_digest_subscriptions System can manage digest subscriptions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can manage digest subscriptions" ON public.deal_digest_subscriptions USING (true);


--
-- Name: experiment_embeddings System can manage experiment embeddings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can manage experiment embeddings" ON public.experiment_embeddings WITH CHECK (true);


--
-- Name: deal_autopsies System can update autopsies; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can update autopsies" ON public.deal_autopsies FOR UPDATE USING (true);


--
-- Name: competitive_mentions System can update competitive mentions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can update competitive mentions" ON public.competitive_mentions FOR UPDATE USING (true);


--
-- Name: competitor_events System can update competitor events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can update competitor events" ON public.competitor_events FOR UPDATE USING (true);


--
-- Name: competitors System can update competitors; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can update competitors" ON public.competitors FOR UPDATE USING (true);


--
-- Name: deals System can update deals; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can update deals" ON public.deals FOR UPDATE USING (true);


--
-- Name: audio_briefings Users can access their project audio; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can access their project audio" ON public.audio_briefings USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: agent_memory Users can create agent memory for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create agent memory for their projects" ON public.agent_memory FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = agent_memory.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: ask_analytics Users can create analytics for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create analytics for their projects" ON public.ask_analytics FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = ask_analytics.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: spec_context_sources Users can create context sources for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create context sources for their projects" ON public.spec_context_sources FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (public.specs
     JOIN public.projects ON ((specs.project_id = projects.id)))
  WHERE ((specs.id = spec_context_sources.spec_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: ask_conversations Users can create conversations in their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create conversations in their projects" ON public.ask_conversations FOR INSERT WITH CHECK (((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = ask_conversations.project_id) AND (projects.owner_id = auth.uid())))) AND (user_id = auth.uid())));


--
-- Name: domain_verifications Users can create domain verifications; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create domain verifications" ON public.domain_verifications FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feedback_embeddings Users can create embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create embeddings for their projects" ON public.feedback_embeddings FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feedback_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_adjustment_history Users can create history for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create history for their projects" ON public.roadmap_adjustment_history FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: launch_boards Users can create launch boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create launch boards for their projects" ON public.launch_boards FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: lovable_generations Users can create lovable generations for own projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create lovable generations for own projects" ON public.lovable_generations FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: ask_messages Users can create messages in their conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create messages in their conversations" ON public.ask_messages FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.ask_conversations
  WHERE ((ask_conversations.id = ask_messages.conversation_id) AND (ask_conversations.user_id = auth.uid())))));


--
-- Name: pre_mortem_analyses Users can create pre-mortems for own projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create pre-mortems for own projects" ON public.pre_mortem_analyses FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: roadmap_adjustment_proposals Users can create proposals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create proposals for their projects" ON public.roadmap_adjustment_proposals FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: retro_boards Users can create retro boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create retro boards for their projects" ON public.retro_boards FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: roadmap_exports Users can create roadmap exports for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create roadmap exports for their projects" ON public.roadmap_exports FOR INSERT WITH CHECK (((user_id = auth.uid()) AND (project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())))));


--
-- Name: ask_scheduled_queries Users can create scheduled queries for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create scheduled queries for their projects" ON public.ask_scheduled_queries FOR INSERT WITH CHECK (((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())
UNION
 SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))) AND (user_id = auth.uid())));


--
-- Name: scheduled_reports Users can create scheduled reports for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create scheduled reports for their projects" ON public.scheduled_reports FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = scheduled_reports.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: strategy_shifts Users can create shifts for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create shifts for their projects" ON public.strategy_shifts FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: spec_embeddings Users can create spec embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create spec embeddings for their projects" ON public.spec_embeddings FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (public.specs
     JOIN public.projects ON ((specs.project_id = projects.id)))
  WHERE ((specs.id = spec_embeddings.spec_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: spec_versions Users can create spec versions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create spec versions for their projects" ON public.spec_versions FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (public.specs
     JOIN public.projects ON ((specs.project_id = projects.id)))
  WHERE ((specs.id = spec_versions.spec_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: specs Users can create specs in their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create specs in their projects" ON public.specs FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = specs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: timeline_events Users can create timeline events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create timeline events for their projects" ON public.timeline_events FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = timeline_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_webhooks Users can create webhooks for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create webhooks for their projects" ON public.feedback_webhooks FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: workflows Users can create workflows for own projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create workflows for own projects" ON public.workflows FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: jira_issue_links Users can delete Jira issue links for their connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete Jira issue links for their connections" ON public.jira_issue_links FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.jira_connections jc
  WHERE ((jc.id = jira_issue_links.jira_connection_id) AND (jc.user_id = auth.uid())))));


--
-- Name: jira_label_mappings Users can delete Jira label mappings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete Jira label mappings for their projects" ON public.jira_label_mappings FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = jira_label_mappings.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: action_recommendations Users can delete action recommendations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete action recommendations for their projects" ON public.action_recommendations FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = action_recommendations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deal_autopsies Users can delete autopsies for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete autopsies for their projects" ON public.deal_autopsies FOR DELETE USING ((EXISTS ( SELECT 1
   FROM (public.deals d
     JOIN public.projects p ON ((p.id = d.project_id)))
  WHERE ((d.id = deal_autopsies.deal_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitive_events Users can delete competitive events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete competitive events for their projects" ON public.competitive_events FOR DELETE USING ((EXISTS ( SELECT 1
   FROM (public.competitors c
     JOIN public.projects p ON ((p.id = c.project_id)))
  WHERE ((c.id = competitive_events.competitor_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitive_mentions Users can delete competitive mentions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete competitive mentions for their projects" ON public.competitive_mentions FOR DELETE USING ((EXISTS ( SELECT 1
   FROM (public.discovered_feedback df
     JOIN public.projects p ON ((p.id = df.project_id)))
  WHERE ((df.id = competitive_mentions.feedback_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitor_events Users can delete competitor events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete competitor events for their projects" ON public.competitor_events FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitor_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: competitors Users can delete competitors for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete competitors for their projects" ON public.competitors FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitors.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deals Users can delete deals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete deals for their projects" ON public.deals FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deals.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discovered_feedback Users can delete discovered feedback for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete discovered feedback for their projects" ON public.discovered_feedback FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discovered_feedback.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_embeddings Users can delete embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete embeddings for their projects" ON public.feedback_embeddings FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feedback_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feature_gaps Users can delete feature gaps for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete feature gaps for their projects" ON public.feature_gaps FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feature_gaps.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: hunter_configs Users can delete hunter configs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete hunter configs for their projects" ON public.hunter_configs FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = hunter_configs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: launch_boards Users can delete launch boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete launch boards for their projects" ON public.launch_boards FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: comment_mentions Users can delete mentions from their comments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete mentions from their comments" ON public.comment_mentions FOR DELETE USING ((comment_id IN ( SELECT comments.id
   FROM public.comments
  WHERE ((comments.author_email)::text = ((current_setting('request.jwt.claims'::text, true))::json ->> 'email'::text)))));


--
-- Name: ask_messages Users can delete messages in their conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete messages in their conversations" ON public.ask_messages FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.ask_conversations
  WHERE ((ask_conversations.id = ask_messages.conversation_id) AND (ask_conversations.user_id = auth.uid())))));


--
-- Name: feature_outcomes Users can delete outcomes for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete outcomes for their projects" ON public.feature_outcomes FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = feature_outcomes.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: domain_verifications Users can delete own domain verifications; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete own domain verifications" ON public.domain_verifications FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: pre_mortem_analyses Users can delete own project pre-mortems; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete own project pre-mortems" ON public.pre_mortem_analyses FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: platform_integrations Users can delete platform integrations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete platform integrations for their projects" ON public.platform_integrations FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = platform_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: retro_boards Users can delete retro boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete retro boards for their projects" ON public.retro_boards FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: prd_risk_alerts Users can delete risk alerts for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete risk alerts for their projects" ON public.prd_risk_alerts FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = prd_risk_alerts.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_suggestions Users can delete roadmap suggestions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete roadmap suggestions for their projects" ON public.roadmap_suggestions FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: specs Users can delete specs in their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete specs in their projects" ON public.specs FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = specs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: sprints Users can delete sprints for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete sprints for their projects" ON public.sprints FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = sprints.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: story_feedback_links Users can delete story feedback links for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete story feedback links for their projects" ON public.story_feedback_links FOR DELETE USING ((EXISTS ( SELECT 1
   FROM (public.user_stories us
     JOIN public.projects p ON ((us.project_id = p.id)))
  WHERE ((us.id = story_feedback_links.story_id) AND (p.owner_id = auth.uid())))));


--
-- Name: story_templates Users can delete story templates for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete story templates for their projects" ON public.story_templates FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = story_templates.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: strategic_recommendations Users can delete strategic recommendations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete strategic recommendations for their projects" ON public.strategic_recommendations FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = strategic_recommendations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: jira_connections Users can delete their own Jira connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own Jira connections" ON public.jira_connections FOR DELETE USING ((user_id = auth.uid()));


--
-- Name: slack_connections Users can delete their own Slack connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own Slack connections" ON public.slack_connections FOR DELETE USING (((user_id = auth.uid()) OR (project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['owner'::character varying, 'admin'::character varying])::text[])))))));


--
-- Name: comments Users can delete their own comments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own comments" ON public.comments FOR DELETE USING (((auth.uid() = author_id) OR (author_id IS NULL)));


--
-- Name: ask_conversations Users can delete their own conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own conversations" ON public.ask_conversations FOR DELETE USING ((user_id = auth.uid()));


--
-- Name: linear_connections Users can delete their own linear connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own linear connections" ON public.linear_connections FOR DELETE USING ((auth.uid() = user_id));


--
-- Name: roadmap_exports Users can delete their own roadmap exports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own roadmap exports" ON public.roadmap_exports FOR DELETE USING ((user_id = auth.uid()));


--
-- Name: ask_scheduled_queries Users can delete their own scheduled queries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own scheduled queries" ON public.ask_scheduled_queries FOR DELETE USING ((user_id = auth.uid()));


--
-- Name: scheduled_reports Users can delete their own scheduled reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own scheduled reports" ON public.scheduled_reports FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = scheduled_reports.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: votes Users can delete their own votes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete their own votes" ON public.votes FOR DELETE USING (((auth.uid() = user_id) OR (user_id IS NULL)));


--
-- Name: user_stories Users can delete user stories for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete user stories for their projects" ON public.user_stories FOR DELETE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = user_stories.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_webhooks Users can delete webhooks for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can delete webhooks for their projects" ON public.feedback_webhooks FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: jira_issue_links Users can insert Jira issue links for their connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert Jira issue links for their connections" ON public.jira_issue_links FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.jira_connections jc
  WHERE ((jc.id = jira_issue_links.jira_connection_id) AND (jc.user_id = auth.uid())))));


--
-- Name: jira_label_mappings Users can insert Jira label mappings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert Jira label mappings for their projects" ON public.jira_label_mappings FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = jira_label_mappings.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: call_ingests Users can insert call_ingests for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert call_ingests for their projects" ON public.call_ingests FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = call_ingests.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: call_records Users can insert call_records for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert call_records for their projects" ON public.call_records FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = call_records.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: competitors Users can insert competitors for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert competitors for their projects" ON public.competitors FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitors.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: daily_briefings Users can insert daily briefings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert daily briefings for their projects" ON public.daily_briefings FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = daily_briefings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deals Users can insert deals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert deals for their projects" ON public.deals FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deals.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: events Users can insert events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert events for their projects" ON public.events FOR INSERT TO authenticated WITH CHECK ((((metadata ->> 'project_id'::text) IS NULL) OR (EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = ((events.metadata ->> 'project_id'::text))::uuid) AND (projects.owner_id = auth.uid()))))));


--
-- Name: roadmap_generation_logs Users can insert generation logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert generation logs for their projects" ON public.roadmap_generation_logs FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: hunter_configs Users can insert hunter configs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert hunter configs for their projects" ON public.hunter_configs FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = hunter_configs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feature_outcomes Users can insert outcomes for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert outcomes for their projects" ON public.feature_outcomes FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = feature_outcomes.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: platform_integrations Users can insert platform integrations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert platform integrations for their projects" ON public.platform_integrations FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = platform_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_suggestions Users can insert roadmap suggestions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert roadmap suggestions for their projects" ON public.roadmap_suggestions FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: sprints Users can insert sprints for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert sprints for their projects" ON public.sprints FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = sprints.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: story_feedback_links Users can insert story feedback links for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert story feedback links for their projects" ON public.story_feedback_links FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (public.user_stories us
     JOIN public.projects p ON ((us.project_id = p.id)))
  WHERE ((us.id = story_feedback_links.story_id) AND (p.owner_id = auth.uid())))));


--
-- Name: story_templates Users can insert story templates for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert story templates for their projects" ON public.story_templates FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = story_templates.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_velocity Users can insert team velocity for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert team velocity for their projects" ON public.team_velocity FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_velocity.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: jira_connections Users can insert their own Jira connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own Jira connections" ON public.jira_connections FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: jira_oauth_states Users can insert their own OAuth states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own OAuth states" ON public.jira_oauth_states FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: slack_connections Users can insert their own Slack connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own Slack connections" ON public.slack_connections FOR INSERT WITH CHECK (((user_id = auth.uid()) AND (project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())))));


--
-- Name: linear_connections Users can insert their own linear connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own linear connections" ON public.linear_connections FOR INSERT WITH CHECK ((auth.uid() = user_id));


--
-- Name: user_preferences Users can insert their own preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own preferences" ON public.user_preferences FOR INSERT TO authenticated WITH CHECK ((user_id = auth.uid()));


--
-- Name: stakeholder_queries Users can insert their own queries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert their own queries" ON public.stakeholder_queries FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: usage_analytics_events Users can insert usage analytics for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert usage analytics for their projects" ON public.usage_analytics_events FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = usage_analytics_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: user_stories Users can insert user stories for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert user stories for their projects" ON public.user_stories FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = user_stories.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: retro_actions Users can manage actions for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage actions for their boards" ON public.retro_actions USING ((board_id IN ( SELECT retro_boards.id
   FROM public.retro_boards
  WHERE (retro_boards.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: slack_alert_rules Users can manage alert rules for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage alert rules for their projects" ON public.slack_alert_rules USING ((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['owner'::character varying, 'admin'::character varying])::text[]))))));


--
-- Name: retro_card_votes Users can manage card votes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage card votes" ON public.retro_card_votes USING ((card_id IN ( SELECT retro_cards.id
   FROM public.retro_cards
  WHERE (retro_cards.column_id IN ( SELECT retro_columns.id
           FROM public.retro_columns
          WHERE (retro_columns.board_id IN ( SELECT retro_boards.id
                   FROM public.retro_boards
                  WHERE (retro_boards.project_id IN ( SELECT projects.id
                           FROM public.projects
                          WHERE (projects.owner_id = auth.uid()))))))))));


--
-- Name: retro_cards Users can manage cards for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage cards for their boards" ON public.retro_cards USING ((column_id IN ( SELECT retro_columns.id
   FROM public.retro_columns
  WHERE (retro_columns.board_id IN ( SELECT retro_boards.id
           FROM public.retro_boards
          WHERE (retro_boards.project_id IN ( SELECT projects.id
                   FROM public.projects
                  WHERE (projects.owner_id = auth.uid()))))))));


--
-- Name: slack_channel_mappings Users can manage channel mappings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage channel mappings for their projects" ON public.slack_channel_mappings USING ((slack_connection_id IN ( SELECT slack_connections.id
   FROM public.slack_connections
  WHERE (slack_connections.project_id IN ( SELECT members.project_id
           FROM public.members
          WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['owner'::character varying, 'admin'::character varying])::text[]))))))));


--
-- Name: launch_checklist_items Users can manage checklist for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage checklist for their boards" ON public.launch_checklist_items USING ((board_id IN ( SELECT launch_boards.id
   FROM public.launch_boards
  WHERE (launch_boards.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: retro_columns Users can manage columns for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage columns for their boards" ON public.retro_columns USING ((board_id IN ( SELECT retro_boards.id
   FROM public.retro_boards
  WHERE (retro_boards.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: competitor_embeddings Users can manage competitor embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage competitor embeddings for their projects" ON public.competitor_embeddings USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitor_embeddings.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitor_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deal_digest_subscriptions Users can manage digests for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage digests for their projects" ON public.deal_digest_subscriptions USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deal_digest_subscriptions.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: launch_dimensions Users can manage dimensions for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage dimensions for their boards" ON public.launch_dimensions USING ((board_id IN ( SELECT launch_boards.id
   FROM public.launch_boards
  WHERE (launch_boards.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: experiment_learnings Users can manage learnings for their experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage learnings for their experiments" ON public.experiment_learnings USING ((EXISTS ( SELECT 1
   FROM (public.experiments e
     JOIN public.projects p ON ((p.id = e.project_id)))
  WHERE ((e.id = experiment_learnings.experiment_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitor_monitoring_config Users can manage monitoring config for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage monitoring config for their projects" ON public.competitor_monitoring_config USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: persona_embeddings Users can manage persona embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage persona embeddings for their projects" ON public.persona_embeddings USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = persona_embeddings.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = persona_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: personas Users can manage personas for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage personas for their projects" ON public.personas USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = personas.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = personas.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: product_doc_embeddings Users can manage product doc embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage product doc embeddings for their projects" ON public.product_doc_embeddings USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = product_doc_embeddings.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = product_doc_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: product_documents Users can manage product documents for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage product documents for their projects" ON public.product_documents USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = product_documents.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = product_documents.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: launch_risks Users can manage risks for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage risks for their boards" ON public.launch_risks USING ((board_id IN ( SELECT launch_boards.id
   FROM public.launch_boards
  WHERE (launch_boards.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: roadmap_item_embeddings Users can manage roadmap embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage roadmap embeddings for their projects" ON public.roadmap_item_embeddings USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = roadmap_item_embeddings.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = roadmap_item_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiment_snapshots Users can manage snapshots for their experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage snapshots for their experiments" ON public.experiment_snapshots USING ((EXISTS ( SELECT 1
   FROM (public.experiments e
     JOIN public.projects p ON ((p.id = e.project_id)))
  WHERE ((e.id = experiment_snapshots.experiment_id) AND (p.owner_id = auth.uid())))));


--
-- Name: push_subscriptions Users can manage their own push subscriptions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their own push subscriptions" ON public.push_subscriptions USING ((user_id = auth.uid()));


--
-- Name: changelog_subscriptions Users can manage their own subscriptions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their own subscriptions" ON public.changelog_subscriptions USING ((((email)::text = (auth.jwt() ->> 'email'::text)) OR (EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = changelog_subscriptions.project_id) AND (projects.owner_id = auth.uid()))))));


--
-- Name: ai_weight_preferences Users can manage their own weight preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their own weight preferences" ON public.ai_weight_preferences USING (((user_id = auth.uid()) OR (project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())))));


--
-- Name: timeline_events Users can manage timeline events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage timeline events for their projects" ON public.timeline_events USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = timeline_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: launch_votes Users can manage votes for their boards; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage votes for their boards" ON public.launch_votes USING ((board_id IN ( SELECT launch_boards.id
   FROM public.launch_boards
  WHERE (launch_boards.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: events Users can read events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can read events for their projects" ON public.events FOR SELECT TO authenticated USING ((((metadata ->> 'project_id'::text) IS NULL) OR (EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = ((events.metadata ->> 'project_id'::text))::uuid) AND (projects.owner_id = auth.uid()))))));


--
-- Name: jira_issue_links Users can update Jira issue links for their connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update Jira issue links for their connections" ON public.jira_issue_links FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.jira_connections jc
  WHERE ((jc.id = jira_issue_links.jira_connection_id) AND (jc.user_id = auth.uid())))));


--
-- Name: jira_label_mappings Users can update Jira label mappings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update Jira label mappings for their projects" ON public.jira_label_mappings FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = jira_label_mappings.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: action_recommendations Users can update action recommendations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update action recommendations for their projects" ON public.action_recommendations FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = action_recommendations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: agent_memory Users can update agent memory for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update agent memory for their projects" ON public.agent_memory FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = agent_memory.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = agent_memory.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: competitor_alerts Users can update alerts for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update alerts for their projects" ON public.competitor_alerts FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: deal_battlecards Users can update battlecards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update battlecards for their projects" ON public.deal_battlecards FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deal_battlecards.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: call_ingests Users can update call_ingests for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update call_ingests for their projects" ON public.call_ingests FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = call_ingests.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: call_records Users can update call_records for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update call_records for their projects" ON public.call_records FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = call_records.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: competitive_events Users can update competitive events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update competitive events for their projects" ON public.competitive_events FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.competitors c
     JOIN public.projects p ON ((p.id = c.project_id)))
  WHERE ((c.id = competitive_events.competitor_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitors Users can update competitors for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update competitors for their projects" ON public.competitors FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitors.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: daily_briefings Users can update daily briefings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update daily briefings for their projects" ON public.daily_briefings FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = daily_briefings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deals Users can update deals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update deals for their projects" ON public.deals FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deals.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discovered_feedback Users can update discovered feedback for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update discovered feedback for their projects" ON public.discovered_feedback FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discovered_feedback.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_embeddings Users can update embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update embeddings for their projects" ON public.feedback_embeddings FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feedback_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feature_gaps Users can update feature gaps for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update feature gaps for their projects" ON public.feature_gaps FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feature_gaps.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: hunter_configs Users can update hunter configs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update hunter configs for their projects" ON public.hunter_configs FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = hunter_configs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: launch_boards Users can update launch boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update launch boards for their projects" ON public.launch_boards FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: ask_messages Users can update messages in their conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update messages in their conversations" ON public.ask_messages FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.ask_conversations
  WHERE ((ask_conversations.id = ask_messages.conversation_id) AND (ask_conversations.user_id = auth.uid())))));


--
-- Name: feature_outcomes Users can update outcomes for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update outcomes for their projects" ON public.feature_outcomes FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = feature_outcomes.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: users Users can update own data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own data" ON public.users FOR UPDATE USING ((auth.uid() = id));


--
-- Name: domain_verifications Users can update own domain verifications; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own domain verifications" ON public.domain_verifications FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: users Users can update own profile; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own profile" ON public.users FOR UPDATE USING ((auth.uid() = id));


--
-- Name: pre_mortem_analyses Users can update own project pre-mortems; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own project pre-mortems" ON public.pre_mortem_analyses FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: workflows Users can update own project workflows; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own project workflows" ON public.workflows FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: platform_integrations Users can update platform integrations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update platform integrations for their projects" ON public.platform_integrations FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = platform_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: ask_proactive_suggestions Users can update proactive suggestions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update proactive suggestions for their projects" ON public.ask_proactive_suggestions FOR UPDATE USING ((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())
UNION
 SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: roadmap_adjustment_proposals Users can update proposals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update proposals for their projects" ON public.roadmap_adjustment_proposals FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: experiment_results Users can update results for their experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update results for their experiments" ON public.experiment_results FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.experiments e
     JOIN public.projects p ON ((p.id = e.project_id)))
  WHERE ((e.id = experiment_results.experiment_id) AND (p.owner_id = auth.uid())))));


--
-- Name: retro_boards Users can update retro boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update retro boards for their projects" ON public.retro_boards FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: prd_risk_alerts Users can update risk alerts for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update risk alerts for their projects" ON public.prd_risk_alerts FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = prd_risk_alerts.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_suggestions Users can update roadmap suggestions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update roadmap suggestions for their projects" ON public.roadmap_suggestions FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: post_similarities Users can update similarities for their project posts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update similarities for their project posts" ON public.post_similarities FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM ((public.posts p
     JOIN public.boards b ON ((p.board_id = b.id)))
     JOIN public.projects pr ON ((b.project_id = pr.id)))
  WHERE ((p.id = post_similarities.post_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: smart_replies Users can update smart replies; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update smart replies" ON public.smart_replies FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.posts p
     JOIN public.projects pr ON ((p.project_id = pr.id)))
  WHERE ((p.id = smart_replies.post_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: specs Users can update specs in their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update specs in their projects" ON public.specs FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = specs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: sprints Users can update sprints for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update sprints for their projects" ON public.sprints FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = sprints.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: story_templates Users can update story templates for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update story templates for their projects" ON public.story_templates FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = story_templates.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: strategic_recommendations Users can update strategic recommendations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update strategic recommendations for their projects" ON public.strategic_recommendations FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = strategic_recommendations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_velocity Users can update team velocity for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update team velocity for their projects" ON public.team_velocity FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_velocity.project_id) AND (projects.owner_id = auth.uid()))))) WITH CHECK ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_velocity.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: jira_connections Users can update their own Jira connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own Jira connections" ON public.jira_connections FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: jira_oauth_states Users can update their own OAuth states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own OAuth states" ON public.jira_oauth_states FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: slack_connections Users can update their own Slack connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own Slack connections" ON public.slack_connections FOR UPDATE USING (((user_id = auth.uid()) OR (project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['owner'::character varying, 'admin'::character varying])::text[])))))));


--
-- Name: comments Users can update their own comments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own comments" ON public.comments FOR UPDATE USING (((auth.uid() = author_id) OR (author_id IS NULL)));


--
-- Name: ask_conversations Users can update their own conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own conversations" ON public.ask_conversations FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: linear_connections Users can update their own linear connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own linear connections" ON public.linear_connections FOR UPDATE USING ((auth.uid() = user_id));


--
-- Name: user_preferences Users can update their own preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own preferences" ON public.user_preferences FOR UPDATE TO authenticated USING ((user_id = auth.uid())) WITH CHECK ((user_id = auth.uid()));


--
-- Name: stakeholder_queries Users can update their own queries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own queries" ON public.stakeholder_queries FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: roadmap_exports Users can update their own roadmap exports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own roadmap exports" ON public.roadmap_exports FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: ask_scheduled_queries Users can update their own scheduled queries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own scheduled queries" ON public.ask_scheduled_queries FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: scheduled_reports Users can update their own scheduled reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their own scheduled reports" ON public.scheduled_reports FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = scheduled_reports.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: strategy_shifts Users can update their project shifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their project shifts" ON public.strategy_shifts FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: user_stories Users can update user stories for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update user stories for their projects" ON public.user_stories FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = user_stories.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_webhooks Users can update webhooks for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update webhooks for their projects" ON public.feedback_webhooks FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: discount_code_usage Users can use discount codes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can use discount codes" ON public.discount_code_usage FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: jira_issue_links Users can view Jira issue links for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view Jira issue links for their projects" ON public.jira_issue_links FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.jira_connections jc
  WHERE ((jc.id = jira_issue_links.jira_connection_id) AND (jc.user_id = auth.uid())))));


--
-- Name: jira_label_mappings Users can view Jira label mappings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view Jira label mappings for their projects" ON public.jira_label_mappings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = jira_label_mappings.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: jira_sync_logs Users can view Jira sync logs for their connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view Jira sync logs for their connections" ON public.jira_sync_logs FOR SELECT USING (((jira_connection_id IS NULL) OR (EXISTS ( SELECT 1
   FROM public.jira_connections jc
  WHERE ((jc.id = jira_sync_logs.jira_connection_id) AND (jc.user_id = auth.uid()))))));


--
-- Name: jira_webhooks Users can view Jira webhooks for their connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view Jira webhooks for their connections" ON public.jira_webhooks FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.jira_connections jc
  WHERE ((jc.id = jira_webhooks.jira_connection_id) AND (jc.user_id = auth.uid())))));


--
-- Name: ask_action_executions Users can view action executions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view action executions for their projects" ON public.ask_action_executions FOR SELECT USING ((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())
UNION
 SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: action_recommendations Users can view action recommendations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view action recommendations for their projects" ON public.action_recommendations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = action_recommendations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: discount_codes Users can view active discount codes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view active discount codes" ON public.discount_codes FOR SELECT USING (((is_active = true) AND ((now() >= valid_from) AND (now() <= COALESCE(valid_until, (now() + '1 year'::interval))))));


--
-- Name: agent_memory Users can view agent memory for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view agent memory for their projects" ON public.agent_memory FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = agent_memory.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: slack_alert_rules Users can view alert rules for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view alert rules for their projects" ON public.slack_alert_rules FOR SELECT USING ((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: competitor_alerts Users can view alerts for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view alerts for their projects" ON public.competitor_alerts FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: ask_analytics Users can view analytics for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view analytics for their projects" ON public.ask_analytics FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = ask_analytics.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deal_autopsies Users can view autopsies for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view autopsies for their projects" ON public.deal_autopsies FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.deals d
     JOIN public.projects p ON ((p.id = d.project_id)))
  WHERE ((d.id = deal_autopsies.deal_id) AND (p.owner_id = auth.uid())))));


--
-- Name: deal_battlecards Users can view battlecards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view battlecards for their projects" ON public.deal_battlecards FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deal_battlecards.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: call_ingests Users can view call_ingests for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view call_ingests for their projects" ON public.call_ingests FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = call_ingests.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: call_records Users can view call_records for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view call_records for their projects" ON public.call_records FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = call_records.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: slack_channel_mappings Users can view channel mappings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view channel mappings for their projects" ON public.slack_channel_mappings FOR SELECT USING ((slack_connection_id IN ( SELECT slack_connections.id
   FROM public.slack_connections
  WHERE ((slack_connections.user_id = auth.uid()) OR (slack_connections.project_id IN ( SELECT members.project_id
           FROM public.members
          WHERE (members.user_id = auth.uid())))))));


--
-- Name: competitive_events Users can view competitive events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view competitive events for their projects" ON public.competitive_events FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.competitors c
     JOIN public.projects p ON ((p.id = c.project_id)))
  WHERE ((c.id = competitive_events.competitor_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitive_mentions Users can view competitive mentions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view competitive mentions for their projects" ON public.competitive_mentions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.discovered_feedback df
     JOIN public.projects p ON ((p.id = df.project_id)))
  WHERE ((df.id = competitive_mentions.feedback_id) AND (p.owner_id = auth.uid())))));


--
-- Name: competitor_embeddings Users can view competitor embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view competitor embeddings for their projects" ON public.competitor_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitor_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: competitor_events Users can view competitor events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view competitor events for their projects" ON public.competitor_events FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitor_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: competitors Users can view competitors for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view competitors for their projects" ON public.competitors FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = competitors.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: spec_context_sources Users can view context sources for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view context sources for their projects" ON public.spec_context_sources FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.specs
     JOIN public.projects ON ((specs.project_id = projects.id)))
  WHERE ((specs.id = spec_context_sources.spec_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: daily_briefings Users can view daily briefings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view daily briefings for their projects" ON public.daily_briefings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = daily_briefings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: deals Users can view deals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view deals for their projects" ON public.deals FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = deals.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: webhook_deliveries Users can view delivery logs for their webhooks; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view delivery logs for their webhooks" ON public.webhook_deliveries FOR SELECT USING ((webhook_id IN ( SELECT feedback_webhooks.id
   FROM public.feedback_webhooks
  WHERE (feedback_webhooks.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: discovered_feedback Users can view discovered feedback for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view discovered feedback for their projects" ON public.discovered_feedback FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = discovered_feedback.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiment_embeddings Users can view embeddings for their experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view embeddings for their experiments" ON public.experiment_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.experiments e
     JOIN public.projects p ON ((p.id = e.project_id)))
  WHERE ((e.id = experiment_embeddings.experiment_id) AND (p.owner_id = auth.uid())))));


--
-- Name: feedback_embeddings Users can view embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view embeddings for their projects" ON public.feedback_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feedback_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: report_executions Users can view execution history for their reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view execution history for their reports" ON public.report_executions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.scheduled_reports sr
     JOIN public.projects p ON ((p.id = sr.project_id)))
  WHERE ((sr.id = report_executions.scheduled_report_id) AND (p.owner_id = auth.uid())))));


--
-- Name: feature_gaps Users can view feature gaps for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view feature gaps for their projects" ON public.feature_gaps FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = feature_gaps.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_generation_logs Users can view generation logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view generation logs for their projects" ON public.roadmap_generation_logs FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: roadmap_adjustment_history Users can view history for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view history for their projects" ON public.roadmap_adjustment_history FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: hunter_configs Users can view hunter configs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view hunter configs for their projects" ON public.hunter_configs FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = hunter_configs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: hunter_logs Users can view hunter logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view hunter logs for their projects" ON public.hunter_logs FOR SELECT USING (((project_id IS NULL) OR (EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = hunter_logs.project_id) AND (projects.owner_id = auth.uid()))))));


--
-- Name: slack_interaction_logs Users can view interaction logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view interaction logs for their projects" ON public.slack_interaction_logs FOR SELECT USING ((slack_connection_id IN ( SELECT slack_connections.id
   FROM public.slack_connections
  WHERE (slack_connections.project_id IN ( SELECT members.project_id
           FROM public.members
          WHERE (members.user_id = auth.uid()))))));


--
-- Name: competitor_job_postings Users can view job postings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view job postings for their projects" ON public.competitor_job_postings FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: launch_boards Users can view launch boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view launch boards for their projects" ON public.launch_boards FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: slack_message_logs Users can view message logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view message logs for their projects" ON public.slack_message_logs FOR SELECT USING ((slack_connection_id IN ( SELECT slack_connections.id
   FROM public.slack_connections
  WHERE (slack_connections.project_id IN ( SELECT members.project_id
           FROM public.members
          WHERE (members.user_id = auth.uid()))))));


--
-- Name: ask_messages Users can view messages in their conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view messages in their conversations" ON public.ask_messages FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.ask_conversations
  WHERE ((ask_conversations.id = ask_messages.conversation_id) AND (ask_conversations.user_id = auth.uid())))));


--
-- Name: feature_outcomes Users can view outcomes for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view outcomes for their projects" ON public.feature_outcomes FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = feature_outcomes.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: domain_verifications Users can view own domain verifications; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own domain verifications" ON public.domain_verifications FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: user_intelligence Users can view own intelligence data; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own intelligence data" ON public.user_intelligence FOR SELECT USING ((auth.uid() = user_id));


--
-- Name: users Users can view own profile; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own profile" ON public.users FOR SELECT USING ((auth.uid() = id));


--
-- Name: lovable_generations Users can view own project lovable generations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own project lovable generations" ON public.lovable_generations FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: pre_mortem_analyses Users can view own project pre-mortems; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own project pre-mortems" ON public.pre_mortem_analyses FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: workflows Users can view own project workflows; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own project workflows" ON public.workflows FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: discount_code_usage Users can view own usage; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own usage" ON public.discount_code_usage FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: persona_embeddings Users can view persona embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view persona embeddings for their projects" ON public.persona_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = persona_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: personas Users can view personas for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view personas for their projects" ON public.personas FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = personas.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: platform_integrations Users can view platform integrations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view platform integrations for their projects" ON public.platform_integrations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = platform_integrations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_priority_history Users can view priority history for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view priority history for their projects" ON public.roadmap_priority_history FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = roadmap_priority_history.project_id) AND (p.owner_id = auth.uid())))));


--
-- Name: ask_proactive_suggestions Users can view proactive suggestions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view proactive suggestions for their projects" ON public.ask_proactive_suggestions FOR SELECT USING ((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())
UNION
 SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: product_doc_embeddings Users can view product doc embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view product doc embeddings for their projects" ON public.product_doc_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = product_doc_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: product_documents Users can view product documents for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view product documents for their projects" ON public.product_documents FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = product_documents.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_adjustment_proposals Users can view proposals for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view proposals for their projects" ON public.roadmap_adjustment_proposals FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: experiment_results Users can view results for their experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view results for their experiments" ON public.experiment_results FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.experiments e
     JOIN public.projects p ON ((p.id = e.project_id)))
  WHERE ((e.id = experiment_results.experiment_id) AND (p.owner_id = auth.uid())))));


--
-- Name: retro_boards Users can view retro boards for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view retro boards for their projects" ON public.retro_boards FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: prd_risk_alerts Users can view risk alerts for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view risk alerts for their projects" ON public.prd_risk_alerts FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = prd_risk_alerts.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_item_embeddings Users can view roadmap embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view roadmap embeddings for their projects" ON public.roadmap_item_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = roadmap_item_embeddings.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: roadmap_suggestions Users can view roadmap suggestions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view roadmap suggestions for their projects" ON public.roadmap_suggestions FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: ask_scheduled_queries Users can view scheduled queries for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view scheduled queries for their projects" ON public.ask_scheduled_queries FOR SELECT USING ((project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())
UNION
 SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: sentiment_history Users can view sentiment history for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view sentiment history for their projects" ON public.sentiment_history FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = sentiment_history.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: post_similarities Users can view similarities for their project posts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view similarities for their project posts" ON public.post_similarities FOR SELECT USING ((EXISTS ( SELECT 1
   FROM ((public.posts p
     JOIN public.boards b ON ((p.board_id = b.id)))
     JOIN public.projects pr ON ((b.project_id = pr.id)))
  WHERE (((p.id = post_similarities.post_id) OR (p.id = post_similarities.similar_post_id)) AND (pr.owner_id = auth.uid())))));


--
-- Name: smart_replies Users can view smart replies for their project posts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view smart replies for their project posts" ON public.smart_replies FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.posts p
     JOIN public.projects pr ON ((p.project_id = pr.id)))
  WHERE ((p.id = smart_replies.post_id) AND (pr.owner_id = auth.uid())))));


--
-- Name: spec_embeddings Users can view spec embeddings for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view spec embeddings for their projects" ON public.spec_embeddings FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.specs
     JOIN public.projects ON ((specs.project_id = projects.id)))
  WHERE ((specs.id = spec_embeddings.spec_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: spec_versions Users can view spec versions for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view spec versions for their projects" ON public.spec_versions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.specs
     JOIN public.projects ON ((specs.project_id = projects.id)))
  WHERE ((specs.id = spec_versions.spec_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: specs Users can view specs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view specs for their projects" ON public.specs FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = specs.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: sprints Users can view sprints for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view sprints for their projects" ON public.sprints FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = sprints.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: story_feedback_links Users can view story feedback links for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view story feedback links for their projects" ON public.story_feedback_links FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_stories us
     JOIN public.projects p ON ((us.project_id = p.id)))
  WHERE ((us.id = story_feedback_links.story_id) AND (p.owner_id = auth.uid())))));


--
-- Name: story_generation_logs Users can view story generation logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view story generation logs for their projects" ON public.story_generation_logs FOR SELECT USING (((project_id IS NULL) OR (EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = story_generation_logs.project_id) AND (projects.owner_id = auth.uid()))))));


--
-- Name: story_templates Users can view story templates for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view story templates for their projects" ON public.story_templates FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = story_templates.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: strategic_recommendations Users can view strategic recommendations for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view strategic recommendations for their projects" ON public.strategic_recommendations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = strategic_recommendations.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: experiment_sync_log Users can view sync logs for their experiments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view sync logs for their experiments" ON public.experiment_sync_log FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.experiments e
     JOIN public.projects p ON ((p.id = e.project_id)))
  WHERE ((e.id = experiment_sync_log.experiment_id) AND (p.owner_id = auth.uid())))));


--
-- Name: customer_sync_log Users can view sync logs for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view sync logs for their projects" ON public.customer_sync_log FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = customer_sync_log.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: team_velocity Users can view team velocity for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view team velocity for their projects" ON public.team_velocity FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = team_velocity.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: jira_connections Users can view their own Jira connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own Jira connections" ON public.jira_connections FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: jira_oauth_states Users can view their own OAuth states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own OAuth states" ON public.jira_oauth_states FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: slack_connections Users can view their own Slack connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own Slack connections" ON public.slack_connections FOR SELECT USING (((user_id = auth.uid()) OR (project_id IN ( SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid())))));


--
-- Name: ask_conversations Users can view their own conversations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own conversations" ON public.ask_conversations FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: linear_connections Users can view their own linear connections; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own linear connections" ON public.linear_connections FOR SELECT USING ((auth.uid() = user_id));


--
-- Name: user_preferences Users can view their own preferences; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own preferences" ON public.user_preferences FOR SELECT TO authenticated USING ((user_id = auth.uid()));


--
-- Name: stakeholder_queries Users can view their own queries; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own queries" ON public.stakeholder_queries FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: roadmap_exports Users can view their own roadmap exports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own roadmap exports" ON public.roadmap_exports FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: scheduled_reports Users can view their own scheduled reports; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own scheduled reports" ON public.scheduled_reports FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = scheduled_reports.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: analytics_events Users can view their project analytics; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their project analytics" ON public.analytics_events FOR SELECT TO authenticated USING ((project_id IN ( SELECT p.id
   FROM (public.projects p
     JOIN public.members m ON ((p.id = m.project_id)))
  WHERE (m.user_id = auth.uid()))));


--
-- Name: strategy_shifts Users can view their project shifts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their project shifts" ON public.strategy_shifts FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: strategy_shift_events Users can view their project strategy events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their project strategy events" ON public.strategy_shift_events FOR SELECT TO authenticated USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: timeline_events Users can view timeline events for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view timeline events for their projects" ON public.timeline_events FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = timeline_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: usage_analytics_events Users can view usage analytics for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view usage analytics for their projects" ON public.usage_analytics_events FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = usage_analytics_events.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: user_stories Users can view user stories for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view user stories for their projects" ON public.user_stories FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.projects
  WHERE ((projects.id = user_stories.project_id) AND (projects.owner_id = auth.uid())))));


--
-- Name: feedback_webhooks Users can view webhooks for their projects; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view webhooks for their projects" ON public.feedback_webhooks FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: votes Votes are viewable by everyone; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Votes are viewable by everyone" ON public.votes FOR SELECT USING (true);


--
-- Name: account_billing_profiles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_billing_profiles ENABLE ROW LEVEL SECURITY;

--
-- Name: unified_action_queue action_queue_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY action_queue_delete_policy ON public.unified_action_queue FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: unified_action_queue action_queue_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY action_queue_insert_policy ON public.unified_action_queue FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: unified_action_queue action_queue_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY action_queue_select_policy ON public.unified_action_queue FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: unified_action_queue action_queue_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY action_queue_update_policy ON public.unified_action_queue FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: action_recommendations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.action_recommendations ENABLE ROW LEVEL SECURITY;

--
-- Name: admin_email_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.admin_email_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: agent_memory; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.agent_memory ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_usage_tracking; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_usage_tracking ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_weight_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_weight_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: churn_alert_rules alert_rules_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY alert_rules_all ON public.churn_alert_rules USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = 'admin'::text)))));


--
-- Name: churn_alert_rules alert_rules_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY alert_rules_select ON public.churn_alert_rules FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: analytics_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.analytics_events ENABLE ROW LEVEL SECURITY;

--
-- Name: anomaly_detections; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.anomaly_detections ENABLE ROW LEVEL SECURITY;

--
-- Name: anomaly_detections anomaly_detections_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY anomaly_detections_delete_policy ON public.anomaly_detections FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: anomaly_detections anomaly_detections_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY anomaly_detections_insert_policy ON public.anomaly_detections FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: anomaly_detections anomaly_detections_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY anomaly_detections_select_policy ON public.anomaly_detections FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: anomaly_detections anomaly_detections_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY anomaly_detections_update_policy ON public.anomaly_detections FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: api_keys; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.api_keys ENABLE ROW LEVEL SECURITY;

--
-- Name: ask_action_executions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ask_action_executions ENABLE ROW LEVEL SECURITY;

--
-- Name: ask_analytics; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ask_analytics ENABLE ROW LEVEL SECURITY;

--
-- Name: ask_conversations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ask_conversations ENABLE ROW LEVEL SECURITY;

--
-- Name: ask_messages; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ask_messages ENABLE ROW LEVEL SECURITY;

--
-- Name: ask_proactive_suggestions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ask_proactive_suggestions ENABLE ROW LEVEL SECURITY;

--
-- Name: ask_scheduled_queries; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ask_scheduled_queries ENABLE ROW LEVEL SECURITY;

--
-- Name: audio_briefings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.audio_briefings ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: billing_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.billing_events ENABLE ROW LEVEL SECURITY;

--
-- Name: boards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.boards ENABLE ROW LEVEL SECURITY;

--
-- Name: brief_schedules; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.brief_schedules ENABLE ROW LEVEL SECURITY;

--
-- Name: brief_schedules brief_schedules_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY brief_schedules_all ON public.brief_schedules USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = 'admin'::text)))));


--
-- Name: brief_schedules brief_schedules_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY brief_schedules_select ON public.brief_schedules FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: brief_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.brief_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: brief_templates brief_templates_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY brief_templates_all ON public.brief_templates USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['admin'::character varying, 'editor'::character varying])::text[]))))));


--
-- Name: brief_templates brief_templates_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY brief_templates_select ON public.brief_templates FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: call_ingests; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.call_ingests ENABLE ROW LEVEL SECURITY;

--
-- Name: call_records; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.call_records ENABLE ROW LEVEL SECURITY;

--
-- Name: changelog_entries; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.changelog_entries ENABLE ROW LEVEL SECURITY;

--
-- Name: changelog_feedback_links; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.changelog_feedback_links ENABLE ROW LEVEL SECURITY;

--
-- Name: changelog_media; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.changelog_media ENABLE ROW LEVEL SECURITY;

--
-- Name: changelog_releases; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.changelog_releases ENABLE ROW LEVEL SECURITY;

--
-- Name: changelog_subscriptions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.changelog_subscriptions ENABLE ROW LEVEL SECURITY;

--
-- Name: changelog_webhooks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.changelog_webhooks ENABLE ROW LEVEL SECURITY;

--
-- Name: churn_alert_rules; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.churn_alert_rules ENABLE ROW LEVEL SECURITY;

--
-- Name: churn_alerts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.churn_alerts ENABLE ROW LEVEL SECURITY;

--
-- Name: churn_alerts churn_alerts_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY churn_alerts_all ON public.churn_alerts USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: churn_alerts churn_alerts_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY churn_alerts_select ON public.churn_alerts FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: churn_risk_predictions churn_risk_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY churn_risk_delete_policy ON public.churn_risk_predictions FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: churn_risk_predictions churn_risk_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY churn_risk_insert_policy ON public.churn_risk_predictions FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: churn_risk_predictions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.churn_risk_predictions ENABLE ROW LEVEL SECURITY;

--
-- Name: churn_risk_predictions churn_risk_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY churn_risk_select_policy ON public.churn_risk_predictions FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: churn_risk_predictions churn_risk_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY churn_risk_update_policy ON public.churn_risk_predictions FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: collected_reviews; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.collected_reviews ENABLE ROW LEVEL SECURITY;

--
-- Name: comment_mentions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.comment_mentions ENABLE ROW LEVEL SECURITY;

--
-- Name: comments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;

--
-- Name: competitive_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitive_events ENABLE ROW LEVEL SECURITY;

--
-- Name: competitive_intel_sessions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitive_intel_sessions ENABLE ROW LEVEL SECURITY;

--
-- Name: competitive_mentions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitive_mentions ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_alerts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_alerts ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_events ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_features; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_features ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_features competitor_features_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_features_select ON public.competitor_features FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: competitor_job_postings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_job_postings ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_monitoring_config; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_monitoring_config ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_products; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_products ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_products competitor_products_delete; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_products_delete ON public.competitor_products FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: competitor_products competitor_products_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_products_insert ON public.competitor_products FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: competitor_products competitor_products_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_products_select ON public.competitor_products FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: competitor_products competitor_products_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_products_update ON public.competitor_products FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: competitor_reviews; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_reviews ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_reviews competitor_reviews_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_reviews_select ON public.competitor_reviews FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: competitor_strengths; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_strengths ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_strengths competitor_strengths_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_strengths_select ON public.competitor_strengths FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: competitor_weaknesses; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitor_weaknesses ENABLE ROW LEVEL SECURITY;

--
-- Name: competitor_weaknesses competitor_weaknesses_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY competitor_weaknesses_select ON public.competitor_weaknesses FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: competitors; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.competitors ENABLE ROW LEVEL SECURITY;

--
-- Name: customer_health; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.customer_health ENABLE ROW LEVEL SECURITY;

--
-- Name: customer_health customer_health_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY customer_health_all ON public.customer_health USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['admin'::character varying, 'editor'::character varying])::text[]))))));


--
-- Name: customer_health_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.customer_health_history ENABLE ROW LEVEL SECURITY;

--
-- Name: customer_health customer_health_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY customer_health_select ON public.customer_health FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: customer_profiles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.customer_profiles ENABLE ROW LEVEL SECURITY;

--
-- Name: customer_sync_log; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.customer_sync_log ENABLE ROW LEVEL SECURITY;

--
-- Name: customers; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.customers ENABLE ROW LEVEL SECURITY;

--
-- Name: customers customers_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY customers_insert ON public.customers FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['admin'::character varying, 'editor'::character varying])::text[]))))));


--
-- Name: customers customers_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY customers_select ON public.customers FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: customers customers_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY customers_update ON public.customers FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['admin'::character varying, 'editor'::character varying])::text[]))))));


--
-- Name: daily_briefings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.daily_briefings ENABLE ROW LEVEL SECURITY;

--
-- Name: deal_autopsies; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_autopsies ENABLE ROW LEVEL SECURITY;

--
-- Name: deal_battlecards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_battlecards ENABLE ROW LEVEL SECURITY;

--
-- Name: deal_digest_subscriptions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_digest_subscriptions ENABLE ROW LEVEL SECURITY;

--
-- Name: deals; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deals ENABLE ROW LEVEL SECURITY;

--
-- Name: discord_integration_states; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discord_integration_states ENABLE ROW LEVEL SECURITY;

--
-- Name: discord_integrations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discord_integrations ENABLE ROW LEVEL SECURITY;

--
-- Name: discount_code_usage; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discount_code_usage ENABLE ROW LEVEL SECURITY;

--
-- Name: discount_codes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discount_codes ENABLE ROW LEVEL SECURITY;

--
-- Name: discovered_feedback; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discovered_feedback ENABLE ROW LEVEL SECURITY;

--
-- Name: domain_verifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.domain_verifications ENABLE ROW LEVEL SECURITY;

--
-- Name: email_batches; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_batches ENABLE ROW LEVEL SECURITY;

--
-- Name: email_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: email_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: email_queue; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: email_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;

--
-- Name: executive_briefs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.executive_briefs ENABLE ROW LEVEL SECURITY;

--
-- Name: executive_briefs executive_briefs_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY executive_briefs_all ON public.executive_briefs USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = ANY ((ARRAY['admin'::character varying, 'editor'::character varying])::text[]))))));


--
-- Name: executive_briefs executive_briefs_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY executive_briefs_select ON public.executive_briefs FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: experiment_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.experiment_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: experiment_learnings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.experiment_learnings ENABLE ROW LEVEL SECURITY;

--
-- Name: experiment_results; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.experiment_results ENABLE ROW LEVEL SECURITY;

--
-- Name: experiment_snapshots; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.experiment_snapshots ENABLE ROW LEVEL SECURITY;

--
-- Name: experiment_sync_log; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.experiment_sync_log ENABLE ROW LEVEL SECURITY;

--
-- Name: experiments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.experiments ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_gaps; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_gaps ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_impact_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_impact_history ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_outcomes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_outcomes ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_predictions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_predictions ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_predictions feature_predictions_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_predictions_delete_policy ON public.feature_predictions FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feature_predictions feature_predictions_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_predictions_insert_policy ON public.feature_predictions FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feature_predictions feature_predictions_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_predictions_select_policy ON public.feature_predictions FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feature_predictions feature_predictions_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_predictions_update_policy ON public.feature_predictions FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feedback_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feedback_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: feedback_integrations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feedback_integrations ENABLE ROW LEVEL SECURITY;

--
-- Name: feedback_merges; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feedback_merges ENABLE ROW LEVEL SECURITY;

--
-- Name: feedback_merges feedback_merges_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feedback_merges_insert_policy ON public.feedback_merges FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feedback_merges feedback_merges_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feedback_merges_select_policy ON public.feedback_merges FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: feedback_metadata; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feedback_metadata ENABLE ROW LEVEL SECURITY;

--
-- Name: feedback_themes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feedback_themes ENABLE ROW LEVEL SECURITY;

--
-- Name: feedback_webhooks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feedback_webhooks ENABLE ROW LEVEL SECURITY;

--
-- Name: gift_subscriptions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.gift_subscriptions ENABLE ROW LEVEL SECURITY;

--
-- Name: customer_health_history health_history_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY health_history_select ON public.customer_health_history FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: health_scores; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.health_scores ENABLE ROW LEVEL SECURITY;

--
-- Name: hunter_configs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.hunter_configs ENABLE ROW LEVEL SECURITY;

--
-- Name: hunter_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.hunter_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: inbox_sync_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.inbox_sync_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: insight_reports; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.insight_reports ENABLE ROW LEVEL SECURITY;

--
-- Name: insight_reports insight_reports_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY insight_reports_delete_policy ON public.insight_reports FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: insight_reports insight_reports_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY insight_reports_insert_policy ON public.insight_reports FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: insight_reports insight_reports_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY insight_reports_select_policy ON public.insight_reports FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: insight_reports insight_reports_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY insight_reports_update_policy ON public.insight_reports FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: integration_credentials; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integration_credentials ENABLE ROW LEVEL SECURITY;

--
-- Name: feedback_integrations integrations_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY integrations_all ON public.feedback_integrations USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE ((members.user_id = auth.uid()) AND ((members.role)::text = 'admin'::text)))));


--
-- Name: feedback_integrations integrations_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY integrations_select ON public.feedback_integrations FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: jira_connections; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jira_connections ENABLE ROW LEVEL SECURITY;

--
-- Name: jira_issue_links; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jira_issue_links ENABLE ROW LEVEL SECURITY;

--
-- Name: jira_label_mappings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jira_label_mappings ENABLE ROW LEVEL SECURITY;

--
-- Name: jira_oauth_states; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jira_oauth_states ENABLE ROW LEVEL SECURITY;

--
-- Name: jira_sync_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jira_sync_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: jira_webhooks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jira_webhooks ENABLE ROW LEVEL SECURITY;

--
-- Name: launch_boards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.launch_boards ENABLE ROW LEVEL SECURITY;

--
-- Name: launch_checklist_items; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.launch_checklist_items ENABLE ROW LEVEL SECURITY;

--
-- Name: launch_dimensions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.launch_dimensions ENABLE ROW LEVEL SECURITY;

--
-- Name: launch_risks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.launch_risks ENABLE ROW LEVEL SECURITY;

--
-- Name: launch_votes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.launch_votes ENABLE ROW LEVEL SECURITY;

--
-- Name: linear_connections; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.linear_connections ENABLE ROW LEVEL SECURITY;

--
-- Name: lovable_generations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lovable_generations ENABLE ROW LEVEL SECURITY;

--
-- Name: members; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.members ENABLE ROW LEVEL SECURITY;

--
-- Name: notification_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.notification_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: persona_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.persona_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: personas; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.personas ENABLE ROW LEVEL SECURITY;

--
-- Name: platform_integrations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.platform_integrations ENABLE ROW LEVEL SECURITY;

--
-- Name: pm_assignments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pm_assignments ENABLE ROW LEVEL SECURITY;

--
-- Name: pm_assignments pm_assignments_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pm_assignments_delete_policy ON public.pm_assignments FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: pm_assignments pm_assignments_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pm_assignments_insert_policy ON public.pm_assignments FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: pm_assignments pm_assignments_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pm_assignments_select_policy ON public.pm_assignments FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: pm_assignments pm_assignments_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pm_assignments_update_policy ON public.pm_assignments FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: poll_options; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.poll_options ENABLE ROW LEVEL SECURITY;

--
-- Name: poll_options poll_options_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY poll_options_delete_policy ON public.poll_options FOR DELETE USING ((poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: poll_options poll_options_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY poll_options_insert_policy ON public.poll_options FOR INSERT WITH CHECK ((poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: poll_options poll_options_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY poll_options_select_policy ON public.poll_options FOR SELECT USING (((poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.status = 'active'::text))) OR (poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid())))))));


--
-- Name: poll_options poll_options_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY poll_options_update_policy ON public.poll_options FOR UPDATE USING ((poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: poll_votes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.poll_votes ENABLE ROW LEVEL SECURITY;

--
-- Name: poll_votes poll_votes_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY poll_votes_insert_policy ON public.poll_votes FOR INSERT WITH CHECK ((poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.status = 'active'::text))));


--
-- Name: poll_votes poll_votes_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY poll_votes_select_policy ON public.poll_votes FOR SELECT USING (((voter_id = auth.uid()) OR (poll_id IN ( SELECT polls.id
   FROM public.polls
  WHERE (polls.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid())))))));


--
-- Name: polls; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.polls ENABLE ROW LEVEL SECURITY;

--
-- Name: polls polls_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY polls_delete_policy ON public.polls FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: polls polls_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY polls_insert_policy ON public.polls FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: polls polls_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY polls_select_policy ON public.polls FOR SELECT USING (((status = 'active'::text) OR (project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())))));


--
-- Name: polls polls_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY polls_update_policy ON public.polls FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: post_similarities; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.post_similarities ENABLE ROW LEVEL SECURITY;

--
-- Name: posts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;

--
-- Name: prd_risk_alerts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.prd_risk_alerts ENABLE ROW LEVEL SECURITY;

--
-- Name: pre_mortem_analyses; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pre_mortem_analyses ENABLE ROW LEVEL SECURITY;

--
-- Name: product_doc_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.product_doc_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: product_documents; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.product_documents ENABLE ROW LEVEL SECURITY;

--
-- Name: project_notification_recipients; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.project_notification_recipients ENABLE ROW LEVEL SECURITY;

--
-- Name: projects; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;

--
-- Name: push_subscriptions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.push_subscriptions ENABLE ROW LEVEL SECURITY;

--
-- Name: rate_limit_violations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.rate_limit_violations ENABLE ROW LEVEL SECURITY;

--
-- Name: reasoning_traces; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.reasoning_traces ENABLE ROW LEVEL SECURITY;

--
-- Name: reasoning_traces reasoning_traces_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reasoning_traces_delete_policy ON public.reasoning_traces FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: reasoning_traces reasoning_traces_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reasoning_traces_insert_policy ON public.reasoning_traces FOR INSERT WITH CHECK (((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))) OR (project_id IS NULL)));


--
-- Name: reasoning_traces reasoning_traces_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reasoning_traces_select_policy ON public.reasoning_traces FOR SELECT USING (((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))) OR (project_id IS NULL)));


--
-- Name: report_executions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.report_executions ENABLE ROW LEVEL SECURITY;

--
-- Name: retro_actions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retro_actions ENABLE ROW LEVEL SECURITY;

--
-- Name: retro_boards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retro_boards ENABLE ROW LEVEL SECURITY;

--
-- Name: retro_card_comments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retro_card_comments ENABLE ROW LEVEL SECURITY;

--
-- Name: retro_card_votes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retro_card_votes ENABLE ROW LEVEL SECURITY;

--
-- Name: retro_cards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retro_cards ENABLE ROW LEVEL SECURITY;

--
-- Name: retro_columns; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retro_columns ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_adjustment_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_adjustment_history ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_adjustment_proposals; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_adjustment_proposals ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_exports; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_exports ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_feedback; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_feedback ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_generation_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_generation_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_item_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_item_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_priority_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_priority_history ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_roast_sessions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_roast_sessions ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_subscriptions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_subscriptions ENABLE ROW LEVEL SECURITY;

--
-- Name: roadmap_suggestions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roadmap_suggestions ENABLE ROW LEVEL SECURITY;

--
-- Name: scheduled_reports; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.scheduled_reports ENABLE ROW LEVEL SECURITY;

--
-- Name: scrape_cache; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.scrape_cache ENABLE ROW LEVEL SECURITY;

--
-- Name: security_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.security_events ENABLE ROW LEVEL SECURITY;

--
-- Name: account_billing_profiles select_own_billing_profile; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY select_own_billing_profile ON public.account_billing_profiles FOR SELECT USING ((auth.uid() = user_id));


--
-- Name: sentiment_analysis; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sentiment_analysis ENABLE ROW LEVEL SECURITY;

--
-- Name: sentiment_forecasts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sentiment_forecasts ENABLE ROW LEVEL SECURITY;

--
-- Name: sentiment_forecasts sentiment_forecasts_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sentiment_forecasts_delete_policy ON public.sentiment_forecasts FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: sentiment_forecasts sentiment_forecasts_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sentiment_forecasts_insert_policy ON public.sentiment_forecasts FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: sentiment_forecasts sentiment_forecasts_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sentiment_forecasts_select_policy ON public.sentiment_forecasts FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: sentiment_forecasts sentiment_forecasts_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sentiment_forecasts_update_policy ON public.sentiment_forecasts FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: sentiment_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sentiment_history ENABLE ROW LEVEL SECURITY;

--
-- Name: signal_correlations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.signal_correlations ENABLE ROW LEVEL SECURITY;

--
-- Name: signal_correlations signal_correlations_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY signal_correlations_insert_policy ON public.signal_correlations FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: signal_correlations signal_correlations_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY signal_correlations_select_policy ON public.signal_correlations FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: signal_correlations signal_correlations_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY signal_correlations_update_policy ON public.signal_correlations FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: signal_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.signal_events ENABLE ROW LEVEL SECURITY;

--
-- Name: signal_events signal_events_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY signal_events_insert_policy ON public.signal_events FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: signal_events signal_events_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY signal_events_select_policy ON public.signal_events FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: slack_alert_rules; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_alert_rules ENABLE ROW LEVEL SECURITY;

--
-- Name: slack_channel_mappings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_channel_mappings ENABLE ROW LEVEL SECURITY;

--
-- Name: slack_connections; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_connections ENABLE ROW LEVEL SECURITY;

--
-- Name: slack_integration_states; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_integration_states ENABLE ROW LEVEL SECURITY;

--
-- Name: slack_integrations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_integrations ENABLE ROW LEVEL SECURITY;

--
-- Name: slack_interaction_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_interaction_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: slack_message_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.slack_message_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: smart_replies; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.smart_replies ENABLE ROW LEVEL SECURITY;

--
-- Name: spec_context_sources; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.spec_context_sources ENABLE ROW LEVEL SECURITY;

--
-- Name: spec_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.spec_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: spec_versions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.spec_versions ENABLE ROW LEVEL SECURITY;

--
-- Name: specs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.specs ENABLE ROW LEVEL SECURITY;

--
-- Name: sprints; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sprints ENABLE ROW LEVEL SECURITY;

--
-- Name: stakeholder_interests; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.stakeholder_interests ENABLE ROW LEVEL SECURITY;

--
-- Name: stakeholder_queries; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.stakeholder_queries ENABLE ROW LEVEL SECURITY;

--
-- Name: stakeholder_reports; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.stakeholder_reports ENABLE ROW LEVEL SECURITY;

--
-- Name: stakeholders; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.stakeholders ENABLE ROW LEVEL SECURITY;

--
-- Name: story_feedback_links; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.story_feedback_links ENABLE ROW LEVEL SECURITY;

--
-- Name: story_generation_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.story_generation_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: story_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.story_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: strategic_recommendations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.strategic_recommendations ENABLE ROW LEVEL SECURITY;

--
-- Name: strategy_shift_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.strategy_shift_events ENABLE ROW LEVEL SECURITY;

--
-- Name: strategy_shifts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.strategy_shifts ENABLE ROW LEVEL SECURITY;

--
-- Name: stripe_settings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.stripe_settings ENABLE ROW LEVEL SECURITY;

--
-- Name: survey_questions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.survey_questions ENABLE ROW LEVEL SECURITY;

--
-- Name: survey_questions survey_questions_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY survey_questions_delete_policy ON public.survey_questions FOR DELETE USING ((survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: survey_questions survey_questions_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY survey_questions_insert_policy ON public.survey_questions FOR INSERT WITH CHECK ((survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: survey_questions survey_questions_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY survey_questions_select_policy ON public.survey_questions FOR SELECT USING (((survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.status = 'active'::text))) OR (survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid())))))));


--
-- Name: survey_questions survey_questions_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY survey_questions_update_policy ON public.survey_questions FOR UPDATE USING ((survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid()))))));


--
-- Name: survey_responses; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.survey_responses ENABLE ROW LEVEL SECURITY;

--
-- Name: survey_responses survey_responses_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY survey_responses_insert_policy ON public.survey_responses FOR INSERT WITH CHECK ((survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.status = 'active'::text))));


--
-- Name: survey_responses survey_responses_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY survey_responses_select_policy ON public.survey_responses FOR SELECT USING (((respondent_id = auth.uid()) OR (survey_id IN ( SELECT surveys.id
   FROM public.surveys
  WHERE (surveys.project_id IN ( SELECT projects.id
           FROM public.projects
          WHERE (projects.owner_id = auth.uid())))))));


--
-- Name: surveys; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.surveys ENABLE ROW LEVEL SECURITY;

--
-- Name: surveys surveys_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY surveys_delete_policy ON public.surveys FOR DELETE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: surveys surveys_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY surveys_insert_policy ON public.surveys FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: surveys surveys_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY surveys_select_policy ON public.surveys FOR SELECT USING (((status = 'active'::text) OR (project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())))));


--
-- Name: surveys surveys_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY surveys_update_policy ON public.surveys FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: inbox_sync_logs sync_logs_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sync_logs_select ON public.inbox_sync_logs FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: team_capacity; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.team_capacity ENABLE ROW LEVEL SECURITY;

--
-- Name: team_invitations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.team_invitations ENABLE ROW LEVEL SECURITY;

--
-- Name: team_velocity; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.team_velocity ENABLE ROW LEVEL SECURITY;

--
-- Name: theme_clusters; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.theme_clusters ENABLE ROW LEVEL SECURITY;

--
-- Name: themes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.themes ENABLE ROW LEVEL SECURITY;

--
-- Name: timeline_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.timeline_events ENABLE ROW LEVEL SECURITY;

--
-- Name: triage_queue; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.triage_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: triage_queue triage_queue_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY triage_queue_insert_policy ON public.triage_queue FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: triage_queue triage_queue_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY triage_queue_select_policy ON public.triage_queue FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: triage_queue triage_queue_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY triage_queue_update_policy ON public.triage_queue FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid()))));


--
-- Name: unified_feedback_items ufi_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ufi_insert ON public.unified_feedback_items FOR INSERT WITH CHECK ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: unified_feedback_items ufi_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ufi_select ON public.unified_feedback_items FOR SELECT USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: unified_feedback_items ufi_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ufi_update ON public.unified_feedback_items FOR UPDATE USING ((project_id IN ( SELECT projects.id
   FROM public.projects
  WHERE (projects.owner_id = auth.uid())
UNION
 SELECT members.project_id
   FROM public.members
  WHERE (members.user_id = auth.uid()))));


--
-- Name: unified_action_queue; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.unified_action_queue ENABLE ROW LEVEL SECURITY;

--
-- Name: unified_feedback_items; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.unified_feedback_items ENABLE ROW LEVEL SECURITY;

--
-- Name: unsubscribe_tokens; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.unsubscribe_tokens ENABLE ROW LEVEL SECURITY;

--
-- Name: usage_analytics_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.usage_analytics_events ENABLE ROW LEVEL SECURITY;

--
-- Name: user_intelligence; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_intelligence ENABLE ROW LEVEL SECURITY;

--
-- Name: user_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: user_stories; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_stories ENABLE ROW LEVEL SECURITY;

--
-- Name: users; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

--
-- Name: vote_metadata; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.vote_metadata ENABLE ROW LEVEL SECURITY;

--
-- Name: votes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.votes ENABLE ROW LEVEL SECURITY;

--
-- Name: webhook_deliveries; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.webhook_deliveries ENABLE ROW LEVEL SECURITY;

--
-- Name: workflows; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workflows ENABLE ROW LEVEL SECURITY;

--
-- PostgreSQL database dump complete
--

\unrestrict gawe2rc5NXHQyU5EuEIuCFIUXcVDFsc4gFvq8m4nm7XNRFh4DAOVlWxePNPANGf

